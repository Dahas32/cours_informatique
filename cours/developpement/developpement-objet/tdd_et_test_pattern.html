<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.7.1 -->
<title>TDD et test pattern | cours d’informatique</title>
<meta name="generator" content="Jekyll v4.2.0" />
<meta property="og:title" content="TDD et test pattern" />
<meta name="author" content="François Brucker" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Support de cours/td d’informatique à l’école centrale marseille." />
<meta property="og:description" content="Support de cours/td d’informatique à l’école centrale marseille." />
<link rel="canonical" href="/cours_informatique/cours/developpement/developpement-objet/tdd_et_test_pattern.html" />
<meta property="og:url" content="/cours_informatique/cours/developpement/developpement-objet/tdd_et_test_pattern.html" />
<meta property="og:site_name" content="cours d’informatique" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="TDD et test pattern" />
<script type="application/ld+json">
{"headline":"TDD et test pattern","description":"Support de cours/td d’informatique à l’école centrale marseille.","@type":"WebPage","url":"/cours_informatique/cours/developpement/developpement-objet/tdd_et_test_pattern.html","author":{"@type":"Person","name":"François Brucker"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/cours_informatique/assets/main.css">

  <link rel="stylesheet" href="/cours_informatique/assets/custom.css"><link type="application/atom+xml" rel="alternate" href="/cours_informatique/feed.xml" title="cours d'informatique" /><!-- Mathjax Support -->
  <script>
    MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
      },
      svg: {
        fontCache: 'global'
      }
    };
    </script>
    <script type="text/javascript" id="MathJax-script" async
      src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js">
    </script>
</head>

<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/cours_informatique/">cours d&#39;informatique</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger">
            <a class="page-link" href="/cours_informatique/about"> about </a>
        </div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post">

  <header class="post-header">
    <h1 class="post-title">TDD et test pattern</h1></p>Auteur : <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span class="p-author h-card" itemprop="name">François Brucker</span></span></p>
  </header>

  <div class="post-content">
    <h2 id="test-driven-development-by-example">Test Driven Development by example</h2>

<p>Vous allez suivre ici le livre séminal : <a href="https://www.amazon.fr/Test-Driven-Development-Kent-Beck/dp/0321146530/ref=sr_1_1?ie=UTF8&amp;qid=1538720480&amp;sr=8-1&amp;keywords=test+driven+development+by+example">TDD by example</a> de Kent Beck (Suivez son <a href="https://twitter.com/kentbeck">twitter</a>, ses posts sont souvent rigolos et toujours utiles). Initialement écrit pour le java, nous allons appliquer ses enseignements au python.</p>

<p>On y verra aussi quelques règles de refactoring que l’on peut voir dans <a href="https://www.amazon.fr/Refactoring-Improving-Design-Existing-Code/dp/0201485672/ref=sr_1_2?ie=UTF8&amp;qid=1539066441&amp;sr=8-2">Refactoring: Improving the Design of Existing Code </a> de <a href="https://martinfowler.com">Martin fowler</a> (allez voir son site, y’a moult choses chouettes sur le code, l’agile, la vie et le reste)</p>

<p>Si vous connaissez tout ça par cœur, mais pas avant car ce n’est pas un livre pour débutant, allez lire <a href="https://www.amazon.fr/Clean-Code-Handbook-Software-Craftsmanship/dp/0132350882">clean code</a> de Robert Martin (dit uncle bob). Ce livre contient, entre autres, le meilleur indicateur d’un bon code au monde, le WTFs/minute :</p>

<p><img src="img/wtfm.jpg" alt="WTFs/minute" /></p>

<h2 id="quoi">Quoi</h2>

<p>Créer une application de change.</p>

<table>
  <thead>
    <tr>
      <th>who</th>
      <th>number</th>
      <th>price</th>
      <th>total</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Apple</td>
      <td>1000</td>
      <td>$200</td>
      <td>$200 000</td>
    </tr>
    <tr>
      <td>Nestlé</td>
      <td>400</td>
      <td>80 CHF</td>
      <td>32 000 CHF</td>
    </tr>
    <tr>
      <td> </td>
      <td> </td>
      <td><strong>total</strong></td>
      <td>$248 000</td>
    </tr>
  </tbody>
</table>

<p>Avec le taux de conversion : 1 CHF = $0.5</p>

<h2 id="comment-">Comment ?</h2>

<p>En programmant par les tests bien sur !</p>

<p>On commence par une todo list qui regroupe tout ce que l’on pense faire pour l’instant. Cette liste va diminuer lorsque l’on avancera sur le projet et grossir lorsque notre connaissance du projet va s’affiner.</p>

<p>Nous n’utiliserons pas ici notre code. Mais il faudra tout faire <em>from scratch</em>. On aura donc besoin :</p>

<ul>
  <li>d’une todo list où tous nos items à faire pour l’instant sont écrit : le <em>backlog</em></li>
  <li>de fichiers de tests</li>
  <li>du code</li>
</ul>

<p>On verra tout au long du cours divers patterns de test et de développement pour que tout aille pour le mieux. Notre but est ici de faire : <em>clean code that works</em> Pour cela on va se fixer quelques règles :</p>

<ul>
  <li>on écrit du code que si un test rate</li>
  <li>élimine les duplications</li>
</ul>

<p>Ces 2 règles impliquent un mode de fonctionnement :</p>

<ol>
  <li>red: 
    - écrire <em>rapidement</em> un <em>petit</em> test. 
    - lancer les test et le voir planter, voir même  ne correspondre à aucun code.</li>
  <li>green: 
    - écrire le code <em>minimal</em> qui permet de faire passer le test
    - lancer les tests et les voir tous réussir</li>
  <li>refactor: élimine les duplications tout en conservant le passage des tests.</li>
</ol>

<p>Cela permet de prendre du plaisir à coder :</p>

<ul>
  <li>en écrivant du code on est sûr de ne rien casser</li>
  <li>voir la todo list diminuer montre que l’on avance</li>
  <li>comme tous les tests sont conservés on  sait que l’on ne travaille pas pour rien</li>
</ul>

<p>Toutes ces règles visent à diminuer la peur qui bloque tout progrès.</p>

<h2 id="code">Code</h2>

<p>On va développer petit à petit notre propre application de change en utilisant le TDD. Essayer de voir comment :</p>

<ul>
  <li>chaque test couvre un petit ajout de fonctionnalités</li>
  <li>rapidement et salement faire fonctionner les tests</li>
  <li>souvent les tests sont lancés</li>
  <li>le refactoring est fait par petites touches</li>
</ul>

<h3 id="1---départ">1 - départ</h3>

<h4>??</h4>

<p>Commençons par remplir notre todo list :</p>

<ul>
  <li>il faut plusieurs devises (ici CHF et $)</li>
  <li>il faut multiplier les devises par des nombres (nb actions * prix)</li>
</ul>

<p>La todolist (backlog) nous indique ce qu’il faut faire (dès que on voit une tâche à faire qui n’est pas dans la todo list, on la rajoute), ce sur quoi on travaille (on travaillera toujours sur un unique item) et ce que l’on a fait (il n’y a rien de plus satisfaisant que de barrer une ligne que l’on vient de finir).</p>

<p>Puis créez un projet avec pycharm. On y placera pour l’instant 1 unique fichier de tests, <code class="language-plaintext highlighter-rouge">tests.py</code>.
Prenez également une feuille de papier pour vos todos.</p>

<p>On ajoutera tout de suite une configuration permettant de lancer les tests avec py.test.</p>

<h4 id="tbd">tbd</h4>

<ul>
  <li>$5 + 2.5CHF = $10 si le taux de change est 1:.5</li>
  <li>$5 * 2 = $10</li>
</ul>

<h4 id="-1">??</h4>

<p>Par quoi on commence ?</p>

<p><strong>PAR UN TEST !</strong></p>

<p>La bonne question est : que teste-t-on en premier ?</p>

<p>La deuxième ligne semble la plus simple. Donc allons-y : utilisons notre application pour multiplier les dollars.</p>

<h4 id="testspy">tests.py</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">money</span> <span class="kn">import</span> <span class="n">Dollar</span>

<span class="k">def</span> <span class="nf">test_multiplication</span><span class="p">():</span>
    <span class="n">five</span> <span class="o">=</span> <span class="n">Dollar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">five</span><span class="p">.</span><span class="n">times</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    
    <span class="k">assert</span> <span class="mi">10</span> <span class="o">==</span> <span class="n">five</span><span class="p">.</span><span class="n">amount</span>
</code></pre></div></div>

<p>Utiliser dollar comme ça permet d’ajouter rapidement des fonctionnalités mais ajoute des choses à faire, que l’on ajoute dans la todo list :</p>

<h4 id="tbd-1">tbd</h4>

<ul>
  <li>$5 + 2.5CHF = $10 si le taux de change est 1:.5</li>
  <li><strong>$5 * 2 = $10</strong></li>
  <li>utiliser <code class="language-plaintext highlighter-rouge">amount</code> ? Le rendre privé (le cacher à l’utilisateur (ici les tests))</li>
  <li>five == 10 n’est pas vraiment super. non mutable</li>
  <li>gestion des arrondis</li>
</ul>

<h5 id="-2">??</h5>

<p>Rien ne marche avec nos tests. On va donc lire attentivement les messages d’erreurs de python et les régler petit à petit.</p>

<p>Il est <strong>TOUJOURS</strong> plus simple de lire un message d’erreur que d’essayer de faire en sorte qu’ils n’arrivent pas en regardant le code.</p>

<ol>
  <li>En lançant les tests on a : <code class="language-plaintext highlighter-rouge">E   ModuleNotFoundError: No module named 'money'</code> : on crée donc un fichier <code class="language-plaintext highlighter-rouge">money.py</code></li>
  <li>L’erreur est maintenant : <code class="language-plaintext highlighter-rouge">E   ImportError: cannot import name 'Dollar' from 'money'</code> : on crée une classe <code class="language-plaintext highlighter-rouge">Dollar</code> et une unique instruction <code class="language-plaintext highlighter-rouge">pass</code> (qui ne fait rien mais permet de ne pas faire d’erreur lorsque l’on crée un bloc sans instructions)</li>
  <li>et ainsi de suite jusqu’à ce qu’il n’y ait plus d’erreur</li>
</ol>

<p>L’interpréteur vous aide : utilisez le pour résoudre ce genre de problèmes !</p>

<p>Après plusieurs tentatives de plus en plus fructueuses (on ajoute à chaque fois le minimum possible pour faire passer l’erreur) on arrive à ce que nos tests passent !</p>

<h4 id="moneypy">money.py</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Dollar</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">amount</span> <span class="o">=</span> <span class="mi">10</span>

    <span class="k">def</span> <span class="nf">times</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">multiplier</span><span class="p">):</span>
        <span class="k">pass</span>
</code></pre></div></div>

<h4 id="-3">??</h4>

<p>Halte là ! Ce n’est pas fini. Nos tests passent mais il reste un étape à faire : <em>supprimer les duplications</em>. Entre chaque étape on relance les tests pour être sûr que tout passe. Si on reste vert, on a pas cassé le code !</p>

<ol>
  <li>le <code class="language-plaintext highlighter-rouge">10</code> du test est dupliqué avec le <code class="language-plaintext highlighter-rouge">10</code> du <code class="language-plaintext highlighter-rouge">self.amount</code>. C’est en fait <code class="language-plaintext highlighter-rouge">5 * 2</code></li>
  <li>le <code class="language-plaintext highlighter-rouge">5</code> du <code class="language-plaintext highlighter-rouge">self.amount</code> est en fait une duplication du paramètre <code class="language-plaintext highlighter-rouge">amount</code>, et le <code class="language-plaintext highlighter-rouge">* 2</code></li>
  <li><code class="language-plaintext highlighter-rouge">le * 2</code> est en fait utile avec la méthode <code class="language-plaintext highlighter-rouge">times()</code> on le rajoute donc dedans et le supprime de <code class="language-plaintext highlighter-rouge">self.amount</code></li>
  <li><code class="language-plaintext highlighter-rouge">2</code> de la méthode <code class="language-plaintext highlighter-rouge">times</code> est en en fait une duplication du paramètre <code class="language-plaintext highlighter-rouge">multiplier</code>.</li>
  <li>on peut même utiliser l’opérateur <code class="language-plaintext highlighter-rouge">*=</code> dans la méthode <code class="language-plaintext highlighter-rouge">times</code>.</li>
</ol>

<p>On ne vous demande pas de toujours faire comme ça, c’est une méthode qui marche lorsque l’on ne sait pas aller plus vite. C’est bourrin et sans interprétation possible. On vient de découvrir une règle du TDD pour faire passer des tests : <strong>fake it</strong></p>

<h4 id="moneypy-1">money.py</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Dollar</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">amount</span> <span class="o">=</span> <span class="n">amount</span>

    <span class="k">def</span> <span class="nf">times</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">multiplier</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">amount</span> <span class="o">*=</span> <span class="n">multiplier</span>
</code></pre></div></div>

<h4 id="tbd-2">tbd</h4>

<ul>
  <li>$5 + 2.5CHF = $10 si le taux de change est 1:.5</li>
  <li><del>$5 * 2 = $10</del></li>
  <li>utiliser <code class="language-plaintext highlighter-rouge">amount</code> ? Le rendre privé</li>
  <li>five == 10 n’est pas vraiment super. non mutable</li>
  <li>gestion des arrondis</li>
</ul>

<h3 id="2---value-object">2 - value object</h3>

<p>On veut faire du <strong>clean code that works</strong>. Mais c’est très difficile même pour des très bons codeurs. Donc on va séparer le problème :</p>

<ol>
  <li>on commence par le <em>that works</em></li>
  <li>on fini par le <em>clean code</em></li>
</ol>

<p>Que faire maintenant ?</p>

<h4 id="tbd-3">tbd</h4>

<ul>
  <li>$5 + 2.5CHF = $10 si le taux de change est 1:.5</li>
  <li><del>$5 * 2 = $10</del></li>
  <li>utiliser <code class="language-plaintext highlighter-rouge">amount</code> ? Le rendre privé</li>
  <li><strong>five == 10 n’est pas vraiment super. non mutable</strong></li>
  <li>gestion des arrondis</li>
</ul>

<h4 id="-4">??</h4>

<p>Rendre des objets non mutable : des <em>value object</em> c’est super chouette. On a plus besoin de faire attention à eux. Une fois créés ils ne bougent plus. On peut donc les donner à des méthodes inconnues sans avoir peur qu’ils soient modifiés, ou les utiliser dans nos propres méthodes sans craindre qu’ils soient modifiés plus tard.</p>

<p>Si l’on veut modifier un value objet, il faut en créer un autre. Heureusement, dans la plupart du temps ce n’est pas très coûteux.</p>

<h4 id="testspy-1">tests.py</h4>

<p>On voudrait pouvoir multiplier plein de fois différentes nos dollars et que ça ne pose pas de soucis. Genre :</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">money</span> <span class="kn">import</span> <span class="n">Dollar</span>

<span class="k">def</span> <span class="nf">test_multiplication</span><span class="p">():</span>
    <span class="n">five</span> <span class="o">=</span> <span class="n">Dollar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">five</span><span class="p">.</span><span class="n">times</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        
    <span class="k">assert</span> <span class="mi">10</span> <span class="o">==</span> <span class="n">five</span><span class="p">.</span><span class="n">amount</span>

    <span class="n">five</span><span class="p">.</span><span class="n">times</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        
    <span class="k">assert</span> <span class="mi">15</span> <span class="o">==</span> <span class="n">five</span><span class="p">.</span><span class="n">amount</span>
</code></pre></div></div>

<p>Mais comme ça c’est pas possible : <em>value objects</em> to the rescue :</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">money</span> <span class="kn">import</span> <span class="n">Dollar</span>

<span class="k">def</span> <span class="nf">test_multiplication</span><span class="p">():</span>
    <span class="n">five</span> <span class="o">=</span> <span class="n">Dollar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
    
    <span class="n">product</span> <span class="o">=</span> <span class="n">five</span><span class="p">.</span><span class="n">times</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">assert</span> <span class="mi">10</span> <span class="o">==</span> <span class="n">product</span><span class="p">.</span><span class="n">amount</span>

    <span class="n">product</span> <span class="o">=</span> <span class="n">five</span><span class="p">.</span><span class="n">times</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>        
    <span class="k">assert</span> <span class="mi">15</span> <span class="o">==</span> <span class="n">product</span><span class="p">.</span><span class="n">amount</span>
</code></pre></div></div>

<p>Pour être sur que notre objet n’est pas modifié, il faut faire 2 test à la suite.</p>

<h4 id="moneypy-2">money.py</h4>

<p>Ce coup ci, pas besoin de grandes manipulations : il faut que la méthode <em>times</em> rende un objet <code class="language-plaintext highlighter-rouge">Dollar</code>. Si l’implémentation semble évidente, autant la coder de suite (mais après le test !).  On vient de découvrir une autre règle du TDD pour faire passer des tests (on va en utiliser 3) : <strong>obvious implementation</strong> (on change directement le code).</p>

<p>Si le code à mettre n’est pas évident, on utilise la première règle, le <strong>fake it</strong> où l’on remplace petit à petit les duplications.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Dollar</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">amount</span> <span class="o">=</span> <span class="n">amount</span>

    <span class="k">def</span> <span class="nf">times</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">multiplier</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Dollar</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">amount</span> <span class="o">*</span> <span class="n">multiplier</span><span class="p">)</span>
</code></pre></div></div>

<h4 id="tbd-4">tbd</h4>

<ul>
  <li>$5 + 2.5CHF = $10 si le taux de change est 1:.5</li>
  <li><del>$5 * 2 = $10</del></li>
  <li>utiliser <code class="language-plaintext highlighter-rouge">amount</code> ? Le rendre privé</li>
  <li><del>five == 10 n’est pas vraiment super. non mutable</del></li>
  <li>gestion des arrondis</li>
</ul>

<h3 id="3---">3 - <code class="language-plaintext highlighter-rouge">==</code></h3>

<p>Pour vérifier que deux objets sont égaux, on ne va pas passer son temps à vérifier que tous leurs attributs soient les même. On va le faire une fois pour toute (ce qui évite les duplications). On le rajoute donc dans le tbd :</p>

<h4 id="tbd-5">tbd</h4>

<ul>
  <li>$5 + 2.5CHF = $10 si le taux de change est 1:.5</li>
  <li><del>$5 * 2 = $10</del></li>
  <li>utiliser <code class="language-plaintext highlighter-rouge">amount</code> ? Le rendre privé</li>
  <li><del>five == 10 n’est pas vraiment super. non mutable</del></li>
  <li>gestion des arrondis</li>
  <li><strong>==</strong></li>
</ul>

<p>On va utiliser pour cela des méthodes spéciales de python qui permettent d’utiliser les opérateurs <code class="language-plaintext highlighter-rouge">==</code> et <code class="language-plaintext highlighter-rouge">!=</code> même si on est pas des entiers. Mais avant d’aller plus loin, les tests.</p>

<h4 id="testspy-2">tests.py</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">money</span> <span class="kn">import</span> <span class="n">Dollar</span>


<span class="k">def</span> <span class="nf">test_equality</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">Dollar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">==</span> <span class="n">Dollar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">test_multiplication</span><span class="p">():</span>
    <span class="n">five</span> <span class="o">=</span> <span class="n">Dollar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

    <span class="n">product</span> <span class="o">=</span> <span class="n">five</span><span class="p">.</span><span class="n">times</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">assert</span> <span class="mi">10</span> <span class="o">==</span> <span class="n">product</span><span class="p">.</span><span class="n">amount</span>

    <span class="n">product</span> <span class="o">=</span> <span class="n">five</span><span class="p">.</span><span class="n">times</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="k">assert</span> <span class="mi">15</span> <span class="o">==</span> <span class="n">product</span><span class="p">.</span><span class="n">amount</span>
</code></pre></div></div>

<p>Bien sur, le test rate. Par défaut, lorsque l’on a pas défini de méthode <code class="language-plaintext highlighter-rouge">__eq__</code> et <code class="language-plaintext highlighter-rouge">__ne__</code>, l’opérateur <code class="language-plaintext highlighter-rouge">==</code> regarde si ce sont les mêmes objets, ce qui n’est pas le cas.</p>

<h4 id="moneypy-3">money.py</h4>

<p>Faisons passer le test :</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Dollar</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">amount</span> <span class="o">=</span> <span class="n">amount</span>

    <span class="k">def</span> <span class="nf">times</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">multiplier</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Dollar</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">amount</span> <span class="o">*</span> <span class="n">multiplier</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">True</span>
</code></pre></div></div>

<p>Avec ce code lorsque l’on écrit <code class="language-plaintext highlighter-rouge">x == y</code>, python le re-écrit en : <code class="language-plaintext highlighter-rouge">x.__eq__(y)</code>. Du coup notre <em>fake it</em> fait passer le test.</p>

<p>Mais ce n’est toujours pas ce que l’on veut. Pour cela on va utiliser la troisième règle du TDD : <strong>triangulation</strong></p>

<h4 id="testspy-3">tests.py</h4>

<p>On utilise la <strong>triangulation</strong> lorsque l’on ne sait pas trop quoi faire pour supprimer les duplications. On écrit alors un autre test pour le même problème. Si le test est différent du premier, pour qu’il passe il faudra supprimer des duplications. On ajoute alors autant de tests qu’il faut jusqu’à ce que les duplications aient disparues. Les tests que l’on rajoute dépendent donc des duplications que l’on a.</p>

<p>Dans notre cas, on répond toujours <code class="language-plaintext highlighter-rouge">True</code>, on va donc forger un test qui doit répondre <code class="language-plaintext highlighter-rouge">False</code> :</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">money</span> <span class="kn">import</span> <span class="n">Dollar</span>


<span class="k">def</span> <span class="nf">test_equality</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">Dollar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">==</span> <span class="n">Dollar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">Dollar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">!=</span> <span class="n">Dollar</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">test_multiplication</span><span class="p">():</span>
    <span class="n">five</span> <span class="o">=</span> <span class="n">Dollar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

    <span class="n">product</span> <span class="o">=</span> <span class="n">five</span><span class="p">.</span><span class="n">times</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">assert</span> <span class="mi">10</span> <span class="o">==</span> <span class="n">product</span><span class="p">.</span><span class="n">amount</span>

    <span class="n">product</span> <span class="o">=</span> <span class="n">five</span><span class="p">.</span><span class="n">times</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="k">assert</span> <span class="mi">15</span> <span class="o">==</span> <span class="n">product</span><span class="p">.</span><span class="n">amount</span>
</code></pre></div></div>

<h4 id="moneypy-4">money.py</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Dollar</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">amount</span> <span class="o">=</span> <span class="n">amount</span>

    <span class="k">def</span> <span class="nf">times</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">multiplier</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Dollar</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">amount</span> <span class="o">*</span> <span class="n">multiplier</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">amount</span> <span class="o">==</span> <span class="n">other</span><span class="p">.</span><span class="n">amount</span>
</code></pre></div></div>

<h4 id="-5">??</h4>

<p>Pour l’instant on ne teste pas si l’objet <code class="language-plaintext highlighter-rouge">other</code> a la propriété <code class="language-plaintext highlighter-rouge">amount</code>. Voir même si l’objet existe (<code class="language-plaintext highlighter-rouge">five == None</code> va planter plutôt que de répondre <code class="language-plaintext highlighter-rouge">False</code>). On va pas s’embêter avec ça pour l’instant, mais on va le rajouter à notre todolist.</p>

<h4 id="tbd-6">tbd</h4>

<ul>
  <li>$5 + 2.5CHF = $10 si le taux de change est 1:.5</li>
  <li><del>$5 * 2 = $10</del></li>
  <li>utiliser <code class="language-plaintext highlighter-rouge">amount</code> ? Le rendre privé</li>
  <li><del>five == 10 n’est pas vraiment super. non mutable</del></li>
  <li>gestion des arrondis</li>
  <li><del>==</del></li>
  <li>== None</li>
  <li>== autre chose qu’un Dollar</li>
</ul>

<h4 id="-6">??</h4>

<p>Tiens si on en profitait pour voir toutes les méthodes spéciales que l’on pourrait utiliser ?</p>

<p>http://www.diveintopython3.net/special-method-names.html#acts-like-number</p>

<p>ou</p>

<p>https://micropyramid.com/blog/python-special-class-methods-or-magic-methods/</p>

<p>Pourquoi on n’utiliserait pas <code class="language-plaintext highlighter-rouge">__mul__</code> ?</p>

<h3 id="4---__mul__">4 - <code class="language-plaintext highlighter-rouge">__mul__</code></h3>

<h4 id="tbd-7">tbd</h4>

<ul>
  <li>$5 + 2.5CHF = $10 si le taux de change est 1:.5</li>
  <li><del>$5 * 2 = $10</del></li>
  <li>utiliser <code class="language-plaintext highlighter-rouge">amount</code> ? Le rendre privé</li>
  <li><del>five == 10 n’est pas vraiment super. non mutable</del></li>
  <li>gestion des arrondis</li>
  <li><del>==</del></li>
  <li>== None</li>
  <li>== autre chose qu’un Dollar</li>
  <li><strong><code class="language-plaintext highlighter-rouge">__mul__</code></strong></li>
</ul>

<h4 id="testspy-4">tests.py</h4>

<p>On va modifier le test de multiplication.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">money</span> <span class="kn">import</span> <span class="n">Dollar</span>

<span class="k">def</span> <span class="nf">test_equality</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">Dollar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">==</span> <span class="n">Dollar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">Dollar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">!=</span> <span class="n">Dollar</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">test_multiplication</span><span class="p">():</span>
    <span class="n">five</span> <span class="o">=</span> <span class="n">Dollar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

    <span class="n">product</span> <span class="o">=</span> <span class="n">five</span> <span class="o">*</span> <span class="mi">2</span>
    <span class="k">assert</span> <span class="mi">10</span> <span class="o">==</span> <span class="n">product</span><span class="p">.</span><span class="n">amount</span>

    <span class="n">product</span> <span class="o">=</span> <span class="n">five</span> <span class="o">*</span> <span class="mi">3</span>
    <span class="k">assert</span> <span class="mi">15</span> <span class="o">==</span> <span class="n">product</span><span class="p">.</span><span class="n">amount</span>
</code></pre></div></div>

<p>Pour python écrire <code class="language-plaintext highlighter-rouge">five * 3</code> est équivalent à <code class="language-plaintext highlighter-rouge">five.__mul__(3)</code>. C’est l’objet de gauche qui est utilisé.</p>

<h4 id="moneypy-5">money.py</h4>

<p>C’est assez simple pour être <strong>obvious implementation</strong> :</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="k">class</span> <span class="nc">Dollar</span><span class="p">:</span>
     <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
         <span class="bp">self</span><span class="p">.</span><span class="n">amount</span> <span class="o">=</span> <span class="n">amount</span>

     <span class="k">def</span> <span class="nf">__mul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">multiplier</span><span class="p">):</span>
         <span class="k">return</span> <span class="n">Dollar</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">amount</span> <span class="o">*</span> <span class="n">multiplier</span><span class="p">)</span>
        
     <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
         <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">amount</span> <span class="o">==</span> <span class="n">other</span><span class="p">.</span><span class="n">amount</span>
</code></pre></div></div>

<h4 id="tbd-8">tbd</h4>

<ul>
  <li>$5 + 2.5CHF = $10 si le taux de change est 1:.5</li>
  <li><del>$5 * 2 = $10</del></li>
  <li>utiliser <code class="language-plaintext highlighter-rouge">amount</code> ? Le rendre privé</li>
  <li><del>five == 10 n’est pas vraiment super. non mutable</del></li>
  <li>gestion des arrondis</li>
  <li><del>==</del></li>
  <li>== None</li>
  <li>== autre chose qu’un Dollar</li>
  <li><del><code class="language-plaintext highlighter-rouge">__mul__</code></del></li>
</ul>

<h3 id="5---privacy">5 - privacy</h3>

<h4 id="tbd-9">tbd</h4>

<ul>
  <li>$5 + 2.5CHF = $10 si le taux de change est 1:.5</li>
  <li><del>$5 * 2 = $10</del></li>
  <li><strong>utiliser <code class="language-plaintext highlighter-rouge">amount</code> ? Le rendre privé</strong></li>
  <li><del>five == 10 n’est pas vraiment super. non mutable</del></li>
  <li>gestion des arrondis</li>
  <li><del>==</del></li>
  <li>== None</li>
  <li>== autre chose qu’un Dollar</li>
  <li><del><code class="language-plaintext highlighter-rouge">__mul__</code></del></li>
</ul>

<p>Il ne manque pas grand chose pour que amount soit privé. Il suffit de ne pas en parler dans les tests. On peut le faire car dans la multiplication, on veut que <code class="language-plaintext highlighter-rouge">five * 2</code> soit égal à 10 dollars par exemple. Faisons le :</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">money</span> <span class="kn">import</span> <span class="n">Dollar</span>

<span class="k">def</span> <span class="nf">test_equality</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">Dollar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">==</span> <span class="n">Dollar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">Dollar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">!=</span> <span class="n">Dollar</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">test_multiplication</span><span class="p">():</span>
    <span class="n">five</span> <span class="o">=</span> <span class="n">Dollar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

    <span class="n">product</span> <span class="o">=</span> <span class="n">five</span> <span class="o">*</span> <span class="mi">2</span>
    <span class="k">assert</span> <span class="n">Dollar</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">==</span> <span class="n">product</span>

    <span class="n">product</span> <span class="o">=</span> <span class="n">five</span> <span class="o">*</span> <span class="mi">3</span>
    <span class="k">assert</span> <span class="n">Dollar</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span> <span class="o">==</span> <span class="n">product</span>
</code></pre></div></div>

<p>On peut même encore faire plus joli :</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">money</span> <span class="kn">import</span> <span class="n">Dollar</span>

<span class="k">def</span> <span class="nf">test_equality</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">Dollar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">==</span> <span class="n">Dollar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">Dollar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">!=</span> <span class="n">Dollar</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">test_multiplication</span><span class="p">():</span>
    <span class="n">five</span> <span class="o">=</span> <span class="n">Dollar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">Dollar</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">==</span> <span class="n">five</span> <span class="o">*</span> <span class="mi">2</span>
    <span class="k">assert</span> <span class="n">Dollar</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span> <span class="o">==</span> <span class="n">five</span> <span class="o">*</span> <span class="mi">3</span>
</code></pre></div></div>

<p>Notez que l’on a utilisé une fonctionnalité que l’on vient de créer pour améliorer un test. C’est normal les tests et le code forment une seule entité.</p>

<p>Maintenant si 2 tests plantent en même temps (si le <code class="language-plaintext highlighter-rouge">==</code> commence à rater par exemple), il faudra se rappeler quel est le test qui plante et les tests qui ne fonctionnent plus.</p>

<h4 id="tbd-10">tbd</h4>

<ul>
  <li>$5 + 2.5CHF = $10 si le taux de change est 1:.5</li>
  <li><del>$5 * 2 = $10</del></li>
  <li><del>utiliser <code class="language-plaintext highlighter-rouge">amount</code> ? Le rendre privé</del></li>
  <li><del>five == 10 n’est pas vraiment super. non mutable</del></li>
  <li>gestion des arrondis</li>
  <li><del>==</del></li>
  <li>== None</li>
  <li>== autre chose qu’un Dollar</li>
  <li><del><code class="language-plaintext highlighter-rouge">__mul__</code></del></li>
</ul>

<h3 id="6----les-francs">6 -  les Francs</h3>

<p>Le seul item dans la todolist qui ne soit pas de l’optimisation est <em>5 + 2.5CHF = $10 si le taux de change est 1:.5</em>. Cela semble bien trop ambitieux pour une seule étape. On va la découper, en commençant par introduire les CHF :</p>

<h4 id="tbd-11">tbd</h4>

<ul>
  <li>$5 + 2.5CHF = $10 si le taux de change est 1:.5</li>
  <li><del>$5 * 2 = $10</del></li>
  <li><del>utiliser <code class="language-plaintext highlighter-rouge">amount</code> ? Le rendre privé</del></li>
  <li><del>five == 10 n’est pas vraiment super. non mutable</del></li>
  <li>gestion des arrondis</li>
  <li><del>==</del></li>
  <li>== None</li>
  <li>== autre chose qu’un Dollar</li>
  <li><del><code class="language-plaintext highlighter-rouge">__mul__</code></del></li>
  <li><strong>5 CHF * 2 = 10CHF</strong></li>
</ul>

<h4 id="testspy-5">tests.py</h4>

<p>On va dupliquer le test des dollars pour les Francs :</p>

<ul>
  <li>heureusement qu’on a un peu modifier les tests avant, non ?</li>
  <li>on a le droit de commettre les pires péchés pour faire marcher le projet (that works), ensuite on fait les choses bien (clean code)</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">money</span> <span class="kn">import</span> <span class="n">Dollar</span><span class="p">,</span> <span class="n">Franc</span>

<span class="k">def</span> <span class="nf">test_equality</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">Dollar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">==</span> <span class="n">Dollar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">Dollar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">!=</span> <span class="n">Dollar</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">test_dollar_multiplication</span><span class="p">():</span>
    <span class="n">five</span> <span class="o">=</span> <span class="n">Dollar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">Dollar</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">==</span> <span class="n">five</span> <span class="o">*</span> <span class="mi">2</span>
    <span class="k">assert</span> <span class="n">Dollar</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span> <span class="o">==</span> <span class="n">five</span> <span class="o">*</span> <span class="mi">3</span>
    
<span class="k">def</span> <span class="nf">test_franc_multiplication</span><span class="p">():</span>
    <span class="n">five</span> <span class="o">=</span> <span class="n">Franc</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">Franc</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">==</span> <span class="n">five</span> <span class="o">*</span> <span class="mi">2</span>
    <span class="k">assert</span> <span class="n">Franc</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span> <span class="o">==</span> <span class="n">five</span> <span class="o">*</span> <span class="mi">3</span>
</code></pre></div></div>

<h4 id="moneypy-6">money.py</h4>

<p>Idem que pour les tests, on copie/colle :</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Franc</span><span class="p">:</span>
     <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
         <span class="bp">self</span><span class="p">.</span><span class="n">amount</span> <span class="o">=</span> <span class="n">amount</span>

     <span class="k">def</span> <span class="nf">__mul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">multiplier</span><span class="p">):</span>
         <span class="k">return</span> <span class="n">Franc</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">amount</span> <span class="o">*</span> <span class="n">multiplier</span><span class="p">)</span>
        
     <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
         <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">amount</span> <span class="o">==</span> <span class="n">other</span><span class="p">.</span><span class="n">amount</span>
 
 
 <span class="k">class</span> <span class="nc">Dollar</span><span class="p">:</span>
     <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
         <span class="bp">self</span><span class="p">.</span><span class="n">amount</span> <span class="o">=</span> <span class="n">amount</span>

     <span class="k">def</span> <span class="nf">__mul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">multiplier</span><span class="p">):</span>
         <span class="k">return</span> <span class="n">Dollar</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">amount</span> <span class="o">*</span> <span class="n">multiplier</span><span class="p">)</span>
        
     <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
         <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">amount</span> <span class="o">==</span> <span class="n">other</span><span class="p">.</span><span class="n">amount</span>
</code></pre></div></div>

<h4 id="tbd-12">tbd</h4>

<p>tous les péchés doivent être expiés, on rajoute donc ce qu’il faut corriger dans la todo list.</p>

<ul>
  <li>$5 + 2.5CHF = $10 si le taux de change est 1:.5</li>
  <li><del>$5 * 2 = $10</del></li>
  <li><del>utiliser <code class="language-plaintext highlighter-rouge">amount</code> ? Le rendre privé</del></li>
  <li><del>five == 10 n’est pas vraiment super. non mutable</del></li>
  <li>gestion des arrondis</li>
  <li><del><code class="language-plaintext highlighter-rouge">==</code></del></li>
  <li><code class="language-plaintext highlighter-rouge">== None</code></li>
  <li><code class="language-plaintext highlighter-rouge">==</code> autre chose qu’un Dollar</li>
  <li><del><code class="language-plaintext highlighter-rouge">__mul__</code></del></li>
  <li><del>5 CHF * 2 = 10CHF</del></li>
  <li>duplication Franc/dollar</li>
  <li>même <code class="language-plaintext highlighter-rouge">==</code></li>
  <li><code class="language-plaintext highlighter-rouge">*</code> presque identique.</li>
</ul>

<h3 id="7---même---pour-tous">7 - même <code class="language-plaintext highlighter-rouge">==</code>  pour tous</h3>

<h4 id="tbd-13">tbd</h4>

<ul>
  <li>$5 + 2.5CHF = $10 si le taux de change est 1:.5</li>
  <li><del>$5 * 2 = $10</del></li>
  <li><del>utiliser <code class="language-plaintext highlighter-rouge">amount</code> ? Le rendre privé</del></li>
  <li><del>five == 10 n’est pas vraiment super. non mutable</del></li>
  <li>gestion des arrondis</li>
  <li><del><code class="language-plaintext highlighter-rouge">==</code></del></li>
  <li><code class="language-plaintext highlighter-rouge">== None</code></li>
  <li><code class="language-plaintext highlighter-rouge">==</code> autre chose qu’un Dollar</li>
  <li><del><code class="language-plaintext highlighter-rouge">__mul__</code></del></li>
  <li><del>5 CHF * 2 = 10CHF</del></li>
  <li>duplication Franc/dollar</li>
  <li><strong>même <code class="language-plaintext highlighter-rouge">==</code></strong></li>
  <li><code class="language-plaintext highlighter-rouge">*</code> presque identique.</li>
</ul>

<h4 id="-7">??</h4>

<p>Pour avoir le même égal on va essayer d’avoir une unique classe qui la contienne. On pourrait faire hériter une monnaie réelle de l’autre mais c’est pas super. Autant faire une classe abstraite qui les englobe tous les 2.</p>

<h4 id="moneypy-7">money.py</h4>

<p>On va faire pas à pas la modification d’ajout d’une classe mère aux deux classes et entre chaque étape on vérifie que les tests passent toujours.</p>

<ol>
  <li>ajout de la classe Money qui ne fait rien</li>
  <li>ajout de money comme classe mère de <code class="language-plaintext highlighter-rouge">Franc</code> et <code class="language-plaintext highlighter-rouge">Dollar</code></li>
</ol>

<p>Maintenant on va faire monter les méthodes identiques des classes filles à la classe mère.</p>

<ol>
  <li><code class="language-plaintext highlighter-rouge">__init__</code> est identique : on le remonte</li>
  <li><code class="language-plaintext highlighter-rouge">__eq__</code> est identique : on ne peut cependant pas le remonter car on ne teste pas l’égalité des Francs entres eux.</li>
  <li>on rajoute le test des Francs entres eux et on en profite pour rajouter un todo sur la comparaison entre Franc et Dollar. On ne le fait pas tout de suite car on a pas fini notre item. ON ne fait qu’une chose à la fois sinon plus rien ne fonctionne. On se rappelle qu’on ne <strong>code que sur du vert</strong>.</li>
  <li>on copie colle les tests du dollar</li>
</ol>

<h4 id="testspy-6">tests.py</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">money</span> <span class="kn">import</span> <span class="n">Dollar</span><span class="p">,</span> <span class="n">Franc</span>


<span class="k">def</span> <span class="nf">test_equality</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">Dollar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">==</span> <span class="n">Dollar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">Dollar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">!=</span> <span class="n">Dollar</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
    
    <span class="k">assert</span> <span class="n">Franc</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">==</span> <span class="n">Franc</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">Franc</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">!=</span> <span class="n">Franc</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">test_dollar_multiplication</span><span class="p">():</span>
    <span class="n">five</span> <span class="o">=</span> <span class="n">Dollar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">Dollar</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">==</span> <span class="n">five</span> <span class="o">*</span> <span class="mi">2</span>
    <span class="k">assert</span> <span class="n">Dollar</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span> <span class="o">==</span> <span class="n">five</span> <span class="o">*</span> <span class="mi">3</span>
    
<span class="k">def</span> <span class="nf">test_franc_multiplication</span><span class="p">():</span>
    <span class="n">five</span> <span class="o">=</span> <span class="n">Franc</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">Franc</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">==</span> <span class="n">five</span> <span class="o">*</span> <span class="mi">2</span>
    <span class="k">assert</span> <span class="n">Franc</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span> <span class="o">==</span> <span class="n">five</span> <span class="o">*</span> <span class="mi">3</span>
</code></pre></div></div>

<h4 id="moneypy-8">money.py</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Money</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">amount</span> <span class="o">=</span> <span class="n">amount</span>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">amount</span> <span class="o">==</span> <span class="n">other</span><span class="p">.</span><span class="n">amount</span>


<span class="k">class</span> <span class="nc">Franc</span><span class="p">(</span><span class="n">Money</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__mul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">multiplier</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Franc</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">amount</span> <span class="o">*</span> <span class="n">multiplier</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Dollar</span><span class="p">(</span><span class="n">Money</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__mul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">multiplier</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Dollar</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">amount</span> <span class="o">*</span> <span class="n">multiplier</span><span class="p">)</span>
</code></pre></div></div>

<h4 id="tbd-14">tbd</h4>

<ul>
  <li>$5 + 2.5CHF = $10 si le taux de change est 1:.5</li>
  <li><del>$5 * 2 = $10</del></li>
  <li><del>utiliser <code class="language-plaintext highlighter-rouge">amount</code> ? Le rendre privé</del></li>
  <li><del>five == 10 n’est pas vraiment super. non mutable</del></li>
  <li>gestion des arrondis</li>
  <li><del>==</del></li>
  <li>== None</li>
  <li>== autre chose qu’un Dollar</li>
  <li><del><code class="language-plaintext highlighter-rouge">__mul__</code></del></li>
  <li><del>5 CHF * 2 = 10CHF</del></li>
  <li>duplication Franc/dollar</li>
  <li><del>même ==</del></li>
  <li><code class="language-plaintext highlighter-rouge">*</code> presque identique.</li>
  <li>compare Franc et Dollar</li>
</ul>

<h3 id="8----franc-et-dollar">8 -  Franc et Dollar</h3>

<h4 id="tbd-15">tbd</h4>

<ul>
  <li>$5 + 2.5CHF = $10 si le taux de change est 1:.5</li>
  <li><del>$5 * 2 = $10</del></li>
  <li><del>utiliser <code class="language-plaintext highlighter-rouge">amount</code> ? Le rendre privé</del></li>
  <li><del>five == 10 n’est pas vraiment super. non mutable</del></li>
  <li>gestion des arrondis</li>
  <li><del>==</del></li>
  <li>== None</li>
  <li>== autre chose qu’un Dollar</li>
  <li><del><code class="language-plaintext highlighter-rouge">__mul__</code></del></li>
  <li><del>5 CHF * 2 = 10CHF</del></li>
  <li>duplication Franc/dollar</li>
  <li><del>même ==</del></li>
  <li><code class="language-plaintext highlighter-rouge">*</code> presque identique.</li>
  <li><strong>compare Franc et Dollar</strong></li>
</ul>

<h4 id="testspy-7">tests.py</h4>

<p>Allons-y pour un petit test en plus</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">money</span> <span class="kn">import</span> <span class="n">Dollar</span><span class="p">,</span> <span class="n">Franc</span>

<span class="k">def</span> <span class="nf">test_equality</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">Dollar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">==</span> <span class="n">Dollar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">Dollar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">!=</span> <span class="n">Dollar</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
    
    <span class="k">assert</span> <span class="n">Franc</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">==</span> <span class="n">Franc</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">Franc</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">!=</span> <span class="n">Franc</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">Franc</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">!=</span> <span class="n">Dollar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">test_dollar_multiplication</span><span class="p">():</span>
    <span class="n">five</span> <span class="o">=</span> <span class="n">Dollar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">Dollar</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">==</span> <span class="n">five</span> <span class="o">*</span> <span class="mi">2</span>
    <span class="k">assert</span> <span class="n">Dollar</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span> <span class="o">==</span> <span class="n">five</span> <span class="o">*</span> <span class="mi">3</span>
    
<span class="k">def</span> <span class="nf">test_franc_multiplication</span><span class="p">():</span>
    <span class="n">five</span> <span class="o">=</span> <span class="n">Franc</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">Franc</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">==</span> <span class="n">five</span> <span class="o">*</span> <span class="mi">2</span>
    <span class="k">assert</span> <span class="n">Franc</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span> <span class="o">==</span> <span class="n">five</span> <span class="o">*</span> <span class="mi">3</span>
</code></pre></div></div>

<h4 id="moneypy-9">money.py</h4>

<p>Une façon simple de corriger cela est de rajouter le fait que les 2 objets à comparer soient de la même classe : la classe d’un objet est l’attribut spécial <code class="language-plaintext highlighter-rouge">__class__</code> présent dans chaque objet.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Money</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">amount</span> <span class="o">=</span> <span class="n">amount</span>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">__class__</span> <span class="o">==</span> <span class="n">other</span><span class="p">.</span><span class="n">__class__</span> <span class="ow">and</span> <span class="bp">self</span><span class="p">.</span><span class="n">amount</span> <span class="o">==</span> <span class="n">other</span><span class="p">.</span><span class="n">amount</span>


<span class="k">class</span> <span class="nc">Franc</span><span class="p">(</span><span class="n">Money</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__mul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">multiplier</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Franc</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">amount</span> <span class="o">*</span> <span class="n">multiplier</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Dollar</span><span class="p">(</span><span class="n">Money</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__mul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">multiplier</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Dollar</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">amount</span> <span class="o">*</span> <span class="n">multiplier</span><span class="p">)</span>
</code></pre></div></div>

<p>Attention, ceci n’est pas du tout une bonne façon de coder. Votre <strong>code smell</strong> (qui vient avec le temps) devrait vous avertir. Notre comparateur utilise ce que sont les devise d’un point de vue de python (deux classes différentes) pas d’un point de vue de la finance (devise ?). Ce n’est jamais bon. Ca risque (va) nous sauter à la figure tôt ou tard. On rajoute donc un todo pour montrer que cela nous embête tout de même un peu.</p>

<h4 id="tbd-16">tbd</h4>

<p>tous les péchés doivent être expiés, on rajoute donc ce qu’il faut corriger dans la todo list.</p>

<ul>
  <li>$5 + 2.5CHF = $10 si le taux de change est 1:.5</li>
  <li><del>$5 * 2 = $10</del></li>
  <li><del>utiliser <code class="language-plaintext highlighter-rouge">amount</code> ? Le rendre privé</del></li>
  <li><del>five == 10 n’est pas vraiment super. non mutable</del></li>
  <li>gestion des arrondis</li>
  <li><del>==</del></li>
  <li>== None</li>
  <li>== autre chose qu’un Dollar</li>
  <li><del><code class="language-plaintext highlighter-rouge">__mul__</code></del></li>
  <li><del>5 CHF * 2 = 10CHF</del></li>
  <li>duplication Franc/dollar</li>
  <li><del>même ==</del></li>
  <li><code class="language-plaintext highlighter-rouge">*</code> presque identique.</li>
  <li><del>compare Franc et Dollar</del></li>
  <li>utilisation de devise ?</li>
</ul>

<h3 id="9----duplication-francdollar">9 -  Duplication Franc/Dollar</h3>

<h4 id="tbd-17">tbd</h4>

<ul>
  <li>$5 + 2.5CHF = $10 si le taux de change est 1:.5</li>
  <li><del>$5 * 2 = $10</del></li>
  <li><del>utiliser <code class="language-plaintext highlighter-rouge">amount</code> ? Le rendre privé</del></li>
  <li><del>five == 10 n’est pas vraiment super. non mutable</del></li>
  <li>gestion des arrondis</li>
  <li><del>==</del></li>
  <li>== None</li>
  <li>== autre chose qu’un Dollar</li>
  <li><del><code class="language-plaintext highlighter-rouge">__mul__</code></del></li>
  <li><del>5 CHF * 2 = 10CHF</del></li>
  <li><strong>duplication Franc/dollar</strong></li>
  <li><del>même ==</del></li>
  <li><code class="language-plaintext highlighter-rouge">*</code> presque identique.</li>
  <li><del>compare Franc et Dollar</del></li>
  <li>utilisation de devise ?</li>
</ul>

<h4 id="-8">??</h4>

<p>Les 2 implémentations de <code class="language-plaintext highlighter-rouge">__mul__</code> ont l’air extrêmement semblables. La seule chose qui les sépare est le retour soir d’un Franc soit d’un Dollar. En allant par là, l’existence même des 2 classes est sujette à caution : est-il vraiment utile d’avoir 2 classes juste pour une comparaison ?</p>

<p>Donc pour réunifier les 2 classes en une seule, on va commencer par gommer leurs existences dans les tests. Commençons par supprimer la classe dollar en passant par un factory dans le test <code class="language-plaintext highlighter-rouge">test_dollar_multiplication()</code></p>

<h4 id="testspy-8">tests.py</h4>

<p>Allons-y pour un petit test en plus</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">money</span> <span class="kn">import</span> <span class="n">Dollar</span><span class="p">,</span> <span class="n">Franc</span>
<span class="kn">import</span> <span class="nn">money</span>

<span class="k">def</span> <span class="nf">test_equality</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">Dollar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">==</span> <span class="n">Dollar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">Dollar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">!=</span> <span class="n">Dollar</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
    
    <span class="k">assert</span> <span class="n">Franc</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">==</span> <span class="n">Franc</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">Franc</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">!=</span> <span class="n">Franc</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">Franc</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">!=</span> <span class="n">Dollar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">test_dollar_multiplication</span><span class="p">():</span>
    <span class="n">five</span> <span class="o">=</span> <span class="n">money</span><span class="p">.</span><span class="n">dollar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">Dollar</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">==</span> <span class="n">five</span> <span class="o">*</span> <span class="mi">2</span>
    <span class="k">assert</span> <span class="n">Dollar</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span> <span class="o">==</span> <span class="n">five</span> <span class="o">*</span> <span class="mi">3</span>
    
<span class="k">def</span> <span class="nf">test_franc_multiplication</span><span class="p">():</span>
    <span class="n">five</span> <span class="o">=</span> <span class="n">Franc</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">Franc</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">==</span> <span class="n">five</span> <span class="o">*</span> <span class="mi">2</span>
    <span class="k">assert</span> <span class="n">Franc</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span> <span class="o">==</span> <span class="n">five</span> <span class="o">*</span> <span class="mi">3</span>
</code></pre></div></div>

<h4 id="moneypy-10">money.py</h4>

<p>Un factory de la classe <code class="language-plaintext highlighter-rouge">Dollar</code> dans <code class="language-plaintext highlighter-rouge">money.py</code></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">dollar</span><span class="p">(</span><span class="n">amount</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">Dollar</span><span class="p">(</span><span class="n">amount</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Money</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">amount</span> <span class="o">=</span> <span class="n">amount</span>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">__class__</span> <span class="o">==</span> <span class="n">other</span><span class="p">.</span><span class="n">__class__</span> <span class="ow">and</span> <span class="bp">self</span><span class="p">.</span><span class="n">amount</span> <span class="o">==</span> <span class="n">other</span><span class="p">.</span><span class="n">amount</span>


<span class="k">class</span> <span class="nc">Franc</span><span class="p">(</span><span class="n">Money</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__mul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">multiplier</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Franc</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">amount</span> <span class="o">*</span> <span class="n">multiplier</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Dollar</span><span class="p">(</span><span class="n">Money</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__mul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">multiplier</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Dollar</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">amount</span> <span class="o">*</span> <span class="n">multiplier</span><span class="p">)</span>
</code></pre></div></div>

<p>Les tests passent (en ajoutant l’import des factory) ! Donc on remplace toute référence à <code class="language-plaintext highlighter-rouge">Dollar</code> en <code class="language-plaintext highlighter-rouge">money.dollar</code> dans les tests</p>

<h4 id="testspy-9">tests.py</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">money</span> <span class="kn">import</span> <span class="n">Franc</span>
<span class="kn">import</span> <span class="nn">money</span>


<span class="k">def</span> <span class="nf">test_equality</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">money</span><span class="p">.</span><span class="n">dollar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">==</span> <span class="n">money</span><span class="p">.</span><span class="n">dollar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">money</span><span class="p">.</span><span class="n">dollar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">!=</span> <span class="n">money</span><span class="p">.</span><span class="n">dollar</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">Franc</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">==</span> <span class="n">Franc</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">Franc</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">!=</span> <span class="n">Franc</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">Franc</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">!=</span> <span class="n">money</span><span class="p">.</span><span class="n">dollar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">test_dollar_multiplication</span><span class="p">():</span>
    <span class="n">five</span> <span class="o">=</span> <span class="n">money</span><span class="p">.</span><span class="n">dollar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">money</span><span class="p">.</span><span class="n">dollar</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">==</span> <span class="n">five</span> <span class="o">*</span> <span class="mi">2</span>
    <span class="k">assert</span> <span class="n">money</span><span class="p">.</span><span class="n">dollar</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span> <span class="o">==</span> <span class="n">five</span> <span class="o">*</span> <span class="mi">3</span>


<span class="k">def</span> <span class="nf">test_franc_multiplication</span><span class="p">():</span>
    <span class="n">five</span> <span class="o">=</span> <span class="n">Franc</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">Franc</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">==</span> <span class="n">five</span> <span class="o">*</span> <span class="mi">2</span>
    <span class="k">assert</span> <span class="n">Franc</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span> <span class="o">==</span> <span class="n">five</span> <span class="o">*</span> <span class="mi">3</span>
</code></pre></div></div>

<p>Avant de faire la même chose pour les Francs, posons nous la question de l’utilité de garder ces tests. Ont-ils une utilité dans le code ? Pas sûr puisque on ne fait plus qu’une seule classe, mais dons le doute on les conserve, mais on l’ajoute à la todo list.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">money</span>


<span class="k">def</span> <span class="nf">test_equality</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">money</span><span class="p">.</span><span class="n">dollar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">==</span> <span class="n">money</span><span class="p">.</span><span class="n">dollar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">money</span><span class="p">.</span><span class="n">dollar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">!=</span> <span class="n">money</span><span class="p">.</span><span class="n">dollar</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">money</span><span class="p">.</span><span class="n">franc</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">==</span> <span class="n">money</span><span class="p">.</span><span class="n">franc</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">money</span><span class="p">.</span><span class="n">franc</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">!=</span> <span class="n">money</span><span class="p">.</span><span class="n">franc</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">money</span><span class="p">.</span><span class="n">franc</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">!=</span> <span class="n">money</span><span class="p">.</span><span class="n">dollar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">test_dollar_multiplication</span><span class="p">():</span>
    <span class="n">five</span> <span class="o">=</span> <span class="n">money</span><span class="p">.</span><span class="n">dollar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">money</span><span class="p">.</span><span class="n">dollar</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">==</span> <span class="n">five</span> <span class="o">*</span> <span class="mi">2</span>
    <span class="k">assert</span> <span class="n">money</span><span class="p">.</span><span class="n">dollar</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span> <span class="o">==</span> <span class="n">five</span> <span class="o">*</span> <span class="mi">3</span>


<span class="k">def</span> <span class="nf">test_franc_multiplication</span><span class="p">():</span>
    <span class="n">five</span> <span class="o">=</span> <span class="n">money</span><span class="p">.</span><span class="n">franc</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">money</span><span class="p">.</span><span class="n">franc</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">==</span> <span class="n">five</span> <span class="o">*</span> <span class="mi">2</span>
    <span class="k">assert</span> <span class="n">money</span><span class="p">.</span><span class="n">franc</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span> <span class="o">==</span> <span class="n">five</span> <span class="o">*</span> <span class="mi">3</span>
</code></pre></div></div>

<p>On est maintenant dans une meilleure position qu’au début. Le code utilisateur n’étant pas au courant qu’il existe 2 classes différentes. On va pouvoir passer à la suite du programme les supprimer également dans le code.</p>

<h4 id="tbd-18">tbd</h4>

<ul>
  <li>$5 + 2.5CHF = $10 si le taux de change est 1:.5</li>
  <li><del>$5 * 2 = $10</del></li>
  <li><del>utiliser <code class="language-plaintext highlighter-rouge">amount</code> ? Le rendre privé</del></li>
  <li><del>five == 10 n’est pas vraiment super. non mutable</del></li>
  <li>gestion des arrondis</li>
  <li><del>==</del></li>
  <li>== None</li>
  <li>== autre chose qu’un Dollar</li>
  <li><del><code class="language-plaintext highlighter-rouge">__mul__</code></del></li>
  <li><del>5 CHF * 2 = 10CHF</del></li>
  <li><strong>duplication Franc/dollar</strong></li>
  <li><del>même ==</del></li>
  <li><code class="language-plaintext highlighter-rouge">*</code> presque identique.</li>
  <li>compare Franc et Dollar</li>
  <li>utilisation de devise ?</li>
  <li>supprimer <code class="language-plaintext highlighter-rouge">test_franc_multiplication</code> ?</li>
</ul>

<h4 id="moneypy-11">money.py</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">dollar</span><span class="p">(</span><span class="n">amount</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">Dollar</span><span class="p">(</span><span class="n">amount</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">franc</span><span class="p">(</span><span class="n">amount</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">Franc</span><span class="p">(</span><span class="n">amount</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Money</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">amount</span> <span class="o">=</span> <span class="n">amount</span>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">__class__</span> <span class="o">==</span> <span class="n">other</span><span class="p">.</span><span class="n">__class__</span> <span class="ow">and</span> <span class="bp">self</span><span class="p">.</span><span class="n">amount</span> <span class="o">==</span> <span class="n">other</span><span class="p">.</span><span class="n">amount</span>


<span class="k">class</span> <span class="nc">Franc</span><span class="p">(</span><span class="n">Money</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__mul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">multiplier</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Franc</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">amount</span> <span class="o">*</span> <span class="n">multiplier</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Dollar</span><span class="p">(</span><span class="n">Money</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__mul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">multiplier</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Dollar</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">amount</span> <span class="o">*</span> <span class="n">multiplier</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="10---devises">10 - devises</h3>

<p>Pour pouvoir supprimer les 2 sous classes, il va nous falloir un moyen de distinguer les Francs des Dollars. Donc autant travailler sur l’ajout d’une devise.</p>

<h4 id="tbd-19">tbd</h4>

<ul>
  <li>$5 + 2.5CHF = $10 si le taux de change est 1:.5</li>
  <li><del>$5 * 2 = $10</del></li>
  <li><del>utiliser <code class="language-plaintext highlighter-rouge">amount</code> ? Le rendre privé</del></li>
  <li><del>five == 10 n’est pas vraiment super. non mutable</del></li>
  <li>gestion des arrondis</li>
  <li><del>==</del></li>
  <li>== None</li>
  <li>== autre chose qu’un Dollar</li>
  <li><del><code class="language-plaintext highlighter-rouge">__mul__</code></del></li>
  <li><del>5 CHF * 2 = 10CHF</del></li>
  <li>duplication Franc/dollar</li>
  <li><del>même ==</del></li>
  <li>
    <ul>
      <li>presque identique.</li>
    </ul>
  </li>
  <li>compare Franc et Dollar</li>
  <li><strong>utilisation de devise ?</strong></li>
  <li>supprimer <code class="language-plaintext highlighter-rouge">test_franc_multiplication</code> ?</li>
</ul>

<h4 id="testspy-10">tests.py</h4>

<p>On ajoute un test pour vérifier que les dollars et les francs ont des devises différentes.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">money</span>


<span class="k">def</span> <span class="nf">test_currencies</span><span class="p">():</span>
    <span class="k">assert</span> <span class="s">"USD"</span> <span class="o">==</span> <span class="n">money</span><span class="p">.</span><span class="n">dollar</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">currencies</span><span class="p">()</span>
    <span class="k">assert</span> <span class="s">"CHF"</span> <span class="o">==</span> <span class="n">money</span><span class="p">.</span><span class="n">franc</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">currencies</span><span class="p">()</span>
    
    
<span class="k">def</span> <span class="nf">test_equality</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">money</span><span class="p">.</span><span class="n">dollar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">==</span> <span class="n">money</span><span class="p">.</span><span class="n">dollar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">money</span><span class="p">.</span><span class="n">dollar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">!=</span> <span class="n">money</span><span class="p">.</span><span class="n">dollar</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">money</span><span class="p">.</span><span class="n">franc</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">==</span> <span class="n">money</span><span class="p">.</span><span class="n">franc</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">money</span><span class="p">.</span><span class="n">franc</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">!=</span> <span class="n">money</span><span class="p">.</span><span class="n">franc</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">money</span><span class="p">.</span><span class="n">franc</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">!=</span> <span class="n">money</span><span class="p">.</span><span class="n">dollar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">test_dollar_multiplication</span><span class="p">():</span>
    <span class="n">five</span> <span class="o">=</span> <span class="n">money</span><span class="p">.</span><span class="n">dollar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">money</span><span class="p">.</span><span class="n">dollar</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">==</span> <span class="n">five</span> <span class="o">*</span> <span class="mi">2</span>
    <span class="k">assert</span> <span class="n">money</span><span class="p">.</span><span class="n">dollar</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span> <span class="o">==</span> <span class="n">five</span> <span class="o">*</span> <span class="mi">3</span>


<span class="k">def</span> <span class="nf">test_franc_multiplication</span><span class="p">():</span>
    <span class="n">five</span> <span class="o">=</span> <span class="n">money</span><span class="p">.</span><span class="n">franc</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">money</span><span class="p">.</span><span class="n">franc</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">==</span> <span class="n">five</span> <span class="o">*</span> <span class="mi">2</span>
    <span class="k">assert</span> <span class="n">money</span><span class="p">.</span><span class="n">franc</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span> <span class="o">==</span> <span class="n">five</span> <span class="o">*</span> <span class="mi">3</span>
</code></pre></div></div>

<h4 id="moneypy-12">money.py</h4>

<p>une <em>obvious implementation</em> plus tard :</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">dollar</span><span class="p">(</span><span class="n">amount</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">Dollar</span><span class="p">(</span><span class="n">amount</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">franc</span><span class="p">(</span><span class="n">amount</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">Franc</span><span class="p">(</span><span class="n">amount</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Money</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">amount</span> <span class="o">=</span> <span class="n">amount</span>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">__class__</span> <span class="o">==</span> <span class="n">other</span><span class="p">.</span><span class="n">__class__</span> <span class="ow">and</span> <span class="bp">self</span><span class="p">.</span><span class="n">amount</span> <span class="o">==</span> <span class="n">other</span><span class="p">.</span><span class="n">amount</span>


<span class="k">class</span> <span class="nc">Franc</span><span class="p">(</span><span class="n">Money</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__mul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">multiplier</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Franc</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">amount</span> <span class="o">*</span> <span class="n">multiplier</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">currencies</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">"CHF"</span>

<span class="k">class</span> <span class="nc">Dollar</span><span class="p">(</span><span class="n">Money</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__mul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">multiplier</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Dollar</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">amount</span> <span class="o">*</span> <span class="n">multiplier</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">currencies</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">"USD"</span>
</code></pre></div></div>

<p>On peut maintenant travailler à faire monter les currencies au niveau de <code class="language-plaintext highlighter-rouge">Money</code>. Commençons par les faire monter au niveu des classes. On va créer un attribut <code class="language-plaintext highlighter-rouge">currency</code> dans chaque classe et l’utiliser dans les méthodes. Il faut pour cela redescendre les <code class="language-plaintext highlighter-rouge">__init__</code> dans chaque classe.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">dollar</span><span class="p">(</span><span class="n">amount</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">Dollar</span><span class="p">(</span><span class="n">amount</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">franc</span><span class="p">(</span><span class="n">amount</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">Franc</span><span class="p">(</span><span class="n">amount</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Money</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">__class__</span> <span class="o">==</span> <span class="n">other</span><span class="p">.</span><span class="n">__class__</span> <span class="ow">and</span> <span class="bp">self</span><span class="p">.</span><span class="n">amount</span> <span class="o">==</span> <span class="n">other</span><span class="p">.</span><span class="n">amount</span>


<span class="k">class</span> <span class="nc">Franc</span><span class="p">(</span><span class="n">Money</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">amount</span> <span class="o">=</span> <span class="n">amount</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">currency</span> <span class="o">=</span> <span class="s">"CHF"</span>

    <span class="k">def</span> <span class="nf">currencies</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">currency</span>

    <span class="k">def</span> <span class="nf">__mul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">multiplier</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Franc</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">amount</span> <span class="o">*</span> <span class="n">multiplier</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Dollar</span><span class="p">(</span><span class="n">Money</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">amount</span> <span class="o">=</span> <span class="n">amount</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">currency</span> <span class="o">=</span> <span class="s">"USD"</span>

    <span class="k">def</span> <span class="nf">currencies</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">currency</span>

    <span class="k">def</span> <span class="nf">__mul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">multiplier</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Dollar</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">amount</span> <span class="o">*</span> <span class="n">multiplier</span><span class="p">)</span>
</code></pre></div></div>

<p>Afin de faire remonter l’attribut <code class="language-plaintext highlighter-rouge">currency</code> dans la classe Money, on va commencer par dire que currency est un paramètre des <code class="language-plaintext highlighter-rouge">__init__</code>. Comme toute devise est créé avec le factory, ça devrait passer et nous permettre ensuite de ne faire plus qu’une seule classe puisque seuls les paramètres des méthodes vont différer.</p>

<p>En ajoutant le paramètre les tests plantent ! C’est parce que l’on a oublié d’ajouter un paramètre aux factory :</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">franc</span><span class="p">(</span><span class="n">amount</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">Franc</span><span class="p">(</span><span class="n">amount</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
</code></pre></div></div>

<p>Les tests plantent encore… C’est parce que <code class="language-plaintext highlighter-rouge">__mul__</code> n’utilise pas le factory :</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Franc</span><span class="p">(</span><span class="n">Money</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">currency</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">amount</span> <span class="o">=</span> <span class="n">amount</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">currency</span> <span class="o">=</span> <span class="s">"CHF"</span>

    <span class="k">def</span> <span class="nf">currencies</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">currency</span>

    <span class="k">def</span> <span class="nf">__mul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">multiplier</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">franc</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">amount</span> <span class="o">*</span> <span class="n">multiplier</span><span class="p">)</span>
</code></pre></div></div>

<p>Ouf, les tests passent. On peut faire pareil pour dollar :</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">dollar</span><span class="p">(</span><span class="n">amount</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">Dollar</span><span class="p">(</span><span class="n">amount</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">franc</span><span class="p">(</span><span class="n">amount</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">Franc</span><span class="p">(</span><span class="n">amount</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Money</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">__class__</span> <span class="o">==</span> <span class="n">other</span><span class="p">.</span><span class="n">__class__</span> <span class="ow">and</span> <span class="bp">self</span><span class="p">.</span><span class="n">amount</span> <span class="o">==</span> <span class="n">other</span><span class="p">.</span><span class="n">amount</span>


<span class="k">class</span> <span class="nc">Franc</span><span class="p">(</span><span class="n">Money</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">currency</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">amount</span> <span class="o">=</span> <span class="n">amount</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">currency</span> <span class="o">=</span> <span class="s">"CHF"</span>

    <span class="k">def</span> <span class="nf">currencies</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">currency</span>

    <span class="k">def</span> <span class="nf">__mul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">multiplier</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">franc</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">amount</span> <span class="o">*</span> <span class="n">multiplier</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Dollar</span><span class="p">(</span><span class="n">Money</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">currency</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">amount</span> <span class="o">=</span> <span class="n">amount</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">currency</span> <span class="o">=</span> <span class="s">"USD"</span>

    <span class="k">def</span> <span class="nf">currencies</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">currency</span>

    <span class="k">def</span> <span class="nf">__mul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">multiplier</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">dollar</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">amount</span> <span class="o">*</span> <span class="n">multiplier</span><span class="p">)</span>
</code></pre></div></div>

<p>Il nous reste plus qu’à utiliser le paramètre <code class="language-plaintext highlighter-rouge">currency</code> des constructeurs dans les factory. Les classes se ressemblent de plus en plus :</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">dollar</span><span class="p">(</span><span class="n">amount</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">Dollar</span><span class="p">(</span><span class="n">amount</span><span class="p">,</span> <span class="s">"USD"</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">franc</span><span class="p">(</span><span class="n">amount</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">Franc</span><span class="p">(</span><span class="n">amount</span><span class="p">,</span> <span class="s">"CHF"</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Money</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">__class__</span> <span class="o">==</span> <span class="n">other</span><span class="p">.</span><span class="n">__class__</span> <span class="ow">and</span> <span class="bp">self</span><span class="p">.</span><span class="n">amount</span> <span class="o">==</span> <span class="n">other</span><span class="p">.</span><span class="n">amount</span>


<span class="k">class</span> <span class="nc">Franc</span><span class="p">(</span><span class="n">Money</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">currency</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">amount</span> <span class="o">=</span> <span class="n">amount</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">currency</span> <span class="o">=</span> <span class="n">currency</span>

    <span class="k">def</span> <span class="nf">currencies</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">currency</span>

    <span class="k">def</span> <span class="nf">__mul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">multiplier</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">franc</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">amount</span> <span class="o">*</span> <span class="n">multiplier</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Dollar</span><span class="p">(</span><span class="n">Money</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">currency</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">amount</span> <span class="o">=</span> <span class="n">amount</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">currency</span> <span class="o">=</span> <span class="n">currency</span>

    <span class="k">def</span> <span class="nf">currencies</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">currency</span>

    <span class="k">def</span> <span class="nf">__mul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">multiplier</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">dollar</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">amount</span> <span class="o">*</span> <span class="n">multiplier</span><span class="p">)</span>
</code></pre></div></div>

<p>Le <code class="language-plaintext highlighter-rouge">__init__</code> est re le même, ainsi que <code class="language-plaintext highlighter-rouge">currencies</code>on peut les bouger dans money (courage on y est presque) :</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">dollar</span><span class="p">(</span><span class="n">amount</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">Dollar</span><span class="p">(</span><span class="n">amount</span><span class="p">,</span> <span class="s">"USD"</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">franc</span><span class="p">(</span><span class="n">amount</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">Franc</span><span class="p">(</span><span class="n">amount</span><span class="p">,</span> <span class="s">"CHF"</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Money</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">currency</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">amount</span> <span class="o">=</span> <span class="n">amount</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">currency</span> <span class="o">=</span> <span class="n">currency</span>

    <span class="k">def</span> <span class="nf">currencies</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">currency</span>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">__class__</span> <span class="o">==</span> <span class="n">other</span><span class="p">.</span><span class="n">__class__</span> <span class="ow">and</span> <span class="bp">self</span><span class="p">.</span><span class="n">amount</span> <span class="o">==</span> <span class="n">other</span><span class="p">.</span><span class="n">amount</span>


<span class="k">class</span> <span class="nc">Franc</span><span class="p">(</span><span class="n">Money</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__mul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">multiplier</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">franc</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">amount</span> <span class="o">*</span> <span class="n">multiplier</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Dollar</span><span class="p">(</span><span class="n">Money</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__mul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">multiplier</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">dollar</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">amount</span> <span class="o">*</span> <span class="n">multiplier</span><span class="p">)</span>
</code></pre></div></div>

<p>Tout est prêt pour maintenant supprimer les sous-classes.</p>

<h4 id="tbd-20">tbd</h4>

<ul>
  <li>$5 + 2.5CHF = $10 si le taux de change est 1:.5</li>
  <li><del>$5 * 2 = $10</del></li>
  <li><del>utiliser <code class="language-plaintext highlighter-rouge">amount</code> ? Le rendre privé</del></li>
  <li><del>five == 10 n’est pas vraiment super. non mutable</del></li>
  <li>gestion des arrondis</li>
  <li><del>==</del></li>
  <li>== None</li>
  <li>== autre chose qu’un Dollar</li>
  <li><del><code class="language-plaintext highlighter-rouge">__mul__</code></del></li>
  <li><del>5 CHF * 2 = 10CHF</del></li>
  <li>duplication Franc/dollar</li>
  <li><del>même ==</del></li>
  <li>
    <ul>
      <li>presque identique.</li>
    </ul>
  </li>
  <li>compare Franc et Dollar</li>
  <li><del>utilisation de devise ?</del></li>
  <li>supprimer <code class="language-plaintext highlighter-rouge">test_franc_multiplication</code> ?</li>
</ul>

<p>Ici, utiliser une tâche annexe (les devises) nous a permis d’avancer vers notre but : supprimer les sous classes.</p>

<h3 id="11----unification-de-">11 -  unification de <code class="language-plaintext highlighter-rouge">*</code></h3>

<p>Tout est prêt pour unifier les <code class="language-plaintext highlighter-rouge">__mul__</code> et ainsi faire disparaitre les dernières différences entre les 2 classes.</p>

<h4 id="tbd-21">tbd</h4>

<ul>
  <li>$5 + 2.5CHF = $10 si le taux de change est 1:.5</li>
  <li><del>$5 * 2 = $10</del></li>
  <li><del>utiliser <code class="language-plaintext highlighter-rouge">amount</code> ? Le rendre privé</del></li>
  <li><del>five == 10 n’est pas vraiment super. non mutable</del></li>
  <li>gestion des arrondis</li>
  <li><del>==</del></li>
  <li>== None</li>
  <li>== autre chose qu’un Dollar</li>
  <li><del><code class="language-plaintext highlighter-rouge">__mul__</code></del></li>
  <li><del>5 CHF * 2 = 10CHF</del></li>
  <li>duplication Franc/dollar</li>
  <li><del>même ==</del></li>
  <li><strong><code class="language-plaintext highlighter-rouge">*</code> presque identique.</strong></li>
  <li>compare Franc et Dollar</li>
  <li><del>utilisation de devise ?</del></li>
  <li>supprimer <code class="language-plaintext highlighter-rouge">test_franc_multiplication</code> ?</li>
</ul>

<h4 id="moneypy-13">money.py</h4>

<p>Les deux <code class="language-plaintext highlighter-rouge">__mul__</code> ne changent que par la classe produite. Donc commençons par expliciter la construction en remplaçant le factory par l’utilisation explicite des constructeurs :</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">dollar</span><span class="p">(</span><span class="n">amount</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">Dollar</span><span class="p">(</span><span class="n">amount</span><span class="p">,</span> <span class="s">"USD"</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">franc</span><span class="p">(</span><span class="n">amount</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">Franc</span><span class="p">(</span><span class="n">amount</span><span class="p">,</span> <span class="s">"CHF"</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Money</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">currency</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">amount</span> <span class="o">=</span> <span class="n">amount</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">currency</span> <span class="o">=</span> <span class="n">currency</span>

    <span class="k">def</span> <span class="nf">currencies</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">currency</span>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">__class__</span> <span class="o">==</span> <span class="n">other</span><span class="p">.</span><span class="n">__class__</span> <span class="ow">and</span> <span class="bp">self</span><span class="p">.</span><span class="n">amount</span> <span class="o">==</span> <span class="n">other</span><span class="p">.</span><span class="n">amount</span>


<span class="k">class</span> <span class="nc">Franc</span><span class="p">(</span><span class="n">Money</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__mul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">multiplier</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Franc</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">amount</span> <span class="o">*</span> <span class="n">multiplier</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">currency</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Dollar</span><span class="p">(</span><span class="n">Money</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__mul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">multiplier</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Dollar</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">amount</span> <span class="o">*</span> <span class="n">multiplier</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">currency</span><span class="p">)</span>
</code></pre></div></div>

<p>On peut maintenant ajouter une méthode <code class="language-plaintext highlighter-rouge">__mul__</code> das la classe money :</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">dollar</span><span class="p">(</span><span class="n">amount</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">Dollar</span><span class="p">(</span><span class="n">amount</span><span class="p">,</span> <span class="s">"USD"</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">franc</span><span class="p">(</span><span class="n">amount</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">Franc</span><span class="p">(</span><span class="n">amount</span><span class="p">,</span> <span class="s">"CHF"</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Money</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">currency</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">amount</span> <span class="o">=</span> <span class="n">amount</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">currency</span> <span class="o">=</span> <span class="n">currency</span>

    <span class="k">def</span> <span class="nf">currencies</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">currency</span>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">__class__</span> <span class="o">==</span> <span class="n">other</span><span class="p">.</span><span class="n">__class__</span> <span class="ow">and</span> <span class="bp">self</span><span class="p">.</span><span class="n">amount</span> <span class="o">==</span> <span class="n">other</span><span class="p">.</span><span class="n">amount</span>

    <span class="k">def</span> <span class="nf">__mul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">multiplier</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Money</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">amount</span> <span class="o">*</span> <span class="n">multiplier</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">currency</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Franc</span><span class="p">(</span><span class="n">Money</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__mul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">multiplier</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Franc</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">amount</span> <span class="o">*</span> <span class="n">multiplier</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">currency</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Dollar</span><span class="p">(</span><span class="n">Money</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__mul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">multiplier</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Dollar</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">amount</span> <span class="o">*</span> <span class="n">multiplier</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">currency</span><span class="p">)</span>
</code></pre></div></div>

<p>En supprimant la methode <code class="language-plaintext highlighter-rouge">__mul__</code> des Francs, et en rendant un <code class="language-plaintext highlighter-rouge">Money</code> dans le factory <code class="language-plaintext highlighter-rouge">franc</code>, les tests passent.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">dollar</span><span class="p">(</span><span class="n">amount</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">Dollar</span><span class="p">(</span><span class="n">amount</span><span class="p">,</span> <span class="s">"USD"</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">franc</span><span class="p">(</span><span class="n">amount</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">Money</span><span class="p">(</span><span class="n">amount</span><span class="p">,</span> <span class="s">"CHF"</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Money</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">currency</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">amount</span> <span class="o">=</span> <span class="n">amount</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">currency</span> <span class="o">=</span> <span class="n">currency</span>

    <span class="k">def</span> <span class="nf">currencies</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">currency</span>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">__class__</span> <span class="o">==</span> <span class="n">other</span><span class="p">.</span><span class="n">__class__</span> <span class="ow">and</span> <span class="bp">self</span><span class="p">.</span><span class="n">amount</span> <span class="o">==</span> <span class="n">other</span><span class="p">.</span><span class="n">amount</span>

    <span class="k">def</span> <span class="nf">__mul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">multiplier</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Money</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">amount</span> <span class="o">*</span> <span class="n">multiplier</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">currency</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Franc</span><span class="p">(</span><span class="n">Money</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="k">class</span> <span class="nc">Dollar</span><span class="p">(</span><span class="n">Money</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__mul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">multiplier</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Dollar</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">amount</span> <span class="o">*</span> <span class="n">multiplier</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">currency</span><span class="p">)</span>
</code></pre></div></div>

<p>Mais supprimer la méthode <code class="language-plaintext highlighter-rouge">__mul__</code> de <code class="language-plaintext highlighter-rouge">Dollar</code> casse les tests : le test d’égalité est cassé. C’est normal il compare des classes et pas des <code class="language-plaintext highlighter-rouge">currency</code>. On revient donc en arrière jusqu’à ce que les tests passes (on remet la méthode <code class="language-plaintext highlighter-rouge">__mul__</code> à <code class="language-plaintext highlighter-rouge">Dollar</code>) puis on corrige la méthode <code class="language-plaintext highlighter-rouge">__eq__</code> pour qu’elle compare les <code class="language-plaintext highlighter-rouge">currency</code> plutôt que les classes.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">dollar</span><span class="p">(</span><span class="n">amount</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">Dollar</span><span class="p">(</span><span class="n">amount</span><span class="p">,</span> <span class="s">"USD"</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">franc</span><span class="p">(</span><span class="n">amount</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">Money</span><span class="p">(</span><span class="n">amount</span><span class="p">,</span> <span class="s">"CHF"</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Money</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">currency</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">amount</span> <span class="o">=</span> <span class="n">amount</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">currency</span> <span class="o">=</span> <span class="n">currency</span>

    <span class="k">def</span> <span class="nf">currencies</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">currency</span>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">currency</span> <span class="o">==</span> <span class="n">other</span><span class="p">.</span><span class="n">currency</span> <span class="ow">and</span> <span class="bp">self</span><span class="p">.</span><span class="n">amount</span> <span class="o">==</span> <span class="n">other</span><span class="p">.</span><span class="n">amount</span>

    <span class="k">def</span> <span class="nf">__mul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">multiplier</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Money</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">amount</span> <span class="o">*</span> <span class="n">multiplier</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">currency</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Franc</span><span class="p">(</span><span class="n">Money</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">Dollar</span><span class="p">(</span><span class="n">Money</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__mul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">multiplier</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Dollar</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">amount</span> <span class="o">*</span> <span class="n">multiplier</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">currency</span><span class="p">)</span>
</code></pre></div></div>

<p>On peut maintenant supprimer la méthode <code class="language-plaintext highlighter-rouge">__mul__</code> de <code class="language-plaintext highlighter-rouge">Dollar</code> et ainsi supprimer les 2 classes. ON vient de supprimer 2 items en un seul refactoring.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">dollar</span><span class="p">(</span><span class="n">amount</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">Money</span><span class="p">(</span><span class="n">amount</span><span class="p">,</span> <span class="s">"USD"</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">franc</span><span class="p">(</span><span class="n">amount</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">Money</span><span class="p">(</span><span class="n">amount</span><span class="p">,</span> <span class="s">"CHF"</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Money</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">currency</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">amount</span> <span class="o">=</span> <span class="n">amount</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">currency</span> <span class="o">=</span> <span class="n">currency</span>

    <span class="k">def</span> <span class="nf">currencies</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">currency</span>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">currency</span> <span class="o">==</span> <span class="n">other</span><span class="p">.</span><span class="n">currency</span> <span class="ow">and</span> <span class="bp">self</span><span class="p">.</span><span class="n">amount</span> <span class="o">==</span> <span class="n">other</span><span class="p">.</span><span class="n">amount</span>

    <span class="k">def</span> <span class="nf">__mul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">multiplier</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Money</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">amount</span> <span class="o">*</span> <span class="n">multiplier</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">currency</span><span class="p">)</span>
</code></pre></div></div>

<h4 id="tbd-22">tbd</h4>

<ul>
  <li>$5 + 2.5CHF = $10 si le taux de change est 1:.5</li>
  <li><del>$5 * 2 = $10</del></li>
  <li><del>utiliser <code class="language-plaintext highlighter-rouge">amount</code> ? Le rendre privé</del></li>
  <li><del>five == 10 n’est pas vraiment super. non mutable</del></li>
  <li>gestion des arrondis</li>
  <li><del>==</del></li>
  <li>== None</li>
  <li>== autre chose qu’un Dollar</li>
  <li><del><code class="language-plaintext highlighter-rouge">__mul__</code></del></li>
  <li><del>5 CHF * 2 = 10CHF</del></li>
  <li><del>duplication Franc/dollar</del></li>
  <li><del>même ==</del></li>
  <li>~~ * presque identique.~~</li>
  <li>compare Franc et Dollar</li>
  <li><del>utilisation de devise ?</del></li>
  <li>supprimer <code class="language-plaintext highlighter-rouge">test_franc_multiplication</code> ?</li>
</ul>

<p>Maintenant les tests d’égalité et de multiplication des <code class="language-plaintext highlighter-rouge">Franc</code> sont vraiment inutiles puisque le code est le même que celui de dollar :</p>

<h4 id="testspy-11">tests.py</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">money</span>


<span class="k">def</span> <span class="nf">test_currencies</span><span class="p">():</span>
    <span class="k">assert</span> <span class="s">"USD"</span> <span class="o">==</span> <span class="n">money</span><span class="p">.</span><span class="n">dollar</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">currencies</span><span class="p">()</span>
    <span class="k">assert</span> <span class="s">"CHF"</span> <span class="o">==</span> <span class="n">money</span><span class="p">.</span><span class="n">franc</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">currencies</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">test_equality</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">money</span><span class="p">.</span><span class="n">dollar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">==</span> <span class="n">money</span><span class="p">.</span><span class="n">dollar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">money</span><span class="p">.</span><span class="n">dollar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">!=</span> <span class="n">money</span><span class="p">.</span><span class="n">dollar</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">money</span><span class="p">.</span><span class="n">franc</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">!=</span> <span class="n">money</span><span class="p">.</span><span class="n">dollar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">test_multiplication</span><span class="p">():</span>
    <span class="n">five</span> <span class="o">=</span> <span class="n">money</span><span class="p">.</span><span class="n">dollar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">money</span><span class="p">.</span><span class="n">dollar</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">==</span> <span class="n">five</span> <span class="o">*</span> <span class="mi">2</span>
    <span class="k">assert</span> <span class="n">money</span><span class="p">.</span><span class="n">dollar</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span> <span class="o">==</span> <span class="n">five</span> <span class="o">*</span> <span class="mi">3</span>
</code></pre></div></div>

<h4 id="moneypy-14">money.py</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">dollar</span><span class="p">(</span><span class="n">amount</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">Money</span><span class="p">(</span><span class="n">amount</span><span class="p">,</span> <span class="s">"USD"</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">franc</span><span class="p">(</span><span class="n">amount</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">Money</span><span class="p">(</span><span class="n">amount</span><span class="p">,</span> <span class="s">"CHF"</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Money</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">currency</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">amount</span> <span class="o">=</span> <span class="n">amount</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">currency</span> <span class="o">=</span> <span class="n">currency</span>

    <span class="k">def</span> <span class="nf">currencies</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">currency</span>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">currency</span> <span class="o">==</span> <span class="n">other</span><span class="p">.</span><span class="n">currency</span> <span class="ow">and</span> <span class="bp">self</span><span class="p">.</span><span class="n">amount</span> <span class="o">==</span> <span class="n">other</span><span class="p">.</span><span class="n">amount</span>

    <span class="k">def</span> <span class="nf">__mul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">multiplier</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Money</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">amount</span> <span class="o">*</span> <span class="n">multiplier</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">currency</span><span class="p">)</span>
</code></pre></div></div>

<h4 id="tbd-23">tbd</h4>

<ul>
  <li>$5 + 2.5CHF = $10 si le taux de change est 1:.5</li>
  <li><del>$5 * 2 = $10</del></li>
  <li><del>utiliser <code class="language-plaintext highlighter-rouge">amount</code> ? Le rendre privé</del></li>
  <li><del>five == 10 n’est pas vraiment super. non mutable</del></li>
  <li>gestion des arrondis</li>
  <li><del>==</del></li>
  <li>== None</li>
  <li>== autre chose qu’un Dollar</li>
  <li><del><code class="language-plaintext highlighter-rouge">__mul__</code></del></li>
  <li><del>5 CHF * 2 = 10CHF</del></li>
  <li><del>duplication Franc/dollar</del></li>
  <li><del>même ==</del></li>
  <li><del>* presque identique.</del></li>
  <li><del>compare Franc et Dollar</del></li>
  <li><del>utilisation de devise ?</del></li>
  <li><del>supprimer <code class="language-plaintext highlighter-rouge">test_franc_multiplication</code> ?</del></li>
</ul>

<h3 id="raz-de-la-todo-list">RAZ de la todo list</h3>

<p>On est arrivé à un point clé de notre projet. La classe <code class="language-plaintext highlighter-rouge">Money</code> permet de gérer plusieurs devises et de multiplier les montant par un entier.</p>

<p>A partir de maintenant, on va vous laisser un peu plus libre.</p>

<p>On va épurer la todo list en supprimant les améliorations possibles de <code class="language-plaintext highlighter-rouge">==</code> et la gestion des arrondis (que l’on vous laisse en exercice :-)) :</p>

<h4 id="tbd-24">tbd</h4>

<ul>
  <li>$5 + 2.5CHF = $10 si le taux de change est 1:.5</li>
</ul>

<h3 id="addition-13">Addition 1/3</h3>

<p>Avant de traiter l’addition de deux monnaies différentes, commençons par traiter le cas de 1 unique monnaie :</p>

<h4 id="tbd-25">tbd</h4>

<ul>
  <li>$5 + 2.5CHF = $10 si le taux de change est 1:.5</li>
  <li><strong>$5 + $5 = $10</strong></li>
</ul>

<p>Commençons par écrire un test permettant de tester que $5 + $5 = $10 en supposant que :</p>

<ul>
  <li>on utilise la méthode <code class="language-plaintext highlighter-rouge">plus</code> de <code class="language-plaintext highlighter-rouge">Money</code> qui rend un objet <code class="language-plaintext highlighter-rouge">Money</code></li>
  <li>les objets de la classe <code class="language-plaintext highlighter-rouge">Money</code> sont toujours non mutables</li>
</ul>

<p>Ce test réalisé, on l’oplémente (une obvious implémentation devrait suffire)</p>

<h4 id="testspy-12">tests.py</h4>

<p>On a ajouté le test ci-après à la batterie de test précédent</p>

<pre><code class="language-pyhton">def test_sum():
    sum = money.dollar(5).plus(money.dollar(5))

    assert money.dollar(10) == sum
</code></pre>

<h4 id="moneypy-15">money.py</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">dollar</span><span class="p">(</span><span class="n">amount</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">Money</span><span class="p">(</span><span class="n">amount</span><span class="p">,</span> <span class="s">"USD"</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">franc</span><span class="p">(</span><span class="n">amount</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">Money</span><span class="p">(</span><span class="n">amount</span><span class="p">,</span> <span class="s">"CHF"</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Money</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">currency</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">amount</span> <span class="o">=</span> <span class="n">amount</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">currency</span> <span class="o">=</span> <span class="n">currency</span>

    <span class="k">def</span> <span class="nf">currencies</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">currency</span>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">currency</span> <span class="o">==</span> <span class="n">other</span><span class="p">.</span><span class="n">currency</span> <span class="ow">and</span> <span class="bp">self</span><span class="p">.</span><span class="n">amount</span> <span class="o">==</span> <span class="n">other</span><span class="p">.</span><span class="n">amount</span>

    <span class="k">def</span> <span class="nf">__mul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">multiplier</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Money</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">amount</span> <span class="o">*</span> <span class="n">multiplier</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">currency</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">plus</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Money</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">amount</span> <span class="o">+</span> <span class="n">other</span><span class="p">.</span><span class="n">amount</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">currency</span><span class="p">)</span>
</code></pre></div></div>

<h4 id="addition">addition</h4>

<p>Tout comme <code class="language-plaintext highlighter-rouge">__mul__</code> il existe une méthode en python pour gérer l’addition : <code class="language-plaintext highlighter-rouge">__add__</code>. On modifie nos tests et le code pour l’utiliser.</p>

<h4 id="testspy-13">tests.py</h4>

<p>On a ajouté le test ci-après à la batterie de test précédent</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">test_sum</span><span class="p">():</span>
    <span class="nb">sum</span> <span class="o">=</span> <span class="n">money</span><span class="p">.</span><span class="n">dollar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="n">money</span><span class="p">.</span><span class="n">dollar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">money</span><span class="p">.</span><span class="n">dollar</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">==</span> <span class="nb">sum</span>
</code></pre></div></div>

<h4 id="moneypy-16">money.py</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Money</span><span class="p">:</span>
    
    <span class="c1"># ...
</span>
    <span class="k">def</span> <span class="nf">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Money</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">amount</span> <span class="o">+</span> <span class="n">other</span><span class="p">.</span><span class="n">amount</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">currency</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="addition-23">Addition 2/3</h3>

<p>Notre implémentation de <code class="language-plaintext highlighter-rouge">+</code> qui rend un objet de type <code class="language-plaintext highlighter-rouge">Money</code> ne sera pas tenable longtemps. En effet <code class="language-plaintext highlighter-rouge">$5 + 2.5CHF</code> ne peut être un objet de type <code class="language-plaintext highlighter-rouge">Money</code>. Ce sont deux devises différentes qui vont avoir une valeur dépendant du cours actuel, qui va fluctuer sans cesse. Il faut donc résoudre deux problèmes :</p>

<ul>
  <li>comment stocker plusieurs devises</li>
  <li>comment convertir une monnaie ou un ensemble de monnaies en une autre.</li>
</ul>

<h4 id="tests-py">tests. py</h4>

<p>Pour imaginer cela rien de mieux qu’un test ! On va l’écrire à l’envers, en partant du résultat, car  on sait où on veut arriver : à $10 :</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">test_simple_addition</span><span class="p">():</span>
    <span class="c1"># ...
</span>    <span class="k">assert</span> <span class="n">money</span><span class="p">.</span><span class="n">dollar</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">==</span> <span class="n">reduced</span>
</code></pre></div></div>

<p>Ces $10 viennent d’une conversion en dollar d’une somme de deux monnaies, conversion qui – d’un point de vue métier – ne peut venir que d’une banque</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">test_simple_addition</span><span class="p">():</span>
    <span class="c1"># ...
</span>    <span class="n">reduced</span> <span class="o">=</span> <span class="n">bank</span><span class="p">.</span><span class="nb">reduce</span><span class="p">(</span><span class="nb">sum</span><span class="p">,</span> <span class="s">"USD"</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">money</span><span class="p">.</span><span class="n">dollar</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">==</span> <span class="n">reduced</span>
</code></pre></div></div>

<p>Banque qu’il faut créer :</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">test_simple_addition</span><span class="p">():</span>
    <span class="c1"># ...
</span>    <span class="n">bank</span> <span class="o">=</span> <span class="n">Bank</span><span class="p">()</span>
    <span class="n">reduced</span> <span class="o">=</span> <span class="n">bank</span><span class="p">.</span><span class="nb">reduce</span><span class="p">(</span><span class="nb">sum</span><span class="p">,</span> <span class="s">"USD"</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">money</span><span class="p">.</span><span class="n">dollar</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">==</span> <span class="n">reduced</span>
</code></pre></div></div>

<p>Il ne reste plus qu’à fabriquer notre expression pur avoir notre test final :</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">test_simple_addition</span><span class="p">():</span>
    <span class="n">five</span> <span class="o">=</span> <span class="n">money</span><span class="p">.</span><span class="n">dollar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
    <span class="nb">sum</span> <span class="o">=</span> <span class="n">five</span> <span class="o">+</span> <span class="n">five</span>
    <span class="n">bank</span> <span class="o">=</span> <span class="n">Bank</span><span class="p">()</span>
    <span class="n">reduced</span> <span class="o">=</span> <span class="n">bank</span><span class="p">.</span><span class="nb">reduce</span><span class="p">(</span><span class="nb">sum</span><span class="p">,</span> <span class="s">"USD"</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">money</span><span class="p">.</span><span class="n">dollar</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">==</span> <span class="n">reduced</span>
</code></pre></div></div>

<h4 id="moneypy-17">money.py</h4>

<p>On fake le tout pour avoir un test qui passe et du pain sur la planche pour plus tard.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Bank</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">reduce</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expression</span><span class="p">,</span> <span class="n">currency</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">dollar</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="addition-33">Addition 3/3</h3>

<p>L’implémentation réelle de tout ce qu’on a <em>faké</em> n’est pas si évidente que ça. On va donc devoir faire des choix restrictifs et ajouter à la todo list les généralisations à effectuer pour terminer le travail.</p>

<p>On va considérer que toute somme de deux monnaies est une nouvelle classe somme (on va cependant ajouter que la somme de 2 monnaies identiques devrait rendre une monnaie dans la todo list).</p>

<p>Donc :</p>

<ul>
  <li>on ajoute que la somme de deux monnaies $ devrait donner des $ dans la todo list</li>
  <li>on supprime du coup le test <code class="language-plaintext highlighter-rouge">test_sum</code> qui vérifie que $5 + $5 = $10 ce qui n’est plus vrai.</li>
  <li>on ajoute un test pour montrer que la somme de deux monnaies est un objet contenant une partie gauche (la partie à gauche du <code class="language-plaintext highlighter-rouge">+</code>) et une partie droite (la partie à droite du <code class="language-plaintext highlighter-rouge">+</code>).</li>
</ul>

<p>Une fois ceci fait, on implémente le tout en <em>obvious implementation</em>.</p>

<h4 id="tbd-26">tbd</h4>

<ul>
  <li>$5 + 2.5CHF = $10 si le taux de change est 1:.5</li>
  <li><strong>$5 + $5 = quelque chose qui correspond à $10</strong></li>
  <li>$5 + $5 devrait rendre une Money</li>
</ul>

<h4 id="tests-py-1">tests. py</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">test_plus_returns_sum</span><span class="p">():</span>
    <span class="n">five</span> <span class="o">=</span> <span class="n">money</span><span class="p">.</span><span class="n">dollar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">three</span> <span class="o">=</span> <span class="n">money</span><span class="p">.</span><span class="n">dollar</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="nb">sum</span> <span class="o">=</span> <span class="n">five</span> <span class="o">+</span> <span class="n">three</span>
    <span class="k">assert</span> <span class="nb">sum</span><span class="p">.</span><span class="n">left</span> <span class="o">==</span> <span class="n">five</span>
    <span class="k">assert</span> <span class="nb">sum</span><span class="p">.</span><span class="n">right</span> <span class="o">==</span> <span class="n">three</span>
</code></pre></div></div>

<h4 id="moneypy-18">money.py</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Money</span><span class="p">:</span>
    <span class="c1"># ... 
</span>    <span class="k">def</span> <span class="nf">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Sum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Sum</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">left</span> <span class="o">=</span> <span class="n">left</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">right</span> <span class="o">=</span> <span class="n">right</span>
</code></pre></div></div>

<h4 id="reduce-13">reduce 1/3</h4>

<p>Il faut faire en sorte de trianguler pour l’implémentation de la méthode <code class="language-plaintext highlighter-rouge">reduce</code> de la banque (pour l’instant c’est un <em>fake</em> qui rend 10 dollar). Maintenant elle prend en paramètre une somme. On va donc faire un test qui vérifiera que <code class="language-plaintext highlighter-rouge">bank.reduce(money.dollar(3) + money.dollar(4), "USD")</code> rende bien 7 dollars.</p>

<p>En implémentant la méthode (après avoir écrit le test bien sur), on considérera que la partie gauche et droite de la somme sont de la monnaie du deuxième paramètre pour l’instant.</p>

<p>En faisant cette implémentation, on va rajouter un todo pour noter que l’on doit aussi implémenter <code class="language-plaintext highlighter-rouge">Bank.reduce</code> pour un objet de type Money (et pas juste pour les sommes)</p>

<h4 id="tbd-27">tbd</h4>

<ul>
  <li>$5 + 2.5CHF = $10 si le taux de change est 1:.5</li>
  <li><strong>$5 + $5 = quelque chose qui correspond à $10</strong></li>
  <li>$5 + $5 devrait rendre une <code class="language-plaintext highlighter-rouge">Money</code></li>
  <li><code class="language-plaintext highlighter-rouge">Bank.reduce(Money)</code></li>
</ul>

<h4 id="tests-py-2">tests. py</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">test_bank_reduce_sum</span><span class="p">():</span>
    <span class="n">bank</span> <span class="o">=</span> <span class="n">Bank</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">money</span><span class="p">.</span><span class="n">dollar</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">==</span> <span class="n">bank</span><span class="p">.</span><span class="nb">reduce</span><span class="p">(</span><span class="n">money</span><span class="p">.</span><span class="n">dollar</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="n">money</span><span class="p">.</span><span class="n">dollar</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="s">"USD"</span><span class="p">)</span>
</code></pre></div></div>
<h4 id="moneypy-19">money.py</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Bank</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">reduce</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expression</span><span class="p">,</span> <span class="n">currency</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Money</span><span class="p">(</span><span class="n">expression</span><span class="p">.</span><span class="n">left</span><span class="p">.</span><span class="n">amount</span> <span class="o">+</span> <span class="n">expression</span><span class="p">.</span><span class="n">right</span><span class="p">.</span><span class="n">amount</span><span class="p">,</span> <span class="n">currency</span><span class="p">)</span>
</code></pre></div></div>

<h4 id="reduce-23">reduce 2/3</h4>

<p>Implémenter juste la méthode <code class="language-plaintext highlighter-rouge">reduce</code> pour la banque pose quelques problèmes. En particulier : la banque doit connaître l’implémentation de Money pour avoir accès à l’attribut amount.</p>

<p>Pour cela on va déplacer le corps de la méthode <code class="language-plaintext highlighter-rouge">reduce</code> de la <code class="language-plaintext highlighter-rouge">Bank</code> à <code class="language-plaintext highlighter-rouge">Sum</code>. Banque ne fera qu’appeler la méthode de <code class="language-plaintext highlighter-rouge">Sum</code>. Pour l’instant on ne va considérer qu’un seul paramètre pour la méthode <code class="language-plaintext highlighter-rouge">reduce</code> de <code class="language-plaintext highlighter-rouge">Sum</code>, la devise d’arrivée (on rajoutera la banque comme paramètre plus tard, lorsque l’on utilisera effectivement des conversions. On place tout de même cette fonctionnalité dans la todo list pour ne pas l’oublier).</p>

<h4 id="moneypy-20">money.py</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Bank</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">reduce</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expression</span><span class="p">,</span> <span class="n">currency</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">expression</span><span class="p">.</span><span class="nb">reduce</span><span class="p">(</span><span class="n">currency</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Sum</span><span class="p">:</span>
    <span class="c1"># ... 
</span>    <span class="k">def</span> <span class="nf">reduce</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">currency</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Money</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">left</span><span class="p">.</span><span class="n">amount</span> <span class="o">+</span> <span class="bp">self</span><span class="p">.</span><span class="n">right</span><span class="p">.</span><span class="n">amount</span><span class="p">,</span> <span class="n">currency</span><span class="p">)</span>
</code></pre></div></div>

<h4 id="reduce-33">reduce 3/3</h4>

<p>L’étape précédente a permis de baisser le niveau de connaissance de la banque des objets qui l’entourent. C’est une bonne chose. Un bon programme utilise plein d’objets qui interagissent entre eux mais qui ne connaissent pas l’implémentation des autres classes. Les objets doivent être le plus découplé possible.</p>

<p>Monter le reduce au niveau de <code class="language-plaintext highlighter-rouge">Sum</code> nous permet également de traiter le cas où Bank.reduce à une Money comme paramètre. Il suffit de rajouter  une méthode <code class="language-plaintext highlighter-rouge">reduce</code> à Money !</p>

<p>Pour faire cela, on commence par faire un test où l’argument de reduce pour la banque est un objet de type <code class="language-plaintext highlighter-rouge">Money</code> puis on écrit le code correspondant. De même que précédemment, on va considérer que le seul paramètre de la méthode <code class="language-plaintext highlighter-rouge">reduce</code> pour <code class="language-plaintext highlighter-rouge">Money</code> est la devise d’arrivée et on ajoute dans la todo list qu’il faudra implémenter une conversion si nécessaire.</p>

<h4 id="tbd-28">tbd</h4>

<ul>
  <li>$5 + 2.5CHF = $10 si le taux de change est 1:.5</li>
  <li><del>$5 + $5 = quelque chose qui correspond à $10</del></li>
  <li>$5 + $5 devrait rendre une Money</li>
  <li><del>Bank.reduce(Money)</del></li>
  <li>Sum.reduce avec conversion</li>
  <li>Money.reduce avec conversion</li>
</ul>

<h4 id="tests-py-3">tests. py</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">test_reduce_money</span><span class="p">():</span>
    <span class="n">bank</span> <span class="o">=</span> <span class="n">Bank</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">money</span><span class="p">.</span><span class="n">dollar</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">bank</span><span class="p">.</span><span class="nb">reduce</span><span class="p">(</span><span class="n">money</span><span class="p">.</span><span class="n">dollar</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="s">"USD"</span><span class="p">)</span>
</code></pre></div></div>

<h4 id="moneypy-21">money.py</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Money</span><span class="p">:</span>
    <span class="c1"># ...
</span>    <span class="k">def</span> <span class="nf">reduce</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">currency</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>
</code></pre></div></div>

<h3 id="taux-de-change-12">Taux de change 1/2</h3>

<p>On va maintenant s’attaquer à la conversion. Commençons simple avec les objets de type <code class="language-plaintext highlighter-rouge">Money</code></p>

<h4 id="tbd-29">tbd</h4>

<ul>
  <li>$5 + 2.5CHF = $10 si le taux de change est 1:.5</li>
  <li><del>$5 + $5 = quelque chose qui correspond à $10</del></li>
  <li>$5 + $5 devrait rendre une Money</li>
  <li><del>Bank.reduce(Money)</del></li>
  <li>Sum.reduce avec conversion</li>
  <li><strong>Money.reduce avec conversion</strong></li>
</ul>

<p>On va écrire un test permettant de gérer le change :</p>

<ul>
  <li>on veut convertir $2 en CHF</li>
  <li>le taux de change que l’on ajoute à la banque lors du test. par exemple 1CHF -&gt; $2 (on y est presque en réalité)</li>
</ul>

<p>Il faut donc ajouter une méthode <code class="language-plaintext highlighter-rouge">add_rate</code> à la banque dont les paramètres pourraient être la monnaie d’origine, la monnaie d’arrivée et le taux de change.</p>

<p>Une fois le test créé, on implémente le tout. En commençant par un fake, puis petit à petit on ajoute la bonne implémentation. Cela peut être long car il vous faudra déterminer comment fonctionne le taux de change.</p>

<h4 id="tbd-30">tbd</h4>

<ul>
  <li>$5 + 2.5CHF = $10 si le taux de change est 1:.5</li>
  <li><del>$5 + $5 = quelque chose qui correspond à $10</del></li>
  <li>$5 + $5 devrait rendre une Money</li>
  <li><del>Bank.reduce(Money)</del></li>
  <li>Sum.reduce avec conversion</li>
  <li><del>Money.reduce avec conversion</del></li>
</ul>

<h4 id="tests-py-4">tests. py</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">test_reduce_money_conversion</span><span class="p">():</span>
    <span class="n">bank</span> <span class="o">=</span> <span class="n">Bank</span><span class="p">()</span>
    <span class="n">bank</span><span class="p">.</span><span class="n">add_rate</span><span class="p">(</span><span class="s">"CHF"</span><span class="p">,</span> <span class="s">"USD"</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">money</span><span class="p">.</span><span class="n">dollar</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="n">bank</span><span class="p">.</span><span class="nb">reduce</span><span class="p">(</span><span class="n">money</span><span class="p">.</span><span class="n">franc</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="s">"USD"</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">test_identity_rate</span><span class="p">():</span>
    <span class="n">bank</span> <span class="o">=</span> <span class="n">Bank</span><span class="p">()</span>
    <span class="k">assert</span> <span class="mi">1</span> <span class="o">==</span> <span class="n">bank</span><span class="p">.</span><span class="n">rate</span><span class="p">(</span><span class="s">"USD"</span><span class="p">,</span> <span class="s">"USD"</span><span class="p">)</span>
</code></pre></div></div>

<h4 id="moneypy-22">money.py</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Bank</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">_rate</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">reduce</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expression</span><span class="p">,</span> <span class="n">currency</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">expression</span><span class="p">.</span><span class="nb">reduce</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">currency</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add_rate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">from_currency</span><span class="p">,</span> <span class="n">to_currency</span><span class="p">,</span> <span class="n">rate</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">_rate</span><span class="p">[(</span><span class="n">from_currency</span><span class="p">,</span> <span class="n">to_currency</span><span class="p">)]</span> <span class="o">=</span> <span class="n">rate</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">_rate</span><span class="p">[(</span><span class="n">to_currency</span><span class="p">,</span> <span class="n">from_currency</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">rate</span>

    <span class="k">def</span> <span class="nf">rate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">from_currency</span><span class="p">,</span> <span class="n">to_currency</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">from_currency</span> <span class="o">==</span> <span class="n">to_currency</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">_rate</span><span class="p">[(</span><span class="n">from_currency</span><span class="p">,</span> <span class="n">to_currency</span><span class="p">)]</span>

<span class="k">class</span> <span class="nc">Money</span><span class="p">:</span>
    <span class="c1"># ... 
</span>    <span class="k">def</span> <span class="nf">reduce</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bank</span><span class="p">,</span> <span class="n">currency</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Money</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">amount</span> <span class="o">*</span> <span class="n">bank</span><span class="p">.</span><span class="n">rate</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">currency</span><span class="p">,</span> <span class="n">currency</span><span class="p">),</span> <span class="n">currency</span><span class="p">)</span>
    
<span class="k">class</span> <span class="nc">Sum</span><span class="p">:</span>
    <span class="c1"># ... 
</span>    <span class="k">def</span> <span class="nf">reduce</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bank</span><span class="p">,</span> <span class="n">currency</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Money</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">left</span><span class="p">.</span><span class="n">amount</span> <span class="o">+</span> <span class="bp">self</span><span class="p">.</span><span class="n">right</span><span class="p">.</span><span class="n">amount</span><span class="p">,</span> <span class="n">currency</span><span class="p">)</span>    
</code></pre></div></div>

<h3 id="taux-de-change-22">Taux de change 2/2</h3>

<p>Pour l’instant notre conversion pour les sommes ne considère que les mêmes devises. On va travailler maintenant sur des devises différentes.</p>

<p>On va écrire un test pour convertir une somme de 2 devises différentes. Puis implémentez le tout.</p>

<h4 id="tbd-31">tbd</h4>

<ul>
  <li>$5 + 2.5CHF = $10 si le taux de change est 1:.5</li>
  <li><del>$5 + $5 = quelque chose qui correspond à $10</del></li>
  <li>$5 + $5 devrait rendre une Money</li>
  <li><del>Bank.reduce(Money)</del></li>
  <li><del>Sum.reduce avec conversion</del></li>
  <li><del>Money.reduce avec conversion</del></li>
</ul>

<h4 id="tests-py-5">tests. py</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">test_sum_reduce_different_currency</span><span class="p">():</span>
    <span class="n">bank</span> <span class="o">=</span> <span class="n">Bank</span><span class="p">()</span>
    <span class="n">bank</span><span class="p">.</span><span class="n">add_rate</span><span class="p">(</span><span class="s">"CHF"</span><span class="p">,</span> <span class="s">"USD"</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">money</span><span class="p">.</span><span class="n">franc</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="n">bank</span><span class="p">.</span><span class="nb">reduce</span><span class="p">(</span><span class="n">money</span><span class="p">.</span><span class="n">dollar</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">money</span><span class="p">.</span><span class="n">franc</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="s">"CHF"</span><span class="p">)</span>
</code></pre></div></div>

<h4 id="moneypy-23">money.py</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Sum</span><span class="p">:</span>
    <span class="c1"># ... 
</span>    <span class="k">def</span> <span class="nf">reduce</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bank</span><span class="p">,</span> <span class="n">currency</span><span class="p">):</span>
        <span class="n">left_money</span> <span class="o">=</span> <span class="n">bank</span><span class="p">.</span><span class="nb">reduce</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">left</span><span class="p">,</span> <span class="n">currency</span><span class="p">)</span>
        <span class="n">right_money</span> <span class="o">=</span> <span class="n">bank</span><span class="p">.</span><span class="nb">reduce</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">right</span><span class="p">,</span> <span class="n">currency</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Money</span><span class="p">(</span><span class="n">left_money</span><span class="p">.</span><span class="n">amount</span> <span class="o">+</span> <span class="n">right_money</span><span class="p">.</span><span class="n">amount</span><span class="p">,</span> <span class="n">currency</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="expressions">Expressions</h3>

<p>Pour finir, il nous reste à généraliser le tout. C’est à dire que l’on aimerait bien pouvoir multiplier une <code class="language-plaintext highlighter-rouge">Sum</code> par un entier par exemple ou additionner des <code class="language-plaintext highlighter-rouge">Sum entre elles</code>.</p>

<p>A priori, une partie de la somme de sommes est déjà implémentée. 
Par exemple le test suivant doit passer :</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">test_sum_of_sum_1</span><span class="p">():</span>
    <span class="n">bank</span> <span class="o">=</span> <span class="n">Bank</span><span class="p">()</span>
    <span class="n">bank</span><span class="p">.</span><span class="n">add_rate</span><span class="p">(</span><span class="s">"CHF"</span><span class="p">,</span> <span class="s">"USD"</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">expression</span> <span class="o">=</span> <span class="n">money</span><span class="p">.</span><span class="n">dollar</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">money</span><span class="p">.</span><span class="n">franc</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">money</span><span class="p">.</span><span class="n">dollar</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
    <span class="k">assert</span> <span class="n">money</span><span class="p">.</span><span class="n">franc</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="n">bank</span><span class="p">.</span><span class="nb">reduce</span><span class="p">(</span><span class="n">expression</span><span class="p">,</span> <span class="s">"CHF"</span><span class="p">)</span>
</code></pre></div></div>

<p>Mais pas celui là :</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">test_sum_of_sum_2</span><span class="p">():</span>
    <span class="n">bank</span> <span class="o">=</span> <span class="n">Bank</span><span class="p">()</span>
    <span class="n">bank</span><span class="p">.</span><span class="n">add_rate</span><span class="p">(</span><span class="s">"CHF"</span><span class="p">,</span> <span class="s">"USD"</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">expression</span> <span class="o">=</span> <span class="p">(</span><span class="n">money</span><span class="p">.</span><span class="n">dollar</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">money</span><span class="p">.</span><span class="n">franc</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span> <span class="o">+</span> <span class="n">money</span><span class="p">.</span><span class="n">dollar</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">money</span><span class="p">.</span><span class="n">franc</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="n">bank</span><span class="p">.</span><span class="nb">reduce</span><span class="p">(</span><span class="n">expression</span><span class="p">,</span> <span class="s">"CHF"</span><span class="p">)</span>
</code></pre></div></div>

<p>Pourquoi ?</p>

<p>(réfléchissez un peu)</p>

<p>Implémentons la solution.</p>

<h4 id="moneypy-24">money.py</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Sum</span><span class="p">:</span>
    <span class="c1"># ... 
</span>    <span class="k">def</span> <span class="nf">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Sum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span>
</code></pre></div></div>

<h4 id="testspy-14">tests.py</h4>

<p>Il ne reste plus qu’à tester la multiplication</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">test_sum_of_sum</span><span class="p">():</span>
    <span class="n">bank</span> <span class="o">=</span> <span class="n">Bank</span><span class="p">()</span>
    <span class="n">bank</span><span class="p">.</span><span class="n">add_rate</span><span class="p">(</span><span class="s">"CHF"</span><span class="p">,</span> <span class="s">"USD"</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">expression</span> <span class="o">=</span> <span class="p">(</span><span class="n">money</span><span class="p">.</span><span class="n">franc</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">money</span><span class="p">.</span><span class="n">dollar</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="o">*</span> <span class="mi">4</span>
    <span class="k">assert</span> <span class="n">money</span><span class="p">.</span><span class="n">franc</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">==</span> <span class="n">bank</span><span class="p">.</span><span class="nb">reduce</span><span class="p">(</span><span class="n">expression</span><span class="p">,</span> <span class="s">"CHF"</span><span class="p">)</span>
</code></pre></div></div>

<h4 id="moneypy-25">money.py</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Sum</span><span class="p">:</span>
    <span class="c1"># ...
</span>    
    <span class="k">def</span> <span class="nf">__mul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">multiplier</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Sum</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">left</span> <span class="o">*</span> <span class="n">multiplier</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">right</span> <span class="o">*</span> <span class="n">multiplier</span><span class="p">)</span>
</code></pre></div></div>

  </div>

</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/cours_informatique/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">cours d&#39;informatique</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">cours d&#39;informatique</li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/FrancoisBrucker"><svg class="svg-icon"><use xlink:href="/cours_informatique/assets/minima-social-icons.svg#github"></use></svg> <span class="username">FrancoisBrucker</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>Support de cours/td d&#39;informatique à l&#39;école centrale marseille.</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>

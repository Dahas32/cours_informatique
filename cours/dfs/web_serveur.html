<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
<!-- Begin Jekyll SEO tag v2.7.1 -->
<title>serveur Web avec node | cours d’informatique</title>
<meta name="generator" content="Jekyll v4.2.0">
<meta property="og:title" content="serveur Web avec node">
<meta name="author" content="François Brucker">
<meta property="og:locale" content="en_US">
<meta name="description" content="Support de cours/td d’informatique à l’école centrale marseille.">
<meta property="og:description" content="Support de cours/td d’informatique à l’école centrale marseille.">
<link rel="canonical" href="/cours_informatique/cours/dfs/web_serveur.html">
<meta property="og:url" content="/cours_informatique/cours/dfs/web_serveur.html">
<meta property="og:site_name" content="cours d’informatique">
<meta name="twitter:card" content="summary">
<meta property="twitter:title" content="serveur Web avec node">
<script type="application/ld+json">
{"description":"Support de cours/td d’informatique à l’école centrale marseille.","@type":"WebPage","headline":"serveur Web avec node","url":"/cours_informatique/cours/dfs/web_serveur.html","author":{"@type":"Person","name":"François Brucker"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/cours_informatique/assets/main.css">

  <link rel="stylesheet" href="/cours_informatique/assets/custom.css">
<link type="application/atom+xml" rel="alternate" href="/cours_informatique/feed.xml" title="cours d'informatique">
</head>

<body>
<header class="site-header" role="banner">

  <div class="wrapper">
<a class="site-title" rel="author" href="/cours_informatique/">cours d'informatique</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger">
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewbox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"></path>
            </svg>
          </span>
        </label>

        <div class="trigger">
            <a class="page-link" href="/cours_informatique/about"> about </a>
        </div>
      </nav>
</div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post">

  <header class="post-header">
    <h1 class="post-title">serveur Web avec node</h1>Auteur : <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span class="p-author h-card" itemprop="name">François Brucker</span></span>
  </header>

  <div class="post-content">
    <h2 id="but">But</h2>

<p>Un (trop) long tutorial pour mettre en place un serveur web et la plupart des outils nécessaires pour son développement et son maintient.</p>

<p>On prendra comme exemple un site de numérologie qui associe un numéro à chaque prénom.</p>

<p>On aimerait avoir un site :</p>

<ul>
  <li>dont le titre serait numérologie</li>
  <li>et où on pourrait taper son prénom pour en connaître son numéro</li>
  <li>si l’on ne tape aucun prénom, le site devrait afficher un ‘?’</li>
</ul>

<h2 id="initialisation-du-projet">initialisation du projet</h2>

<p>On va écrire le code en <a href="https://nodejs.org/en/">node</a>, donc commencez par l’installer (avec apt-get ou brew) si ce n’est pas déjà le cas.</p>

<h3 id="node">node</h3>

<p><a href="https://nodejs.org/en/">Node</a> est un interpréteur <a href="https://fr.wikipedia.org/wiki/V8_(moteur_JavaScript)">javascript V8</a> performant, très utilisé pour créer des serveur web. On va commencer par découvrir un peu ses fonctionnalités en console. Tapez <code class="language-plaintext highlighter-rouge">node</code> dans un terminal pour entrer en mode interpréteur où chque ligne tapée est directement interprétée ;</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>fbrucker@emma » node
Welcome to Node.js v14.13.0.
Type <span class="s2">".help"</span> <span class="k">for </span>more information.
<span class="o">&gt;</span> console.log<span class="o">(</span><span class="s2">"Hello World!"</span><span class="o">)</span>
Hello World!
undefined
<span class="o">&gt;</span> x <span class="o">=</span> 1
1
<span class="o">&gt;</span> console.log<span class="o">(</span>x<span class="o">)</span>
1
undefined
<span class="o">&gt;</span> f <span class="o">=</span> <span class="o">()</span> <span class="o">=&gt;</span> <span class="o">{</span> <span class="k">return</span> <span class="s2">"je suis une fonction"</span><span class="o">}</span>
<span class="o">[</span>Function: f]
<span class="o">&gt;</span> f<span class="o">()</span>
<span class="s1">'je suis une fonction'</span>
</code></pre></div></div>

<p>Chaque ligne est exécutée puis son résultat est donné. C’est pour ça qu’il y a de temps en temps des <code class="language-plaintext highlighter-rouge">undefined</code>, c’est des retour de fonctions (comme <code class="language-plaintext highlighter-rouge">console.log</code> qui ne rend <strong>RIEN</strong>, elle ne fait qu’afficher à l’écran)</p>

<p>C’est idéal pour tester des choses, en particulier pour reprendre les exemples de <a href="https://www.destroyallsoftware.com/talks/wat">cette fameuse comparaison entre ruby et js</a> (même si les plus terribles exemples ont été corrigés…).</p>

<h3 id="git">git</h3>

<p>On suit le tuto et on crée notre projet git, que l’on synchronise avec notre github.</p>

<ol>
  <li><code class="language-plaintext highlighter-rouge">git init</code></li>
  <li>synchronise avec github</li>
  <li>on crée un fichier <code class="language-plaintext highlighter-rouge">main.js</code> vide et on commit le tout.</li>
</ol>

<h2 id="un-peut-de-js">Un peut de js</h2>

<p>On va créer un site de numérologie du prénom qui associera un nombre à chaque prénom écrit en utf8. On va s’inspirer de <a href="https://numerologist.com/numerology/the-numerology-of-your-first-name-decoded-explained/">cet article scientifique</a> mais permettre tout prénom écrit en unicode. Il nous faut donc :</p>

<ul>
  <li>pouvoir associer un chiffre à chaque lettre</li>
  <li>sommer tout ça et, si le nombre est plus grand que 10, re-sommer les chiffres sauf si la somme fait 11, 22, ou 33.</li>
</ul>

<p>On ne va cependant pas commencer à coder directement, on va utiliser une bibliothèque de tests unitaires, <a href="https://jestjs.io/">jest</a> et créer un projet node avec <a href="https://classic.yarnpkg.com/en/">yarn</a> (<code class="language-plaintext highlighter-rouge">yarn init</code> pour initialiser le projet, suivez le tuto dédié si vous avez du mal)</p>

<h3 id="jest">jest</h3>

<p>On installe jest comme dépendance de développement au projet, on en aura en effet pas besoin en production : <code class="language-plaintext highlighter-rouge">yarn add --dev jest</code>. <code class="language-plaintext highlighter-rouge">git status</code> devient fou, on ajute donc ce qu’il faut dans le <code class="language-plaintext highlighter-rouge">.gitignore</code> et on commit le tout.</p>

<p>Remarquez que le fichier <code class="language-plaintext highlighter-rouge">package.json</code> contient les dépendances de développement.</p>

<p>On va tout de suite ajouter une ligne pour que les tests s’exécutent via une commande <code class="language-plaintext highlighter-rouge">yarn</code> en ajoutant les lignes suivantes à votre fichier <em>package.json</em> :</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>"scripts": {
    "test": "jest"
  },
</code></pre></div></div>

<p>On pourra ensuite exécuter la commande <code class="language-plaintext highlighter-rouge">yarn run test</code> pour exécuter tous les tests. Pour l’instant il n’y en a pas.</p>

<blockquote>
  <p><strong>Nota Bene :</strong> Si l’on ne veut pas passer par une commande de <code class="language-plaintext highlighter-rouge">yarn</code>, il faut trouver l’exécutable <code class="language-plaintext highlighter-rouge">jest</code> qui se trouve dans <em>node_modules/.bin</em></p>
</blockquote>

<p>Par défaut, <em>jest</em> va exécuter tous les fichier qui finissent par <em>test.js</em> récursivement dans tout le projet et tous les fichiers dans le dossier <strong>__tests__</strong>.</p>

<p>Essayons ça en créant un fichier <em>main.test.js</em> :</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">empty test</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">expect</span><span class="p">(</span><span class="kc">true</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div></div>

<p>Puis <code class="language-plaintext highlighter-rouge">yarn run test</code> (ou <code class="language-plaintext highlighter-rouge">./node_modules/.bin/jest</code>) pour voir le résultat.</p>

<p>Changez ensuite le vrai en faux pour voir le test planter.</p>

<h3 id="import">import</h3>

<p>Nos tests doivent importer des fonctions définies autre part. Typiquement le fichier de test <em>main.test.js</em> doit importer des fonctions définies dans <em>main.js</em>. La gestion des imports est spéciale en js, et suit deux modèles celui de commonJs et l’autre ES6. Nous allons ici suivre celui classique dans node de commonJS.</p>

<p>Tout est expliqué <a href="https://developer.mozilla.org/fr/docs/Web/JavaScript/Guide/Modules">dans cet excellent guide</a>, mais en deux mots :</p>

<ul>
  <li>on n’exporte qu’un nom <code class="language-plaintext highlighter-rouge">module.exports</code>. Ce nom peut alors être plein de choses mais c’est typiquement une fonction ou un objet.</li>
  <li>on importe un nom via la commande <code class="language-plaintext highlighter-rouge">require</code>.</li>
</ul>

<h4 id="exemple">exemple</h4>

<p><em>main.js</em> :</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">numerologie</span><span class="p">(</span><span class="nx">prenom</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="mi">22</span>
<span class="p">}</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">numerologie</span>
</code></pre></div></div>

<p><em>main.test.js</em> :</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">numerologie</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">./main</span><span class="dl">"</span><span class="p">)</span>

<span class="nx">test</span><span class="p">(</span><span class="dl">"</span><span class="s2">numerologie</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">numerologie</span><span class="p">(</span><span class="dl">"</span><span class="s2">moi</span><span class="dl">"</span><span class="p">)).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">22</span><span class="p">)</span>
<span class="p">})</span>

</code></pre></div></div>

<h4 id="plusieurs-imports">plusieurs imports</h4>

<p>Si l’on veut importer plusieurs choses, on a coutume de rendre un objet dont les clés sont les noms et les valeurs le fonctions associées.</p>

<p><em>main.js</em> :</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">numerologie</span><span class="p">(</span><span class="nx">prenom</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="mi">22</span>
<span class="p">}</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">numerologie</span><span class="p">:</span> <span class="nx">numerologie</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div></div>

<p>et le <em>main.test.js</em> :</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">main</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">./main</span><span class="dl">"</span><span class="p">)</span>

<span class="nx">test</span><span class="p">(</span><span class="dl">"</span><span class="s2">numerologie</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">main</span><span class="p">.</span><span class="nx">numerologie</span><span class="p">(</span><span class="dl">"</span><span class="s2">moi</span><span class="dl">"</span><span class="p">)).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">22</span><span class="p">)</span>
<span class="p">})</span>
</code></pre></div></div>

<h4 id="retour-de-fonctions">retour de fonctions</h4>

<p>L’intérêt de rendre une fonciton plutôt qu’un module est que l’on peut ainsi paramétrer ce que l’on rend.</p>

<p>Exemple :</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">(</span><span class="nx">parametre</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="na">addition</span><span class="p">:</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="k">return</span> <span class="nx">data</span> <span class="o">+</span> <span class="nx">parametre</span><span class="p">},</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>et le test :</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">main</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">./main</span><span class="dl">"</span><span class="p">)(</span><span class="mi">42</span><span class="p">)</span>

<span class="nx">test</span><span class="p">(</span><span class="dl">"</span><span class="s2">numerologie</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">main</span><span class="p">.</span><span class="nx">addition</span><span class="p">(</span><span class="mi">8</span><span class="p">)).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>
<span class="p">})</span>

</code></pre></div></div>

<h3 id="le-code-and-mainjson">le code and main.json</h3>

<ul>
  <li>trouver le code associé à un caractère est facile en js en utilisant <a href="https://developer.mozilla.org/fr/docs/Web/JavaScript/Reference/Objets_globaux/String/charCodeAt">charCodeAt</a>. Testez dans un node ` (‘coucou’).charCodeAt(1)<code class="language-plaintext highlighter-rouge"> par exemple ou encore </code>(‘你好’).charCodeAt(0)`</li>
  <li>pour associer un chiffre à un nombre en sommant ses composantes on peut tricher en utilisant les chaînes de caractères. Cela va être notre premier test.</li>
</ul>

<p>On va mettre tout ça dans les fichiers <em>numerologie.js</em> et <em>numerologie.test.js</em></p>

<p>On ajoute une <a href="https://jestjs.io/docs/en/api#describename-fn">suite de test</a> qui va correspondre à l’association d’un chiffre à un prénom. Commençons par le test :</p>

<h4 id="boilerplate">boilerplate</h4>

<p><em>numerologie.js</em> :</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">somme</span><span class="p">:</span> <span class="p">(</span><span class="nx">nombre</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="k">return</span> <span class="mi">6</span><span class="o">+</span><span class="mi">5</span>
    <span class="p">}</span>
<span class="p">}</span>

</code></pre></div></div>

<p><em>numerologie.test.js</em> :</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">numerologie</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">./numerologie</span><span class="dl">"</span><span class="p">)</span>

<span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">Un chiffre à un prenom</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">test</span><span class="p">(</span><span class="dl">"</span><span class="s2">somme des nombres</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">expect</span><span class="p">(</span><span class="nx">numerologie</span><span class="p">.</span><span class="nx">somme</span><span class="p">(</span><span class="mi">65</span><span class="p">)).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">6</span><span class="o">+</span><span class="mi">5</span><span class="p">)</span>
    <span class="p">})</span>

<span class="p">})</span>

</code></pre></div></div>

<h4 id="on-résoud-le-problème">on résoud le problème</h4>

<p><em>numerologie.js</em> :</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">somme</span><span class="p">:</span> <span class="p">(</span><span class="nx">nombre</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">somme</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="nx">chaine</span> <span class="o">=</span> <span class="nb">String</span><span class="p">(</span><span class="nx">nombre</span><span class="p">)</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">chaine</span><span class="p">.</span><span class="nx">length</span> <span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">somme</span> <span class="o">+=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">chaine</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">i</span><span class="p">))</span>
        <span class="p">}</span>        
        <span class="k">return</span> <span class="nx">somme</span>
    <span class="p">}</span>
<span class="p">}</span>

</code></pre></div></div>

<p>Ce qui nous permet de transformer tout nombre en somme de ses chiffres tant que sa valeur est &gt;9.</p>

<p>En ajoutant un test :</p>

<p><em>numerologie.test.js</em> :</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">numerologie</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">./numerologie</span><span class="dl">"</span><span class="p">)</span>

<span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">Un chiffre à un prenom</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">test</span><span class="p">(</span><span class="dl">"</span><span class="s2">somme des nombres</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">expect</span><span class="p">(</span><span class="nx">numerologie</span><span class="p">.</span><span class="nx">somme</span><span class="p">(</span><span class="mi">65</span><span class="p">)).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">6</span><span class="o">+</span><span class="mi">5</span><span class="p">)</span>
    <span class="p">})</span>
    <span class="nx">test</span><span class="p">(</span><span class="dl">"</span><span class="s2">&lt;=9</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">expect</span><span class="p">(</span><span class="nx">numerologie</span><span class="p">.</span><span class="nx">sommeFinale</span><span class="p">(</span><span class="mi">65</span><span class="p">)).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="p">})</span>
<span class="p">})</span>
</code></pre></div></div>

<p>et le code :</p>

<p><em>numerologie.js</em></p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">somme</span><span class="p">(</span><span class="nx">nombre</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">somme</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="nx">chaine</span> <span class="o">=</span> <span class="nb">String</span><span class="p">(</span><span class="nx">nombre</span><span class="p">)</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">chaine</span><span class="p">.</span><span class="nx">length</span> <span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">somme</span> <span class="o">+=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">chaine</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">i</span><span class="p">))</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">somme</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">sommeFinale</span><span class="p">(</span><span class="nx">nombre</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">while</span> <span class="p">(</span><span class="nx">nombre</span> <span class="o">&gt;</span> <span class="mi">9</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">nombre</span> <span class="o">=</span> <span class="nx">somme</span><span class="p">(</span><span class="nx">nombre</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">nombre</span>
<span class="p">}</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">somme</span><span class="p">:</span> <span class="nx">somme</span><span class="p">,</span>
    <span class="na">sommeFinale</span><span class="p">:</span> <span class="nx">sommeFinale</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div></div>

<blockquote>
  <p><strong>Nota Bene :</strong> Attention à la blague lorsque l’on enlève le <code class="language-plaintext highlighter-rouge">var</code> à la première ligne de la fonction somme. La variable n’est plus locale et elle remplace donc la valeur de la fonction…</p>
</blockquote>

<h4 id="le-nombre-associé-à-un-prenom">le nombre associé à un prenom</h4>

<p><em>numerologie.test.js</em> :</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">numerologie</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">./numerologie</span><span class="dl">"</span><span class="p">)</span>

<span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">Un chiffre à un prenom</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">test</span><span class="p">(</span><span class="dl">"</span><span class="s2">somme des nombres</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">expect</span><span class="p">(</span><span class="nx">numerologie</span><span class="p">.</span><span class="nx">somme</span><span class="p">(</span><span class="mi">65</span><span class="p">)).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">6</span><span class="o">+</span><span class="mi">5</span><span class="p">)</span>
    <span class="p">})</span>
    <span class="nx">test</span><span class="p">(</span><span class="dl">"</span><span class="s2">&lt;=9</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">expect</span><span class="p">(</span><span class="nx">numerologie</span><span class="p">.</span><span class="nx">sommeFinale</span><span class="p">(</span><span class="mi">65</span><span class="p">)).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="p">})</span>
    <span class="nx">test</span><span class="p">(</span><span class="dl">"</span><span class="s2">nombre associé au prénom d'une lettre</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">expect</span><span class="p">(</span><span class="nx">numerologie</span><span class="p">.</span><span class="nx">nombre</span><span class="p">(</span><span class="dl">"</span><span class="s2">A</span><span class="dl">"</span><span class="p">)).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="p">})</span>
    <span class="nx">test</span><span class="p">(</span><span class="dl">"</span><span class="s2">nombre associé au prénom de plusieurs lettres</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">expect</span><span class="p">(</span><span class="nx">numerologie</span><span class="p">.</span><span class="nx">nombre</span><span class="p">(</span><span class="dl">"</span><span class="s2">A</span><span class="dl">"</span><span class="p">)).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="nx">expect</span><span class="p">(</span><span class="nx">numerologie</span><span class="p">.</span><span class="nx">nombre</span><span class="p">(</span><span class="dl">"</span><span class="s2">m</span><span class="dl">"</span><span class="p">)).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="nx">expect</span><span class="p">(</span><span class="nx">numerologie</span><span class="p">.</span><span class="nx">nombre</span><span class="p">(</span><span class="dl">"</span><span class="s2">y</span><span class="dl">"</span><span class="p">)).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
        <span class="nx">expect</span><span class="p">(</span><span class="nx">numerologie</span><span class="p">.</span><span class="nx">nombre</span><span class="p">(</span><span class="dl">"</span><span class="s2">Amy</span><span class="dl">"</span><span class="p">)).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span>
    <span class="p">})</span>

<span class="p">})</span>

</code></pre></div></div>

<p>Le code :</p>

<p><em>numerologie.js</em></p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kd">function</span> <span class="nx">somme</span><span class="p">(</span><span class="nx">nombre</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">somme</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="nx">chaine</span> <span class="o">=</span> <span class="nb">String</span><span class="p">(</span><span class="nx">nombre</span><span class="p">)</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">chaine</span><span class="p">.</span><span class="nx">length</span> <span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">somme</span> <span class="o">+=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">chaine</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">i</span><span class="p">))</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">somme</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">sommeFinale</span><span class="p">(</span><span class="nx">nombre</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">while</span> <span class="p">(</span><span class="nx">nombre</span> <span class="o">&gt;</span> <span class="mi">9</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">nombre</span> <span class="o">=</span> <span class="nx">somme</span><span class="p">(</span><span class="nx">nombre</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">nombre</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">nombre</span><span class="p">(</span><span class="nx">chaine</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">somme</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span> <span class="nx">chaine</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">somme</span> <span class="o">+=</span> <span class="nx">sommeFinale</span><span class="p">(</span><span class="nx">chaine</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="nx">i</span><span class="p">))</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">sommeFinale</span><span class="p">(</span><span class="nx">somme</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">somme</span><span class="p">:</span> <span class="nx">somme</span><span class="p">,</span>
    <span class="na">sommeFinale</span><span class="p">:</span> <span class="nx">sommeFinale</span><span class="p">,</span>
    <span class="na">nombre</span><span class="p">:</span> <span class="nx">nombre</span><span class="p">,</span>
<span class="p">}</span>

</code></pre></div></div>

<blockquote>
  <p><strong>Nota Bene :</strong> On a pas ici traité le cas particuliers des prénoms valant 11, 22, ou 33;</p>
</blockquote>

<h2 id="une-page-web">Une page web</h2>

<p>On va créer une page <em>index.html</em> qui nous permettra d’associer un chiffre à chaque prénom</p>

<p>On va d’abord créer le html puis le rendre joli et enfin ajouter le js.</p>

<h3 id="html">html</h3>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;!doctype html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">"fr"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;head&gt;</span>
        <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"utf-8"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;title&gt;</span>Numérologie<span class="nt">&lt;/title&gt;</span>
    <span class="nt">&lt;/head&gt;</span>
    <span class="nt">&lt;body&gt;</span>
        <span class="nt">&lt;form&gt;</span>
            <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">"prenom"</span><span class="nt">&gt;</span>Prénom :<span class="nt">&lt;/label&gt;</span>
            <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">"prenom"</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">name=</span><span class="s">"prenom"</span><span class="nt">/&gt;</span>

            <span class="nt">&lt;button</span> <span class="na">type=</span><span class="s">"submit"</span><span class="nt">&gt;</span>Envoi<span class="nt">&lt;/button&gt;</span>
        <span class="nt">&lt;/form&gt;</span>
        <span class="nt">&lt;p&gt;</span>7<span class="nt">&lt;/p&gt;</span>
    <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>

</code></pre></div></div>

<h3 id="css">css</h3>

<p>On va le rendre joli. D’abord en mettant un peu de css puis en ajoutant la lib <a href="https://purecss.io/">purecss</a>.</p>

<h4 id="maincss">main.css</h4>

<div class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">html</span><span class="o">,</span> <span class="nt">body</span> <span class="p">{</span>
    <span class="nl">margin</span><span class="p">:</span> <span class="m">0</span><span class="p">;</span>
    <span class="nl">background-color</span><span class="p">:</span> <span class="no">azure</span><span class="p">;</span>
<span class="p">}</span>

<span class="nc">.body</span> <span class="p">{</span>
    <span class="nl">margin-top</span><span class="p">:</span> <span class="m">100px</span><span class="p">;</span>
    <span class="nl">margin-left</span><span class="p">:</span> <span class="nb">auto</span><span class="p">;</span>
    <span class="nl">margin-right</span><span class="p">:</span> <span class="nb">auto</span><span class="p">;</span>
    <span class="nl">width</span><span class="p">:</span> <span class="m">600px</span><span class="p">;</span>
    <span class="nl">text-align</span><span class="p">:</span> <span class="nb">center</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">p</span> <span class="p">{</span>
    <span class="nl">font-size</span><span class="p">:</span> <span class="m">100px</span><span class="p">;</span>
<span class="p">}</span>

</code></pre></div></div>

<p>en modifiant un peu le html :</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;!doctype html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">"fr"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;head&gt;</span>
        <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"utf-8"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;title&gt;</span>Numérologie<span class="nt">&lt;/title&gt;</span>

        <span class="nt">&lt;link</span> <span class="na">href=</span><span class="s">"main.css"</span> <span class="na">rel=</span><span class="s">"stylesheet"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;/head&gt;</span>
    <span class="nt">&lt;body&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"body"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;form&gt;</span>
                <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">"prenom"</span><span class="nt">&gt;</span>Prénom :<span class="nt">&lt;/label&gt;</span>
                <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">"prenom"</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">name=</span><span class="s">"prenom"</span><span class="nt">/&gt;</span>

                <span class="nt">&lt;button</span> <span class="na">type=</span><span class="s">"submit"</span><span class="nt">&gt;</span>Envoi<span class="nt">&lt;/button&gt;</span>
            <span class="nt">&lt;/form&gt;</span>
            <span class="nt">&lt;p&gt;</span>7<span class="nt">&lt;/p&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div>

<h4 id="on-ajoute-purecss">on ajoute purecss</h4>

<p>Pour cela on va le rajouter à nos dépendances du projet : <code class="language-plaintext highlighter-rouge">yarn add purecss</code></p>

<p>E l’ajouter, avec son style dans le <em>index.html</em> :</p>

<ul>
  <li>on le rajoute avant le link du <em>main.css</em> car on doit avoir le dernier mot pour les propriétés css</li>
  <li>on prend la version <em>-min</em> qui est “minified” pour être chargée plus vite.</li>
</ul>

<p>On a du coup :</p>

<p><em>main.css</em> :</p>

<div class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">html</span><span class="o">,</span> <span class="nt">body</span> <span class="p">{</span>
    <span class="nl">margin</span><span class="p">:</span> <span class="m">0</span><span class="p">;</span>
    <span class="nl">background-color</span><span class="p">:</span> <span class="no">azure</span><span class="p">;</span>
<span class="p">}</span>

<span class="nc">.body</span> <span class="p">{</span>
    <span class="nl">margin-top</span><span class="p">:</span> <span class="m">100px</span><span class="p">;</span>
    <span class="nl">margin-left</span><span class="p">:</span> <span class="nb">auto</span><span class="p">;</span>
    <span class="nl">margin-right</span><span class="p">:</span> <span class="nb">auto</span><span class="p">;</span>
    <span class="nl">width</span><span class="p">:</span> <span class="m">600px</span><span class="p">;</span>
    <span class="nl">text-align</span><span class="p">:</span> <span class="nb">center</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">p</span> <span class="p">{</span>
    <span class="nl">margin-top</span><span class="p">:</span> <span class="m">0</span><span class="p">;</span>
    <span class="nl">margin-bottom</span><span class="p">:</span> <span class="m">0</span><span class="p">;</span>
    <span class="nl">font-family</span><span class="p">:</span> <span class="s2">'Lobster'</span><span class="p">,</span> <span class="nb">cursive</span><span class="p">;</span>
    <span class="nl">font-size</span><span class="p">:</span> <span class="m">200px</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p><em>index.html</em> :</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;!doctype html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">"fr"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;head&gt;</span>
        <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"utf-8"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;title&gt;</span>Numérologie<span class="nt">&lt;/title&gt;</span>

        <span class="nt">&lt;link</span> <span class="na">href=</span><span class="s">"./node_modules/purecss/build/pure-min.css"</span> <span class="na">rel=</span><span class="s">"stylesheet"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;link</span> <span class="na">href=</span><span class="s">"https://fonts.googleapis.com/css2?family=Lobster&display=swap"</span> <span class="na">rel=</span><span class="s">"stylesheet"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;link</span> <span class="na">href=</span><span class="s">"main.css"</span> <span class="na">rel=</span><span class="s">"stylesheet"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;/head&gt;</span>
    <span class="nt">&lt;body&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"body"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;form</span> <span class="na">class=</span><span class="s">"pure-form"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">"prenom"</span><span class="nt">&gt;</span>Prénom :<span class="nt">&lt;/label&gt;</span>
                <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">"prenom"</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">name=</span><span class="s">"prenom"</span><span class="nt">/&gt;</span>

                <span class="nt">&lt;button</span> <span class="na">type=</span><span class="s">"submit"</span><span class="na">class=</span><span class="s">"pure-button pure-button-primary"</span><span class="nt">&gt;</span>Envoi<span class="nt">&lt;/button&gt;</span>
            <span class="nt">&lt;/form&gt;</span>
            <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"pure-g"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"pure-u-1-3"</span><span class="nt">&gt;&lt;/div&gt;</span>
                <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"pure-u-1-3"</span><span class="nt">&gt;&lt;p&gt;</span>7<span class="nt">&lt;/p&gt;&lt;/div&gt;</span>
                <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"pure-u-1-3"</span><span class="nt">&gt;&lt;/div&gt;</span>
            <span class="nt">&lt;/div&gt;</span>

        <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div>

<h3 id="js">js</h3>

<p>Pour l’instant appuyer sur le bouton ne sert à rien. On va donc faire en sorte que lorsque’on appuie sur le bouton le chiffre change.</p>

<p>On ne peut pas utiliser require dans le browser… Pour le pas avoir besoin de compiler notre js on fait des choses un peu sales.</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;!doctype html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">"fr"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;head&gt;</span>
        <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"utf-8"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;title&gt;</span>Numérologie<span class="nt">&lt;/title&gt;</span>

        <span class="nt">&lt;link</span> <span class="na">href=</span><span class="s">"./node_modules/purecss/build/pure-min.css"</span> <span class="na">rel=</span><span class="s">"stylesheet"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;link</span> <span class="na">href=</span><span class="s">"https://fonts.googleapis.com/css2?family=Lobster&display=swap"</span> <span class="na">rel=</span><span class="s">"stylesheet"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;link</span> <span class="na">href=</span><span class="s">"main.css"</span> <span class="na">rel=</span><span class="s">"stylesheet"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;/head&gt;</span>
    <span class="nt">&lt;body&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"body"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;form</span> <span class="na">class=</span><span class="s">"pure-form"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">"prenom"</span><span class="nt">&gt;</span>Prénom :<span class="nt">&lt;/label&gt;</span>
                <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">"prenom"</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">name=</span><span class="s">"prenom"</span><span class="nt">/&gt;</span>

                <span class="nt">&lt;button</span> <span class="na">id=</span><span class="s">"button-form"</span> <span class="na">type=</span><span class="s">"submit"</span> <span class="na">class=</span><span class="s">"pure-button pure-button-primary"</span><span class="nt">&gt;</span>Envoi<span class="nt">&lt;/button&gt;</span>
            <span class="nt">&lt;/form&gt;</span>
            <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"pure-g"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"pure-u-1-3"</span><span class="nt">&gt;&lt;/div&gt;</span>
                <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"pure-u-1-3"</span><span class="nt">&gt;&lt;p</span> <span class="na">id=</span><span class="s">"get-value"</span><span class="nt">&gt;</span>7<span class="nt">&lt;/p&gt;&lt;/div&gt;</span>
                <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"pure-u-1-3"</span><span class="nt">&gt;&lt;/div&gt;</span>
            <span class="nt">&lt;/div&gt;</span>

        <span class="nt">&lt;/div&gt;</span>

        <span class="nt">&lt;script&gt;</span>
         <span class="nx">module</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="nt">&lt;/script&gt;</span>
        <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"numerologie.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
        <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"main.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
    <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div>

<p><em>main.js</em></p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">change_value</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">prenom</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="dl">"</span><span class="s2">#prenom</span><span class="dl">"</span><span class="p">).</span><span class="nx">value</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">prenom</span><span class="p">)</span> <span class="p">{</span>
        <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="dl">"</span><span class="s2">#get-value</span><span class="dl">"</span><span class="p">).</span><span class="nx">textContent</span> <span class="o">=</span> <span class="nx">nombre</span><span class="p">(</span><span class="nx">prenom</span><span class="p">)</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="dl">"</span><span class="s2">#get-value</span><span class="dl">"</span><span class="p">).</span><span class="nx">textContent</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">?</span><span class="dl">"</span>
    <span class="p">}</span>

<span class="p">}</span>
<span class="nx">change_value</span><span class="p">()</span>

<span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="dl">"</span><span class="s2">#button-form</span><span class="dl">"</span><span class="p">).</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">"</span><span class="s2">click</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">change_value</span><span class="p">()</span>
    <span class="nx">event</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">()</span>
<span class="p">})</span>
</code></pre></div></div>

<blockquote>
  <p><strong>Nota Bene :</strong> on pourrait ajouter une animation pour savoir que le code est exécuté.</p>
</blockquote>

<h2 id="on-met-en-prod-">on met en prod !</h2>

<p>On envoie le tout sur l’ovh !</p>

<ol>
  <li>une fois sur l’ovh (on fait attention d’être bien parti avec son agent) on clone notre répo dans le dossier <code class="language-plaintext highlighter-rouge">~/www</code>
</li>
  <li>on procède à un <code class="language-plaintext highlighter-rouge">yarn install --production</code> qui va mettre à jour tous nos packages, exepté ceux liés au développement. On a donc uniquement <code class="language-plaintext highlighter-rouge">purecss</code>. Comparez avec la taille en dev.</li>
</ol>

<h2 id="tests-fonctionnelsusers-stories">tests fonctionnels/users stories</h2>

<p>Lorsque l’on fabrique un site, on a envie de l’utiliser d’une certaine manière, de pouvoir naviguer et récupérer des informations. On peut regrouper ces utilisations en  petites saynètes d’utilisation 
appelées <em>user stories</em>.</p>

<p>On a déjà notre première user story, c’est notre but. Il est atteint puisqu’on peut faire cette user story sur l’ovh.</p>

<p>Comme toujours, on va automatiser ce processus en utilisant un script qui fera les manipulation et vérifiera le résultat pour nous.</p>

<h3 id="selenium">selenium</h3>

<p><a href="https://www.selenium.dev/">selenium</a> est un outil, écrit en java, qui permet d’automatiser un browser.</p>

<p>Cet outils est très générique car :
    - de nombreux browsers sont supportés
    - on peut utiliser selenium en codant avec de nombreux langages.</p>

<p>Avant d’utiliser selenium pour notre site, faisons le fonctionner.</p>

<h4 id="exemple-1">exemple</h4>

<p>Pour que l’on puisse faire fonctionner selenium vous devez avoir un java d’installé (vous devriez le faire avec <a href="https://sdkman.io/">sdkman</a>)</p>

<p>On va avoir besoin de plusieurs bibliothèques : <code class="language-plaintext highlighter-rouge">yarn add --dev selenium-webdriver chromedriver</code> :</p>

<ul>
  <li>
<code class="language-plaintext highlighter-rouge">selenium-webdriver</code> est selenium proprement dit,</li>
  <li>un driver de navigateur (<code class="language-plaintext highlighter-rouge">geckodriver</code> pour firefox ou <code class="language-plaintext highlighter-rouge">chromedriver</code> pour chrome)</li>
</ul>

<p>Pour finir la paramétrisation, voilà le <em>package.json</em> avec les deux driver de navigateurs installés :</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{
  "name": "selenium_jest",
  "version": "1.0.0",
  "main": "index.js",
  "license": "MIT",
  "devDependencies": {
    "geckodriver": "^1.20.0",
    "jest": "^26.5.2",
    "selenium-webdriver": "^4.0.0-alpha.7",
    "chromedriver": "85.0.0"
  }
}
</code></pre></div></div>

<blockquote>
  <p><strong>Nota Bene :</strong> On a mis la version 85 de chromedriver car la version 86 n’est pas encore supportée chez moi.</p>
</blockquote>

<p>On place notre premier essai dans le fichier : <em>user-story/look-at-google.user-story.js</em> (on a pas mis l’extension test sinon il serait exécuté tout le temps avec les tests unitaires et ça prend un peu de temps…)</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kd">var</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">fs</span><span class="dl">'</span><span class="p">);</span>

<span class="kd">const</span> <span class="nx">url</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">https://www.google.com</span><span class="dl">'</span>



<span class="kd">const</span> <span class="p">{</span><span class="nx">By</span><span class="p">,</span> <span class="nx">Key</span><span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">selenium-webdriver</span><span class="dl">'</span><span class="p">);</span>

<span class="kd">const</span> <span class="nx">webdriver</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">selenium-webdriver</span><span class="dl">'</span><span class="p">);</span>
 
 
<span class="nx">describe</span><span class="p">(</span><span class="dl">'</span><span class="s1">Google renders</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>

    <span class="c1">// beforeEach(() =&gt; {</span>
    <span class="c1">//     require('chromedriver');</span>
    <span class="c1">//     browser =  new webdriver.Builder().forBrowser('chrome').build()</span>
    <span class="c1">// })</span>

    <span class="nx">beforeEach</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">geckodriver</span><span class="dl">'</span><span class="p">);</span>
        <span class="nx">browser</span> <span class="o">=</span>  <span class="k">new</span> <span class="nx">webdriver</span><span class="p">.</span><span class="nx">Builder</span><span class="p">().</span><span class="nx">forBrowser</span><span class="p">(</span><span class="dl">'</span><span class="s1">firefox</span><span class="dl">'</span><span class="p">).</span><span class="nx">build</span><span class="p">()</span>
    <span class="p">})</span>


  <span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">it renders</span><span class="dl">'</span><span class="p">,</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">await</span> <span class="nx">browser</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span>
    <span class="kd">const</span> <span class="nx">title</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">browser</span><span class="p">.</span><span class="nx">getTitle</span><span class="p">()</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">title</span><span class="p">).</span><span class="nx">toContain</span><span class="p">(</span><span class="dl">'</span><span class="s1">Google</span><span class="dl">'</span><span class="p">)</span>
  <span class="p">})</span>

  <span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">save a picture</span><span class="dl">'</span><span class="p">,</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="c1">// files saved in ./reports/screenshots by default</span>
        <span class="k">await</span> <span class="nx">browser</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span>
        <span class="kd">const</span> <span class="nx">iframe</span> <span class="o">=</span> <span class="nx">browser</span><span class="p">.</span><span class="nx">findElement</span><span class="p">(</span><span class="nx">By</span><span class="p">.</span><span class="nx">css</span><span class="p">(</span><span class="dl">'</span><span class="s1">iframe</span><span class="dl">'</span><span class="p">));</span>
        <span class="k">await</span> <span class="nx">browser</span><span class="p">.</span><span class="nx">switchTo</span><span class="p">().</span><span class="nx">frame</span><span class="p">(</span><span class="nx">iframe</span><span class="p">);</span>
      
        <span class="k">await</span> <span class="nx">browser</span><span class="p">.</span><span class="nx">findElement</span><span class="p">(</span><span class="nx">By</span><span class="p">.</span><span class="nx">id</span><span class="p">(</span><span class="dl">"</span><span class="s2">introAgreeButton</span><span class="dl">"</span><span class="p">)).</span><span class="nx">click</span><span class="p">()</span>

        <span class="k">await</span> <span class="nx">browser</span><span class="p">.</span><span class="nx">switchTo</span><span class="p">().</span><span class="nx">defaultContent</span><span class="p">();</span>
        <span class="k">await</span> <span class="nx">browser</span><span class="p">.</span><span class="nx">findElement</span><span class="p">(</span><span class="nx">By</span><span class="p">.</span><span class="nx">name</span><span class="p">(</span><span class="dl">"</span><span class="s2">q</span><span class="dl">"</span><span class="p">)).</span><span class="nx">sendKeys</span><span class="p">(</span><span class="dl">"</span><span class="s2">Carole Deumié</span><span class="dl">"</span><span class="p">,</span> <span class="nx">Key</span><span class="p">.</span><span class="nx">ENTER</span><span class="p">);</span>
      
      
        <span class="nx">browser</span><span class="p">.</span><span class="nx">takeScreenshot</span><span class="p">().</span><span class="nx">then</span><span class="p">((</span><span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
          <span class="nx">fs</span><span class="p">.</span><span class="nx">writeFileSync</span><span class="p">(</span><span class="dl">'</span><span class="s1">img.png</span><span class="dl">'</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="dl">'</span><span class="s1">base64</span><span class="dl">'</span><span class="p">)</span>
        <span class="p">})</span>
    <span class="p">},</span> <span class="mi">10000</span><span class="p">)</span>
    
    <span class="nx">afterEach</span><span class="p">(</span><span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="k">await</span> <span class="nx">browser</span><span class="p">.</span><span class="nx">quit</span><span class="p">()</span>
    <span class="p">})</span>
<span class="p">})</span>
</code></pre></div></div>

<p>Que l’on lance avec la commande : <code class="language-plaintext highlighter-rouge">yarn run test --testRegex="user-story.js"</code></p>

<p>Testez le. Ca fait plein de trucs. Attention, c’est comme si vous faisiez une naviguation privée, auun cookie n’est placé. <a href="https://www.selenium.dev/documentation/en/getting_started/">La doc</a> est très bien faite et explique beaucoup de choses.</p>

<p>Les commandes <code class="language-plaintext highlighter-rouge">await</code> (et <code class="language-plaintext highlighter-rouge">async</code> que vous ne voyez pas là mais qui existent) permettent de gérer les événemnts asynchrones (le temps que la commande se fasse). C’est lié aux <a href="https://developer.mozilla.org/fr/docs/Web/JavaScript/Guide/Utiliser_les_promesses">Promises</a>. Regardez ce <a href="https://www.grafikart.fr/tutoriels/promise-async-await-875">tuto</a> si vous voulez tout savoir sur les promesses (le tuto date un peu donc tout ce qu’il dit est maintenant implémenté dans les browser modernes. Vous pouvez le voir sur <a href="https://caniuse.com/?search=async">ce site</a> par exemple).</p>

<p>Enfin, on a augmenté le temps disponible du second test à 10s.</p>

<h4 id="tests-en-local">tests en local</h4>

<p>On ne va pas faire nos tests en production. On aimerait tout tester en local, comme nos tests unitaires. Pour l’instant on peut utiliser le protocole file des browser.</p>

<p><em>numerologie.user-story.js</em> :</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * @jest-environment jest-environment-webdriver
 */</span>

<span class="kd">var</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">fs</span><span class="dl">'</span><span class="p">);</span>

<span class="kd">const</span> <span class="nx">url</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">file://</span><span class="dl">"</span> <span class="o">+</span> <span class="nx">__dirname</span> <span class="o">+</span><span class="dl">'</span><span class="s1">/../index.html</span><span class="dl">'</span>



<span class="nx">describe</span><span class="p">(</span><span class="dl">'</span><span class="s1">Le site fonctionne</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">it renders</span><span class="dl">'</span><span class="p">,</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">await</span> <span class="nx">browser</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span>
    <span class="kd">const</span> <span class="nx">title</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">browser</span><span class="p">.</span><span class="nx">getTitle</span><span class="p">()</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">title</span><span class="p">).</span><span class="nx">toContain</span><span class="p">(</span><span class="dl">'</span><span class="s1">Numérologie</span><span class="dl">'</span><span class="p">)</span>
  <span class="p">})</span>
<span class="p">})</span>

</code></pre></div></div>

<h4 id="pour-notre-site">pour notre site</h4>

<p>Transformons notre user-story en test selenium.</p>

<p>TBD</p>

<h2 id="node-1">node</h2>

<p>Nos allons enfin utiliser <a href="https://nodejs.org/en/">node</a> sous la forme d’un serveur web.</p>

<p>On a souvent besoin d’un petit serveur web, en particulier pour la gestion des données. L’usage courant est de faire son appli front avec une bibliothèque front comme <a href="https://vuejs.org/">vuejs</a> ou <a href="https://fr.reactjs.org/">react</a> et de gérer les données via le serveur node (en utilsant une architecture <a href="https://fr.wikipedia.org/wiki/Representational_state_transfer">REST</a> et/ou <a href="https://graphql.org/">graphql</a>).</p>

<p>Cette partie sera décorrelée  du site front. On y reviendra lorsque l’on utilisera <a href="https://expressjs.com/fr/">express</a>, un module quasi indispensable pour créer des serveur web en node. On expliquera ici comment fonctionne node et son utilisation avec l’ovh.</p>

<h3 id="mon-premier-serveur-node">mon premier serveur node</h3>

<p>On va le mettre dans le fichier <em>index.js</em> qui était là depuis le début dans le fichier <em>package.json</em>.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kd">const</span> <span class="nx">hostname</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">127.0.0.1</span><span class="dl">'</span><span class="p">;</span>
<span class="kd">const</span> <span class="nx">port</span> <span class="o">=</span> <span class="mi">3000</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">server</span> <span class="o">=</span> <span class="nx">http</span><span class="p">.</span><span class="nx">createServer</span><span class="p">((</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">statusCode</span> <span class="o">=</span> <span class="mi">200</span><span class="p">;</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">setHeader</span><span class="p">(</span><span class="dl">'</span><span class="s1">Content-Type</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">text/plain</span><span class="dl">'</span><span class="p">);</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="dl">'</span><span class="s1">Hello World</span><span class="se">\n</span><span class="dl">'</span><span class="p">);</span>
<span class="p">});</span>

<span class="nx">server</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">port</span><span class="p">,</span> <span class="nx">hostname</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`Server running at http://</span><span class="p">${</span><span class="nx">hostname</span><span class="p">}</span><span class="s2">:</span><span class="p">${</span><span class="nx">port</span><span class="p">}</span><span class="s2">/`</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div></div>

<p>On exécute ce fichier en console : <code class="language-plaintext highlighter-rouge">node index.js</code></p>

<p>Et on peut ensuite voir le résultat dans un navigateur à l’url : http://localhost:3000.</p>

<p>Le code précédent crée un serveur <em>http</em> qui répond toujours la même chose dès qu’on le contacte. Il affiche en log la requête reçue, qui elle dépend de l’url donnée.</p>

<p>Regardons le code de près :</p>

<ul>
  <li>
<code class="language-plaintext highlighter-rouge">const</code> : déclaration de constantes. Changer port par exemple produit une erreur.</li>
  <li>
<code class="language-plaintext highlighter-rouge">require</code> : importation d’une bibliothèque  et affectation de celle-ci à une constante.</li>
  <li>les fonctions peuvent se créer à la volée avec : <code class="language-plaintext highlighter-rouge">nomFonction((paramètres) =&gt; {})</code>
</li>
  <li>création d’un objet serveur avec une fonction ayant 2 paramètres, la requête et la réponse (voir <a href="https://nodejs.org/dist/latest-v14.x/docs/api/http.html#http_http_createserver_options_requestlistener">doc</a>).</li>
  <li>
<code class="language-plaintext highlighter-rouge">listen</code> : lien entre le serveur et le couple adresse + port.</li>
</ul>

<p>On peut afficher l’url de la requête : On récupère les variables <em>hostname</em> et <em>port</em> et on les affiche dans la console.</p>

<p>Détails, en utilisant la <a href="https://nodejs.org/en/docs/">documentation</a> de nodejs :</p>

<ul>
  <li>
<code class="language-plaintext highlighter-rouge">http</code> : C’est le module s’occupant des échanges et du codage des données.</li>
  <li>
<code class="language-plaintext highlighter-rouge">http.createServer</code> : demande un <a href="https://www.w3schools.com/nodejs/func_http_requestlistener.asp"><code class="language-plaintext highlighter-rouge">requestListener</code></a> qui est ajouté à l’événement request.</li>
  <li>event request : deux paramètres <code class="language-plaintext highlighter-rouge">http.IncomingMessage</code>  et <code class="language-plaintext highlighter-rouge">http.ServerResponse</code>. Il est émit à chaque fois qu’un <em>request</em> est demandé</li>
  <li>
<code class="language-plaintext highlighter-rouge">http.IncomingMessage</code> a un attribut url : il sert à générer le <em>Readable Stream interface</em> et beaucoup d’autres choses (événements, méthodes, …).</li>
</ul>

<p>La <a href="https://nodejs.org/api/">documentation</a> de nodejs est très bien faite. Trouvez tous les éléments mentionnés ci-dessus.</p>

<p>Tout est orienté autour d’évènements auxquels le serveur doit répondre.</p>

<h3 id="on-regarde-ce-que-ça-donne-sur-lovh">on regarde ce que ça donne sur l’ovh</h3>

<p>Le serveur est local. Pour l’exécuter sur l’ovh il va falloir faire des trucs.</p>

<h4 id="ports">ports</h4>

<p>La configuration du serveur est la suivante :</p>

<ul>
  <li>chaque étudiant a un certain nombre de ports alloués pour ses serveurs, un par techno. Les ports sont visibles dans le fichier <em>readme.txt</em> à la racine de votre site.</li>
  <li>le nginx de l’ovh enverra toutes les requêtes arrivant pour l’adresse <code class="language-plaintext highlighter-rouge">node.herbe.ovh1.ec-m.fr</code> (où <em>herbe</em> est votre herbe) à <code class="language-plaintext highlighter-rouge">127.0.0.1:port</code> (où <em>pour</em> est votre port)</li>
</ul>

<p>La conf du <a href="https://www.nginx.com/">nginx</a> (<a href="https://www.grafikart.fr/tutoriels/nginx-692">un petit tuto</a>) est :</p>

<ol>
  <li>chargée lors du lancement du démon et est le fichier <em>/etc/nginx.conf</em>
</li>
  <li>ce fichier charge tous les fichiers de <em>/etc/nginx/conf.d/*.conf</em>
</li>
  <li>regardons celui appelé <em>nodejs.conf</em> :
    - il regarde la liste des port par herbe
    - et envoie toutes les requêtes sur le démon qui écoute le port de votre herbe
    - il n’envoie cependant pas les adresse qui commencent par <code class="language-plaintext highlighter-rouge">/static</code> qui eux sont traitées directement en cherchant un fichier dans le dossier <em>static/</em> du <code class="language-plaintext highlighter-rouge">root</code> de cette configuration : <code class="language-plaintext highlighter-rouge">/home/$user/node</code>.</li>
</ol>

<h4 id="exemple-dorganisation">exemple d’organisation</h4>

<p>dans le dossier <code class="language-plaintext highlighter-rouge">~/node</code></p>

<ul>
  <li>un fichier <em>index.js</em> qui va contenir notre serveur</li>
  <li>un dossier static contenant une image <code class="language-plaintext highlighter-rouge">img.png</code>
</li>
</ul>

<p>Par défaut l’adresse <code class="language-plaintext highlighter-rouge">http://node.herbe.ovh1.ec-m.fr</code> ne rend rien, juste un <a href="https://http.cat/502">502</a>.</p>

<p>Lançons notre serveur ! (mais pas trop loin) : <code class="language-plaintext highlighter-rouge">node index.js</code> :</p>

<ul>
  <li>Maintenant l’adresse fonctionne et nous accueille avec un <code class="language-plaintext highlighter-rouge">Hello World</code> bien mérité.</li>
  <li>
<code class="language-plaintext highlighter-rouge">http://node.herbe.ovh1.ec-m.fr/static/img.png</code> fonctionne aussi.</li>
</ul>

<p>Sauf qu’en se déconnectant, le terminal et tous ses process attachés disparaissent, dont notre serveur.</p>

<p>En revanche, l’adresse  <code class="language-plaintext highlighter-rouge">http://node.herbe.ovh1.ec-m.fr/static/img.png</code> continue de fonctionner puisqu’elle n’est pas dépendante du serveur node…</p>

<h4 id="le-démon">le démon</h4>

<p>On va utiliser la commande <a href="https://linuxize.com/post/how-to-use-linux-screen/">screen</a> qui nous permet de détacher des process. Elle possède pleins de paramètres mais, pour nous, on va exécuter le screen avec la commande : <code class="language-plaintext highlighter-rouge">/usr/bin/screen -d -m -S node node index.js</code> :</p>

<ul>
  <li>-S : When creating a new session, this option can be used to specify a meaningful name for the session. This name  identifies
        the session for “screen -list” and “screen -r” actions. It substitutes the default [tty.host] suffix.</li>
  <li>-d -m :  Start  screen  in  “detached”  mode.  This  creates a new session but doesn’t attach to it. This is useful for system startup scripts.</li>
</ul>

<p>Après la commande, l’adresse <code class="language-plaintext highlighter-rouge">http://node.herbe.ovh1.ec-m.fr</code> répond, et on peut se déconnecter, ça marche toujours.</p>

<p>Le process <code class="language-plaintext highlighter-rouge">screen</code> est détaché de notre shell et reste donc effectif après déconnection. On le retrouve en regardant tous nos processes : <code class="language-plaintext highlighter-rouge">ps aux | grep herbe</code>. On retrouve le process <em>screen</em>. On va le tuer et voir ce qu’il se passe : <code class="language-plaintext highlighter-rouge">kill numero_du_process</code> (le premier numéro). Le serveur a disparu et le process aussi.</p>

<p>Relançons le : <code class="language-plaintext highlighter-rouge">/usr/bin/screen -d -m -S node node index.js</code>. On peut manager ses process screen sans avoir beoin de les tuer sauvagement avec <a href="https://korben.info/commande-kill-linux-tuer-processus.html">kill</a> :</p>

<ul>
  <li>
<code class="language-plaintext highlighter-rouge">screen -ls</code> : trouve les différents screen</li>
  <li>
<code class="language-plaintext highlighter-rouge">screen -X -S [nom de la session à tuer, pour nous node] quit</code> : tue le screen</li>
</ul>

<h4 id="conf-dun-app-node">conf d’un app node</h4>

<ul>
  <li>front dans <code class="language-plaintext highlighter-rouge">~/node/static/</code>. Les fichiers html, css de l’app mais aussi ses node_modules. Le mieux est de faire un lien de votre dossier front vers <em>static</em>
</li>
  <li>back dans le dossier <code class="language-plaintext highlighter-rouge">~ /node/</code> avec ses fichiers js, mais aussi ses templates si vous en avez et son dossier node_module</li>
</ul>

<h3 id="globaux-et-asynchrones">Globaux et Asynchrones</h3>

<p>Node est un interpréteur javascript, mais sa grande force est dans ses modules et son fonctionnement purement asynchrone :</p>

<blockquote>
  <p>Lorsque cet évènement se produit ou lorsque j’ai fini de faire quelque chose, j’exécute une fonction.</p>
</blockquote>

<p>Par exemple, on utilise la méthode <code class="language-plaintext highlighter-rouge">setInterval</code> utilisable par défaut en node car définit dans https://nodejs.org/api/globals.html</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">affiche_bloup</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">bloup</span><span class="dl">"</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">timer1</span> <span class="o">=</span> <span class="nx">setInterval</span><span class="p">(</span> <span class="nx">affiche_bloup</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span> <span class="c1">// un intervalle</span>

<span class="kd">var</span> <span class="nx">timer2</span> <span class="o">=</span> <span class="nx">setInterval</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="c1">// un deuxième avec une function anonyme</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">bim</span><span class="dl">"</span><span class="p">)</span>
<span class="p">},</span> <span class="mi">2000</span><span class="p">)</span>
</code></pre></div></div>

<p>Tout est asynchrone, lorsque la condition est vérifiée la fonction est exécutée. On peut donc en ajouter plusieurs sans problème.</p>

<h3 id="les-routes">les routes</h3>

<p>Le but d’un serveur web est de répondre à des requêtes (une url). Cette réponse peut être beaucoup de choses (défini dans son <a href="https://developer.mozilla.org/fr/docs/Web/HTTP/Basics_of_HTTP/MIME_types/Common_types">type mime</a> qui permet au navigateur de savoir ce que c’est), les plus courantes étant du html ou des données aux format json (le reste étant souvent des fichiers statiques).</p>

<p>Nodejs gère les routes de façon assez frustre, nous utiliserons ensuite  <a href="https://expressjs.com/fr/">expressjs</a> pour gérer tout ça de façon plus simple. Mais voici un exemple avec 3 routes (une où la réponse est directe, une qui charge un fichier local et une qui charge un fichier distant) et un 404 :</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">http</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">http</span><span class="dl">'</span><span class="p">)</span>
<span class="kd">var</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">fs</span><span class="dl">'</span><span class="p">)</span>

<span class="kd">var</span> <span class="nx">server</span> <span class="o">=</span> <span class="nx">http</span><span class="p">.</span><span class="nx">createServer</span><span class="p">((</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span><span class="p">{</span>
    <span class="nx">response</span><span class="p">.</span><span class="nx">statusCode</span> <span class="o">=</span> <span class="mi">200</span><span class="p">;</span>
    <span class="nx">response</span><span class="p">.</span><span class="nx">setHeader</span><span class="p">(</span><span class="dl">'</span><span class="s1">Content-Type</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">text/html</span><span class="dl">'</span><span class="p">);</span>

    <span class="k">if</span> <span class="err">\</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">url</span> <span class="o">===</span> <span class="err">\</span><span class="dl">"</span><span class="s2">/</span><span class="se">\"</span><span class="s2"> </span><span class="se">\</span><span class="s2">|| request.url === </span><span class="se">\"</span><span class="s2">/home</span><span class="se">\"</span><span class="s2">) {
        response.writeHead(200,  {'Content-Type': 'text/html'})
        var readStream = fs.createReadStream(__dirname + </span><span class="dl">"</span><span class="o">/</span><span class="nx">index</span><span class="p">.</span><span class="nx">html</span><span class="dl">"</span><span class="s2">, </span><span class="dl">"</span><span class="nx">utf8</span><span class="dl">"</span><span class="s2">)
        readStream.pipe(response)
    }
    else if (request.url === </span><span class="dl">"</span><span class="o">/</span><span class="nx">contact</span><span class="dl">"</span><span class="s2">) {
        response.end(</span><span class="dl">"</span><span class="o">&lt;</span><span class="nx">html</span><span class="o">&gt;&lt;</span><span class="nx">head</span><span class="o">&gt;&lt;</span><span class="nx">title</span><span class="o">&gt;</span><span class="nx">contact</span><span class="o">&lt;</span><span class="sr">/title&gt;&lt;/</span><span class="nx">head</span><span class="o">&gt;&lt;</span><span class="nx">body</span><span class="o">&gt;&lt;</span><span class="nx">h1</span><span class="o">&gt;</span><span class="nx">contact</span><span class="o">&lt;</span><span class="sr">/h1&gt;&lt;/</span><span class="nx">body</span><span class="o">&gt;&lt;</span><span class="sr">/html&gt;"</span><span class="se">)</span><span class="err">;
</span>    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">url</span> <span class="o">===</span> <span class="dl">"</span><span class="s2">/lecture</span><span class="dl">"</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">response</span><span class="p">.</span><span class="nx">statusCode</span> <span class="o">=</span> <span class="mi">200</span><span class="p">;</span>
		<span class="nx">response</span><span class="p">.</span><span class="nx">setHeader</span><span class="p">(</span><span class="dl">'</span><span class="s1">Content-Type</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">text/plain</span><span class="dl">'</span><span class="p">);</span>
	
        <span class="nx">http</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">"</span><span class="s2">http://www.gutenberg.org/files/4300/4300-0.txt</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span><span class="nx">response_get</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="nx">response_get</span><span class="p">.</span><span class="nx">setEncoding</span><span class="p">(</span><span class="dl">'</span><span class="s1">utf8</span><span class="dl">'</span><span class="p">);</span>
            <span class="nx">response_get</span><span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">response</span><span class="p">)</span>
        <span class="p">})</span>
    <span class="p">}</span> 
    <span class="k">else</span> <span class="p">{</span>
        <span class="nx">response</span><span class="p">.</span><span class="nx">statusCode</span> <span class="o">=</span> <span class="mi">404</span><span class="p">;</span>
        <span class="nx">response</span><span class="p">.</span><span class="nx">setHeader</span><span class="p">(</span><span class="dl">'</span><span class="s1">Content-Type</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">text/plain</span><span class="dl">'</span><span class="p">);</span>
        <span class="nx">response</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">})</span>

<span class="nx">server</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="mi">3000</span><span class="p">,</span> <span class="dl">'</span><span class="s1">localhost</span><span class="dl">'</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">c'est parti</span><span class="dl">"</span><span class="p">)</span>
</code></pre></div></div>

<p>Notez comment un fichier local et distant sont chargés. En particulier comment la réponse du ficher distant est rendue immédiatement. Ceci permet de donner une réponse même si tout n’est pas chargé.</p>

<h2 id="express">express</h2>

<p>La gestion de différentes routes est malaisée en node pure, on se perd vite dans tous ces else/if. C’est pourquoi on va utiliser la bibliothèque <a href="https://expressjs.com/fr/">expressjs</a> à notre projet back : <code class="language-plaintext highlighter-rouge">yarn add express</code></p>

<h3 id="les-requêtes-en-express">les requêtes en express</h3>

<p>Comme toute bibliothèque node pour l’utiliser on utilise <code class="language-plaintext highlighter-rouge">require</code> :</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">express</span><span class="dl">'</span><span class="p">)</span>
<span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">()</span>
</code></pre></div></div>

<p>Notez que l’import est une fonction, ce qui permettrait de passer des paramètres à l’app express si besoin.</p>

<p>Tout va maintenant passer via l’objet <code class="language-plaintext highlighter-rouge">app</code>. Chaque requête va passer dans les appels successifs jusqu’à être <em>“consommée”</em>.</p>

<p>On utilisera essentiellement quatre méthodes de <code class="language-plaintext highlighter-rouge">app</code> :</p>

<ul>
  <li>
<code class="language-plaintext highlighter-rouge">app.set()</code> : qui s’occupe des paramètres de express,</li>
  <li>
<code class="language-plaintext highlighter-rouge">app.use()</code> : qui reçoit toutes les requêtes</li>
  <li>
<code class="language-plaintext highlighter-rouge">app.get()</code>, <code class="language-plaintext highlighter-rouge">app.post()</code> : qui reçoivent respectivement les requêtes http get et post.</li>
</ul>

<p>Avant d’expliquer comment tout ça se passe, regardons un exemple en recréant un fichier <em>index.js</em> utilisant express dans notre projet :</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kd">var</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">express</span><span class="dl">'</span><span class="p">)</span>
<span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">()</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">Time:</span><span class="dl">'</span><span class="p">,</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">());</span>
    <span class="nx">next</span><span class="p">();</span> <span class="c1">// sans cette ligne on ne pourra pas poursuivre.</span>
<span class="p">})</span>



<span class="nx">app</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">response</span><span class="p">.</span><span class="nx">statusCode</span> <span class="o">=</span> <span class="mi">200</span><span class="p">;</span>
    <span class="nx">response</span><span class="p">.</span><span class="nx">setHeader</span><span class="p">(</span><span class="dl">'</span><span class="s1">Content-Type</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">text/html</span><span class="dl">'</span><span class="p">);</span>

    <span class="nx">response</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="dl">"</span><span class="s2">&lt;html&gt;&lt;head&gt;&lt;title&gt;index&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&lt;h1&gt;Hello world&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;</span><span class="dl">"</span><span class="p">);</span>
<span class="p">})</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">ensuite</span><span class="dl">"</span><span class="p">);</span>
    <span class="nx">next</span><span class="p">();</span> <span class="c1">// sans cette ligne on ne pourra pas poursuivre.</span>
<span class="p">})</span>

<span class="nx">app</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/contact</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">response</span><span class="p">.</span><span class="nx">statusCode</span> <span class="o">=</span> <span class="mi">200</span><span class="p">;</span>
    <span class="nx">response</span><span class="p">.</span><span class="nx">setHeader</span><span class="p">(</span><span class="dl">'</span><span class="s1">Content-Type</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">text/html</span><span class="dl">'</span><span class="p">);</span>

    <span class="nx">response</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="dl">"</span><span class="s2">&lt;html&gt;&lt;head&gt;&lt;title&gt;contact&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&lt;h1&gt;contact&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;</span><span class="dl">"</span><span class="p">);</span>
<span class="p">})</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">request</span><span class="p">,</span><span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">et c'est le 404</span><span class="dl">"</span><span class="p">);</span>
    
    <span class="nx">response</span><span class="p">.</span><span class="nx">statusCode</span> <span class="o">=</span> <span class="mi">404</span><span class="p">;</span>
    <span class="nx">response</span><span class="p">.</span><span class="nx">setHeader</span><span class="p">(</span><span class="dl">'</span><span class="s1">Content-Type</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">text/html</span><span class="dl">'</span><span class="p">);</span>

    <span class="nx">response</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="dl">"</span><span class="s2">&lt;html&gt;&lt;head&gt;&lt;title&gt;quatre cent quatre&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&lt;h1&gt;404&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;</span><span class="dl">"</span><span class="p">);</span>
    
<span class="p">})</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="mi">3000</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">c'est parti</span><span class="dl">"</span><span class="p">)</span>
</code></pre></div></div>

<p>Lorsque vous exécutez votre code vous voyez des choses qui s’affichent dans la console :</p>

<ul>
  <li>
<em>“Time”</em> s’affiche à chaque appel</li>
  <li>
<em>“ensuite”</em> ne s’affiche que si notre requête est différente de ‘/’</li>
  <li>
<em>“et c’est le 404”</em> s’affiche si l’on demande une url différente de <code class="language-plaintext highlighter-rouge">/</code> ou <code class="language-plaintext highlighter-rouge">contact</code>
</li>
</ul>

<p>Ceci s’explique par les différentes manières dont peuvent s’appeler les méthodes de <code class="language-plaintext highlighter-rouge">app</code> :</p>

<ul>
  <li>
    <p>un unique paramètre qui est une <code class="language-plaintext highlighter-rouge">fonction(request, response)</code> :</p>
  </li>
  <li>un unique paramètre qui est une <code class="language-plaintext highlighter-rouge">fonction(request, response, next)</code>
</li>
  <li>deux paramètres un premier qui est un <em>“filtre à requête</em> (<code class="language-plaintext highlighter-rouge">get</code> dans l’exemple) et le second la fonction à 2 ou 3 paramètres.</li>
</ul>

<p>Les deux ou trois paramètres de la requetes sont des objets qui permettent de gérer :</p>

<ul>
  <li>la <a href="https://expressjs.com/fr/api.html#req">requête</a> (paramètre <code class="language-plaintext highlighter-rouge">request</code>) qui permet de tout savoir sur la requête,</li>
  <li>la <a href="http://expressjs.com/fr/api.html#res">réponse</a> (paramètre <code class="language-plaintext highlighter-rouge">response</code>) qui permet de gérer la réponse que va envoyer le serveur</li>
  <li>lorsque l’on exécute ce paramètre, la requête est envoyé à la prochaine route possible (l’ordre est déterminé par l’ordre dans le quel ces routes sont écrites dans le code). S’il n’y a pas de paramètre <code class="language-plaintext highlighter-rouge">next</code> ou que la fonction n’est pas appelée, la requête est consommée : elle ne sera pas passé à d’autres routes.</li>
</ul>

<blockquote>
  <p>**Nota Bene : ** essayez d’enlever un next() n’une route pour voir l’effet que ça fait. Il faudra bien sur relancer le serveur avant que les modifications prennent effet.</p>
</blockquote>

<h3 id="les-fichiers-statiques">les fichiers statiques</h3>

<p>On serait tenté de charger à la main chaque fichier :</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">app</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">response</span><span class="p">.</span><span class="nx">sendFile</span><span class="p">(</span><span class="nx">__dirname</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">/static/index.html</span><span class="dl">"</span><span class="p">)</span>
<span class="p">})</span>
</code></pre></div></div>

<p>Mais ce n’est pas une bonne idée pour plusieurs raisons :</p>

<ol>
  <li>on ne sais pas combien de fichier statique on va avoir besoin, car ce n’est pas que les fichiers html, c’est aussi les images, les css, tous les fichiers js, etc. Bref il y en a beaucoup trop</li>
  <li>si l’on laisse node charger les fichiers statiques, on ajoute le délais de traitement des fichiers de node dans chaque traitmeent de la requête</li>
  <li>on ne peut pas gérer le cache web.</li>
</ol>

<p>On laisse donc nginx gerer les fichiers statiques pour nous dans la configuration de l’ovh (regardez la doc) : toutes les requetes qui commencent par <code class="language-plaintext highlighter-rouge">/static</code> sont gérées immédiatement par nginx et ne passent même pas par le serveur node.</p>

<p>Mais en développement, à moins de simuler la production, on ne peut pas faire ça. Du coup, on ajoute un middleware dont le boulot est de gérer les fichiers statiques en simulant ce que ferait le nginx en production.</p>

<p>On ajoute donc la ligne :</p>

<pre><code class="language- js">app.use("/static", express.static(__dirname + '/static'))
</code></pre>

<p>Au début des routes.</p>

<h2 id="notre-site-avec-express">Notre site avec express</h2>

<p>Pour l’instant pas de routes, que des fichiers statiques.  Ca va changer bientôt, mais pour l’instant on prépare le tout.</p>

<ul>
  <li>Il va falloir créer un dossier <em>static</em> qui
    <ul>
      <li>contiendra nos pages statiques</li>
      <li>possédera un fichier <em>package.json</em> (et donc un dossier <em>node_modules</em>) pour toutes les bibliothèques front (ici purecss)</li>
    </ul>
  </li>
  <li>On épure le fichier <em>package.json</em> côté serveur pour qu’il ne possède plus que les bibliothèques nécessaires au back.</li>
  <li>mettre tous nos tests unitaires et de user stories dans un dossier <em>tests</em> (pas <em><strong>tests</strong></em> car par défaut tous les fichiers de ce dossier sont exécutés en tant que tests, et nous on veut séparer tests unitaires et tests de users stories).</li>
</ul>

<p>Il faut un peu jardiner le code pour qu’il continue de fonctionner :</p>

<ul>
  <li>Il faut changer les chemin d’import des tests</li>
  <li>il faut faire deux package.json (un pour le back et un pour le front) et procéder aux imports. Le plus simple est de supprimer les fichiers node_modules et de les laisser se recréer avec un <code class="language-plaintext highlighter-rouge">yarn install</code> côté front et côté back</li>
  <li>il faut un peut changer la configuration de jest pour qu’il ne voit pas le dossier static et son <em>package.json</em>
</li>
  <li>On <a href="https://expressjs.com/fr/api.html#res.redirect">redirige</a> la route <code class="language-plaintext highlighter-rouge">/</code> vers <code class="language-plaintext highlighter-rouge">static/index.html</code>.</li>
</ul>

<p>On a alors une architecture qui ressemble à (commande <code class="language-plaintext highlighter-rouge">tree -I node_modules </code>) :</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>.
├── index.js
├── package.json
├── static
│   ├── index.html
│   ├── main.css
│   ├── main.js
│   ├── numerologie.js
│   ├── package.json
│   └── yarn.lock
├── tests
│   ├── numerologie.test.js
│   └── user-stories
│       ├── look-at-google.user-story.js
│       └── numerologie.user-story.js
└── yarn.lock

</code></pre></div></div>

<p>Avec le fichier <em>package.json</em> du back qui ressemble à :</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{
  "name": "web_serveur",
  "version": "1.0.0",
  "main": "index.js",
  "repository": "git@github.com:FrancoisBrucker/web_serveur_cours.git",
  "author": "François Brucker &lt;francois.brucker@centrale-marseille.fr&gt;",
  "license": "MIT",
  "scripts": {
    "test": "jest",
    "user-story": "jest --testRegex=\"user-story.js\""
  },
  "devDependencies": {
    "selenium-webdriver": "^4.0.0-alpha.7",
    "geckodriver": "^1.20.0",
    "chromedriver": "85.0.1",
    "jest": "^26.5.0"
  },
  "dependencies": {
    "express": "^4.17.1"
  },
  "jest": {
    "modulePathIgnorePatterns": [
      "&lt;rootDir&gt;/static"
    ]
  }
}
</code></pre></div></div>

<blockquote>
  <p>Notez la modification des paramètres de jest.</p>
</blockquote>

<p>Et celui du du <em>static/package.json</em> qui ne contient plus que la dépendance purecss :</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{
  "name": "web_serveur",
  "version": "1.0.0",
  "main": "index.html",
  "repository": "git@github.com:FrancoisBrucker/web_serveur_cours.git",
  "author": "François Brucker &lt;francois.brucker@centrale-marseille.fr&gt;",
  "license": "MIT",
  "dependencies": {
    "purecss": "^2.0.3"
  }
}

</code></pre></div></div>

<p>Enfin, le ficher <em>index.js</em> qui ne continent que gestion des fichiers statiques, une route (une redirection) et la gestion des 404 :</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">express</span><span class="dl">'</span><span class="p">)</span>
<span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">()</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">Time:</span><span class="dl">'</span><span class="p">,</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">());</span>
    <span class="nx">next</span><span class="p">();</span> <span class="c1">// sans cette ligne on ne pourra pas poursuivre.</span>
<span class="p">})</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="dl">"</span><span class="s2">/static</span><span class="dl">"</span><span class="p">,</span> <span class="nx">express</span><span class="p">.</span><span class="kd">static</span><span class="p">(</span><span class="nx">__dirname</span> <span class="o">+</span> <span class="dl">'</span><span class="s1">/static</span><span class="dl">'</span><span class="p">))</span>

<span class="nx">app</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">response</span>
        <span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="mi">301</span><span class="p">,</span> <span class="dl">'</span><span class="s1">/static/index.html</span><span class="dl">'</span><span class="p">)</span>
<span class="p">})</span>


<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">request</span><span class="p">,</span><span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">et c'est le 404 : </span><span class="dl">"</span> <span class="o">+</span> <span class="nx">request</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span>

    <span class="nx">response</span><span class="p">.</span><span class="nx">statusCode</span> <span class="o">=</span> <span class="mi">404</span><span class="p">;</span>
    <span class="nx">response</span><span class="p">.</span><span class="nx">setHeader</span><span class="p">(</span><span class="dl">'</span><span class="s1">Content-Type</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">text/html</span><span class="dl">'</span><span class="p">);</span>

    <span class="nx">response</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="dl">"</span><span class="s2">&lt;html&gt;&lt;head&gt;&lt;title&gt;la quatre cent quatre&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&lt;h1&gt;Et c'est la 404.&lt;/h1&gt;&lt;img  src=</span><span class="se">\"</span><span class="s2">https://www.leblogauto.com/wp-content/uploads/2020/04/Peugeot-404-1.jpg</span><span class="se">\"</span><span class="s2"> /&gt;&lt;/body&gt;&lt;/html&gt;</span><span class="dl">"</span><span class="p">);</span>

<span class="p">})</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="mi">3000</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">c'est parti</span><span class="dl">"</span><span class="p">)</span>

</code></pre></div></div>

<blockquote>
  <p>**Nota Bene : ** On a mis du contenu dans la 404 (toute une famille).</p>
</blockquote>

<h2 id="tests-de-routes">tests de routes</h2>

<p>Pour être sur que notre serveur fonctionne, on va tester les routes qu’il produit. Ceci peut se faire avec un outil spécialisé comme <a href="https://www.postman.com/">postman</a> ou une bibliothèque de test comme <a href="https://github.com/visionmedia/supertest">supertest</a>.</p>

<h3 id="postman">postman</h3>

<p>Très utile lorsque l’on veut tester nos routes en post (ce qui est dur/impossible à faire avec un navigateur), <a href="https://www.postman.com/">postman</a> permet aussi de tester nos routes toute simple en get.</p>

<p>Attention, postman va vouloir vous enregistrer, mais ce n’est pas nécessaire. Il faut  juste bien lire toutes les petites lignes avant de cliquer.</p>

<p>On commence par <a href="https://www.postman.com/downloads/">télécharger le client</a>. Lorsque vous le lancez il va vous ouvrir une fenêtre de login. Lisez la petite ligne tout en bas de la fenêtre pour<em>skip sign in</em></p>

<p>Cliquez sur le <em>+</em> de la fenêtre pour ouvrir un testeur de requête. On choisit get et vous pouvez ensuite tester une route de votre serveur. Ces routes sont conservées dans l’historique pour pouvoir être réutilisées facilement ensuite.</p>

<p>Si cette méthode est idéale en développementpour configurer une route récalcitrante, elle n’est pas recommandée pour faires des tests réguliers. Pour ça on va les automatiser avec la bibliothèque supertest.</p>

<h3 id="supertest">supertest</h3>

<p><a href="https://github.com/visionmedia/supertest">supertest</a> est une bibliothèque permettant de tester facilement les routes. On commence par l’installer : <code class="language-plaintext highlighter-rouge">yarn add --dev supertest</code></p>

<p><a href="https://dev.to/nedsoft/testing-nodejs-express-api-with-jest-and-supertest-1km6">un tuto</a></p>

<p>On teste toutes les routes du serveur pour être sur de ne pas avoir de 404. Ce n’est pas la peine de tester l’algorithmie des routes s’il y en a, puisque ceci est fait avec des tests unitaires.</p>

<p>Pas une user story ni un test unitaire, on vérifie que nos routes sont ok.</p>

<p>Pour que supertest fonctionne, il faut pouvoir lancer le serveur à la volée ce qui est impossible actuellement puisque <em>index.js</em> crée les routes et lance le serveur tout seul. On sépare donc tout ça en deux fichiers.</p>

<p><em>app.js</em> qui crée les routes :</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">express</span><span class="dl">'</span><span class="p">)</span>
<span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">()</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">Time:</span><span class="dl">'</span><span class="p">,</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">());</span>
    <span class="nx">next</span><span class="p">();</span> <span class="c1">// sans cette ligne on ne pourra pas poursuivre.</span>
<span class="p">})</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="dl">"</span><span class="s2">/static</span><span class="dl">"</span><span class="p">,</span> <span class="nx">express</span><span class="p">.</span><span class="kd">static</span><span class="p">(</span><span class="nx">__dirname</span> <span class="o">+</span> <span class="dl">'</span><span class="s1">/static</span><span class="dl">'</span><span class="p">))</span>

<span class="nx">app</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">response</span>
        <span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="mi">301</span><span class="p">,</span> <span class="dl">'</span><span class="s1">/static/index.html</span><span class="dl">'</span><span class="p">)</span>
<span class="p">})</span>


<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">request</span><span class="p">,</span><span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">et c'est le 404 : </span><span class="dl">"</span> <span class="o">+</span> <span class="nx">request</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span>

    <span class="nx">response</span><span class="p">.</span><span class="nx">statusCode</span> <span class="o">=</span> <span class="mi">404</span><span class="p">;</span>
    <span class="nx">response</span><span class="p">.</span><span class="nx">setHeader</span><span class="p">(</span><span class="dl">'</span><span class="s1">Content-Type</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">text/html</span><span class="dl">'</span><span class="p">);</span>

    <span class="nx">response</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="dl">"</span><span class="s2">&lt;html&gt;&lt;head&gt;&lt;title&gt;la quatre cent quatre&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&lt;h1&gt;Et c'est la 404.&lt;/h1&gt;&lt;img  src=</span><span class="se">\"</span><span class="s2">https://www.leblogauto.com/wp-content/uploads/2020/04/Peugeot-404-1.jpg</span><span class="se">\"</span><span class="s2"> /&gt;&lt;/body&gt;&lt;/html&gt;</span><span class="dl">"</span><span class="p">);</span>

<span class="p">})</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">app</span>

</code></pre></div></div>

<p>Et <em>index.js</em> qui ne fait que lancer le serveur :</p>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">./app</span><span class="dl">'</span><span class="p">);</span>

<span class="nx">config</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">baseUrl</span><span class="p">:</span> <span class="dl">"</span><span class="s2">localhost</span><span class="dl">"</span><span class="p">,</span>
    <span class="na">port</span><span class="p">:</span> <span class="mi">3000</span>
<span class="p">}</span>


<span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">port</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">server is running at: </span><span class="dl">'</span> <span class="o">+</span> <span class="dl">'</span><span class="s1">http://</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">config</span><span class="p">.</span><span class="nx">baseUrl</span> <span class="o">+</span> <span class="dl">'</span><span class="s1">:</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">config</span><span class="p">.</span><span class="nx">port</span><span class="p">);</span>
<span class="p">});</span>

</code></pre></div></div>

<p>Du coup nos tests de routes peuvent s’écrire par exemple (fichier <em>test/routes.test.js</em>) :</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kd">const</span> <span class="nx">request</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">supertest</span><span class="dl">'</span><span class="p">);</span>

<span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">../app</span><span class="dl">'</span><span class="p">);</span>

<span class="kd">let</span> <span class="nx">user</span><span class="p">;</span>
<span class="kd">let</span> <span class="nx">server</span><span class="p">;</span>

<span class="nx">beforeAll</span><span class="p">(</span><span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">user</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">request</span><span class="p">.</span><span class="nx">agent</span><span class="p">(</span><span class="nx">app</span><span class="p">);</span>
    <span class="nx">server</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="mi">3000</span><span class="p">);</span>
<span class="p">});</span>

<span class="nx">afterAll</span><span class="p">(</span><span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">await</span> <span class="nx">server</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
<span class="p">});</span>


<span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">GET index.html</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">user</span>
        <span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/</span><span class="dl">'</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="mi">301</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">expect</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">location</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="dl">'</span><span class="s1">/static/index.html</span><span class="dl">'</span><span class="p">)</span>
        <span class="p">})</span>
        <span class="p">.</span><span class="nx">end</span><span class="p">((</span><span class="nx">err</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">done</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="nx">done</span><span class="p">()</span>
        <span class="p">})</span>
<span class="p">})</span>

<span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">GET 404</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">user</span>
        <span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/not here</span><span class="dl">'</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">end</span><span class="p">((</span><span class="nx">err</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="nx">done</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
        <span class="p">})</span>
<span class="p">})</span>
 
</code></pre></div></div>

<p>On teste qu’il y a une redirection vers <code class="language-plaintext highlighter-rouge">/static/index/html</code> et que les 404 sont mis en œuvre.</p>

<h2 id="loggeur">loggeur</h2>

<p>Lorsqu’il y a une erreur sur un serveur distant, il est très rare qu’elle se produise alors que le développeur la regarde. Il faut donc pouvoir a posteriori retrouver ce qu’il s’est passé.</p>

<p>On va en utiliser deux : <a href="https://github.com/expressjs/morgan">morgan</a> et <a href="https://github.com/winstonjs/winston">winston</a>.</p>

<h3 id="morgan">morgan</h3>

<p>Le loggeur  <a href="https://github.com/expressjs/morgan">morgan</a> permet d’intercepter toutes les requêtes http. Il permet de savoir exactement ce qu’il se passe sur notre serveur.</p>

<p>On l’ajoute en commençant par l’installer : <code class="language-plaintext highlighter-rouge">yarn add morgan</code></p>

<ul>
  <li>on l’importe : <code class="language-plaintext highlighter-rouge">var morgan = require('morgan')</code>
</li>
  <li>puis on ajoute la ligne <code class="language-plaintext highlighter-rouge">app.use(morgan('dev'))</code> au début des routes pour l’utiliser.</li>
</ul>

<p>Selon ce que l’on veut logger, il y a plein de possibilités, essayez par exemple <code class="language-plaintext highlighter-rouge">'combined'</code> ou <code class="language-plaintext highlighter-rouge">'tiny'</code> à la place de <code class="language-plaintext highlighter-rouge">'dev'</code> par exemple.</p>

<h3 id="winston">winston</h3>

<p><a href="https://github.com/winstonjs/winston">winston</a> permet lui de loggeur tout ce que l’on veut. L’idée est de <strong>pouvoir</strong> tout loger pour retrouver un bug, mais de ne pas tout stocker pour éviter d’avoir des fichiers de logs énorme et pour le coup non utile.</p>

<p>L’usage veut que l’on donne donc des niveaux de log et que ne sont stockés que les log de niveau inférieur à un seuil donné. Pour winston les logging levels sont :</p>

<pre><code class="language- js">const levels = { 
  error: 0,
  warn: 1,
  info: 2,
  http: 3,
  verbose: 4,
  debug: 5,
  silly: 6
};
</code></pre>

<p>En production on pourra par exemple utiliser le level 0, en développement le 2 et en debug le 4.</p>

<p>Commençons par ajouter winston : <code class="language-plaintext highlighter-rouge">yarn add winston</code></p>

<p>Et créons un loggeur. Pour cela, on va créer un fichier <em>logger.js</em> et mettre notre configuration winston à l’intérieur. Ce fichier sera ensuite importé dans tous les fichiers nécessitant des logs. Comme l’import est fait avec un [require] ), ce sera le <em>même</em> loggeur qui sera utilisé partout (c’est ce qu’on appelle le <a href="https://nodejs.org/docs/latest/api/modules.html#modules_caching">caching</a>).</p>

<p>Fichier <em>logger.js</em> :</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">winston</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">winston</span><span class="dl">'</span><span class="p">);</span>

<span class="kd">const</span> <span class="nx">logger</span> <span class="o">=</span> <span class="nx">winston</span><span class="p">.</span><span class="nx">createLogger</span><span class="p">({</span>
  <span class="na">level</span><span class="p">:</span> <span class="dl">'</span><span class="s1">info</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">format</span><span class="p">:</span> <span class="nx">winston</span><span class="p">.</span><span class="nx">format</span><span class="p">.</span><span class="nx">combine</span><span class="p">(</span>
      <span class="nx">winston</span><span class="p">.</span><span class="nx">format</span><span class="p">.</span><span class="nx">timestamp</span><span class="p">(),</span>
      <span class="nx">winston</span><span class="p">.</span><span class="nx">format</span><span class="p">.</span><span class="nx">json</span><span class="p">()),</span>
  <span class="na">transports</span><span class="p">:</span> <span class="p">[</span>
    <span class="k">new</span> <span class="nx">winston</span><span class="p">.</span><span class="nx">transports</span><span class="p">.</span><span class="nx">File</span><span class="p">({</span> <span class="na">filename</span><span class="p">:</span> <span class="dl">'</span><span class="s1">error.log</span><span class="dl">'</span><span class="p">,</span> <span class="na">level</span><span class="p">:</span> <span class="dl">'</span><span class="s1">error</span><span class="dl">'</span> <span class="p">}),</span>
    <span class="k">new</span> <span class="nx">winston</span><span class="p">.</span><span class="nx">transports</span><span class="p">.</span><span class="nx">Console</span><span class="p">(),</span>
  <span class="p">],</span>
<span class="p">});</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">logger</span>
</code></pre></div></div>

<p>On a deux sorties, une dans la console pour (défini dans les options) tous les log de criticité inférieur à <code class="language-plaintext highlighter-rouge">'info'</code>  et dans un fichier pour toute les erreurs.</p>

<p>Puis on l’importe dans <em>app.js</em> pour :</p>

<ul>
  <li>inclure les messages de morgan dans winston au level <code class="language-plaintext highlighter-rouge">http</code>
</li>
</ul>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">express</span><span class="dl">'</span><span class="p">)</span>
<span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">()</span>

<span class="kd">var</span> <span class="nx">morgan</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">morgan</span><span class="dl">'</span><span class="p">)</span>

<span class="kd">const</span> <span class="nx">logger</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">./logger</span><span class="dl">'</span><span class="p">)</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">morgan</span><span class="p">(</span><span class="dl">'</span><span class="s1">dev</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span><span class="na">stream</span><span class="p">:</span> <span class="p">{</span><span class="na">write</span><span class="p">:(</span><span class="nx">log</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="nx">logger</span><span class="p">.</span><span class="nx">http</span><span class="p">(</span><span class="nx">log</span><span class="p">)}}}))</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="dl">"</span><span class="s2">/static</span><span class="dl">"</span><span class="p">,</span> <span class="nx">express</span><span class="p">.</span><span class="kd">static</span><span class="p">(</span><span class="nx">__dirname</span> <span class="o">+</span> <span class="dl">'</span><span class="s1">/static</span><span class="dl">'</span><span class="p">))</span>

<span class="nx">app</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">response</span>
        <span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="mi">301</span><span class="p">,</span> <span class="dl">'</span><span class="s1">/static/index.html</span><span class="dl">'</span><span class="p">)</span>
<span class="p">})</span>


<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">request</span><span class="p">,</span><span class="nx">response</span><span class="p">)</span> <span class="p">{</span>

    <span class="nx">response</span><span class="p">.</span><span class="nx">statusCode</span> <span class="o">=</span> <span class="mi">404</span><span class="p">;</span>
    <span class="nx">response</span><span class="p">.</span><span class="nx">setHeader</span><span class="p">(</span><span class="dl">'</span><span class="s1">Content-Type</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">text/html</span><span class="dl">'</span><span class="p">);</span>

    <span class="nx">response</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="dl">"</span><span class="s2">&lt;html&gt;&lt;head&gt;&lt;title&gt;la quatre cent quatre&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&lt;h1&gt;Et c'est la 404.&lt;/h1&gt;&lt;img  src=</span><span class="se">\"</span><span class="s2">https://www.leblogauto.com/wp-content/uploads/2020/04/Peugeot-404-1.jpg</span><span class="se">\"</span><span class="s2"> /&gt;&lt;/body&gt;&lt;/html&gt;</span><span class="dl">"</span><span class="p">);</span>

<span class="p">})</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">app</span>
</code></pre></div></div>

<p>Et enfin dans <em>index.js</em> pour un petit message au démarrage du serveur :</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">logger</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">./logger</span><span class="dl">'</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">./app</span><span class="dl">'</span><span class="p">);</span>

<span class="nx">config</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">baseUrl</span><span class="p">:</span> <span class="dl">"</span><span class="s2">localhost</span><span class="dl">"</span><span class="p">,</span>
    <span class="na">port</span><span class="p">:</span> <span class="mi">3000</span>
<span class="p">}</span>


<span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">port</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">logger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="dl">'</span><span class="s1">server is running at: </span><span class="dl">'</span> <span class="o">+</span> <span class="dl">'</span><span class="s1">http://</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">config</span><span class="p">.</span><span class="nx">baseUrl</span> <span class="o">+</span> <span class="dl">'</span><span class="s1">:</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">config</span><span class="p">.</span><span class="nx">port</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div></div>

<p>Essayer de changer le level par défaut pour voir les messages de niveau http dans la console.</p>

<h3 id="winston-daily-rotate">winston daily rotate</h3>

<p><a href="https://github.com/winstonjs/winston-daily-rotate-file">winston daily rotate</a> est un plugin winston qui permet de faire des log qui ne maintiennent qu’une durée fixe de log (une journée, semaine, etc) permettant ainsi aux logs de ne pas grossir indéfiniment.</p>

<p>Il existe aussi des outils unix pour cela, comme <a href="https://doc.ubuntu-fr.org/logrotate">logrotate</a> par exemple (voir <a href="https://medium.com/techiee/log-rotation-with-forever-6d8a1797355b">tuto</a>).</p>

<p>TBD</p>

<h2 id="transfert-de-données-en-post-et-fetch">transfert de données en post et fetch</h2>

<p>Pour l’instant, le code js de calcul du nombre est inclus dans le front. On va le mettre dans une route. On va mettre ces nouvelles routes dans un fichier séparé.</p>

<h3 id="api-et-nouvelle-route">API et nouvelle route</h3>

<p>On va créer une route commençant par <code class="language-plaintext highlighter-rouge">/api</code> qui contiendra notre appel à la fonction numérologie.</p>

<p>L’usage veut également que l’on conserve les différentes versions des api pour pouvoir changer nos appels sans perturber les sites utilisant ceux-ci. On va donc avoir les routes suivantes :</p>

<ul>
  <li>
<code class="language-plaintext highlighter-rouge">/api/current/</code> qui sera la route pour la version actuelle de l’api</li>
  <li>
<code class="language-plaintext highlighter-rouge">/api/v1/</code> qui sera un lien vers la version courante.</li>
</ul>

<p>Ceci nous permettra de maintenir la version <code class="language-plaintext highlighter-rouge">v1</code> de l’api lorsque la version courante changera en <code class="language-plaintext highlighter-rouge">v1.2</code> ou <code class="language-plaintext highlighter-rouge">v2</code>.</p>

<p>On aura aussi pour l’instant qu’une unique méthode : <code class="language-plaintext highlighter-rouge">numerologie/&lt;prenom&gt;</code> qui prend une chaîne de caractère en <em>“paramètre”</em>.</p>

<p>Construisons ces routes. Pour cela on crée des dossiers que l’on importera (importer un dossier revient à importer le fichier <em>index.js</em> qui s’y trouve).</p>

<p>Notre site correspond maintenant à ça :</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>├── app.js
├── error.log
├── index.js
├── logger.js
├── package.json
├── routes
│   ├── index.js
│   └── v1
│       └── index.js
├── static
│   ├── index.html
│   ├── main.css
│   ├── main.js
│   ├── numerologie.js
│   ├── package.json
│   └── yarn.lock
├── tests
│   ├── numerologie.test.js
│   ├── routes.test.js
│   └── user-stories
│       ├── look-at-google.user-story.js
│       └── numerologie.user-story.js
└── yarn.lock

</code></pre></div></div>

<p>On a ajouté un dossier <em>routes</em> contenant un fichier <em>index.js</em>. Ce fichier est importé dans <em>app.js</em>, juste avant la gestion des 404 avec 2 lignes :</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">express</span><span class="dl">'</span><span class="p">)</span>
<span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">()</span>

<span class="kd">var</span> <span class="nx">morgan</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">morgan</span><span class="dl">'</span><span class="p">)</span>

<span class="kd">const</span> <span class="nx">logger</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">./logger</span><span class="dl">'</span><span class="p">)</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">morgan</span><span class="p">(</span><span class="dl">'</span><span class="s1">dev</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span><span class="na">stream</span><span class="p">:</span> <span class="p">{</span><span class="na">write</span><span class="p">:(</span><span class="nx">log</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="nx">logger</span><span class="p">.</span><span class="nx">http</span><span class="p">(</span><span class="nx">log</span><span class="p">)}}}))</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="dl">"</span><span class="s2">/static</span><span class="dl">"</span><span class="p">,</span> <span class="nx">express</span><span class="p">.</span><span class="kd">static</span><span class="p">(</span><span class="nx">__dirname</span> <span class="o">+</span> <span class="dl">'</span><span class="s1">/static</span><span class="dl">'</span><span class="p">))</span>

<span class="nx">app</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">response</span>
        <span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="mi">301</span><span class="p">,</span> <span class="dl">'</span><span class="s1">/static/index.html</span><span class="dl">'</span><span class="p">)</span>
<span class="p">})</span>

<span class="nx">api</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">./routes</span><span class="dl">'</span><span class="p">)</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="dl">'</span><span class="s1">/api</span><span class="dl">'</span><span class="p">,</span> <span class="nx">api</span><span class="p">)</span>


<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">request</span><span class="p">,</span><span class="nx">response</span><span class="p">)</span> <span class="p">{</span>

    <span class="nx">response</span><span class="p">.</span><span class="nx">statusCode</span> <span class="o">=</span> <span class="mi">404</span><span class="p">;</span>
    <span class="nx">response</span><span class="p">.</span><span class="nx">setHeader</span><span class="p">(</span><span class="dl">'</span><span class="s1">Content-Type</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">text/html</span><span class="dl">'</span><span class="p">);</span>

    <span class="nx">response</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="dl">"</span><span class="s2">&lt;html&gt;&lt;head&gt;&lt;title&gt;la quatre cent quatre&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&lt;h1&gt;Et c'est la 404.&lt;/h1&gt;&lt;img  src=</span><span class="se">\"</span><span class="s2">https://www.leblogauto.com/wp-content/uploads/2020/04/Peugeot-404-1.jpg</span><span class="se">\"</span><span class="s2"> /&gt;&lt;/body&gt;&lt;/html&gt;</span><span class="dl">"</span><span class="p">);</span>

<span class="p">})</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">app</span>
</code></pre></div></div>

<p>Le fichier <em>index.js</em> contient le code suivant :</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">express</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">router</span> <span class="o">=</span> <span class="nx">express</span><span class="p">.</span><span class="nx">Router</span><span class="p">();</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">router</span>

<span class="nx">router</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="dl">'</span><span class="s1">/current</span><span class="dl">'</span><span class="p">,</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">./v1</span><span class="dl">'</span><span class="p">))</span>
<span class="nx">router</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="dl">'</span><span class="s1">/v1</span><span class="dl">'</span><span class="p">,</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">./v1</span><span class="dl">'</span><span class="p">))</span>

</code></pre></div></div>

<p>Son boulot est de créer (et de rendre) un router qui contient deux routes <code class="language-plaintext highlighter-rouge">/current</code> et <code class="language-plaintext highlighter-rouge">/v1</code> qui seront identiques.</p>

<p>Le fichier <em>index.js</em> contient la route proprement dite de notre api. Pour l’instant c’est un fake. On fera le lien avec notre code js plus tard :</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">express</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">router</span> <span class="o">=</span> <span class="nx">express</span><span class="p">.</span><span class="nx">Router</span><span class="p">();</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">router</span>

<span class="nx">router</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/numerologie/:prenom</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span>
        <span class="dl">"</span><span class="s2">prenom</span><span class="dl">"</span><span class="p">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">prenom</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">numero</span><span class="dl">"</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
    <span class="p">})</span>
<span class="p">})</span>

</code></pre></div></div>

<p>Remarquez que cette route prend un paramètre nommé <code class="language-plaintext highlighter-rouge">:prenom</code> que l’on peut ensuite reprendre and le code.</p>

<p>Pour l’instant le code rend un objet <a href="https://www.json.org/json-fr.html">json</a> contenant 2 champ, le prénom (le paramètre de notre route) et le code (pour l’instnant toujours 4)</p>

<p>Pour savoir comment appeler cette route depuis notre server, regardons comment elle est appelée :</p>

<ol>
  <li>on commence par l’appeler depuis <em>./app.js</em> : <code class="language-plaintext highlighter-rouge">app.use('/api', api)</code> où <code class="language-plaintext highlighter-rouge">api = require('./routes')</code>
</li>
  <li>cela continue dans <em>./routes/index.js</em> avec <code class="language-plaintext highlighter-rouge">router.use('/current', require('./v1'))</code> et <code class="language-plaintext highlighter-rouge">router.use('/v1', require('./v1'))</code>
</li>
  <li>on arrive enfin au <em>./routes/v1/index.js</em> qui crée la route : <code class="language-plaintext highlighter-rouge">router.get('/numerologie/:prenom', ...</code>
</li>
</ol>

<p>En combinant tout ça on arrive à une route : <code class="language-plaintext highlighter-rouge">http://localhost:3000/api/current/numerologie/un truc</code> qui est la même que <code class="language-plaintext highlighter-rouge">http://localhost:3000/api/v1/numerologie/un truc</code>. Onpeut bien sur remplacer “un truc” par ce qu’on veut du moment que ce n’est pas vide.</p>

<h3 id="tests">tests</h3>

<p>On peut tester notre route directement dans un navigateur (puisque c’est une requête get), mais aussi avec postman.</p>

<p>Remarquez que :</p>

<ul>
  <li>le corps de la réponse est notre objet json</li>
  <li>le type (dans les header) est bien placé à json. C’est express qui a fait ça.</li>
</ul>

<p>Ajoutons un test avec supertest en créant le fichier <em>./tests/routes.api.test.js</em> :</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kd">const</span> <span class="nx">request</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">supertest</span><span class="dl">'</span><span class="p">);</span>

<span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">../app</span><span class="dl">'</span><span class="p">);</span>

<span class="kd">let</span> <span class="nx">user</span><span class="p">;</span>
<span class="kd">let</span> <span class="nx">server</span><span class="p">;</span>

<span class="nx">beforeAll</span><span class="p">(</span><span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">user</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">request</span><span class="p">.</span><span class="nx">agent</span><span class="p">(</span><span class="nx">app</span><span class="p">);</span>
    <span class="nx">server</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="mi">3000</span><span class="p">);</span>
<span class="p">});</span>

<span class="nx">afterAll</span><span class="p">(</span><span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">await</span> <span class="nx">server</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
<span class="p">});</span>


<span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">GET /api/current/numerologie/François</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">user</span>
        <span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/api/current/numerologie/François</span><span class="dl">'</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">expect</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">body</span><span class="p">).</span><span class="nx">toMatchObject</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="dl">"</span><span class="s2">prenom</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">François</span><span class="dl">"</span><span class="p">,</span>
                    <span class="dl">"</span><span class="s2">numero</span><span class="dl">"</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">)</span>
        <span class="p">})</span>
        <span class="p">.</span><span class="nx">end</span><span class="p">((</span><span class="nx">err</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">done</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="nx">done</span><span class="p">()</span>
        <span class="p">})</span>
<span class="p">})</span>


</code></pre></div></div>

<p>Pour l’instant notre test rate (puisque l’on ne rend que 4. Changez le 8 en 4 dans le test pour voir le test réussir), mais on va le faire marcher dans la suite.</p>

<h3 id="mise-à-jour-du-site">mise à jour du site</h3>

<h4 id="côté-back">côté back</h4>

<p>Commençons par faire marcher les tests. Pour cela, il faut rapatrier le fichier <em>static/numerologie.js</em> dans la racine du site et l’utiliser dans <em>/routes/v1/numerologie.js</em> :</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">express</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">router</span> <span class="o">=</span> <span class="nx">express</span><span class="p">.</span><span class="nx">Router</span><span class="p">();</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">router</span>

<span class="kd">const</span> <span class="nx">numerologie</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">../../numerologie</span><span class="dl">'</span><span class="p">)</span>


<span class="nx">router</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/numerologie/:prenom</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span>
        <span class="dl">"</span><span class="s2">prenom</span><span class="dl">"</span><span class="p">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">prenom</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">numero</span><span class="dl">"</span><span class="p">:</span> <span class="nx">numerologie</span><span class="p">.</span><span class="nx">nombre</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">prenom</span><span class="p">),</span>
    <span class="p">})</span>
<span class="p">})</span>
</code></pre></div></div>

<p>Les tests doivent maintenant passer (si vous avez bien changé le path pour le require du test de numérologie). On ne fait pas de tests supplémentaire dans supertest, les tests unitaires de <em>numerologie.js</em> nous assurant que la fonction <code class="language-plaintext highlighter-rouge">numerologie.nombre</code> fonctionne.</p>
<h4 id="côté-front">côté front</h4>

<p>Enfin, il faut modifier le fichier <em>static/main.js</em> pour qu’il cherche la réponse dans le serveur plutôt que par une fonction js. On utilise pour ça la fonction <a href="https://developer.mozilla.org/fr/docs/Web/API/Fetch_API/Using_Fetch">fetch</a>, très pratique, qui permet de récupérer des choses sur internet avec des promesses :</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">change_value</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">prenom</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="dl">"</span><span class="s2">#prenom</span><span class="dl">"</span><span class="p">).</span><span class="nx">value</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">prenom</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">fetch</span><span class="p">(</span><span class="dl">'</span><span class="s1">/api/current/numerologie/</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">prenom</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">response</span> <span class="o">=&gt;</span> <span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">())</span>
            <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">data</span> <span class="o">=&gt;</span> <span class="p">{</span>
                <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="dl">"</span><span class="s2">#get-value</span><span class="dl">"</span><span class="p">).</span><span class="nx">textContent</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">numero</span>
                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
            <span class="p">})</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="dl">"</span><span class="s2">#get-value</span><span class="dl">"</span><span class="p">).</span><span class="nx">textContent</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">?</span><span class="dl">"</span>
    <span class="p">}</span>

<span class="p">}</span>
<span class="nx">change_value</span><span class="p">()</span>

<span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="dl">"</span><span class="s2">#button-form</span><span class="dl">"</span><span class="p">).</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">"</span><span class="s2">click</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">change_value</span><span class="p">()</span>
    <span class="nx">event</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">()</span>
<span class="p">})</span>

</code></pre></div></div>

<p>Regardez la console pour voir ce que reçoit le fetch : les données brutes sont d’abort converties en json avant d’être utilisées (c’est le double <code class="language-plaintext highlighter-rouge">then</code>)</p>

<p>On oublie pas de modifier <em>static/index.html</em> pour supprimer les imports non nécessaires</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;!doctype html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">"fr"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;head&gt;</span>
        <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"utf-8"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;title&gt;</span>Numérologie<span class="nt">&lt;/title&gt;</span>

        <span class="nt">&lt;link</span> <span class="na">href=</span><span class="s">"./node_modules/purecss/build/pure-min.css"</span> <span class="na">rel=</span><span class="s">"stylesheet"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;link</span> <span class="na">href=</span><span class="s">"https://fonts.googleapis.com/css2?family=Lobster&display=swap"</span> <span class="na">rel=</span><span class="s">"stylesheet"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;link</span> <span class="na">href=</span><span class="s">"main.css"</span> <span class="na">rel=</span><span class="s">"stylesheet"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;/head&gt;</span>
    <span class="nt">&lt;body&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"body"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;form</span> <span class="na">class=</span><span class="s">"pure-form"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">"prenom"</span><span class="nt">&gt;</span>Prénom :<span class="nt">&lt;/label&gt;</span>
                <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">"prenom"</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">name=</span><span class="s">"prenom"</span><span class="nt">/&gt;</span>

                <span class="nt">&lt;button</span> <span class="na">id=</span><span class="s">"button-form"</span> <span class="na">type=</span><span class="s">"submit"</span> <span class="na">class=</span><span class="s">"pure-button pure-button-primary"</span><span class="nt">&gt;</span>Envoi<span class="nt">&lt;/button&gt;</span>
            <span class="nt">&lt;/form&gt;</span>
            <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"pure-g"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"pure-u-1-3"</span><span class="nt">&gt;&lt;/div&gt;</span>
                <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"pure-u-1-3"</span><span class="nt">&gt;&lt;p</span> <span class="na">id=</span><span class="s">"get-value"</span><span class="nt">&gt;</span>7<span class="nt">&lt;/p&gt;&lt;/div&gt;</span>
                <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"pure-u-1-3"</span><span class="nt">&gt;&lt;/div&gt;</span>
            <span class="nt">&lt;/div&gt;</span>

        <span class="nt">&lt;/div&gt;</span>

        <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"main.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
    <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div>

<h2 id="à-faire-">à faire ?</h2>
<ul>
  <li>
    <p>graphql ?</p>
  </li>
  <li>templating express ?</li>
  <li>gestion des environnements de prod, test, etc</li>
  <li>bases de données et requêtes post</li>
  <li>compilation du front</li>
  <li>gestion des routes dans des fichiers séparés</li>
</ul>


  </div>

</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/cours_informatique/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">cours d'informatique</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">cours d'informatique</li>
</ul>
      </div>

      <div class="footer-col footer-col-2">
<ul class="social-media-list"><li><a href="https://github.com/FrancoisBrucker"><svg class="svg-icon"><use xlink:href="/cours_informatique/assets/minima-social-icons.svg#github"></use></svg> <span class="username">FrancoisBrucker</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>Support de cours/td d'informatique à l'école centrale marseille.</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>

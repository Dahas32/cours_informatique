<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
<!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Numérologie partie 2 - niveau 2. Mise en production sur un serveur distant (ovh1 en 3A) | cours d’informatique</title>
<meta name="generator" content="Jekyll v4.2.0">
<meta property="og:title" content="Numérologie partie 2 - niveau 2. Mise en production sur un serveur distant (ovh1 en 3A)">
<meta name="author" content="Lucie Danard">
<meta property="og:locale" content="en_US">
<meta name="description" content="Support de cours/td d’informatique de François Brucker.">
<meta property="og:description" content="Support de cours/td d’informatique de François Brucker.">
<link rel="canonical" href="/cours_informatique/cours/web/projets/tuto_serveur_node.html">
<meta property="og:url" content="/cours_informatique/cours/web/projets/tuto_serveur_node.html">
<meta property="og:site_name" content="cours d’informatique">
<meta name="twitter:card" content="summary">
<meta property="twitter:title" content="Numérologie partie 2 - niveau 2. Mise en production sur un serveur distant (ovh1 en 3A)">
<script type="application/ld+json">
{"description":"Support de cours/td d’informatique de François Brucker.","author":{"@type":"Person","name":"Lucie Danard"},"@type":"WebPage","url":"/cours_informatique/cours/web/projets/tuto_serveur_node.html","headline":"Numérologie partie 2 - niveau 2. Mise en production sur un serveur distant (ovh1 en 3A)","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/cours_informatique/assets/main.css">

  <link rel="stylesheet" href="/cours_informatique/assets/custom.css">

  <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
<link type="application/atom+xml" rel="alternate" href="/cours_informatique/feed.xml" title="cours d'informatique">
</head>

<body>
<header class="site-header" role="banner">

  <div class="wrapper">
<a class="site-title" rel="author" href="/cours_informatique/">cours d'informatique</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger">
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewbox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"></path>
            </svg>
          </span>
        </label>

        <div class="trigger">
            <a class="page-link" href="/cours_informatique/about"> about </a>
        </div>
      </nav>
</div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post">

  <header class="post-header">
    <h1 class="post-title">Numérologie partie 2 - niveau 2. Mise en production sur un serveur distant (ovh1 en 3A)</h1>Auteurs :
      <ul>
      
        <li><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span class="p-author h-card" itemprop="name">Lucie Danard</span></span></li>
      
        <li><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span class="p-author h-card" itemprop="name">Anaïs Merliot</span></span></li>
      
      </ul>
  </header>

  <div class="post-content">
    <h2 id="étape-1--récupérer-les-fichiers-du-projet-numérologie">Étape 1 : Récupérer les fichiers du projet numérologie</h2>
<p>Créez un dossier <em>numerologie</em> et reproduisez la structure suivante :</p>

<h3 id="structure-du-projet">structure du projet</h3>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>.
├── back
│   └── numerologie.js
├── index.js
├── package-lock.json
├── package.json
└── static
    ├── index.html
    └── main.css
</code></pre></div></div>

<h3 id="fichiers">fichiers</h3>

<p><a href="https://francoisbrucker.github.io/cours_informatique/cours/web/projets/numerologie/partie-2-serveur/5-structures.html">Lien vers les contenus des fichiers</a></p>

<h2 id="étape-2--utiliser-express">Étape 2 : Utiliser express</h2>

<h3 id="gestionnaire-de-package">gestionnaire de package</h3>

<p>Pour gérer notre site, on va utiliser le module pour node <a href="https://expressjs.com/fr/">express</a>. 
Pour l’installer, comme pour installer les autres packages node, on peut utiliser npm (<strong>n</strong>ode <strong>p</strong>ackage <strong>m</strong>anager), qui est livré avec node.</p>

<h4 id="npm-init">npm init</h4>

<p>Pour commencer, <code class="language-plaintext highlighter-rouge">npm</code> doit pouvoir gérer vos modules. Pour cela, il faut lui laisser créer un fichier de configuration nommé <em>“package.json”</em>. Pour cela, tapez dans un terminal placé à la racine de notre projet :</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npm init
</code></pre></div></div>

<p>Répondez aux questions (ou tapez sur entrée). Lorsque le programme est fini, vous trouverez un fichier <em>“package.json”</em> à la racine de votre projet.</p>

<p>Chez moi, il ressemble à ça :</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"numerologie"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"version"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1.0.0"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"de la numérologie"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"main"</span><span class="p">:</span><span class="w"> </span><span class="s2">"index.js"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"scripts"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"test"</span><span class="p">:</span><span class="w"> </span><span class="s2">"echo </span><span class="se">\"</span><span class="s2">Error: no test specified</span><span class="se">\"</span><span class="s2"> &amp;&amp; exit 1"</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"author"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Lucie Danard"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"license"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ISC"</span><span class="w">
</span><span class="p">}</span><span class="w">

</span></code></pre></div></div>

<p>Il ne contient pour l’instant que des informations générales quant au projet. Nous allons bientôt y ajouter des modules.</p>

<blockquote>
  <p>Le <a href="https://fr.wikipedia.org/wiki/JavaScript_Object_Notation">json</a> est un format texte pour sauvegarder des données structurée. C’est un format génial qui sert tout autant pour les fichiers de configurations que le transfert de données par le web.</p>
</blockquote>

<h4 id="ajout-dun-module">ajout d’un module</h4>

<p>Pour cela, tapez dans un terminal placé à la racine de notre projet :</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npm add <span class="nt">--save</span> express
</code></pre></div></div>

<blockquote class="attention">
  <p>N’oubliez pas <code class="language-plaintext highlighter-rouge">--save</code>, sinon le module sera installé mais la dépendance ne sera pas ajoutée au fichier <em>“package.json”</em> ce qui est tarte.</p>
</blockquote>

<p>Cette commande a ajouté une dépendance à notre fichier <em>“package.json”</em> :</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nl">"dependencies"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"express"</span><span class="p">:</span><span class="w"> </span><span class="s2">"^4.17.1"</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>A créer un fichier <em>“package-lock.json”</em> qui contient la liste de tous les modules installés et un (gros) dossier <em>“node_modules”</em> qui contient les modules installés.</p>

<blockquote>
  <p>Il y a plus de 50 modules installés alors que l’on a demandé d’installer que le module <code class="language-plaintext highlighter-rouge">express</code>, car il a lui même des dépendances et ses dépendances d’autres dépendances, etc.</p>
</blockquote>

<p>La différence entre <em>“package.json”</em> et <em>“package-lock.json”</em> est que le premier décrit les versions possibles (nous, toutes les versions ultérieures à 4.17.1) alors que <em>“package-lock.json”</em> décrit la version effectivement installée (la 4.17.1). Cette méchanique permet de mettre à jour nos modules en supprimant le dossier <em>“node_module”</em> et le fichier <em>“package-lock.json”</em> et en tapant la commande <code class="language-plaintext highlighter-rouge">npm install</code>.</p>

<h4 id="sauvegarde-et-installation-du-projet">sauvegarde et installation du projet</h4>

<p>Le dossier <em>“node_module”</em> n’est pas un module à sauver, on peut installer toutes les dépendances avec la commande <code class="language-plaintext highlighter-rouge">npm install</code> :</p>

<ul>
  <li>grâce au fichier <em>“package-lock.json”</em> : la commande <code class="language-plaintext highlighter-rouge">npm --install</code> sait exactement quels modules installer</li>
  <li>le fichier <em>“package.json”</em> donnant les dépendances générales de notre projet.</li>
</ul>

<h2 id="étape-3--tester-le-projet-en-local">Étape 3 : Tester le projet en local</h2>

<p>Ça y est en principe ça marche ! Pour vérifier que votre projet fonctionne en local, exécutez le fichier index.js en tapant dans le terminal :</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>node index.js
</code></pre></div></div>

<p>et allez vérifier le résultat dans le navigateur à l’adresse : http://localhost:3000. Vous remarquerez que 3000 correspond au port rentré dans le fichier index.js, donc si vous en avez mis un autre, il faut modifier l’adresse en conséquence.</p>

<h2 id="étape-4--mettre-en-production-sur-lovh">Étape 4 : Mettre en production sur l’ovh</h2>

<h3 id="1-trouver-et-changer-le-port">1. Trouver et changer le port</h3>

<h4 id="rappel-connexion-à-lovh-avec-sa-clé-ssh">Rappel: Connexion à l’ovh avec sa clé Ssh</h4>

<blockquote>
  <p>Se connecter à sas1 avec un agent: <code class="language-plaintext highlighter-rouge">ssh identifiant@sas1.centrale-marseille.fr -A</code>
<br> Récuppèrer la clé SSh: <code class="language-plaintext highlighter-rouge">ssh -add</code>
<br> Regarder ce que contient l’agent: <code class="language-plaintext highlighter-rouge">ssh -add -l</code>
<br> Se connecter à l’ovh avec un agent:  <code class="language-plaintext highlighter-rouge">ssh  herbearomatique@ovh1.ec-m.fr -A</code></p>
</blockquote>

<p><br> Une fois connecté, on pourra faire régulièrement des ls, afin de savoir quels fichiers on a dans le répertoire.
<br> Le numéro du port se trouve dans le fichier <strong>readme</strong>, pour le lire : <code class="language-plaintext highlighter-rouge">cat readme.txt</code>.</p>

<p><br>Chez moi cela ressemble à :</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Tomcat instance port = 10033            &lt;-- java.herbearomatique.ovh1.ec-m.fr
Tomcat shutdown port = 10133

Gunicorn (Django) port = 10233          &lt;-- django.herbearomatique.ovh1.ec-m.fr

Gunicorn (Flask) port = 10333           &lt;-- flask.herbearomatique.ovh1.ec-m.fr

Node.js port = 10433                            &lt;-- node.herbearomatique.ovh1.ec-m.fr

PHP port = 10533                                &lt;-- herbearomatique.ovh1.ec-m.fr pour les fichiers en .php seulement
</code></pre></div></div>

<p><br> Lire le port correspondant au serveur node (ici 10433) et le remplacer dans le fichier <em>index.js</em> (à la place de 3000).</p>

<h3 id="2-exporter-le-projet-sur-lovh">2. Exporter le projet sur l’ovh</h3>

<p><br>On utilise <a href="https://francoisbrucker.github.io/cours_informatique/cours/git_et_github/" title="Voir git">git et github</a>.</p>

<h4 id="pour-exporter">Pour exporter</h4>
<p><br>On utilise pour exporter la totalité du projet: <code class="language-plaintext highlighter-rouge">git add --all</code> ou un fichier en particulier : <code class="language-plaintext highlighter-rouge">git add &lt;nomfichier&gt;</code>.
<br>Ensuite on commit et push le projet sur github : <code class="language-plaintext highlighter-rouge">git commit -am “&lt;commentaire&gt;”</code> et <code class="language-plaintext highlighter-rouge">git push</code>.</p>

<h4 id="pour-importer">Pour importer</h4>
<p><br> On se place dans le dossier <b>node</b> de l’ovh, et on clone le projet: <code class="language-plaintext highlighter-rouge">git clone &lt;lien github ssh&gt;</code>.</p>
<blockquote>
  <p>Attention: ne pas oublier de se connecter à l’ovh avec son agent contenant la clé Ssh.</p>
</blockquote>

<h1 id="étape-5--lancer-le-démon">Étape 5 : Lancer le démon</h1>

<p>Pour lancer le serveur node sur l’ovh, et que celui-ci ne s’arrête pas quand vous éteignez votre machine, il faut lancer un démon. Pour commencer, placez-vous au bon endroit, c’est-à-dire à la racine du projet numérologie. Si vous lancez la commande ‘'’ls’’’, vous devriez voir le fichier index.js. Ensuite vous pouvez lancer le démon avec la commande :</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/usr/bin/screen <span class="nt">-d</span> <span class="nt">-m</span> <span class="nt">-S</span> node node index.js
</code></pre></div></div>
<p>C’est bon, votre serveur est en prod ! Vous pouvez vérifier que tout va bien en vous connectant à l’adresse <node.herbearomatique.ovh1.ec-m.fr>.</node.herbearomatique.ovh1.ec-m.fr></p>

<blockquote>
  <p>Si vous avez une erreur dans les 500, cela signifie qu’il y a un problème avec le serveur (la mise en prod probablement, si tout marchait en local). Si vous avez une erreur 404 en revanche, c’est probablement parce que certains fichiers de votre projet ne sont pas trouvés par le serveur.</p>
</blockquote>

<p>Si vous voulez tuer le démon, vous pouvez procéder de la façon suivante :</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code> screen <span class="nt">-X</span> <span class="nt">-S</span> node quit
</code></pre></div></div>

<p>et pour voir les screen en marche :</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code> screen <span class="nt">-ls</span>
</code></pre></div></div>

<h1 id="bonus--gestion-des-processus">Bonus : Gestion des processus</h1>

<p>Dans cette partie, vous allez pouvoir visualiser et arrêter les processus en cours.
Par exemple, commencez par vous connecter sur l’ovh (pour rappel <code class="language-plaintext highlighter-rouge">ssh  herbearomatique@ovh1.ec-m.fr -A</code>)</p>

<p>Pour visualiser tous les processus en cours :</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ps aux
</code></pre></div></div>

<p>Vous remarquez que la première colonne correspond au nom de l’utilisateur, et la deuxième donne le numéro d’identification du processus.</p>

<p>Pour visualiser les processus de quelqu’un (par exemple stevia) :</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ps aux | <span class="nb">grep </span>stevia
</code></pre></div></div>

<p>Chez moi cela renvoie ça :</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root     1438186  0.0  0.2  14652  8968 ?        Ss   10:27   0:00 sshd: stevia <span class="o">[</span>priv]
stevia   1438192  0.0  0.1  14652  6032 ?        S    10:27   0:00 sshd: stevia@pts/0
stevia   1438193  0.0  0.1  10776  5916 pts/0    Ss   10:27   0:00 <span class="nt">-zsh</span>
stevia   1438605  0.0  0.0  10428  3524 pts/0    R+   10:34   0:00 ps aux
stevia   1438606  0.0  0.0   6832   648 pts/0    S+   10:34   0:00 <span class="nb">grep</span> <span class="nt">--color</span><span class="o">=</span>auto stevia
stevia   2252952  0.0  0.2  15252  8108 ?        Ss   sept.30   0:00 /lib/systemd/systemd <span class="nt">--user</span>
stevia   2252953  0.0  0.0 167576   732 ?        S    sept.30   0:00 <span class="o">(</span>sd-pam<span class="o">)</span>
stevia   2913276  0.0  0.0   7564  2136 ?        Ss   oct.08   0:00 /usr/bin/SCREEN <span class="nt">-d</span> <span class="nt">-m</span> <span class="nt">-S</span> node node index.js
stevia   2913277  0.0  0.5 629340 23404 pts/11   Ssl+ oct.08   0:00 node index.js
</code></pre></div></div>

<p>On peut arrêter un processus, mais pas n’importe lequel !! On ne peut stopper que les siens (donc pas le root). Pour tuer un processus, on le désigne par son numéro. Par exemple, la commande suivante détruit le processus de connection à l’ovh, et donc me déconnecte.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">kill </span>1438192
</code></pre></div></div>

  </div>

</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/cours_informatique/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">cours d'informatique</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">cours d'informatique</li>
</ul>
      </div>

      <div class="footer-col footer-col-2">
<ul class="social-media-list"><li><a href="https://github.com/FrancoisBrucker"><svg class="svg-icon"><use xlink:href="/cours_informatique/assets/minima-social-icons.svg#github"></use></svg> <span class="username">FrancoisBrucker</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>Support de cours/td d'informatique de François Brucker.</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
<!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Projet commentaires : partie 4 / intégration | cours d’informatique</title>
<meta name="generator" content="Jekyll v4.2.0">
<meta property="og:title" content="Projet commentaires : partie 4 / intégration">
<meta name="author" content="François Brucker">
<meta property="og:locale" content="en_US">
<meta name="description" content="Support de cours/td d’informatique à l’école centrale marseille.">
<meta property="og:description" content="Support de cours/td d’informatique à l’école centrale marseille.">
<link rel="canonical" href="/cours_informatique/cours/web/projets/commentaires/partie-4-base-de-donnees/2-db-config.html">
<meta property="og:url" content="/cours_informatique/cours/web/projets/commentaires/partie-4-base-de-donnees/2-db-config.html">
<meta property="og:site_name" content="cours d’informatique">
<meta name="twitter:card" content="summary">
<meta property="twitter:title" content="Projet commentaires : partie 4 / intégration">
<script type="application/ld+json">
{"description":"Support de cours/td d’informatique à l’école centrale marseille.","@type":"WebPage","headline":"Projet commentaires : partie 4 / intégration","url":"/cours_informatique/cours/web/projets/commentaires/partie-4-base-de-donnees/2-db-config.html","author":{"@type":"Person","name":"François Brucker"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/cours_informatique/assets/main.css">

  <link rel="stylesheet" href="/cours_informatique/assets/custom.css">
<link type="application/atom+xml" rel="alternate" href="/cours_informatique/feed.xml" title="cours d'informatique">
</head>

<body>
<header class="site-header" role="banner">

  <div class="wrapper">
<a class="site-title" rel="author" href="/cours_informatique/">cours d'informatique</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger">
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewbox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"></path>
            </svg>
          </span>
        </label>

        <div class="trigger">
            <a class="page-link" href="/cours_informatique/about"> about </a>
        </div>
      </nav>
</div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post">

  <header class="post-header">
    <h1 class="post-title">Projet commentaires : partie 4 / intégration</h1>Auteur : <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span class="p-author h-card" itemprop="name">François Brucker</span></span>
  </header>

  <div class="post-content">
    <blockquote class="chemin">
  <p><a href="/cours_informatique/cours/web/projets/commentaires/">commentaires</a> / <a href="/cours_informatique/cours/web/projets/commentaires/partie-4-base-de-donnees/">partie 4</a> / <a href="/cours_informatique/cours/web/projets/commentaires/partie-4-base-de-donnees/2-db-config.html">intégration</a></p>
</blockquote>

<p>On incorpore la base de donnée et les modèles sequelize dans notre serveur.</p>

<h2 id="intégration-de-la-base-de-donnée">intégration de la base de donnée</h2>

<p>On pourrait mettre le code en vrac dans server.js, mais ce n’est pas vraiment une bonne pratique. On va créer dans notre projet plusieurs fichiers relatif à la base.</p>

<p>On va créer un module <em>“commentaires/db.js”</em> dont le but sera de rendre un objet permettant de gérer la base de donnée :</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="p">{</span> <span class="nx">Sequelize</span><span class="p">,</span> <span class="nx">DataTypes</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">sequelize</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">sequelize</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Sequelize</span><span class="p">(</span><span class="dl">'</span><span class="s1">sqlite::memory:</span><span class="dl">'</span><span class="p">);</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">sequeleize</span><span class="p">:</span> <span class="nx">sequelize</span> 
<span class="p">}</span>
</code></pre></div></div>

<p>Dans un projet node, si l’on importe plusieurs fois le même module, on ne lira le fichier que la prmière fois. La seconde fois, node ne renverra uniquement que le <code class="language-plaintext highlighter-rouge">module.exports</code>. On peut donc exécuter du code, ici faire le lien avec notre base de donnée sans soucis, il ne sera exécuté qu’une fois.</p>

<p>On peut maintenant ajouter l’import dans <em>“commentaires/server.js”</em> :</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// ...</span>

<span class="nx">db</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">./db</span><span class="dl">'</span><span class="p">)</span>

<span class="c1">// ...</span>
</code></pre></div></div>

<blockquote>
  <p>Notez que comme c’est un import à nous, le chemin est relatif (<code class="language-plaintext highlighter-rouge">./</code>).</p>
</blockquote>

<h2 id="modèles">modèles</h2>

<p>La base de données c’est bien, mais il manque tous les modèles que nous avons crées.</p>

<p>Pour cela, l’usage est de créer un dossier <em>“models”</em> où l’on stocke nos modèles. Donc créons un dossier <em>“commentaires/models”</em> et placez-y le fichier du model <em>“message.js”</em> :</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="p">{</span> <span class="nx">DataTypes</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">sequelize</span><span class="dl">'</span><span class="p">);</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">(</span><span class="nx">sequelize</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">sequelize</span><span class="p">.</span><span class="nx">define</span><span class="p">(</span><span class="dl">'</span><span class="s1">Message</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
        <span class="na">pseudo</span><span class="p">:</span> <span class="p">{</span>
            <span class="na">type</span><span class="p">:</span> <span class="nx">DataTypes</span><span class="p">.</span><span class="nx">STRING</span><span class="p">,</span>
            <span class="na">allowNull</span><span class="p">:</span> <span class="kc">false</span>
        <span class="p">},</span>
        <span class="na">titre</span><span class="p">:</span> <span class="p">{</span>
            <span class="na">type</span><span class="p">:</span> <span class="nx">DataTypes</span><span class="p">.</span><span class="nx">STRING</span><span class="p">,</span>
            <span class="na">allowNull</span><span class="p">:</span> <span class="kc">false</span>
        <span class="p">},</span>
        <span class="na">message</span><span class="p">:</span> <span class="p">{</span>
            <span class="na">type</span><span class="p">:</span> <span class="nx">DataTypes</span><span class="p">.</span><span class="nx">STRING</span><span class="p">,</span>
            <span class="na">allowNull</span><span class="p">:</span> <span class="kc">false</span>
        <span class="p">},</span>
    <span class="p">},</span> <span class="p">{</span>
        <span class="c1">// Other model options go here</span>
    <span class="p">});</span>
<span class="p">}</span>
</code></pre></div></div>

<p>La création du modèle nécessitant la base de données, il faut que l’on connaisse la base lorsque l’on crée le domèle. L’astuce ici est de rendre une fonction. Ce qui nous permettra d’importer notre modèle dans <em>“db.js”</em> en utilisant la base de données crée. De là, le fichier <em>“db.js”</em> :</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="p">{</span> <span class="nx">Sequelize</span><span class="p">,</span> <span class="nx">DataTypes</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">sequelize</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">sequelize</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Sequelize</span><span class="p">(</span><span class="dl">'</span><span class="s1">sqlite::memory:</span><span class="dl">'</span><span class="p">);</span>

<span class="kd">const</span> <span class="nx">message</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">./models/message</span><span class="dl">'</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">Message</span> <span class="o">=</span> <span class="nx">message</span><span class="p">(</span><span class="nx">sequelize</span><span class="p">)</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">sequelize</span><span class="p">:</span> <span class="nx">sequelize</span><span class="p">,</span> 
    <span class="na">models</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">Message</span><span class="p">:</span> <span class="nx">Message</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>C’est technique s’appelle <a href="https://www.freecodecamp.org/news/a-quick-intro-to-dependency-injection-what-it-is-and-when-to-use-it-7578c84fa88f/">injection de dépendances</a> : on donne ses dépendances à l’objet lors de l’exécution et c’est très très puissant pour découpler les dépendances entre objets.</p>

<blockquote>
  <p>On aurait pu écrire les 2 lignes de l’injection de dépendances en une seule : <code class="language-plaintext highlighter-rouge">const Message = require('./models/message')(sequelize)</code></p>
</blockquote>

<p>Enfin, on joute une synchronisation de la base après avoir chargé nos modèles. Cette synchronisation n’est obligatoire que si la base ne connait pas le modèle chargé. Pour plus de sureté, on le l’exécuter tout le temps :</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="p">{</span> <span class="nx">Sequelize</span><span class="p">,</span> <span class="nx">DataTypes</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">sequelize</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">sequelize</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Sequelize</span><span class="p">(</span><span class="dl">'</span><span class="s1">sqlite::memory:</span><span class="dl">'</span><span class="p">);</span>

<span class="kd">const</span> <span class="nx">message</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">./models/message</span><span class="dl">'</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">Message</span> <span class="o">=</span> <span class="nx">message</span><span class="p">(</span><span class="nx">sequelize</span><span class="p">);</span>

<span class="p">(</span><span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">// await sequelize.sync({ force: true });</span>
    <span class="k">await</span> <span class="nx">sequelize</span><span class="p">.</span><span class="nx">sync</span><span class="p">();</span>
<span class="p">})()</span>


<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">sequelize</span><span class="p">:</span> <span class="nx">sequelize</span><span class="p">,</span> 
    <span class="na">models</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">Message</span><span class="p">:</span> <span class="nx">Message</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<blockquote>
  <p>Il faut mettre le <code class="language-plaintext highlighter-rouge">;</code> avant de commencer une instruction par une parenthèse, sinon javascript ne sait pas si c’est la suite de l’inscruction précédente ou une nouvelle instruction.</p>
</blockquote>

<p>On a utilisé le truc de la fonction <code class="language-plaintext highlighter-rouge">async</code> pour attendre la fin d’une fonction asynchrone. C’est important ici car on <strong>doit</strong> fini la synchronisation de la base avant de finir l’importation.</p>

<p>Vous pouvez tester en remplaçant la fonction <code class="language-plaintext highlighter-rouge">async</code> par  le code suivant :</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">// await sequelize.sync({ force: true });</span>
    <span class="k">await</span> <span class="nx">sequelize</span><span class="p">.</span><span class="nx">sync</span><span class="p">();</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">je suis là</span><span class="dl">"</span><span class="p">)</span>
<span class="p">})()</span>
</code></pre></div></div>

<blockquote class="attention">
  <p>Si vous enlevez le mot <code class="language-plaintext highlighter-rouge">await</code>, le texte <code class="language-plaintext highlighter-rouge">"je suis là"</code> sera affiché avant le résultat de la fonction de synchronisation. Si à la place du <code class="language-plaintext highlighter-rouge">console.log</code> on avait tenté d’utiliser la base de données, on aurait eu une erreur.</p>
</blockquote>

<h2 id="modèle-de-base-de-données">modèle de base de données</h2>

<p>On a donc un module qui sera importé à chaque fois qu’on a besoin d’accéder notre base de données : le fichier <em>“commentaires/db.js”</em>. Ce fichier va inclure tous les modèles de notre base puis faire une synchronisation avec la base. Ceci ne sera fait qu’au premier import, lors des prochains import seule <code class="language-plaintext highlighter-rouge">module.exports</code> sera rendu, le reste du code ne sera même pas exécuté.</p>

<p>Au final, pour la suite de nos développements, on va utiliser une base de donnée sqlite, histoire de ne pas avoir à remettre des données à chaque fois que l’on relance le serveur (ce qui va arriver souvent en phase de développement…). On a alors le fichier <em>“commentaires/db.js”</em> suivant :</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="p">{</span> <span class="nx">Sequelize</span><span class="p">,</span> <span class="nx">DataTypes</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">sequelize</span><span class="dl">'</span><span class="p">);</span>
<span class="c1">//const sequelize = new Sequelize('sqlite::memory:');</span>

<span class="nx">path</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">path</span><span class="dl">'</span><span class="p">)</span>

<span class="kd">const</span> <span class="nx">sequelize</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Sequelize</span><span class="p">({</span>
  <span class="na">dialect</span><span class="p">:</span> <span class="dl">'</span><span class="s1">sqlite</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">storage</span><span class="p">:</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="dl">'</span><span class="s1">db.sqlite</span><span class="dl">'</span><span class="p">)</span>
<span class="p">});</span>

<span class="kd">const</span> <span class="nx">message</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">./models/message</span><span class="dl">'</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">Message</span> <span class="o">=</span> <span class="nx">message</span><span class="p">(</span><span class="nx">sequelize</span><span class="p">);</span>

<span class="p">(</span><span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">// await sequelize.sync({ force: true });</span>
    <span class="k">await</span> <span class="nx">sequelize</span><span class="p">.</span><span class="nx">sync</span><span class="p">();</span>
<span class="p">})()</span>


<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">sequelize</span><span class="p">:</span> <span class="nx">sequelize</span><span class="p">,</span> 
    <span class="na">models</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">Message</span><span class="p">:</span> <span class="nx">Message</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

  </div>

</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/cours_informatique/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">cours d'informatique</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">cours d'informatique</li>
</ul>
      </div>

      <div class="footer-col footer-col-2">
<ul class="social-media-list"><li><a href="https://github.com/FrancoisBrucker"><svg class="svg-icon"><use xlink:href="/cours_informatique/assets/minima-social-icons.svg#github"></use></svg> <span class="username">FrancoisBrucker</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>Support de cours/td d'informatique à l'école centrale marseille.</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>

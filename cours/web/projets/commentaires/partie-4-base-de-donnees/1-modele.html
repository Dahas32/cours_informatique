<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Projet commentaires : partie 4 / modèle | cours d’informatique</title>
<meta name="generator" content="Jekyll v4.2.0">
<meta property="og:title" content="Projet commentaires : partie 4 / modèle">
<meta name="author" content="François Brucker">
<meta property="og:locale" content="en_US">
<meta name="description" content="Support de cours/td d’informatique de François Brucker.">
<meta property="og:description" content="Support de cours/td d’informatique de François Brucker.">
<link rel="canonical" href="/cours_informatique/cours/web/projets/commentaires/partie-4-base-de-donnees/1-modele.html">
<meta property="og:url" content="/cours_informatique/cours/web/projets/commentaires/partie-4-base-de-donnees/1-modele.html">
<meta property="og:site_name" content="cours d’informatique">
<meta property="og:type" content="website">
<meta name="twitter:card" content="summary">
<meta property="twitter:title" content="Projet commentaires : partie 4 / modèle">
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","author":{"@type":"Person","name":"François Brucker"},"description":"Support de cours/td d’informatique de François Brucker.","headline":"Projet commentaires : partie 4 / modèle","url":"/cours_informatique/cours/web/projets/commentaires/partie-4-base-de-donnees/1-modele.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/cours_informatique/assets/main.css">

  <link rel="stylesheet" href="/cours_informatique/assets/custom.css">

  <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
<link type="application/atom+xml" rel="alternate" href="/cours_informatique/feed.xml" title="cours d'informatique">
</head>

<body>
<header class="site-header" role="banner">

  <div class="wrapper">
<a class="site-title" rel="author" href="/cours_informatique/">cours d'informatique</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger">
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewbox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"></path>
            </svg>
          </span>
        </label>

        <div class="trigger">
            <a class="page-link" href="/cours_informatique/about"> about </a>
        </div>
      </nav>
</div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post">

  <header class="post-header">
    <h1 class="post-title">Projet commentaires : partie 4 / modèle</h1>Auteur : <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span class="p-author h-card" itemprop="name">François Brucker</span></span>
  </header>

  <div class="post-content">
    <blockquote class="chemin">
  <p><a href="/cours_informatique/cours/web/projets/commentaires/">commentaires</a> / <a href="/cours_informatique/cours/web/projets/commentaires/partie-4-base-de-donnees/">partie 4</a> / <a href="/cours_informatique/cours/web/projets/commentaires/partie-4-base-de-donnees/1-modele.html">modèle</a></p>
</blockquote>

<h2 id="sequelize">sequelize</h2>

<p>La vie est trop courte pour taper du SQL à la main. On va utiliser <a href="https://sequelize.org/">sequelize</a> qui va nous permettre de gérer tout le côté configuration et utilisation de SQL pour nous.</p>

<p>En effet, selon la base, le dialecte SQL sera différent. Si l’on écrit nos requêtes à la main, il faudra toutes les changer lorsque l’on change de base, ce qui n’est pas humainement possible. On va donc écrire nos requête dans le formalisme de sequelize qui va le traduire pour chaque base utilisée.</p>

<p>Commençons par installer la dépendance sequelize dans le projet, côté back. Tapez la commande suivante dans le dossier <em>“commentaires”</em> :</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npm <span class="nb">install</span> <span class="nt">--save</span> sequelize
</code></pre></div></div>

<p>Notre base de donnée étant sqlite3, on installe également le driver :</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npm <span class="nb">install</span> <span class="nt">--save</span> sqlite3
</code></pre></div></div>

<blockquote>
  <p>Le driver sqlite3 est différent du logiciel sqlite3 que vous avez déjà installé (enfin, je crois).</p>
</blockquote>

<p>Nous allons ici utiliser une base de donnée en mémoire. Elle sera remise à zéro à chaque fois que l’on relancera le serveur.</p>

<p>On initialise sequelize avec les deux lignes suivantes :</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="p">{</span> <span class="nx">Sequelize</span><span class="p">,</span> <span class="nx">DataTypes</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">sequelize</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">sequelize</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Sequelize</span><span class="p">(</span><span class="dl">'</span><span class="s1">sqlite::memory:</span><span class="dl">'</span><span class="p">);</span>
</code></pre></div></div>

<p>La première récupère le module, la seconde crée le lien entre la base de donnée et nous.</p>

<blockquote>
  <p>Si on avait eu une base de donnée physique ou un serveur de base de donnée, on aurait eu besoin de mettre nos login/mots de passe</p>
</blockquote>

<h2 id="modèle">modèle</h2>

<p>Nous avons envi de sauvegarder les commentaires. C’est à dire 3 chaînes de caractères. Les types possible de champ sont disponible <a href="https://sequelize.org/v5/manual/data-types.html">dans la documentation</a>. On va prendre les chaine les plus simple : <code class="language-plaintext highlighter-rouge">Sequelize.STRING</code> (tous nos champs devront avoir moins de 255 caractères).</p>

<p>Notre modèle de message est alors :</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="p">{</span> <span class="nx">Sequelize</span><span class="p">,</span> <span class="nx">DataTypes</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">sequelize</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">sequelize</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Sequelize</span><span class="p">(</span><span class="dl">'</span><span class="s1">sqlite::memory:</span><span class="dl">'</span><span class="p">);</span>

<span class="kd">const</span> <span class="nx">Message</span> <span class="o">=</span> <span class="nx">sequelize</span><span class="p">.</span><span class="nx">define</span><span class="p">(</span><span class="dl">'</span><span class="s1">User</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">pseudo</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">type</span><span class="p">:</span> <span class="nx">DataTypes</span><span class="p">.</span><span class="nx">STRING</span><span class="p">,</span>
    <span class="na">allowNull</span><span class="p">:</span> <span class="kc">false</span>
  <span class="p">},</span>
  <span class="na">titre</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">type</span><span class="p">:</span> <span class="nx">DataTypes</span><span class="p">.</span><span class="nx">STRING</span><span class="p">,</span>
    <span class="na">allowNull</span><span class="p">:</span> <span class="kc">false</span>
  <span class="p">},</span>
  <span class="na">message</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">type</span><span class="p">:</span> <span class="nx">DataTypes</span><span class="p">.</span><span class="nx">STRING</span><span class="p">,</span>
    <span class="na">allowNull</span><span class="p">:</span> <span class="kc">false</span>
  <span class="p">},</span>
<span class="p">},</span> <span class="p">{</span>
  <span class="c1">// Other model options go here</span>
<span class="p">});</span>

</code></pre></div></div>

<p>On demande qu’un message soit 3 chaînes de caractères non vide. Notez qu’on a pas donné de clé primaire : dans ce cas sequelize en crée une qui s’appelle <code class="language-plaintext highlighter-rouge">id</code> pour nous.</p>

<h2 id="création-de-la-base">création de la base</h2>

<blockquote class="note">
  <p>TBD :
ne pas mettre force…</p>
</blockquote>

<p>Nous n’avons pour l’instant que créé le modèle, il n’existe pas encore dans la base. Comme notre modèle est en mémoire, on va faire en sorte de recréer la base en changeant tous les modèles que nous avons défini (ici un seul). Ceci se fait avec la ligne :</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">await</span> <span class="nx">sequelize</span><span class="p">.</span><span class="nx">sync</span><span class="p">({</span> <span class="na">force</span><span class="p">:</span> <span class="kc">true</span> <span class="p">});</span>
</code></pre></div></div>

<p>Le mot clé <code class="language-plaintext highlighter-rouge">await</code> précise que l’on attend que la commande soit finie avant de passer à la ligne suivante. La commande est asynchrone par défaut, mais on ne veut pas commencer à faire des choses avec la base de donnée avant qu’elle ait été complètement créée.</p>

<p>On ne peut cependant pas utiliser <code class="language-plaintext highlighter-rouge">await</code> comme ça, il doit être dans une fonction de type <code class="language-plaintext highlighter-rouge">async</code> (asynchrone), ce que n’est pas notre programme par défaut. On utilise du coup le truc suivant :</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">await</span> <span class="nx">sequelize</span><span class="p">.</span><span class="nx">sync</span><span class="p">({</span> <span class="na">force</span><span class="p">:</span> <span class="kc">true</span> <span class="p">});</span>
    <span class="c1">// Code here</span>
  <span class="p">})();</span>
</code></pre></div></div>

<p>On exécute notre code dans une fonction asynchrone sans paramètre qui est exécutée juste après avoir été définie.</p>

<blockquote>
  <p>Le javascript est formidable, non ?</p>
</blockquote>

<h2 id="fichier-de-test">fichier de test</h2>

<p>Avant d’incorporer la base de donnée dans le code du serveur, on va déjà l’utiliser dans un fichier séparé, histoire de voir si tout se passe comme prévu.</p>

<p>Créez un fichier <em>“db.test.js”</em> dans <em>“commentaires”</em> et on pourra y mettre le code suivant pour voir comment tout ça peut fonctionne :</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="p">{</span> <span class="nx">Sequelize</span><span class="p">,</span> <span class="nx">DataTypes</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">sequelize</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">sequelize</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Sequelize</span><span class="p">(</span><span class="dl">'</span><span class="s1">sqlite::memory:</span><span class="dl">'</span><span class="p">);</span>

<span class="kd">const</span> <span class="nx">Message</span> <span class="o">=</span> <span class="nx">sequelize</span><span class="p">.</span><span class="nx">define</span><span class="p">(</span><span class="dl">'</span><span class="s1">Message</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
    <span class="na">pseudo</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">type</span><span class="p">:</span> <span class="nx">DataTypes</span><span class="p">.</span><span class="nx">STRING</span><span class="p">,</span>
      <span class="na">allowNull</span><span class="p">:</span> <span class="kc">false</span>
    <span class="p">},</span>
    <span class="na">titre</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">type</span><span class="p">:</span> <span class="nx">DataTypes</span><span class="p">.</span><span class="nx">STRING</span><span class="p">,</span>
      <span class="na">allowNull</span><span class="p">:</span> <span class="kc">false</span>
    <span class="p">},</span>
    <span class="na">message</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">type</span><span class="p">:</span> <span class="nx">DataTypes</span><span class="p">.</span><span class="nx">STRING</span><span class="p">,</span>
      <span class="na">allowNull</span><span class="p">:</span> <span class="kc">false</span>
    <span class="p">},</span>
  <span class="p">},</span> <span class="p">{</span>
    <span class="c1">// Other model options go here</span>
  <span class="p">});</span>
  
  <span class="p">(</span><span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">await</span> <span class="nx">sequelize</span><span class="p">.</span><span class="nx">sync</span><span class="p">({</span> <span class="na">force</span><span class="p">:</span> <span class="kc">true</span> <span class="p">});</span>
    <span class="c1">// Code here</span>
  <span class="p">})();</span>
</code></pre></div></div>

<p>En exécutant ce code on voit (en SQL, dialecte parlé par sqlite qui est notre base de donnée) ce que fait sequelize. Le résultat de la commande <code class="language-plaintext highlighter-rouge">node db.test.js</code> donne :</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Executing (default): DROP TABLE IF EXISTS `Users`;
Executing (default): DROP TABLE IF EXISTS `Users`;
Executing (default): CREATE TABLE IF NOT EXISTS `Users` (`id` INTEGER PRIMARY KEY AUTOINCREMENT, `pseudo` VARCHAR(255) NOT NULL, `titre` VARCHAR(255) NOT NULL, `message` VARCHAR(255) NOT NULL, `createdAt` DATETIME NOT NULL, `updatedAt` DATETIME NOT NULL);
Executing (default): PRAGMA INDEX_LIST(`Users`)
</code></pre></div></div>

<p>On supprime toute la base puis on recrée notre modèle <code class="language-plaintext highlighter-rouge">Message</code>.</p>

<h2 id="crud">crud</h2>

<p>Pour l’accès à nos données, on utilise le formalisme <a href="https://fr.wikipedia.org/wiki/CRUD">CRUD</a>, c’est à dire que l’on veut avoir des url qui nous permettent de :</p>

<ul>
  <li>
<strong>C</strong>reate : créer un message</li>
  <li>
<strong>R</strong>ead : lire un message</li>
  <li>
<strong>U</strong>pdate : mettre à jour un message</li>
  <li>
<strong>D</strong>elete : supprimer un message</li>
</ul>

<p>Nous utiliserons l’id qui est ajouté par défaut à chaque message pour spécifier directement  un message.</p>

<p>Avant de créer les routes, concentrons nous sur les façons de faire ça en sequelize.</p>

<h3 id="create">create</h3>

<blockquote>
  <p><a href="https://sequelize.org/master/manual/model-instances.html#creating-an-instance">https://sequelize.org/master/manual/model-instances.html#creating-an-instance</a></p>
</blockquote>

<p>On veut créer une donnée avec sequelize en ayant le pseudo, le titre et le corps du message. On peut faire comme ça :</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">pseudo</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">François</span><span class="dl">"</span>
<span class="nx">titre</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">un coup de gueule</span><span class="dl">"</span>
<span class="nx">corps</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">il faut permettre aux étudiants de de faire plus d'informatique !</span><span class="dl">"</span>

<span class="kd">const</span> <span class="nx">message</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">Message</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
    <span class="na">pseudo</span><span class="p">:</span> <span class="nx">pseudo</span><span class="p">,</span>
    <span class="na">titre</span><span class="p">:</span> <span class="nx">titre</span><span class="p">,</span>
    <span class="na">message</span><span class="p">:</span> <span class="nx">corps</span>
<span class="p">})</span>
</code></pre></div></div>

<p>Le message est poussé en base. Son <code class="language-plaintext highlighter-rouge">id</code> est visible : <code class="language-plaintext highlighter-rouge">console.log(message.id)</code>. Si c’est le premier élément que vous créez, son <code class="language-plaintext highlighter-rouge">id</code> sera de 1, et si vous en créez d’autres, l’<code class="language-plaintext highlighter-rouge">id</code> va augmenter. C’est la clé primaire de notre modèle.</p>

<p>Testons ça en modifiant notre fonction <code class="language-plaintext highlighter-rouge">async</code> de <code class="language-plaintext highlighter-rouge">test.db.js</code> :</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">await</span> <span class="nx">sequelize</span><span class="p">.</span><span class="nx">sync</span><span class="p">({</span> <span class="na">force</span><span class="p">:</span> <span class="kc">true</span> <span class="p">});</span>
    <span class="c1">// Code here</span>
    <span class="nx">pseudo</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">François</span><span class="dl">"</span>
    <span class="nx">titre</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">un coup de gueule</span><span class="dl">"</span>
    <span class="nx">corps</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">il faut permettre aux étudiants de de faire plus d'informatique !</span><span class="dl">"</span>

    <span class="nx">message</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">Message</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
        <span class="na">pseudo</span><span class="p">:</span> <span class="nx">pseudo</span><span class="p">,</span>
        <span class="na">titre</span><span class="p">:</span> <span class="nx">titre</span><span class="p">,</span>
        <span class="na">message</span><span class="p">:</span> <span class="nx">corps</span>
    <span class="p">})</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span>
    
    <span class="nx">messages</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">Message</span><span class="p">.</span><span class="nx">findAll</span><span class="p">({});</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">messages</span><span class="p">);</span>
<span class="p">})();</span>
</code></pre></div></div>

<p>On crée un message, on note son id puis on cherche tous les messages de la base et on les affiche (notez le <code class="language-plaintext highlighter-rouge">await</code> dans la dernière ligne pour être sur que o’n a tout chargé avant de l’afficher).</p>

<h3 id="read">read</h3>

<blockquote>
  <p><a href="https://sequelize.org/master/manual/model-querying-finders.html#-code-findbypk--code-">https://sequelize.org/master/manual/model-querying-finders.html#-code-findbypk--code-</a></p>
</blockquote>

<p>On va lire une instance en connaissant sa clé primaire.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">message</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">Message</span><span class="p">.</span><span class="nx">findByPk</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div></div>

<p>Si l’on donne une clé primaire inexistante, on récupère l’objet <code class="language-plaintext highlighter-rouge">null</code>.</p>

<h3 id="update">update</h3>

<blockquote>
  <p><a href="https://sequelize.org/master/manual/model-instances.html#updating-an-instance">https://sequelize.org/master/manual/model-instances.html#updating-an-instance</a></p>
</blockquote>

<p>On met à jour un objet en connaissant sa clé primaire et les attributs à changer.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">message</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">Message</span><span class="p">.</span><span class="nx">findByPk</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="nx">message</span><span class="p">.</span><span class="nx">titre</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">un pavé dans la marre</span><span class="dl">"</span>

<span class="nx">message</span><span class="p">.</span><span class="nx">save</span><span class="p">()</span>
</code></pre></div></div>

<h3 id="delete">delete</h3>

<blockquote>
  <p><a href="https://sequelize.org/master/manual/model-instances.html#deleting-an-instance">https://sequelize.org/master/manual/model-instances.html#deleting-an-instance</a></p>
</blockquote>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">message</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">Message</span><span class="p">.</span><span class="nx">findByPk</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

<span class="k">await</span> <span class="nx">message</span><span class="p">.</span><span class="nx">destroy</span><span class="p">();</span>
</code></pre></div></div>

<h2 id="requêtes">requêtes</h2>

<p>Nous allons aussi avoir besoin de 2 routes spéciales, pour la page <strong>lire.html</strong> :</p>

<ul>
  <li>une route qui rend une liste de tous les messages</li>
  <li>une route qui rend une liste de tous les messages pour un pseudo donné.</li>
</ul>

<h3 id="tous-les-messages">tous les messages</h3>

<p>On a déjà utilisé cette requête, c’est <code class="language-plaintext highlighter-rouge">Message.findAll({}))</code>.</p>

<h3 id="les-messages-dun-pseudo">les messages d’un pseudo</h3>

<p>Il suffit de donner des contraintes à la requête <code class="language-plaintext highlighter-rouge">findAll</code> grâce un <code class="language-plaintext highlighter-rouge">where</code> sqlien :</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">messages</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">Message</span><span class="p">.</span><span class="nx">findAll</span><span class="p">({</span>
        <span class="na">where</span><span class="p">:</span> <span class="p">{</span>
            <span class="na">pseudo</span><span class="p">:</span> <span class="dl">"</span><span class="s2">François</span><span class="dl">"</span>
        <span class="p">}</span>
    <span class="p">})</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">messages</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="requêtes-possible-dans-sequelize">requêtes possible dans sequelize</h3>

<p>Les requêtes possibles dans sequelize sont très puissantes. Regardez du côté de la <a href="https://sequelize.org/master/manual/model-querying-basics.html">documentation sur les requêtes basiques</a>, c’est en plus (presque) facile à utiliser.</p>

<p>Si vous êtes en mal de SQL, vous pouvez bien sur aussi utiliser les <a href="https://sequelize.org/master/manual/raw-queries.html">requêtes SQL</a> standards.</p>

<h2 id="base-de-donnée-en-dur">base de donnée en dur</h2>

<blockquote>
  <p><a href="https://sequelize.org/master/manual/getting-started.html#connecting-to-a-database">https://sequelize.org/master/manual/getting-started.html#connecting-to-a-database</a></p>
</blockquote>

<p>Pour ne pas avoir une base de donnée en mémoire (ce qui est bien pour des tests par exemple, mais en prod on aimerait ne pas tout perdre à chaque fois qu’un relance le serveur).</p>

<p>Si l’on veut utiliser une base de données sqlite en dur on peut alors créer le lien sequelize avec la base comme ça :</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="p">{</span> <span class="nx">Sequelize</span><span class="p">,</span> <span class="nx">DataTypes</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">sequelize</span><span class="dl">'</span><span class="p">);</span>

<span class="nx">path</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">path</span><span class="dl">'</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">sequelize</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Sequelize</span><span class="p">({</span>
  <span class="na">dialect</span><span class="p">:</span> <span class="dl">'</span><span class="s1">sqlite</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">storage</span><span class="p">:</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="dl">'</span><span class="s1">db.sqlite</span><span class="dl">'</span><span class="p">)</span>
<span class="p">});</span>
</code></pre></div></div>

<p>On vient de créer (si le fichier <em>“db.sqlite”</em> n’existait pas) ou d’utiliser la base de donnée sqlite dans un fichier dans le dossier <em>“commentaires”</em>.</p>

<blockquote class="attention">
  <p>Si vous utilisez une base de donnée persistante,  remplacez la ligne <code class="language-plaintext highlighter-rouge">await sequelize.sync({ force: true });</code> par <code class="language-plaintext highlighter-rouge">await sequelize.sync();</code>. Comme cela, la base est juste synchronisée (on ajoute les modèles qui ne sont pas encore dans la base) et non remise à plat. Ceci vous permet d’avoir une base qui va grandir au fil du temps.</p>
</blockquote>

<h2 id="fichier">fichier</h2>

<p>Le fichier <em>3commentaires/db.test.js”</em> ressemble à la fin de ces tests à ça :</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="p">{</span> <span class="nx">Sequelize</span><span class="p">,</span> <span class="nx">DataTypes</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">sequelize</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">sequelize</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Sequelize</span><span class="p">(</span><span class="dl">'</span><span class="s1">sqlite::memory:</span><span class="dl">'</span><span class="p">);</span>

<span class="c1">// path = require('path')</span>

<span class="c1">// const sequelize = new Sequelize({</span>
<span class="c1">//   dialect: 'sqlite',</span>
<span class="c1">//   storage: path.join(__dirname, 'db.sqlite')</span>
<span class="c1">// });</span>

<span class="kd">const</span> <span class="nx">Message</span> <span class="o">=</span> <span class="nx">sequelize</span><span class="p">.</span><span class="nx">define</span><span class="p">(</span><span class="dl">'</span><span class="s1">Message</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
    <span class="na">pseudo</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">type</span><span class="p">:</span> <span class="nx">DataTypes</span><span class="p">.</span><span class="nx">STRING</span><span class="p">,</span>
        <span class="na">allowNull</span><span class="p">:</span> <span class="kc">false</span>
    <span class="p">},</span>
    <span class="na">titre</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">type</span><span class="p">:</span> <span class="nx">DataTypes</span><span class="p">.</span><span class="nx">STRING</span><span class="p">,</span>
        <span class="na">allowNull</span><span class="p">:</span> <span class="kc">false</span>
    <span class="p">},</span>
    <span class="na">message</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">type</span><span class="p">:</span> <span class="nx">DataTypes</span><span class="p">.</span><span class="nx">STRING</span><span class="p">,</span>
        <span class="na">allowNull</span><span class="p">:</span> <span class="kc">false</span>
    <span class="p">},</span>
<span class="p">},</span> <span class="p">{</span>
    <span class="c1">// Other model options go here</span>
<span class="p">});</span>

<span class="p">(</span><span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">// await sequelize.sync({ force: true });</span>
    <span class="k">await</span> <span class="nx">sequelize</span><span class="p">.</span><span class="nx">sync</span><span class="p">();</span>
    
    <span class="c1">// Code here</span>
    <span class="nx">pseudo</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">François</span><span class="dl">"</span>
    <span class="nx">titre</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">un coup de gueule</span><span class="dl">"</span>
    <span class="nx">corps</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">il faut permettre aux étudiants de de faire plus d'informatique !</span><span class="dl">"</span>

    <span class="nx">message</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">Message</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
        <span class="na">pseudo</span><span class="p">:</span> <span class="nx">pseudo</span><span class="p">,</span>
        <span class="na">titre</span><span class="p">:</span> <span class="nx">titre</span><span class="p">,</span>
        <span class="na">message</span><span class="p">:</span> <span class="nx">corps</span>
    <span class="p">})</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span>

    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="k">await</span> <span class="nx">Message</span><span class="p">.</span><span class="nx">findAll</span><span class="p">({}));</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="k">await</span> <span class="nx">Message</span><span class="p">.</span><span class="nx">findByPk</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>

    <span class="nx">message</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">Message</span><span class="p">.</span><span class="nx">findByPk</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="nx">message</span><span class="p">.</span><span class="nx">titre</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">un pavé dans la marre</span><span class="dl">"</span>

    <span class="nx">message</span><span class="p">.</span><span class="nx">save</span><span class="p">()</span>

    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="k">await</span> <span class="nx">Message</span><span class="p">.</span><span class="nx">findByPk</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>

    <span class="nx">messages</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">Message</span><span class="p">.</span><span class="nx">findAll</span><span class="p">({</span>
        <span class="na">where</span><span class="p">:</span> <span class="p">{</span>
            <span class="na">pseudo</span><span class="p">:</span> <span class="dl">"</span><span class="s2">François</span><span class="dl">"</span>
        <span class="p">}</span>
    <span class="p">})</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">messages</span><span class="p">)</span>

    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">------</span><span class="dl">"</span><span class="p">)</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">messages</span><span class="p">)</span>

<span class="p">})();</span>
</code></pre></div></div>

  </div>

</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/cours_informatique/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">cours d'informatique</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">cours d'informatique</li>
</ul>
      </div>

      <div class="footer-col footer-col-2">
<ul class="social-media-list"><li><a href="https://github.com/FrancoisBrucker"><svg class="svg-icon"><use xlink:href="/cours_informatique/assets/minima-social-icons.svg#github"></use></svg> <span class="username">FrancoisBrucker</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>Support de cours/td d'informatique de François Brucker.</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>

<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Projet numérologie : partie 5 / tests de routes | cours d’informatique</title>
<meta name="generator" content="Jekyll v4.2.0" />
<meta property="og:title" content="Projet numérologie : partie 5 / tests de routes" />
<meta name="author" content="François Brucker" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Support de cours/td d’informatique à l’école centrale marseille." />
<meta property="og:description" content="Support de cours/td d’informatique à l’école centrale marseille." />
<link rel="canonical" href="/cours_informatique/cours/web/projets/numerologie/partie-5-tests/2-tests-routes.html" />
<meta property="og:url" content="/cours_informatique/cours/web/projets/numerologie/partie-5-tests/2-tests-routes.html" />
<meta property="og:site_name" content="cours d’informatique" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Projet numérologie : partie 5 / tests de routes" />
<script type="application/ld+json">
{"description":"Support de cours/td d’informatique à l’école centrale marseille.","@type":"WebPage","headline":"Projet numérologie : partie 5 / tests de routes","url":"/cours_informatique/cours/web/projets/numerologie/partie-5-tests/2-tests-routes.html","author":{"@type":"Person","name":"François Brucker"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/cours_informatique/assets/main.css">

  <link rel="stylesheet" href="/cours_informatique/assets/custom.css"><link type="application/atom+xml" rel="alternate" href="/cours_informatique/feed.xml" title="cours d'informatique" /><!-- Mathjax Support -->
  <script>
    MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
      },
      svg: {
        fontCache: 'global'
      }
    };
    </script>
    <script type="text/javascript" id="MathJax-script" async
      src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js">
    </script>
</head>

<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/cours_informatique/">cours d&#39;informatique</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger">
            <a class="page-link" href="/cours_informatique/about"> about </a>
        </div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post">

  <header class="post-header">
    <h1 class="post-title">Projet numérologie : partie 5 / tests de routes</h1></p>Auteur : <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span class="p-author h-card" itemprop="name">François Brucker</span></span></p>
  </header>

  <div class="post-content">
    <blockquote class="chemin">
  <p><a href="/cours_informatique/cours/web/projets/numerologie/">numérologie</a> / <a href="/cours_informatique/cours/web/projets/numerologie/partie-5-tests/">partie 5</a> / <a href="/cours_informatique/cours/web/projets/numerologie/partie-5-tests/2-tests-routes.html">tests fonctionnels</a></p>
</blockquote>

<p>Le tests des routes du serveur nous permet de garantir que l’api fonctionne bien. C’est différent des tests unitaires car il faut que le serveur tourne pour les faire.</p>

<h2 id="mise-en-place">mise en place</h2>

<p>On va utiliser la bibliothèque <a href="https://github.com/visionmedia/supertest#readme">supertest</a> pour gérer le serveur. Supertest va créer une instance de notre serveur pour chaque test, cela nous permettra de faire plein de test en même temps (il va lancer chaque serveur sur un autre port).</p>

<p>Commençons pas l’installer :</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npm <span class="nb">install </span>supertest <span class="nt">--save-dev</span>
</code></pre></div></div>

<p>Pour pouvoir l’utiliser, il faut séparer l’application (express) du serveur proprement dit. On va donc créer un fichier <em>“numerologie/app.js”</em> qui contiendra toute notre application :</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">path</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">path</span><span class="dl">'</span><span class="p">)</span>

<span class="kd">const</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">express</span><span class="dl">'</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">()</span>

<span class="kd">const</span> <span class="nx">routes</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">./routes</span><span class="dl">"</span><span class="p">)</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">date</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">())</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">Time:</span><span class="dl">'</span><span class="p">,</span> <span class="nx">date</span><span class="p">.</span><span class="nx">toLocaleDateString</span><span class="p">(),</span> <span class="nx">date</span><span class="p">.</span><span class="nx">toLocaleTimeString</span><span class="p">(),</span> <span class="dl">"</span><span class="s2">; url :</span><span class="dl">"</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span>
    <span class="nx">next</span><span class="p">();</span> <span class="c1">// sans cette ligne on ne pourra pas poursuivre.</span>
<span class="p">})</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="dl">"</span><span class="s2">/static</span><span class="dl">"</span><span class="p">,</span> <span class="nx">express</span><span class="p">.</span><span class="kd">static</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="dl">'</span><span class="s1">/static</span><span class="dl">'</span><span class="p">)))</span>

<span class="nx">app</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="mi">301</span><span class="p">,</span> <span class="dl">'</span><span class="s1">/static/index.html</span><span class="dl">'</span><span class="p">)</span>
<span class="p">})</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="dl">'</span><span class="s1">/</span><span class="dl">'</span><span class="p">,</span> <span class="nx">routes</span><span class="p">)</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">et c'est le 404 : </span><span class="dl">"</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span>

    <span class="nx">res</span><span class="p">.</span><span class="nx">statusCode</span> <span class="o">=</span> <span class="mi">404</span><span class="p">;</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">setHeader</span><span class="p">(</span><span class="dl">'</span><span class="s1">Content-Type</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">text/html</span><span class="dl">'</span><span class="p">);</span>

    <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="dl">"</span><span class="s2">&lt;html&gt;&lt;head&gt;&lt;title&gt;la quatre cent quatre&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&lt;h1&gt;Et c'est la 404.&lt;/h1&gt;&lt;img  src=</span><span class="se">\"</span><span class="s2">https://www.leblogauto.com/wp-content/uploads/2020/04/Peugeot-404-1.jpg</span><span class="se">\"</span><span class="s2"> /&gt;&lt;/body&gt;&lt;/html&gt;</span><span class="dl">"</span><span class="p">);</span>

<span class="p">})</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">app</span>
</code></pre></div></div>

<p>et ne laisser que le lancement du serveur à <em>“numerologie/index.js”</em> :</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">./app</span><span class="dl">"</span><span class="p">)</span>

<span class="kd">const</span> <span class="nx">hostname</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">127.0.0.1</span><span class="dl">'</span><span class="p">;</span>
<span class="kd">const</span> <span class="nx">port</span> <span class="o">=</span> <span class="mi">3000</span><span class="p">;</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">port</span><span class="p">,</span> <span class="nx">hostname</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`Server running at http://</span><span class="p">${</span><span class="nx">hostname</span><span class="p">}</span><span class="s2">:</span><span class="p">${</span><span class="nx">port</span><span class="p">}</span><span class="s2">/`</span><span class="p">);</span>
</code></pre></div></div>

<p>C’est <em>“numerologie/app.js”</em> que nous importerons pour nos tests.</p>

<h2 id="tests">tests</h2>

<h3 id="premier-test">premier test</h3>

<p>On va faire un premier test pour voir si on arrive à mettre en place tout ça, dans un fichier <em>“__test__/routes.text.js”</em> :</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">request</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">supertest</span><span class="dl">'</span><span class="p">);</span>

<span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">../app</span><span class="dl">'</span><span class="p">)</span>

<span class="nx">test</span><span class="p">(</span><span class="dl">"</span><span class="s2">GET /</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">request</span><span class="p">(</span><span class="nx">app</span><span class="p">)</span>
        <span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">"</span><span class="s2">/</span><span class="dl">"</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="dl">"</span><span class="s2">Content-Type</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">text/plain; charset=utf-8</span><span class="dl">"</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="mi">301</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">end</span><span class="p">((</span><span class="nx">err</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">done</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="nx">done</span><span class="p">()</span>
        <span class="p">})</span>
<span class="p">})</span>
</code></pre></div></div>

<p>Plusieurs choses :</p>

<ul>
  <li>on a passé un paramètre (<code class="language-plaintext highlighter-rouge">done</code>) dans la fonction de test. Ce paramètre est exécuté en fin de test pour montrer que le test est fini. C’est la façon qu’à jest de traiter les <a href="https://jestjs.io/docs/asynchronous">tests de fonctions asynchrones</a>, sinon il n’a aucun moyen de savoir si un test est fini ou pas.</li>
  <li>on passe l’application à supertest (<code class="language-plaintext highlighter-rouge">request(app)</code>) pour créer un serveur qu’on interroge ensuite.</li>
  <li>n’oubliez pas de finir par <code class="language-plaintext highlighter-rouge">.end</code> pour récupérer les erreurs s’il y en a et exécuter <code class="language-plaintext highlighter-rouge">done</code> pour la fin de test.</li>
</ul>

<h3 id="fichiers-statiques">fichiers statiques</h3>

<p>Ajoutons les tests des autres routes statiques. On va ajouter une autre bibliothèque, <a href="https://github.com/jsdom/jsdom">jsdom</a> (<code class="language-plaintext highlighter-rouge">npm install --save-dev jsdom</code>), qui nous permettra de tester le contenu du html :</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">request</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">supertest</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="p">{</span> <span class="nx">JSDOM</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">jsdom</span><span class="dl">'</span><span class="p">)</span>

<span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">../app</span><span class="dl">'</span><span class="p">)</span>

<span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">routes statiques</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">test</span><span class="p">(</span><span class="dl">"</span><span class="s2">GET /</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">request</span><span class="p">(</span><span class="nx">app</span><span class="p">)</span>
            <span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">"</span><span class="s2">/</span><span class="dl">"</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="dl">"</span><span class="s2">Content-Type</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">text/plain; charset=utf-8</span><span class="dl">"</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="mi">301</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">end</span><span class="p">((</span><span class="nx">err</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="nx">done</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
                <span class="p">}</span>
                <span class="k">return</span> <span class="nx">done</span><span class="p">()</span>
            <span class="p">})</span>
    <span class="p">})</span>

    <span class="nx">test</span><span class="p">(</span><span class="dl">"</span><span class="s2">GET /index.html 404</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">request</span><span class="p">(</span><span class="nx">app</span><span class="p">)</span>
            <span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">"</span><span class="s2">/index.html</span><span class="dl">"</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">end</span><span class="p">((</span><span class="nx">err</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="nx">done</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
                <span class="p">}</span>
                <span class="k">return</span> <span class="nx">done</span><span class="p">()</span>
            <span class="p">})</span>
    <span class="p">})</span>

    <span class="nx">test</span><span class="p">(</span><span class="dl">"</span><span class="s2">GET /static/index.html</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">request</span><span class="p">(</span><span class="nx">app</span><span class="p">)</span>
            <span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">"</span><span class="s2">/static/index.html</span><span class="dl">"</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="dl">"</span><span class="s2">Content-Type</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">text/html; charset=UTF-8</span><span class="dl">"</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">end</span><span class="p">((</span><span class="nx">err</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="nx">done</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
                <span class="p">}</span>
                <span class="k">return</span> <span class="nx">done</span><span class="p">()</span>
            <span class="p">})</span>
    <span class="p">})</span>
    <span class="nx">test</span><span class="p">(</span><span class="dl">"</span><span class="s2">GET /static/prenoms.html</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">request</span><span class="p">(</span><span class="nx">app</span><span class="p">)</span>
            <span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">"</span><span class="s2">/static/prenoms.html</span><span class="dl">"</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="dl">"</span><span class="s2">Content-Type</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">text/html; charset=UTF-8</span><span class="dl">"</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">expect</span><span class="p">((</span><span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
                <span class="nx">dom</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">JSDOM</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">text</span><span class="p">)</span>
                <span class="nx">expect</span><span class="p">(</span><span class="nx">dom</span><span class="p">.</span><span class="nb">window</span><span class="p">.</span><span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="dl">"</span><span class="s2">#main &gt; p</span><span class="dl">"</span><span class="p">).</span><span class="nx">textContent</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="dl">"</span><span class="s2">Chargement des prénoms...</span><span class="dl">"</span><span class="p">)</span>
            <span class="p">})</span>
            <span class="p">.</span><span class="nx">end</span><span class="p">((</span><span class="nx">err</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="nx">done</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
                <span class="p">}</span>
                <span class="k">return</span> <span class="nx">done</span><span class="p">()</span>
            <span class="p">})</span>
    <span class="p">})</span>
<span class="p">})</span>
</code></pre></div></div>

<blockquote>
  <p>On aura tendance à plutôt placer en test fonctionnels les tests qui vérifient du html. On l’a fait ici pour vous introduire la bibliothèque jsdom qui est très pratique</p>
</blockquote>

<h2 id="tests-de-base-de-données">tests de base de données</h2>

<p>Il nous reste deux routes à tester à faire qui concernent les bases de données. On va traiter ces deux cas différemment.</p>

<h3 id="mock">mock</h3>

<p>La première solution est de ne pas toucher la base de donnée et de remplacer un appel de la base de donnée par notre propre code.</p>

<p>Pour cela on utilise le fait qu’en javascript, une fois un module importé une fois, il n’est plus lu ensuite, on ne fait que rendre l’objet <code class="language-plaintext highlighter-rouge">module.exports</code>. De là, on <a href="https://fr.wikipedia.org/wiki/Mock_(programmation_orient%C3%A9e_objet)">mock</a> le module ou une partie de celui ci en l’important une première fois avant tout le monde. Lorsque les autres fichiers importeront le module, c’est notre mock qu’ils vont importer.</p>

<p>On a utilisé cette technique pour tester la route <code class="language-plaintext highlighter-rouge">/api/prenoms/read'</code>en mockant la partie <code class="language-plaintext highlighter-rouge">model</code> du module db. Fichier <em>“numerologie/__test__/donnees.test.js”</em> :</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">request</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">supertest</span><span class="dl">'</span><span class="p">);</span>



<span class="nx">jest</span><span class="p">.</span><span class="nx">mock</span><span class="p">(</span><span class="dl">"</span><span class="s2">../db</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">originalModule</span> <span class="o">=</span> <span class="nx">jest</span><span class="p">.</span><span class="nx">requireActual</span><span class="p">(</span><span class="dl">'</span><span class="s1">../db</span><span class="dl">'</span><span class="p">);</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="na">__esModule</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
        <span class="p">...</span><span class="nx">originalModule</span><span class="p">,</span>
        <span class="na">model</span><span class="p">:</span> <span class="p">{</span>
            <span class="na">Prenoms</span><span class="p">:</span> <span class="p">{</span>
                <span class="na">findAll</span><span class="p">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
                        <span class="nx">resolve</span><span class="p">([{</span> <span class="na">prenom</span><span class="p">:</span> <span class="dl">"</span><span class="s2">toto</span><span class="dl">"</span> <span class="p">}])</span>
                    <span class="p">})</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">},</span>
    <span class="p">};</span>
<span class="p">});</span>

<span class="kd">const</span> <span class="nx">numerologie</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">../back/numerologie</span><span class="dl">"</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">../app</span><span class="dl">'</span><span class="p">)</span>

<span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">GET /api/prenoms/read</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>

    <span class="nx">request</span><span class="p">(</span><span class="nx">app</span><span class="p">)</span>
        <span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">"</span><span class="s2">/api/prenoms/read</span><span class="dl">"</span><span class="p">)</span>
        <span class="c1">// .expect("Content-Type", "application/json; charset=utf-8")</span>
        <span class="p">.</span><span class="nx">expect</span><span class="p">((</span><span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="nx">expect</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">body</span><span class="p">).</span><span class="nx">toEqual</span><span class="p">([{</span>
                <span class="na">prenom</span><span class="p">:</span> <span class="dl">"</span><span class="s2">toto</span><span class="dl">"</span><span class="p">,</span>
                <span class="na">chiffre</span><span class="p">:</span> <span class="nx">numerologie</span><span class="p">.</span><span class="nx">chiffre</span><span class="p">(</span><span class="dl">"</span><span class="s2">toto</span><span class="dl">"</span><span class="p">)</span>
            <span class="p">}])</span>
        <span class="p">})</span>
        <span class="p">.</span><span class="nx">end</span><span class="p">((</span><span class="nx">err</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">done</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="nx">done</span><span class="p">()</span>
        <span class="p">})</span>

<span class="p">})</span>
</code></pre></div></div>

<p>On a dans le code ci-dessus remplacé la partie model du retour du <code class="language-plaintext highlighter-rouge">require("db")</code> par une <a href="https://developer.mozilla.org/fr/docs/Web/JavaScript/Reference/Global_Objects/Promise">promesse</a> qui rend toujours <code class="language-plaintext highlighter-rouge">[{ prenom: "toto" }]</code>. IL n’y a alors plus d’appel à la base de donnée dans la route et le code se poursuit jusqu’à renvoyer la liste qui est notre test.</p>

<blockquote>
  <p>La technique de mock est très puissante ! Elle permet de tester presque tout ce qu’on veut sans soucis. Lisez <a href="https://jestjs.io/docs/mock-functions">la documentation de jest</a> pour plus de renseignements sur ce qu’on peut faire avec.</p>
</blockquote>

<h3 id="environnementbase-de-test">environnement/base de test</h3>

<p>Lorsque l’on a de nombreux appel différent à la base de donnée, il est illusoire de tout mocker. On utilise alors une base de donnée spécifique aux tests. Ceci permet de plus de ne pas toucher à la base de donnée de production, ce qui est indispensable pour garantir la répétabilité des tests (et ne pas casser la production accessoirement).</p>

<h4 id="base-de-test">base de test</h4>

<p>On va commencer par différentier la base selon l’environnement d’exécution. Fichier <em>“numerologie/db.js”</em> :</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//...</span>

<span class="kd">let</span> <span class="nx">env</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">NODE_ENV</span> <span class="o">||</span> <span class="dl">'</span><span class="s1">dev</span><span class="dl">'</span>

<span class="k">if</span> <span class="p">(</span><span class="nx">env</span> <span class="o">==</span> <span class="dl">'</span><span class="s1">test</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">sequelize</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Sequelize</span><span class="p">(</span><span class="dl">'</span><span class="s1">sqlite::memory:</span><span class="dl">'</span><span class="p">);</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
  <span class="nx">sequelize</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Sequelize</span><span class="p">({</span>
    <span class="na">dialect</span><span class="p">:</span> <span class="dl">'</span><span class="s1">sqlite</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">storage</span><span class="p">:</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="dl">'</span><span class="s1">db.sqlite</span><span class="dl">'</span><span class="p">)</span>
  <span class="p">});</span>
<span class="p">}</span>

<span class="c1">// ...</span>
</code></pre></div></div>

<p>Si l’on est dans un environnement de test on crée un base en mémoire et sinon on utilise la base normale.</p>

<p>On place l’environnement :</p>

<ul>
  <li>soit en assignant une valeur à la variable <code class="language-plaintext highlighter-rouge">process.env.NODE_ENV</code> (<a href="https://nodejs.org/api/process.html#process">process</a> est bibliothèque globale à node et on peut mettre ce qu’on veut comme attribut à <code class="language-plaintext highlighter-rouge">env</code>)</li>
  <li>soit en exécutant le serveur en mettant le nom de la variable avant : <code class="language-plaintext highlighter-rouge">TRUC=3 npm start</code>. Dans le serveur, la variable <code class="language-plaintext highlighter-rouge">process.env.TRUC</code> vaudra 3.</li>
  <li>soit en créant une variable d’environnement dans le shell puis en exécutant le serveur (dépend du shell. En <code class="language-plaintext highlighter-rouge">zsh</code> : <code class="language-plaintext highlighter-rouge">export NODE_ENV="test"</code>)</li>
</ul>

<p>Nous allons utiliser la première solution.</p>

<blockquote>
  <p>On peut choisir ce qu’on veut comme variable d’environnement. <code class="language-plaintext highlighter-rouge">NODE_ENV</code>, est la variable usuellement utilisée, <a href="https://www.twilio.com/blog/working-with-environment-variables-in-node-js-html">parmi d’autres</a></p>
</blockquote>

<h4 id="tests-avec-une-nouvelle-base">tests avec une nouvelle base</h4>

<p>Le fichier de test ci-après commence par placer l’environnement d’exécution à <code class="language-plaintext highlighter-rouge">"test"</code> puis on met en place plusieurs <a href="https://jestjs.io/docs/setup-teardown">fonctions spéciales de jest</a> qui permettent d’exécuter des fonctions à des moments précis. Ici nous avons besoin d’exécuter une fonction avant chaque tests (la synchronisation et la mise à zérode la base).</p>

<p>Il est important de remettre à zéro la base de données à chaque test pour garantir l’indépendance des tests et leurs répétabilités.</p>

<p>Fichier <em>“numerologie/__tests__/prenoms.test.js”</em> :</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">request</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">supertest</span><span class="dl">'</span><span class="p">);</span>

<span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">NODE_ENV</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">test</span><span class="dl">'</span>

<span class="kd">const</span> <span class="nx">db</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">../db</span><span class="dl">"</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">../app</span><span class="dl">'</span><span class="p">);</span>

<span class="nx">beforeEach</span><span class="p">(</span><span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">await</span> <span class="nx">db</span><span class="p">.</span><span class="nx">sequelize</span><span class="p">.</span><span class="nx">sync</span><span class="p">({</span><span class="na">force</span><span class="p">:</span> <span class="kc">true</span><span class="p">})</span>
    <span class="k">for</span> <span class="p">(</span><span class="nx">i</span><span class="o">=</span><span class="mi">1</span> <span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span><span class="mi">10</span> <span class="p">;</span> <span class="nx">i</span> <span class="o">+=</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">await</span> <span class="nx">db</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">Signification</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
            <span class="na">message</span><span class="p">:</span> <span class="nx">i</span><span class="p">,</span>
            <span class="na">nombre</span><span class="p">:</span> <span class="nx">i</span><span class="p">,</span>
        <span class="p">})</span>
    <span class="p">}</span>
<span class="p">})</span>

<span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">GET /prénom?valeur=toto pas de prénom</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">request</span><span class="p">(</span><span class="nx">app</span><span class="p">)</span>
        <span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="nb">encodeURI</span><span class="p">(</span><span class="dl">"</span><span class="s2">/prénom</span><span class="dl">"</span><span class="p">)</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">?valeur=toto</span><span class="dl">"</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">expect</span><span class="p">((</span><span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="nx">expect</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">body</span><span class="p">).</span><span class="nx">toEqual</span><span class="p">({</span><span class="dl">"</span><span class="s2">prénom</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">toto</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">chiffre</span><span class="dl">"</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">4</span><span class="dl">"</span><span class="p">})</span>
        <span class="p">})</span>
        <span class="p">.</span><span class="nx">end</span><span class="p">((</span><span class="nx">err</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">done</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="nx">done</span><span class="p">()</span>
        <span class="p">})</span>
<span class="p">})</span>
</code></pre></div></div>

<blockquote>
  <p>On a qu’un seul test donc le <code class="language-plaintext highlighter-rouge">beforeEach</code> est théorique, mais c’est l’idée.</p>
</blockquote>

  </div>

</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/cours_informatique/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">cours d&#39;informatique</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">cours d&#39;informatique</li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/FrancoisBrucker"><svg class="svg-icon"><use xlink:href="/cours_informatique/assets/minima-social-icons.svg#github"></use></svg> <span class="username">FrancoisBrucker</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>Support de cours/td d&#39;informatique à l&#39;école centrale marseille.</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>

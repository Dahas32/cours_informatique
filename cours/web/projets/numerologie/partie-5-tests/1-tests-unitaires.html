<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
<!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Projet numérologie : partie 5 / tests unitaires | cours d’informatique</title>
<meta name="generator" content="Jekyll v4.2.0">
<meta property="og:title" content="Projet numérologie : partie 5 / tests unitaires">
<meta name="author" content="François Brucker">
<meta property="og:locale" content="en_US">
<meta name="description" content="Support de cours/td d’informatique de François Brucker.">
<meta property="og:description" content="Support de cours/td d’informatique de François Brucker.">
<link rel="canonical" href="/cours_informatique/cours/web/projets/numerologie/partie-5-tests/1-tests-unitaires.html">
<meta property="og:url" content="/cours_informatique/cours/web/projets/numerologie/partie-5-tests/1-tests-unitaires.html">
<meta property="og:site_name" content="cours d’informatique">
<meta name="twitter:card" content="summary">
<meta property="twitter:title" content="Projet numérologie : partie 5 / tests unitaires">
<script type="application/ld+json">
{"headline":"Projet numérologie : partie 5 / tests unitaires","description":"Support de cours/td d’informatique de François Brucker.","@type":"WebPage","url":"/cours_informatique/cours/web/projets/numerologie/partie-5-tests/1-tests-unitaires.html","author":{"@type":"Person","name":"François Brucker"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/cours_informatique/assets/main.css">

  <link rel="stylesheet" href="/cours_informatique/assets/custom.css">

  <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
<link type="application/atom+xml" rel="alternate" href="/cours_informatique/feed.xml" title="cours d'informatique">
</head>

<body>
<header class="site-header" role="banner">

  <div class="wrapper">
<a class="site-title" rel="author" href="/cours_informatique/">cours d'informatique</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger">
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewbox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"></path>
            </svg>
          </span>
        </label>

        <div class="trigger">
            <a class="page-link" href="/cours_informatique/about"> about </a>
        </div>
      </nav>
</div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post">

  <header class="post-header">
    <h1 class="post-title">Projet numérologie : partie 5 / tests unitaires</h1>Auteur : <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span class="p-author h-card" itemprop="name">François Brucker</span></span>
  </header>

  <div class="post-content">
    <blockquote class="chemin">
  <p><a href="/cours_informatique/cours/web/projets/numerologie/">numérologie</a> / <a href="/cours_informatique/cours/web/projets/numerologie/partie-5-tests/">partie 5</a> / <a href="/cours_informatique/cours/web/projets/numerologie/partie-5-tests/1-tests-unitaires.html">tests unitaires</a></p>
</blockquote>

<h2 id="bibliothèque-de-test">bibliothèque de test</h2>

<p>Il existe plusieurs bibliothèques permettant de faire des tests unitaires. Nous allons utiliser <a href="https://jestjs.io/">jest</a></p>

<p>Commençons par l’installer :</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npm <span class="nb">install</span> <span class="nt">--save-dev</span> jest
</code></pre></div></div>

<p>Remarquez qu’on a pas utilisé le classique <code class="language-plaintext highlighter-rouge">--save</code> mais le nouveau <code class="language-plaintext highlighter-rouge">--save-dev</code>. Ceci à changer le fichier <em>“package.json”</em> :</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"numerologie"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"version"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1.0.0"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"de la numérologie"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"main"</span><span class="p">:</span><span class="w"> </span><span class="s2">"index.js"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"scripts"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"init"</span><span class="p">:</span><span class="w"> </span><span class="s2">"node db-init.js"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"test"</span><span class="p">:</span><span class="w"> </span><span class="s2">"echo </span><span class="se">\"</span><span class="s2">Error: no test specified</span><span class="se">\"</span><span class="s2"> &amp;&amp; exit 1"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"start"</span><span class="p">:</span><span class="w"> </span><span class="s2">"node index.js"</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"author"</span><span class="p">:</span><span class="w"> </span><span class="s2">"François Brucker"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"license"</span><span class="p">:</span><span class="w"> </span><span class="s2">"WTFPL"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"dependencies"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"express"</span><span class="p">:</span><span class="w"> </span><span class="s2">"^4.17.1"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"sequelize"</span><span class="p">:</span><span class="w"> </span><span class="s2">"^6.7.0"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"sqlite3"</span><span class="p">:</span><span class="w"> </span><span class="s2">"^5.0.2"</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"devDependencies"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"jest"</span><span class="p">:</span><span class="w"> </span><span class="s2">"^27.3.1"</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>Une valeur a été ajoutée : <code class="language-plaintext highlighter-rouge">"devDependencies"</code> pour distinguer les dépendances utiles en production (<code class="language-plaintext highlighter-rouge">"dependencies"</code>) et celles utiles en développement. En tapant :</p>

<ul>
  <li>
<code class="language-plaintext highlighter-rouge">npm install</code> : toutes les dépendances (<code class="language-plaintext highlighter-rouge">"dependencies"</code> et <code class="language-plaintext highlighter-rouge">"devDependencies"</code>) seront installées</li>
  <li>
<code class="language-plaintext highlighter-rouge">npm install --production</code> : uniquement les dépendances <code class="language-plaintext highlighter-rouge">"dependencies"</code>  seront installées</li>
</ul>

<p>Voir <a href="https://docs.npmjs.com/cli/v7/commands/npm-install">la documentation</a> pour de plus amples informations.</p>

<h2 id="usage">usage</h2>

<p><code class="language-plaintext highlighter-rouge">jest</code> va exécuter des tests écrit dans des fichiers. Par défaut ces fichiers sont :</p>

<ul>
  <li>les fichiers finissant par <em>“.test.js”</em> (ou <em>“.spec.js”</em>) du projet ou dans ses sous dossiers</li>
  <li>tous les fichiers du dossier <em>“<strong>tests</strong>”</em> s’il existe.</li>
</ul>

<h3 id="commande">commande</h3>

<p>On peut exécuter jest de deux façon, soit via <code class="language-plaintext highlighter-rouge">npm</code> et une configuration dans <em>“package.json”</em> ou en ligne de commande.</p>

<h4 id="npm">npm</h4>

<p>On commence par associer <code class="language-plaintext highlighter-rouge">jest</code> aux tests en renseignant le champ <code class="language-plaintext highlighter-rouge">"test"</code> de l’attribut <code class="language-plaintext highlighter-rouge">"script"</code> du fichier <em>“package.json”</em> :</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">...</span><span class="w">

  </span><span class="nl">"scripts"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"init"</span><span class="p">:</span><span class="w"> </span><span class="s2">"node db-init.js"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"test"</span><span class="p">:</span><span class="w"> </span><span class="s2">"jest"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"start"</span><span class="p">:</span><span class="w"> </span><span class="s2">"node index.js"</span><span class="w">
  </span><span class="p">}</span><span class="err">,</span><span class="w">

</span><span class="err">...</span><span class="w">
</span></code></pre></div></div>

<p>Puis on exécute <code class="language-plaintext highlighter-rouge">jest</code> en tapant la commande :</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npm <span class="nb">test</span>
</code></pre></div></div>

<blockquote>
  <p><code class="language-plaintext highlighter-rouge">npm test</code> est un raccourci pour <code class="language-plaintext highlighter-rouge">npm run test</code></p>
</blockquote>

<h4 id="cli">CLI</h4>

<p>Le programme <code class="language-plaintext highlighter-rouge">jest</code> est rangé dans le dossier <em>“node_modules/.bin”</em>, on peut donc l’appeler directement par la commande :</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./node_modules/.bin/jest
</code></pre></div></div>

<h3 id="vscode">vscode</h3>

<p>Vous pouvez installer le plugin <a href="https://github.com/jest-community/vscode-jest">vscode-jest</a> pour utiliser jest dans vscode. Nous allons ici tout faire en ligne de commande, mais c’est pratique et ça permet (entre autres) :</p>

<ul>
  <li>à vscode de comprendre notre code jest</li>
  <li>d’exécuter les tests quand on les crée</li>
</ul>

<blockquote>
  <p>La palette de commande permet d’accéder à toutes les commandes du plugin en tapant <em>jest</em></p>
</blockquote>

<p>On installera également le module <code class="language-plaintext highlighter-rouge">@types/jest</code> pour que vscode fasse la completion automatique lorsque l’on code des tests : <code class="language-plaintext highlighter-rouge">npm install --save-dev @types/jest</code> (tips pris de <a href="https://tekloon.dev/autocomplete-for-jest-in-vscode">là</a>).</p>

<h3 id="tests">tests</h3>

<p>les tests seront tous de la forme (repris des <a href="https://jestjs.io/fr/docs/getting-started">premiers pas</a>) :</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">deux plus deux font quatre</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">expect</span><span class="p">(</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div></div>

<p>Chaque test aura :</p>

<ul>
  <li>un nom. Ici : <code class="language-plaintext highlighter-rouge">'deux plus deux font quatre'</code>
</li>
  <li>le test en lui même qui est une fonction et dont le but est de comparer une valeur théorique à une valeur réelle. Ici on cherche à vérifier que <code class="language-plaintext highlighter-rouge">2 + 2</code> vaut <code class="language-plaintext highlighter-rouge">4</code>.</li>
</ul>

<p>L’essence même d’un test est l’utilisation de <a href="https://jestjs.io/fr/docs/using-matchers">comparateurs</a></p>

<h3 id="blocs-de-tests">blocs de tests</h3>

<p>Par défaut, on va grouper les tests similaire dans un même fichier. Si l’on a besoin de sous-groupes à l’intérieur d’un fichier, par exemple en faisant un groupe pour les tests d’une fonction, on peut utiliser un bloc <a href="https://jestjs.io/fr/docs/api#describename-fn">describe</a>.</p>

<h2 id="tests-métiers">tests métiers</h2>

<p>On va tester ici les méthodes <em>métiers</em> c’esrt à dire tout ce qui n’est pas des routes. Notre projet à un unique fichier métier : <em>“numerologie/back/numerologie.js”</em></p>

<p>On doit tester toutes les méthodes de ce fichier : <code class="language-plaintext highlighter-rouge">nombre</code>, <code class="language-plaintext highlighter-rouge">somme</code> et <code class="language-plaintext highlighter-rouge">chiffreAssocie</code>.</p>

<p>Il n’y a jamais de bonne réponses à la question : quoi tester ? La seule réponse satisfaisante est: juste assez pour que l’on soit intimement persuadé que la fonction marche si les testent passent.</p>

<p>De toute façon, si l’on se rend compte (ou plutôt quand on se rendra compte) qu’il y a un bug, on écrira un test qui mettra en évidence le bug, puis on le corrigera. De cette façon ce bug ne pourra plus jamais réapparaitre, les tests étant conservés.</p>

<blockquote>
  <p>Lorsqu’un programme et muni de tests, il ne peut jamais régresser : Kent Beck dit que c’est une progression par <a href="https://fr.wikipedia.org/wiki/Cliquet_(m%C3%A9canique)">cliquet</a></p>
</blockquote>

<p>Chaque test doit tester une seule chose, et on peut s’appuyer sur une fonction que si les tests des fonctions qui la composent sont testées. On doit donc tester <code class="language-plaintext highlighter-rouge">nombre</code> et <code class="language-plaintext highlighter-rouge">somme</code> avant de tester <code class="language-plaintext highlighter-rouge">chiffreAssocie</code>.</p>

<h3 id="module-rewire">module rewire</h3>

<p>Il reste un dernier problème à résoudre avant de commencer les tests proprement dit : <code class="language-plaintext highlighter-rouge">nombre</code> et <code class="language-plaintext highlighter-rouge">somme</code> ne sont pas exportées, il est donc a priori impossible de simplement les importer pour les tester. POur faire cela, on va utiliser le module <a href="https://github.com/jhnns/rewire">rewire</a> comme expliqué dans <a href="https://javascript.plainenglish.io/how-to-test-a-non-export-function-in-javascript-a1d0bc339ac">ce tuto</a> :</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npm <span class="nb">install</span> <span class="nt">--save-dev</span> rewire
</code></pre></div></div>

<h3 id="numerologietestjs">numerologie.test.js</h3>

<p>Plaçons nos tests dans un dossier <em>“numerologie/<strong>tests</strong>“</em>, comme le veut jest par défaut</p>

<blockquote>
  <p>Un autre coding mantra pour la route : <a href="https://en.wikipedia.org/wiki/Convention_over_configuration">convention over configuration</a>. On essaie dans la mesure du possible de se conformer aux conventions, cela facilite le travail en groupe.</p>
</blockquote>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">rewire</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">rewire</span><span class="dl">'</span><span class="p">)</span>

<span class="kd">const</span> <span class="nx">numerologieRewire</span> <span class="o">=</span> <span class="nx">rewire</span><span class="p">(</span><span class="dl">'</span><span class="s1">../back/numerologie</span><span class="dl">'</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">numerologie</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">nombre</span><span class="p">:</span> <span class="nx">numerologieRewire</span><span class="p">.</span><span class="nx">__get__</span><span class="p">(</span><span class="dl">'</span><span class="s1">nombre</span><span class="dl">'</span><span class="p">),</span>
    <span class="na">somme</span><span class="p">:</span> <span class="nx">numerologieRewire</span><span class="p">.</span><span class="nx">__get__</span><span class="p">(</span><span class="dl">'</span><span class="s1">somme</span><span class="dl">'</span><span class="p">),</span>
    <span class="na">chiffreAssocie</span><span class="p">:</span> <span class="nx">numerologieRewire</span><span class="p">.</span><span class="nx">__get__</span><span class="p">(</span><span class="dl">'</span><span class="s1">chiffreAssocie</span><span class="dl">'</span><span class="p">),</span>
<span class="p">}</span>

<span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">numerologie.nombre</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">test</span><span class="p">(</span><span class="dl">"</span><span class="s2">chaine vide</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">expect</span><span class="p">(</span><span class="nx">numerologie</span><span class="p">.</span><span class="nx">nombre</span><span class="p">(</span><span class="dl">""</span><span class="p">)).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="p">})</span>
    <span class="nx">test</span><span class="p">(</span><span class="dl">"</span><span class="s2">un caractère simple</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">expect</span><span class="p">(</span><span class="nx">numerologie</span><span class="p">.</span><span class="nx">nombre</span><span class="p">(</span><span class="dl">"</span><span class="s2">A</span><span class="dl">"</span><span class="p">)).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">65</span><span class="p">)</span>
    <span class="p">})</span>
    <span class="nx">test</span><span class="p">(</span><span class="dl">"</span><span class="s2">deux caractères</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">expect</span><span class="p">(</span><span class="nx">numerologie</span><span class="p">.</span><span class="nx">nombre</span><span class="p">(</span><span class="dl">"</span><span class="s2">éç</span><span class="dl">"</span><span class="p">)).</span><span class="nx">toBe</span><span class="p">(</span><span class="mh">0xE9</span> <span class="o">+</span> <span class="mh">0xE7</span><span class="p">)</span>
    <span class="p">})</span>
<span class="p">})</span>

<span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">numerologie.somme</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">test</span><span class="p">(</span><span class="dl">"</span><span class="s2">0</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">expect</span><span class="p">(</span><span class="nx">numerologie</span><span class="p">.</span><span class="nx">somme</span><span class="p">(</span><span class="mi">0</span><span class="p">)).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="p">})</span>
    <span class="nx">test</span><span class="p">(</span><span class="dl">"</span><span class="s2">un chiffre</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">expect</span><span class="p">(</span><span class="nx">numerologie</span><span class="p">.</span><span class="nx">somme</span><span class="p">(</span><span class="mi">4</span><span class="p">)).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
    <span class="p">})</span>
    <span class="nx">test</span><span class="p">(</span><span class="dl">"</span><span class="s2">un nombre</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">expect</span><span class="p">(</span><span class="nx">numerologie</span><span class="p">.</span><span class="nx">somme</span><span class="p">(</span><span class="dl">"</span><span class="s2">101</span><span class="dl">"</span><span class="p">)).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="p">})</span>
<span class="p">})</span>


<span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">numerologie.chiffreAssocie</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">test</span><span class="p">(</span><span class="dl">"</span><span class="s2">éç</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">expect</span><span class="p">(</span><span class="nx">numerologie</span><span class="p">.</span><span class="nx">chiffreAssocie</span><span class="p">(</span><span class="dl">"</span><span class="s2">éç</span><span class="dl">"</span><span class="p">)).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span>
    <span class="p">})</span>
<span class="p">})</span>
</code></pre></div></div>

<h3 id="exécution-des-tests">exécution des tests</h3>

<p>On peut exécuter ce code de plusieurs manières :</p>

<ul>
  <li>tous les tests via <code class="language-plaintext highlighter-rouge">npm</code> : <code class="language-plaintext highlighter-rouge">npm test</code>
</li>
  <li>tous les tests via le programme : <code class="language-plaintext highlighter-rouge">./node_modules/.bin/jest</code>
</li>
  <li>un fichier particulier via <code class="language-plaintext highlighter-rouge">npm</code> : <code class="language-plaintext highlighter-rouge">npm test -- __tests__/numerologie.test.js</code> (<code class="language-plaintext highlighter-rouge">npm test --  numerologie.test.js</code> fonctionne aussi)</li>
  <li>un fichier particulier via le programme : <code class="language-plaintext highlighter-rouge">./node_modules/.bin/jest __tests__/numerologie.test.js</code> (<code class="language-plaintext highlighter-rouge">./node_modules/.bin/jest numerologie.test.js</code> fonctionne aussi)</li>
</ul>

<p>Chez moi, le résultat de ces tests est :</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
&gt; numerologie@1.0.0 test
&gt; jest

 PASS  __tests__/numerologie.test.js
  numerologie.nombre
    ✓ chaine vide (2 ms)
    ✓ un caractère simple
    ✓ deux caractères (1 ms)
  numerologie.somme
    ✓ 0
    ✓ un chiffre
    ✓ un nombre
  numerologie.chiffreAssocie
    ✓ éç

Test Suites: 1 passed, 1 total
Tests:       7 passed, 7 total
Snapshots:   0 total
Time:        0.489 s, estimated 1 s
Ran all test suites.
</code></pre></div></div>

<p>On voit les noms des 3 suites et des tests dans chacune d’elle.</p>

<h3 id="structure-du-fichier">structure du fichier</h3>

<p>On a commencé par importer toutes les fonction de <em>“numerologie/back/numerologie.js”</em>, puis on a fait un bloc par fonction testée. Pour chaque fonction, je commence par tester un cas simple (sans paramètre ou un paramètre trivial), puis les cas d’usages courant.</p>

<p>J’ai l’impression que si ces tests fonctionnent, mes fonctions sont correctes.</p>

<h3 id="coverage">coverage</h3>

<p>Pour savoir si nos tests couvrent bien l’ensemble du projet, c’est à dire si les tests passent bien par chaque ligne de code, on utilise des outils de <a href="https://fr.wikipedia.org/wiki/Couverture_de_code">couverture de code</a>.</p>

<blockquote>
  <p><strong>Attention</strong> : Avoir 100% de couverture de code ne signifie pas que votre projet est bien testé… Juste que les tests ont utilisé toutes les lignes de codes :</p>

  <ul>
    <li>ça ne prouve pas que les fonctionnalités de votre code sont correctes</li>
    <li>certaines fonctions n’ont pas besoin d’être testées (comme les constantes ou les affichages à l’écran par exemple)</li>
  </ul>
</blockquote>

<p>Le code coverage est particulièrement utile pour savoir si on a bien testé ce <em>else</em> d’un <em>if/then/else</em> qui n’arrive que rarement.</p>

<p>Il suffit de rajouter <code class="language-plaintext highlighter-rouge">--coverage</code>à jest pour qu’il fasse le coverage tout seul : <code class="language-plaintext highlighter-rouge">npm test -- --coverage</code> (ou <code class="language-plaintext highlighter-rouge">./node_modules/.bin/jest --coverage</code>).</p>

<p>Si on essaie sur notre code… Ca ne va pas marcher. C’est à cause du module <code class="language-plaintext highlighter-rouge">rewire</code> qui ne déclenche pas le coverage de jest. Pour palier ça, on va utiliser chiffre, qui est la fonction importée plutôt que de l’utiliser via <code class="language-plaintext highlighter-rouge">rewire</code> dans <em>“numerologie/__tests/numerologie.test.js”</em> :</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">rewire</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">rewire</span><span class="dl">'</span><span class="p">)</span>
<span class="kd">const</span> <span class="p">{</span> <span class="nx">chiffre</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">../back/numerologie</span><span class="dl">'</span><span class="p">)</span>

<span class="kd">const</span> <span class="nx">numerologieRewire</span> <span class="o">=</span> <span class="nx">rewire</span><span class="p">(</span><span class="dl">'</span><span class="s1">../back/numerologie</span><span class="dl">'</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">numerologie</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">nombre</span><span class="p">:</span> <span class="nx">numerologieRewire</span><span class="p">.</span><span class="nx">__get__</span><span class="p">(</span><span class="dl">'</span><span class="s1">nombre</span><span class="dl">'</span><span class="p">),</span>
    <span class="na">somme</span><span class="p">:</span> <span class="nx">numerologieRewire</span><span class="p">.</span><span class="nx">__get__</span><span class="p">(</span><span class="dl">'</span><span class="s1">somme</span><span class="dl">'</span><span class="p">),</span>
    <span class="na">chiffreAssocie</span><span class="p">:</span> <span class="nx">chiffre</span><span class="p">,</span>
<span class="p">}</span>

<span class="c1">// ...</span>
</code></pre></div></div>

<p>Lorsque l’on exécutera nos tests avec coverage (<code class="language-plaintext highlighter-rouge">npm test -- --coverage</code>), on aura comme réponse :</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
&gt; numerologie@1.0.0 test
&gt; jest "--coverage"

 PASS  __tests__/numerologie.test.js
  numerologie.nombre
    ✓ chaine vide (1 ms)
    ✓ un caractère simple
    ✓ deux caractères
  numerologie.somme
    ✓ 0
    ✓ un chiffre (1 ms)
    ✓ un nombre
  numerologie.chiffreAssocie
    ✓ éç (1 ms)

----------------|---------|----------|---------|---------|-------------------
File            | % Stmts | % Branch | % Funcs | % Lines | Uncovered Line #s 
----------------|---------|----------|---------|---------|-------------------
All files       |     100 |      100 |     100 |     100 |                   
 numerologie.js |     100 |      100 |     100 |     100 |                   
----------------|---------|----------|---------|---------|-------------------
Test Suites: 1 passed, 1 total
Tests:       7 passed, 7 total
Snapshots:   0 total
Time:        0.574 s, estimated 1 s
Ran all test suites.
</code></pre></div></div>

<p>Les tests de <code class="language-plaintext highlighter-rouge">chiffreAssoce</code> (et uniquement eux, les autres passant par le module rewire) passent bien par toute les lignes de <em>“back/numerologie.js”</em>.</p>

<p>Modifions le test de chiffreAssocie pour s’en convaincre :</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">numerologie.chiffreAssocie</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">test</span><span class="p">(</span><span class="dl">"</span><span class="s2">éç</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">expect</span><span class="p">(</span><span class="nx">numerologie</span><span class="p">.</span><span class="nx">chiffreAssocie</span><span class="p">(</span><span class="dl">""</span><span class="p">)).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="p">})</span>
<span class="p">})</span>
</code></pre></div></div>

<p>Le résultat est maintenant :</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
&gt; numerologie@1.0.0 test
&gt; jest "--coverage"

 PASS  __tests__/numerologie.test.js
  numerologie.nombre
    ✓ chaine vide (1 ms)
    ✓ un caractère simple
    ✓ deux caractères
  numerologie.somme
    ✓ 0
    ✓ un chiffre (1 ms)
    ✓ un nombre
  numerologie.chiffreAssocie
    ✓ éç (1 ms)

----------------|---------|----------|---------|---------|-------------------
File            | % Stmts | % Branch | % Funcs | % Lines | Uncovered Line #s 
----------------|---------|----------|---------|---------|-------------------
All files       |      50 |      100 |   66.66 |      50 |                   
 numerologie.js |      50 |      100 |   66.66 |      50 | 4,10-15,22        
----------------|---------|----------|---------|---------|-------------------
Test Suites: 1 passed, 1 total
Tests:       7 passed, 7 total
Snapshots:   0 total
Time:        0.575 s, estimated 1 s
Ran all test suites.
</code></pre></div></div>

<p>On est pas passé par la ligne 4 (l’intérieur de la boucle for de la fonction <code class="language-plaintext highlighter-rouge">nombre</code>), 10 à 15 (on a pas utilisé la fonction <code class="language-plaintext highlighter-rouge">somme</code>) et 22 (l’intérieur du while de <code class="language-plaintext highlighter-rouge">chiffreAssocie</code>).</p>

<p>Remettons nos test comme avant pour bien avoir 100 de coverage…</p>

<blockquote>
  <p>Le coverage crée un dossier coverage, que l’on ajoute dans le fichier <em>“.gitignore”</em>, il n’a pas à être suivi.</p>
</blockquote>

<h2 id="mocker-des-fonctions">mocker des fonctions</h2>

<p>Concept avancé mais très utile lorsque l’on veut tester un comportement spécifique d’une fonction sans avoir à tout paramétrer. On va l’utiliser ici de façon un peut surfaite, mais pensez-y pour les tests de pannes, d’erreurs ou de fonction nécessitant le réseau.</p>

<p><a href="https://jestjs.io/docs/mock-functions">https://jestjs.io/docs/mock-functions</a></p>

<h2 id="ressources">ressources</h2>

<ul>
  <li><a href="https://www.valentinog.com/blog/jest/">https://www.valentinog.com/blog/jest/</a></li>
  <li><a href="https://practicalprogramming.fr/jest">https://practicalprogramming.fr/jest</a></li>
  <li><a href="https://jestjs.io/">https://jestjs.io/</a></li>
</ul>

  </div>

</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/cours_informatique/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">cours d'informatique</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">cours d'informatique</li>
</ul>
      </div>

      <div class="footer-col footer-col-2">
<ul class="social-media-list"><li><a href="https://github.com/FrancoisBrucker"><svg class="svg-icon"><use xlink:href="/cours_informatique/assets/minima-social-icons.svg#github"></use></svg> <span class="username">FrancoisBrucker</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>Support de cours/td d'informatique de François Brucker.</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>

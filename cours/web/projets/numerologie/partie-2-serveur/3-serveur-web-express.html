<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Projet numérologie : partie 2 / niveau 1 / web avec express | cours d’informatique</title>
<meta name="generator" content="Jekyll v4.2.0" />
<meta property="og:title" content="Projet numérologie : partie 2 / niveau 1 / web avec express" />
<meta name="author" content="François Brucker" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Support de cours/td d’informatique à l’école centrale marseille." />
<meta property="og:description" content="Support de cours/td d’informatique à l’école centrale marseille." />
<link rel="canonical" href="/cours_informatique/cours/web/projets/numerologie/partie-2-serveur/3-serveur-web-express.html" />
<meta property="og:url" content="/cours_informatique/cours/web/projets/numerologie/partie-2-serveur/3-serveur-web-express.html" />
<meta property="og:site_name" content="cours d’informatique" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Projet numérologie : partie 2 / niveau 1 / web avec express" />
<script type="application/ld+json">
{"description":"Support de cours/td d’informatique à l’école centrale marseille.","@type":"WebPage","headline":"Projet numérologie : partie 2 / niveau 1 / web avec express","url":"/cours_informatique/cours/web/projets/numerologie/partie-2-serveur/3-serveur-web-express.html","author":{"@type":"Person","name":"François Brucker"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/cours_informatique/assets/main.css">

  <link rel="stylesheet" href="/cours_informatique/assets/custom.css"><link type="application/atom+xml" rel="alternate" href="/cours_informatique/feed.xml" title="cours d'informatique" /><!-- Mathjax Support -->
  <script>
    MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
      },
      svg: {
        fontCache: 'global'
      }
    };
    </script>
    <script type="text/javascript" id="MathJax-script" async
      src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js">
    </script>
</head>

<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/cours_informatique/">cours d&#39;informatique</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger">
            <a class="page-link" href="/cours_informatique/about"> about </a>
        </div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post">

  <header class="post-header">
    <h1 class="post-title">Projet numérologie : partie 2 / niveau 1 / web avec express</h1></p>Auteur : <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span class="p-author h-card" itemprop="name">François Brucker</span></span></p>
  </header>

  <div class="post-content">
    <blockquote class="chemin">
  <p><a href="/cours_informatique/cours/web/projets/numerologie/">numérologie</a> / <a href="/cours_informatique/cours/web/projets/numerologie/partie-2-serveur/">partie 2</a> / <a href="/cours_informatique/cours/web/projets/numerologie/partie-2-serveur/3-serveur-web-express.html">serveur web avec express</a></p>
</blockquote>

<p>On utilise le module express pour gérer plus élégamment notre site.</p>

<h2 id="gestionnaire-de-package">gestionnaire de package</h2>

<p><a href="https://expressjs.com/">express</a> est un module pour node qui permet une gestion efficace et apaisée des site web.</p>

<p>Pour installer des packages node, on peut utiliser <a href="https://www.npmjs.com/">npm</a> (<strong>n</strong>ode <strong>p</strong>ackage <strong>m</strong>anager) qui est livré avec node.</p>

<blockquote>
  <p>Un <a href="https://www.digitalocean.com/community/tutorials/how-to-use-node-js-modules-with-npm-and-package-json-fr">tutoriel pour utiliser npm</a></p>
</blockquote>

<h3 id="npm-init">npm init</h3>

<p>Pour que <code class="language-plaintext highlighter-rouge">npm</code> puisse gérer nos module, il faut lui laisser créer un fichier de configuration nommé <em>“package.json”</em>. Pour cela, tapez dans un terminal placé à la racine de notre projet :</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npm init
</code></pre></div></div>

<p>Répondez aux questions (ou tapez sur entrée). Lorsque le programme est fini, vous trouverez un fichier <em>“package.json”</em> à la racine de votre projet.</p>

<p>Chez moi, il ressemble à ça :</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"numerologie"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"version"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1.0.0"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"de la numérologie"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"main"</span><span class="p">:</span><span class="w"> </span><span class="s2">"index.js"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"scripts"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"test"</span><span class="p">:</span><span class="w"> </span><span class="s2">"echo </span><span class="se">\"</span><span class="s2">Error: no test specified</span><span class="se">\"</span><span class="s2"> &amp;&amp; exit 1"</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"author"</span><span class="p">:</span><span class="w"> </span><span class="s2">"François Brucker"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"license"</span><span class="p">:</span><span class="w"> </span><span class="s2">"WTFPL"</span><span class="w">
</span><span class="p">}</span><span class="w">

</span></code></pre></div></div>

<p>Il ne contient pour l’instant que des informations générales quant au projet. Nous allons bientôt y ajouter des modules.</p>

<blockquote>
  <p>Le <a href="https://fr.wikipedia.org/wiki/JavaScript_Object_Notation">json</a> est un format texte pour sauvegarder des données structurée. C’est un format génial qui sert tout autant pour les fichiers de configurations que le transfert de données par le web.</p>
</blockquote>

<h3 id="ajout-dun-module">ajout d’un module</h3>

<p>Pour cela, tapez dans un terminal placé à la racine de notre projet :</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npm add <span class="nt">--save</span> express
</code></pre></div></div>

<blockquote class="attention">
  <p>N’oubliez pas <code class="language-plaintext highlighter-rouge">--save</code>, sinon le module sera installé mais la dépendance ne sera pas ajoutée au fichier <em>“package.json”</em> ce qui est tarte.</p>
</blockquote>

<p>Cette commande a ajouté une dépendance à notre fichier <em>“package.json”</em> :</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nl">"dependencies"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"express"</span><span class="p">:</span><span class="w"> </span><span class="s2">"^4.17.1"</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>A créer un fichier <em>“package-lock.json”</em> qui contient la liste de tous les modules installés et un (gros) dossier <em>“node_modules”</em> qui contient les modules installés.</p>

<blockquote>
  <p>Il y a plus de 50 modules installés alors que l’on a demandé d’installer que le module <code class="language-plaintext highlighter-rouge">express</code>, car il a lui même des dépendances et ses dépendances d’autres dépendances, etc.</p>
</blockquote>

<p>La différence entre <em>“package.json”</em> et <em>“package-lock.json”</em> est que le premier décrit les versions possibles (nous, toutes les versions ultérieures à 4.17.1) alors que <em>“package-lock.json”</em> décrit la version effectivement installée (la 4.17.1). Cette méchanique permet de mettre à jour nos modules en supprimant le dossier <em>“node_module”</em> et le fichier <em>“package-lock.json”</em> et en tapant la commande <code class="language-plaintext highlighter-rouge">npm install</code>.</p>

<h3 id="sauvegarde-et-installation-du-projet">sauvegarde et installation du projet</h3>

<p>Le dossier <em>“node_module”</em> n’est pas un module à sauver, on peut installer toutes les dépendances avec la commande <code class="language-plaintext highlighter-rouge">npm install</code> :</p>

<ul>
  <li>grâce au fichier <em>“package-lock.json”</em> : la commande <code class="language-plaintext highlighter-rouge">npm --install</code> sait exactement quels modules installer</li>
  <li>le fichier <em>“package.json”</em> donnant les dépendances générales de notre projet.</li>
</ul>

<h2 id="routes">routes</h2>

<p>Le module <a href="https://expressjs.com/">express</a> va nous permettre de créer nos routes (les urls que le serveur connait) simplement.</p>

<p>Avant d’utiliser le module, penchons nous un peut sur que l’on veut :</p>

<ul>
  <li>site statique : on demande à l’utilisateur de taper son prénom</li>
  <li>une fois que l’on appuie sur le bouton, le prénom est envoyé au server qui retourne le chiffre associé.</li>
</ul>

<p>Pour l’instant nous n’avons qu’un site front. Donc commençons par organiser le tout.</p>

<h3 id="séparation-front-et-back">séparation front et back</h3>

<p>L’usage veut que le site front soit séparé des actions du serveur. Cela permet de ne pas se mélanger les fichiers.</p>

<ol>
  <li>créez un dossier <em>“numerologie/static”</em> et déplacez les fichiers :
    <ul>
      <li><em>“index.html”</em></li>
      <li><em>“mains.css”</em></li>
      <li><em>“numerologie.js”</em></li>
    </ul>
  </li>
  <li>supprimez le fichier <em>“mes_test.js”</em>, on ne s’en sert plus depis longtemps.</li>
</ol>

<p>Le projet ressemble maintenant à ça, en excluant le dossier <em>“node_modules”</em> :</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>.
├── index.js
├── package-lock.json
├── package.json
└── static
    ├── index.html
    ├── main.css
    └── numerologie.js
</code></pre></div></div>

<blockquote>
  <p>On a utilisé la commande unix <a href="https://linux.die.net/man/1/tree">tree</a> (<code class="language-plaintext highlighter-rouge">tree -I node_modules</code>) pour réaliser le dessin ci-dessus.</p>
</blockquote>

<h3 id="notre-site-en-express">notre site en express</h3>

<p>Modifions le fichier <em>“numerologie/index.js”</em> pour que notre site fonctionne sous express :</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">path</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">path</span><span class="dl">'</span><span class="p">)</span>

<span class="kd">const</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">express</span><span class="dl">'</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">()</span>

<span class="kd">const</span> <span class="nx">hostname</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">127.0.0.1</span><span class="dl">'</span><span class="p">;</span>
<span class="kd">const</span> <span class="nx">port</span> <span class="o">=</span> <span class="mi">3000</span><span class="p">;</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="dl">"</span><span class="s2">/static</span><span class="dl">"</span><span class="p">,</span> <span class="nx">express</span><span class="p">.</span><span class="kd">static</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="dl">'</span><span class="s1">/static</span><span class="dl">'</span><span class="p">)))</span>

<span class="nx">app</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="mi">301</span><span class="p">,</span> <span class="dl">'</span><span class="s1">/static/index.html</span><span class="dl">'</span><span class="p">)</span>
<span class="p">})</span>


<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">et c'est le 404 : </span><span class="dl">"</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span>

    <span class="nx">res</span><span class="p">.</span><span class="nx">statusCode</span> <span class="o">=</span> <span class="mi">404</span><span class="p">;</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">setHeader</span><span class="p">(</span><span class="dl">'</span><span class="s1">Content-Type</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">text/html</span><span class="dl">'</span><span class="p">);</span>

    <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="dl">"</span><span class="s2">&lt;html&gt;&lt;head&gt;&lt;title&gt;la quatre cent quatre&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&lt;h1&gt;Et c'est la 404.&lt;/h1&gt;&lt;img  src=</span><span class="se">\"</span><span class="s2">https://www.leblogauto.com/wp-content/uploads/2020/04/Peugeot-404-1.jpg</span><span class="se">\"</span><span class="s2"> /&gt;&lt;/body&gt;&lt;/html&gt;</span><span class="dl">"</span><span class="p">);</span>

<span class="p">})</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">port</span><span class="p">,</span> <span class="nx">hostname</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`Server running at http://</span><span class="p">${</span><span class="nx">hostname</span><span class="p">}</span><span class="s2">:</span><span class="p">${</span><span class="nx">port</span><span class="p">}</span><span class="s2">/`</span><span class="p">);</span>
</code></pre></div></div>

<p>Tout se passe <em>via</em> l’objet <code class="language-plaintext highlighter-rouge">app</code>, qui est le résultat de l’import de express. Chaque requête au serveur passera d’un appel de <code class="language-plaintext highlighter-rouge">app</code> à l’autre (dans l’ordre du fichier).</p>

<blockquote>
  <p>Express appelle ces bouts de codes qui interceptent une requête un <a href="https://expressjs.com/fr/guide/using-middleware.html">middleware</a></p>
</blockquote>

<p>Pour chaque appel de app (dans notre cas on en a 2 <code class="language-plaintext highlighter-rouge">app.use</code> et <code class="language-plaintext highlighter-rouge">app.get</code>) :</p>

<ol>
  <li>on vérifie si la requête satisfait l’appel de <code class="language-plaintext highlighter-rouge">app</code> :
    <ul>
      <li><code class="language-plaintext highlighter-rouge">app.use()</code> : reçoit toutes les requêtes</li>
      <li><code class="language-plaintext highlighter-rouge">app.get()</code> : ne reçoit que les requêtes de méthode <code class="language-plaintext highlighter-rouge">get</code></li>
      <li><code class="language-plaintext highlighter-rouge">app.post()</code> : ne reçoit que les requêtes de méthode <code class="language-plaintext highlighter-rouge">post</code></li>
    </ul>
  </li>
  <li>Si la requête satisfait l’appel de <code class="language-plaintext highlighter-rouge">app</code>, on vérifie si elle satisfait le 1er paramètre</li>
  <li>Si la requête satisfait le 1er paramètre on exécute la méthode du second paramètre avec la requête en 1er paramètre.</li>
</ol>

<blockquote>
  <p>Comme dit précédemment, la route <code class="language-plaintext highlighter-rouge">/static</code> ne doit être utilisée qu’en développement. En production, on doit avoir un serveur dédié aux fichiers statiques pour éviter tout problème de charge.</p>
</blockquote>

<p>Dans notre cas l’enchaînement de route est ainsi :</p>

<ol>
  <li>1er <code class="language-plaintext highlighter-rouge">app.use</code> : si l’url de la requête commence par <code class="language-plaintext highlighter-rouge">/static</code> on envoie cette requête dans le gestionnaire de fichiers statiques de express.</li>
  <li><code class="language-plaintext highlighter-rouge">app.get</code>  :  si l’url de la requête est <code class="language-plaintext highlighter-rouge">/</code> on redirige la requête vers <code class="language-plaintext highlighter-rouge">/static/index.html</code>. Cette requête redirigée sera alors consommée par le <code class="language-plaintext highlighter-rouge">app.use</code></li>
  <li>2ème <code class="language-plaintext highlighter-rouge">app.use</code> : s on arrive là, c’est que toutes les routes précédentes ont échouées : on ne peut rien faire de la requêtes on indique au client que c’est un 404. On en a aussi profité pour rendre du contenu (toute une famille).</li>
</ol>

<blockquote>
  <p>Le dernier appel de <code class="language-plaintext highlighter-rouge">app</code> doit être pour gérer les requêtes qui n’ont pas pu être consommées avant. C’est souvent que l’on ne sait pas quoi en faire donc on l’indique au client part un 404.</p>
</blockquote>

<p>Pour plus d’informations sur le routage express, n’hésitez pas à <a href="https://expressjs.com/fr/guide/routing.html">consulter la documentation</a></p>

<h3 id="fonction-next">fonction next()</h3>

<p>On peut remettre des requêtes utilisées en fonction avec la méthode <code class="language-plaintext highlighter-rouge">next()</code></p>

<p>Ajoutez par exemple ce code en début de fichier en faisant en sorte que ce soit le 1er appel à <code class="language-plaintext highlighter-rouge">app</code> :</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// ...</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">date</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">())</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">Time:</span><span class="dl">'</span><span class="p">,</span> <span class="nx">date</span><span class="p">.</span><span class="nx">toLocaleDateString</span><span class="p">(),</span> <span class="nx">date</span><span class="p">.</span><span class="nx">toLocaleTimeString</span><span class="p">(),</span> <span class="dl">"</span><span class="s2">; url :</span><span class="dl">"</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span>
    <span class="nx">next</span><span class="p">();</span> <span class="c1">// sans cette ligne on ne pourra pas poursuivre.</span>
<span class="p">})</span>

<span class="c1">// ...</span>
</code></pre></div></div>

<blockquote class="attention">
  <p>Notez Le format de la fonction change, remarquez qu’il y a un troisième paramètre, <code class="language-plaintext highlighter-rouge">next</code>.
Lorsque vous voulez utiliser <code class="language-plaintext highlighter-rouge">next</code> il faut que vous l’ajoutiez en paramètre de la fonction.</p>
</blockquote>

<p>Toutes les requêtes satisfont cet appel, c’est un loggeur rudimentaire.</p>

<p>Si vous supprimez la ligne avec <code class="language-plaintext highlighter-rouge">next()</code> plus rien ne fonctionne. Toutes les requêtes sont consommées.</p>

  </div>

</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/cours_informatique/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">cours d&#39;informatique</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">cours d&#39;informatique</li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/FrancoisBrucker"><svg class="svg-icon"><use xlink:href="/cours_informatique/assets/minima-social-icons.svg#github"></use></svg> <span class="username">FrancoisBrucker</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>Support de cours/td d&#39;informatique à l&#39;école centrale marseille.</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
<!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Projet numérologie : partie 3 : intégration | cours d’informatique</title>
<meta name="generator" content="Jekyll v4.2.0">
<meta property="og:title" content="Projet numérologie : partie 3 : intégration">
<meta name="author" content="François Brucker">
<meta property="og:locale" content="en_US">
<meta name="description" content="Support de cours/td d’informatique de François Brucker.">
<meta property="og:description" content="Support de cours/td d’informatique de François Brucker.">
<link rel="canonical" href="/cours_informatique/cours/web/projets/numerologie/partie-3-donnees/2-integration.html">
<meta property="og:url" content="/cours_informatique/cours/web/projets/numerologie/partie-3-donnees/2-integration.html">
<meta property="og:site_name" content="cours d’informatique">
<meta name="twitter:card" content="summary">
<meta property="twitter:title" content="Projet numérologie : partie 3 : intégration">
<script type="application/ld+json">
{"description":"Support de cours/td d’informatique de François Brucker.","author":{"@type":"Person","name":"François Brucker"},"@type":"WebPage","url":"/cours_informatique/cours/web/projets/numerologie/partie-3-donnees/2-integration.html","headline":"Projet numérologie : partie 3 : intégration","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/cours_informatique/assets/main.css">

  <link rel="stylesheet" href="/cours_informatique/assets/custom.css">

  <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
<link type="application/atom+xml" rel="alternate" href="/cours_informatique/feed.xml" title="cours d'informatique">
</head>

<body>
<header class="site-header" role="banner">

  <div class="wrapper">
<a class="site-title" rel="author" href="/cours_informatique/">cours d'informatique</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger">
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewbox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"></path>
            </svg>
          </span>
        </label>

        <div class="trigger">
            <a class="page-link" href="/cours_informatique/about"> about </a>
        </div>
      </nav>
</div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post">

  <header class="post-header">
    <h1 class="post-title">Projet numérologie : partie 3 : intégration</h1>Auteur : <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span class="p-author h-card" itemprop="name">François Brucker</span></span>
  </header>

  <div class="post-content">
    <blockquote class="chemin">
  <p><a href="/cours_informatique/cours/web/projets/numerologie/">numérologie</a> / <a href="/cours_informatique/cours/web/projets/numerologie/partie-3-donnees/">partie 3</a> / <a href="/cours_informatique/cours/web/projets/numerologie/partie-3-donnees/2-integration.html">intégration</a></p>
</blockquote>

<p>Création de la base de donnée associée au projet</p>

<h2 id="base-en-lecture-seule">base en lecture seule</h2>

<p>On va commencer par créer une base de donnée en lecture pour associer à chaque chiffre sa signification (scientifique).</p>

<h3 id="modèle">modèle</h3>

<p>Le modèle va être identique à notre modèle jouet de la partie précédente. Modifions <em>“numerologie/db.js”</em> pour qu’il corresponde à notre nouveau modèle :</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="p">{</span> <span class="nx">Sequelize</span><span class="p">,</span> <span class="nx">DataTypes</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">sequelize</span><span class="dl">'</span><span class="p">);</span>
<span class="nx">path</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">path</span><span class="dl">'</span><span class="p">)</span>

<span class="kd">const</span> <span class="nx">sequelize</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Sequelize</span><span class="p">({</span>
  <span class="na">dialect</span><span class="p">:</span> <span class="dl">'</span><span class="s1">sqlite</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">storage</span><span class="p">:</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="dl">'</span><span class="s1">db.sqlite</span><span class="dl">'</span><span class="p">)</span>
<span class="p">});</span>

<span class="kd">const</span> <span class="nx">Signification</span> <span class="o">=</span> <span class="nx">sequelize</span><span class="p">.</span><span class="nx">define</span><span class="p">(</span><span class="dl">'</span><span class="s1">Signification</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
    <span class="na">message</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">type</span><span class="p">:</span> <span class="nx">DataTypes</span><span class="p">.</span><span class="nx">STRING</span><span class="p">,</span>
        <span class="na">allowNull</span><span class="p">:</span> <span class="kc">false</span>
    <span class="p">},</span>
    <span class="na">nombre</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">type</span><span class="p">:</span> <span class="nx">DataTypes</span><span class="p">.</span><span class="nx">INTEGER</span><span class="p">,</span>
        <span class="na">allowNull</span><span class="p">:</span> <span class="kc">false</span>
    <span class="p">},</span>
<span class="p">},</span> <span class="p">{</span>
    <span class="c1">// Other model options go here</span>
<span class="p">});</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">sequelize</span><span class="p">:</span> <span class="nx">sequelize</span><span class="p">,</span>
    <span class="na">model</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">Signification</span><span class="p">:</span> <span class="nx">Signification</span><span class="p">,</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="initialisation">initialisation</h3>

<p>On initialise la base dans le fichier <em>“numerologie/db-init.js”</em> :</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">db</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">./db</span><span class="dl">"</span><span class="p">)</span>

<span class="k">async</span> <span class="kd">function</span> <span class="nx">initDB</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">await</span> <span class="nx">db</span><span class="p">.</span><span class="nx">sequelize</span><span class="p">.</span><span class="nx">sync</span><span class="p">({</span><span class="na">force</span><span class="p">:</span> <span class="kc">true</span><span class="p">})</span>
    
    <span class="k">await</span> <span class="nx">db</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">Signification</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
        <span class="na">message</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Une main de fer dans un gant de velours... Votre caractère bien trempé vous cause parfois du tort, mais pas question de vous adoucir : vous êtes comme vous êtes, que ça plaise ou non ! Au moins, vous avez le mérite de jouer cartes sur table. Vos amis savent qu'ils peuvent compter sur votre loyauté.</span><span class="dl">"</span><span class="p">,</span>
        <span class="na">nombre</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="p">})</span>

    <span class="k">await</span> <span class="nx">db</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">Signification</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
        <span class="na">message</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Au premier abord, on vous juge froide, distante. Mais c'est mal vous connaître car sous votre carapace glaciale, vous êtes ultrasensible ! Le sarcasme et l'ironie vous protègent des déceptions... Combien de fois avez-vous accordé votre confiance à des gens qui ne la méritaient pas ?</span><span class="dl">"</span><span class="p">,</span>
        <span class="na">nombre</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
    <span class="p">})</span>

    <span class="k">await</span> <span class="nx">db</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">Signification</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
        <span class="na">message</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Vous avez l'âme d'une artiste ! Dessin, chant, danse... Vous vous épanouissez dans les activités créatives, et vous avez une imagination débordante.</span><span class="dl">"</span><span class="p">,</span>
        <span class="na">nombre</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
    <span class="p">})</span>

    <span class="k">await</span> <span class="nx">db</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">Signification</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
        <span class="na">message</span><span class="p">:</span> <span class="dl">"</span><span class="s2">La spontanéité, ce n'est pas votre truc. Dans votre vie, tout doit être rangé, organisé, planifié, sinon c'est la panique ! Au travail, les responsabilités vous font peur : vous préférez vous mettre au service d'un supérieur plutôt que de prendre les commandes. Votre prudence naturelle vous pousse à ne pas vous aventurer en terrain inconnu...</span><span class="dl">"</span><span class="p">,</span>
        <span class="na">nombre</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
    <span class="p">})</span>

    <span class="k">await</span> <span class="nx">db</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">Signification</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
        <span class="na">message</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Le changement, l'imprévu, la nouveauté, vous adorez ! Ultra curieuse, vous êtes bien décidée à tout essayer, et les expériences extrêmes ne vous font pas peur.</span><span class="dl">"</span><span class="p">,</span>
        <span class="na">nombre</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
    <span class="p">})</span>

    <span class="k">await</span> <span class="nx">db</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">Signification</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
        <span class="na">message</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Vous attendez le prince charmant !</span><span class="dl">"</span><span class="p">,</span>
        <span class="na">nombre</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
    <span class="p">})</span>

    <span class="k">await</span> <span class="nx">db</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">Signification</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
        <span class="na">message</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Sous votre petit air mystérieux, vous cachez des capacités d'observation et d'analyse incroyables. D'ailleurs, lorsque vous leur donnez des conseils, vos proches les suivent à la lettre !</span><span class="dl">"</span><span class="p">,</span>
        <span class="na">nombre</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span>
    <span class="p">})</span>

    <span class="k">await</span> <span class="nx">db</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">Signification</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
        <span class="na">message</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Des projets, vous en avez toujours en pagaille ! Visionnaire, vous avez l'âme d'un chef : vous commandez, et les autres vous obéissent sans discuter. Et à l'arrivée, on reconnaît vos mérites.</span><span class="dl">"</span><span class="p">,</span>
        <span class="na">nombre</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>
    <span class="p">})</span>

    <span class="k">await</span> <span class="nx">db</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">Signification</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
        <span class="na">message</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Vous rêvez d'un monde paisible et harmonieux... L'idéaliste de la famille, c'est vous ! Vous êtes vulnérable face au mensonge et à la trahison. Pourtant, lorsque les choses se corsent, vous êtes capable de vous démener pour résoudre les problèmes au plus vite. Pas question de rester passive face aux situations difficiles !</span><span class="dl">"</span><span class="p">,</span>
        <span class="na">nombre</span><span class="p">:</span> <span class="mi">9</span><span class="p">,</span>
    <span class="p">})</span>

<span class="p">}</span>

<span class="nx">initDB</span><span class="p">()</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">base initalisée</span><span class="dl">"</span><span class="p">)</span>
    <span class="p">})</span>
</code></pre></div></div>

<h2 id="on-jardine">on jardine</h2>

<h3 id="suppression-des-vieux-fichiers">suppression des vieux fichiers</h3>

<p>Nous n’avons plus besoin des vieux fichiers de tests : <em>“numerologie/ma_db_init.js”</em>, <em>“numerologie/ma_db_test.js”</em> et <em>“numerologie/ma_db_utilisation.js”</em></p>

<h3 id="script-init">script init</h3>

<p>On a coutume de mettre les différents scripts utiles dans la partie <code class="language-plaintext highlighter-rouge">script</code> du fichier <em>“package.json”</em>. Ajoutons donc un script d’initialisation :</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">...</span><span class="w">

  </span><span class="nl">"scripts"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"init"</span><span class="p">:</span><span class="w"> </span><span class="s2">"node db-init.js"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"test"</span><span class="p">:</span><span class="w"> </span><span class="s2">"echo </span><span class="se">\"</span><span class="s2">Error: no test specified</span><span class="se">\"</span><span class="s2"> &amp;&amp; exit 1"</span><span class="w">
  </span><span class="p">}</span><span class="err">,</span><span class="w">

</span><span class="err">...</span><span class="w">
</span></code></pre></div></div>

<p>On pourra exécuter ce script (juste une commande pour l’instant) en tapant la commande :</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npm run init
</code></pre></div></div>

<p>Ajoutons également les commandesà faire dans le fichier <em>“numerologie/readme.md”</em> :</p>

<div class="language-markdown highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gh"># numerologie</span>

Voyez la vie en base 10 en associant un chiffre à votre prénom.

<span class="gu">## initialisation</span>

<span class="sb">`npm run init`</span>
</code></pre></div></div>

<h2 id="utilisation-de-la-base">utilisation de la base</h2>

<p>Nous allons donner le message associé au numéro en plus du reste.</p>

<h3 id="côté-serveur">côté serveur</h3>

<p>Avec le numéro calculé, on cherche dans la base [e premier élément ayant ce numéro (méthode <a href="https://sequelize.org/master/manual/model-querying-finders.html#-code-findone--code-">findOne</a>) et on le renvoie dans le json de résultat. On modifie le fichier <em>“numerologie/index.js”</em> pour cela :</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// ...</span>

<span class="kd">const</span> <span class="nx">db</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">./db</span><span class="dl">"</span><span class="p">)</span>

<span class="c1">// ...</span>

<span class="nx">app</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="nb">encodeURI</span><span class="p">(</span><span class="dl">'</span><span class="s1">/prénom</span><span class="dl">'</span><span class="p">),</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">)</span>
    <span class="nx">prenom</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">[</span><span class="dl">"</span><span class="s2">valeur</span><span class="dl">"</span><span class="p">]</span>
    <span class="nx">chiffre</span> <span class="o">=</span> <span class="nx">numerologie</span><span class="p">.</span><span class="nx">chiffre</span><span class="p">(</span><span class="nx">prenom</span><span class="p">)</span> 
    <span class="nx">db</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">Signification</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span>
        <span class="na">where</span><span class="p">:</span> <span class="p">{</span>
            <span class="na">nombre</span><span class="p">:</span> <span class="nx">chiffre</span>
        <span class="p">}</span>
    <span class="p">}).</span><span class="nx">then</span><span class="p">((</span><span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span>
            <span class="na">prénom</span><span class="p">:</span> <span class="nx">prenom</span><span class="p">,</span>
            <span class="na">chiffre</span><span class="p">:</span> <span class="nx">chiffre</span><span class="p">,</span> 
            <span class="na">message</span><span class="p">:</span> <span class="nx">data</span><span class="p">.</span><span class="nx">message</span>
        <span class="p">})</span>
    <span class="p">})</span>
<span class="p">})</span>

<span class="c1">// ...</span>
</code></pre></div></div>

<p>Notez que l’accès en base est asynchrone, il faut donc attendre le résultat (avec le <code class="language-plaintext highlighter-rouge">then</code> des promise) avant de finir la requête.</p>

<h3 id="côté-client">côté client</h3>

<p>On va créer un div et afficher le message reçu. Fichier <em>“numerologie/static/index.html”</em> :</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">&lt;!-- ... --&gt;</span>

<span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"message"</span><span class="nt">&gt;&lt;/div&gt;</span>

<span class="nt">&lt;script&gt;</span>
<span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="dl">"</span><span class="s2">#form-button</span><span class="dl">"</span><span class="p">).</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">"</span><span class="s2">click</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">prenom</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="dl">"</span><span class="s2">#form-input</span><span class="dl">"</span><span class="p">).</span><span class="nx">value</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">prenom</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">fetch</span><span class="p">(</span><span class="dl">'</span><span class="s1">/prénom/?valeur=</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">prenom</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">response</span> <span class="o">=&gt;</span> <span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">())</span>
            <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">data</span> <span class="o">=&gt;</span> <span class="p">{</span>
                <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="dl">"</span><span class="s2">#chiffre</span><span class="dl">"</span><span class="p">).</span><span class="nx">textContent</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">chiffre</span>
                <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="dl">"</span><span class="s2">#message</span><span class="dl">"</span><span class="p">).</span><span class="nx">textContent</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">message</span>
                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
            <span class="p">})</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="dl">"</span><span class="s2">#chiffre</span><span class="dl">"</span><span class="p">).</span><span class="nx">textContent</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">?</span><span class="dl">"</span>
    <span class="p">}</span>

    <span class="nx">event</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
<span class="p">})</span>
<span class="nt">&lt;/script&gt;</span>

<span class="c">&lt;!-- ... --&gt;</span>

</code></pre></div></div>

<h2 id="base-des-correspondances-recherchées">base des correspondances recherchées</h2>

<p>Ajoutons un autre modèle qui stocke les prénoms recherchés. On ne va cependant stocker qu’une seule fois le prénom.</p>

<h3 id="modèle-prénom">modèle prénom</h3>

<p>On modifie <em>“numerologie/db.js”</em> pour inclure le nouveau modèle :</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="p">{</span> <span class="nx">Sequelize</span><span class="p">,</span> <span class="nx">DataTypes</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">sequelize</span><span class="dl">'</span><span class="p">);</span>
<span class="nx">path</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">path</span><span class="dl">'</span><span class="p">)</span>

<span class="kd">const</span> <span class="nx">sequelize</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Sequelize</span><span class="p">({</span>
  <span class="na">dialect</span><span class="p">:</span> <span class="dl">'</span><span class="s1">sqlite</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">storage</span><span class="p">:</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="dl">'</span><span class="s1">db.sqlite</span><span class="dl">'</span><span class="p">)</span>
<span class="p">});</span>

<span class="kd">const</span> <span class="nx">Signification</span> <span class="o">=</span> <span class="nx">sequelize</span><span class="p">.</span><span class="nx">define</span><span class="p">(</span><span class="dl">'</span><span class="s1">Signification</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
    <span class="na">message</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">type</span><span class="p">:</span> <span class="nx">DataTypes</span><span class="p">.</span><span class="nx">STRING</span><span class="p">,</span>
        <span class="na">allowNull</span><span class="p">:</span> <span class="kc">false</span>
    <span class="p">},</span>
    <span class="na">nombre</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">type</span><span class="p">:</span> <span class="nx">DataTypes</span><span class="p">.</span><span class="nx">INTEGER</span><span class="p">,</span>
        <span class="na">allowNull</span><span class="p">:</span> <span class="kc">false</span>
    <span class="p">},</span>
<span class="p">},</span> <span class="p">{</span>
    <span class="c1">// Other model options go here</span>
<span class="p">});</span>

<span class="kd">const</span> <span class="nx">Prenoms</span> <span class="o">=</span> <span class="nx">sequelize</span><span class="p">.</span><span class="nx">define</span><span class="p">(</span><span class="dl">'</span><span class="s1">Prenoms</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
    <span class="na">prenom</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">type</span><span class="p">:</span> <span class="nx">DataTypes</span><span class="p">.</span><span class="nx">STRING</span><span class="p">,</span>
        <span class="na">allowNull</span><span class="p">:</span> <span class="kc">false</span>
    <span class="p">},</span>
<span class="p">},</span> <span class="p">{</span>
    <span class="c1">// Other model options go here</span>
<span class="p">});</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">sequelize</span><span class="p">:</span> <span class="nx">sequelize</span><span class="p">,</span>
    <span class="na">model</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">Signification</span><span class="p">:</span> <span class="nx">Signification</span><span class="p">,</span>
        <span class="na">Prenoms</span><span class="p">:</span> <span class="nx">Prenoms</span><span class="p">,</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Puis on recrée notre base de données avec la commande :</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npm run init
</code></pre></div></div>

<h3 id="création-des-éléments-de-la-base">création des éléments de la base</h3>

<p>Il nous reste plus qu’à ajouter, si nécessaire, le prénom dans la base. On modifie la route dans <em>“numerologie/index.js”</em> :</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// ...</span>

<span class="nx">app</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="nb">encodeURI</span><span class="p">(</span><span class="dl">'</span><span class="s1">/prénom</span><span class="dl">'</span><span class="p">),</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">)</span>
    <span class="nx">prenom</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">[</span><span class="dl">"</span><span class="s2">valeur</span><span class="dl">"</span><span class="p">]</span>
    <span class="nx">chiffre</span> <span class="o">=</span> <span class="nx">numerologie</span><span class="p">.</span><span class="nx">chiffre</span><span class="p">(</span><span class="nx">prenom</span><span class="p">)</span> 
    <span class="nx">db</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">Prenoms</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span>
        <span class="na">where</span><span class="p">:</span> <span class="p">{</span>
            <span class="na">prenom</span><span class="p">:</span> <span class="nx">prenom</span>
        <span class="p">}</span>
    <span class="p">}).</span><span class="nx">then</span><span class="p">((</span><span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">data</span> <span class="o">===</span> <span class="kc">null</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">db</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">Prenoms</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
                <span class="na">prenom</span><span class="p">:</span> <span class="nx">prenom</span>
            <span class="p">})</span>
        <span class="p">}</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
    <span class="p">})</span>
    <span class="nx">db</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">Signification</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span>
        <span class="na">where</span><span class="p">:</span> <span class="p">{</span>
            <span class="na">nombre</span><span class="p">:</span> <span class="nx">chiffre</span>
        <span class="p">}</span>
    <span class="p">}).</span><span class="nx">then</span><span class="p">((</span><span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span>
            <span class="na">prénom</span><span class="p">:</span> <span class="nx">prenom</span><span class="p">,</span>
            <span class="na">chiffre</span><span class="p">:</span> <span class="nx">chiffre</span><span class="p">,</span> 
            <span class="na">message</span><span class="p">:</span> <span class="nx">data</span><span class="p">.</span><span class="nx">message</span>
        <span class="p">})</span>
    <span class="p">})</span>
<span class="p">})</span>

<span class="c1">//...</span>
</code></pre></div></div>

<p>On commence par tenter de chercher le prénom dans la base. S’il n’y est pas (le retour est <code class="language-plaintext highlighter-rouge">null</code>), on sauve le prénom.
Les deux recherches sont asynchrones et indépendantes.</p>

<blockquote>
  <p><code class="language-plaintext highlighter-rouge">==</code> et <code class="language-plaintext highlighter-rouge">===</code> <a href="https://developer.mozilla.org/fr/docs/Web/JavaScript/Equality_comparisons_and_sameness">sont différents</a> en javascript.</p>
</blockquote>

<h3 id="lire-les-prénoms">lire les prénoms</h3>

<p>Pour voir les différents prénoms de la base, il faut que l’on implémente la méthode <strong>R</strong>ead pour notre modèle <code class="language-plaintext highlighter-rouge">Prenoms</code> (<strong>C</strong>reate est intégré à la route GET <code class="language-plaintext highlighter-rouge">/Prénom</code>, <strong>U</strong>pdate et <strong>D</strong>elete sont pour l’instant inutiles).</p>

<p>L’usage veut que l’accès aux données soient rangé dans une route qui commence par <code class="language-plaintext highlighter-rouge">/api</code>. Dans notre cas, on utiliser la route :
GET <code class="language-plaintext highlighter-rouge">/api/prenoms/read/</code> pour lire tous nos prénoms. Ajoutons cette route à <em>“numerologie/index.js”</em> :</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// ...</span>

<span class="nx">app</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/api/prenoms/read</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">db</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">Prenoms</span><span class="p">.</span><span class="nx">findAll</span><span class="p">()</span>
        <span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">liste</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="p">(</span><span class="nx">element</span> <span class="k">of</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">liste</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
                    <span class="na">prenom</span><span class="p">:</span> <span class="nx">element</span><span class="p">.</span><span class="nx">prenom</span><span class="p">,</span>
                    <span class="na">chiffre</span><span class="p">:</span> <span class="nx">numerologie</span><span class="p">.</span><span class="nx">chiffre</span><span class="p">(</span><span class="nx">element</span><span class="p">.</span><span class="nx">prenom</span><span class="p">)</span>
                <span class="p">})</span>
            <span class="p">}</span>
            <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">liste</span><span class="p">)</span>
        <span class="p">})</span>
<span class="p">})</span>

<span class="c1">//...</span>
</code></pre></div></div>

<p>Testez cette route après avec l’url <a href="http://127.0.0.1:3000/api/prenoms/read">http://127.0.0.1:3000/api/prenoms/read</a> avoir ajouté (avec la page de départ) quelques prénoms à la base.</p>

<h3 id="représenter-les-prénoms">représenter les prénoms</h3>

<p>On peut maintenant finir cette partie en ajoutant une page html <em>“numerologie/static/prenoms.html”</em> qui liste tous les prénoms de la base :</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;!doctype html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">"fr"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;head&gt;</span>
        <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"utf-8"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;title&gt;</span>Les prénoms recherchés<span class="nt">&lt;/title&gt;</span>
        
        <span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">"stylesheet"</span> <span class="na">href=</span><span class="s">"https://unpkg.com/purecss@2.0.6/build/pure-min.css"</span> <span class="na">integrity=</span><span class="s">"sha384-Uu6IeWbM+gzNVXJcM9XV3SohHtmWE+3VGi496jvgX1jyvDTXfdK+rfZc8C1Aehk5"</span> <span class="na">crossorigin=</span><span class="s">"anonymous"</span><span class="nt">&gt;</span>
        
        <span class="nt">&lt;link</span> <span class="na">href=</span><span class="s">"main.css"</span> <span class="na">rel=</span><span class="s">"stylesheet"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;/head&gt;</span>
    <span class="nt">&lt;body&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"main"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;p&gt;</span>Chargement des prénoms...<span class="nt">&lt;/p&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
        
        <span class="nt">&lt;script&gt;</span>
        <span class="nx">main</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="dl">"</span><span class="s2">#main</span><span class="dl">"</span><span class="p">)</span>
        <span class="nx">fetch</span><span class="p">(</span><span class="dl">"</span><span class="s2">/api/prenoms/read</span><span class="dl">"</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">response</span> <span class="o">=&gt;</span> <span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">())</span>
            <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">data</span> <span class="o">=&gt;</span> <span class="p">{</span>
                <span class="nx">main</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="dl">""</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">element</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="dl">"</span><span class="s2">p</span><span class="dl">"</span><span class="p">)</span>
                    <span class="nx">element</span><span class="p">.</span><span class="nx">innerText</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">pas de prénoms sauvés dans la base.</span><span class="dl">"</span>                    
                    <span class="nx">main</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span>

                    <span class="k">return</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="nx">list</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="dl">"</span><span class="s2">ul</span><span class="dl">"</span><span class="p">)</span>
                <span class="nx">main</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">list</span><span class="p">)</span>
                <span class="k">for</span> <span class="p">(</span><span class="nx">prenom</span> <span class="k">of</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>                    
                    <span class="nx">element</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="dl">"</span><span class="s2">li</span><span class="dl">"</span><span class="p">)</span>
                    <span class="nx">element</span><span class="p">.</span><span class="nx">innerText</span> <span class="o">=</span> <span class="nx">prenom</span><span class="p">.</span><span class="nx">prenom</span>
                    <span class="nx">list</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span>
                <span class="p">}</span>
            <span class="p">})</span>
        <span class="nt">&lt;/script&gt;</span>
    <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div>

<p>Cette page affiche un texte par défaut (<code class="language-plaintext highlighter-rouge">&lt;p&gt;Chargement des prénoms...&lt;/p&gt;</code>) qui est remplacé après lecture des prénoms de la base. On distingue 2 cas : la base est vide (et on le signale) ou la base contient des prénoms et on les affiche.</p>

<p>Notez comment on a fait pour :</p>

<ul>
  <li>supprimer tous les enfant d’un élément de l’arbre DOM : <code class="language-plaintext highlighter-rouge">main.innerHTML = ""</code>
</li>
  <li>créer des éléments : <code class="language-plaintext highlighter-rouge">element = document.createElement("p")</code>
</li>
  <li>ajouter des enfants à un élément : <code class="language-plaintext highlighter-rouge">main.appendChild(element)</code>
</li>
</ul>

<p>Testez cette page (<a href="http://127.0.0.1:3000/static/prenoms.html">http://127.0.0.1:3000/static/prenoms.html</a>) sur une base vide (juste après un <code class="language-plaintext highlighter-rouge">npm run init</code>) et sur une base avec des prénoms de stockés.</p>

  </div>

</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/cours_informatique/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">cours d'informatique</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">cours d'informatique</li>
</ul>
      </div>

      <div class="footer-col footer-col-2">
<ul class="social-media-list"><li><a href="https://github.com/FrancoisBrucker"><svg class="svg-icon"><use xlink:href="/cours_informatique/assets/minima-social-icons.svg#github"></use></svg> <span class="username">FrancoisBrucker</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>Support de cours/td d'informatique de François Brucker.</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>

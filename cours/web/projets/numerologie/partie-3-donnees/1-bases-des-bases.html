<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
<!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Projet numérologie : partie 3 : bases des bases de données | cours d’informatique</title>
<meta name="generator" content="Jekyll v4.2.0">
<meta property="og:title" content="Projet numérologie : partie 3 : bases des bases de données">
<meta name="author" content="François Brucker">
<meta property="og:locale" content="en_US">
<meta name="description" content="Support de cours/td d’informatique à l’école centrale marseille.">
<meta property="og:description" content="Support de cours/td d’informatique à l’école centrale marseille.">
<link rel="canonical" href="/cours_informatique/cours/web/projets/numerologie/partie-3-donnees/1-bases-des-bases.html">
<meta property="og:url" content="/cours_informatique/cours/web/projets/numerologie/partie-3-donnees/1-bases-des-bases.html">
<meta property="og:site_name" content="cours d’informatique">
<meta name="twitter:card" content="summary">
<meta property="twitter:title" content="Projet numérologie : partie 3 : bases des bases de données">
<script type="application/ld+json">
{"description":"Support de cours/td d’informatique à l’école centrale marseille.","author":{"@type":"Person","name":"François Brucker"},"@type":"WebPage","url":"/cours_informatique/cours/web/projets/numerologie/partie-3-donnees/1-bases-des-bases.html","headline":"Projet numérologie : partie 3 : bases des bases de données","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/cours_informatique/assets/main.css">

  <link rel="stylesheet" href="/cours_informatique/assets/custom.css">

  <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
<link type="application/atom+xml" rel="alternate" href="/cours_informatique/feed.xml" title="cours d'informatique">
</head>

<body>
<header class="site-header" role="banner">

  <div class="wrapper">
<a class="site-title" rel="author" href="/cours_informatique/">cours d'informatique</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger">
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewbox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"></path>
            </svg>
          </span>
        </label>

        <div class="trigger">
            <a class="page-link" href="/cours_informatique/about"> about </a>
        </div>
      </nav>
</div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post">

  <header class="post-header">
    <h1 class="post-title">Projet numérologie : partie 3 : bases des bases de données</h1>Auteur : <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span class="p-author h-card" itemprop="name">François Brucker</span></span>
  </header>

  <div class="post-content">
    <blockquote class="chemin">
  <p><a href="/cours_informatique/cours/web/projets/numerologie/">numérologie</a> / <a href="/cours_informatique/cours/web/projets/numerologie/partie-3-donnees/">partie 3</a> / <a href="/cours_informatique/cours/web/projets/numerologie/partie-3-donnees/1-bases-des-bases.html">bases des bases de données</a></p>
</blockquote>

<p>Comment utiliser des bases de données avec express et node.</p>

<h2 id="asynchrone-et-promise">asynchrone et promise</h2>

<p>La plupart des requêtes en base de données sont asynchrones. C’est à dire que l’on va demander quelque chose à la base de données puis continuer notre code. Une fois que la base de donnée aura répondu, on exécutera une fonction. C’est une <em>promise</em> (voir <a href="https://nodejs.dev/learn/understanding-javascript-promises">la doc de node</a>) et on en a déjà vu une <a href="/cours_informatique/cours/web/projets/numerologie/partie-2-serveur/4-javascript-serveur.html#int%C3%A9gration-au-html">dans la partie 2</a>.</p>

<p>Il peut cependant parfois être utile d’écrire du code, <em>à l’ancienne</em>, c’est à dire un exécutant ligne çà ligne notre code. Pour cela, on utilise alors le mots clés <code class="language-plaintext highlighter-rouge">await</code> qui doit être utilisé  dans une fonction déclarée en <code class="language-plaintext highlighter-rouge">async</code>. Lisez <a href="https://nodejs.dev/learn/modern-asynchronous-javascript-with-async-and-await">la documentation</a> pour comprendre la syntaxe.</p>

<blockquote>
  <p>On va utiliser cette méthode lorsque l’on créera et synchronisera nos bases de données.</p>
</blockquote>

<h2 id="base-de-données">Base de données</h2>

<p>Nous allons voir ici comment créer une base de donnée et l’utiliser avec <a href="https://sequelize.org/">sequelize</a> qui va nous permettre de gérer tout le côté configuration et utilisation de SQL pour nous.</p>

<p>En effet, selon la base, le dialecte SQL sera différent. Si l’on écrit nos requêtes à la main, il faudra toutes les changer lorsque l’on change de base, ce qui n’est pas humainement possible. On va donc écrire nos requête dans le formalisme de sequelize qui va le traduire pour chaque base utilisée.</p>

<h3 id="sequelize">sequelize</h3>

<p>Dans le dossier <em>“numerologie/”</em> tapez :</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npm <span class="nb">install</span> <span class="nt">--save</span> sequelize
</code></pre></div></div>

<p>Notre base de donnée étant sqlite3, on installe également le driver :</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npm <span class="nb">install</span> <span class="nt">--save</span> sqlite3
</code></pre></div></div>

<p>Pour initialiser notre base de données il faut dire à <code class="language-plaintext highlighter-rouge">sequelize</code> quelle base on utilise.
Nous allons ici utiliser une base de donnée en mémoire. Elle sera remise à zéro à chaque fois que l’on relancera le serveur :</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="p">{</span> <span class="nx">Sequelize</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">sequelize</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">sequelize</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Sequelize</span><span class="p">(</span><span class="dl">'</span><span class="s1">sqlite::memory:</span><span class="dl">'</span><span class="p">);</span>
</code></pre></div></div>

<blockquote>
  <p>La première ligne trouve sequelize dans le module et la seconde crée le lien avec la base de donnée.</p>
</blockquote>

<h3 id="model">model</h3>

<p>On va interagir avec notre base via des modèles. Chaque modèle est constitué de champs qui vont décrire nos données : c’est une table où chaque donnée est une ligne et où les colonnes ont des types prédéfinis.</p>

<p>Les types possible de champ sont disponible <a href="https://sequelize.org/v5/manual/data-types.html">dans la documentation</a>.</p>

<p>On va par exemple créer un modèle constitué d’une chaine de caractère (<code class="language-plaintext highlighter-rouge">STRING</code> : chaine de caractère d’au plus 255 caractères) et d’un entier (<code class="language-plaintext highlighter-rouge">INTEGER</code>) :</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="p">{</span> <span class="nx">Sequelize</span><span class="p">,</span> <span class="nx">DataTypes</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">sequelize</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">sequelize</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Sequelize</span><span class="p">(</span><span class="dl">'</span><span class="s1">sqlite::memory:</span><span class="dl">'</span><span class="p">);</span>

<span class="kd">const</span> <span class="nx">MonModele</span> <span class="o">=</span> <span class="nx">sequelize</span><span class="p">.</span><span class="nx">define</span><span class="p">(</span><span class="dl">'</span><span class="s1">MonModele</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">message</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">type</span><span class="p">:</span> <span class="nx">DataTypes</span><span class="p">.</span><span class="nx">STRING</span><span class="p">,</span>
    <span class="na">allowNull</span><span class="p">:</span> <span class="kc">false</span>
  <span class="p">},</span>
  <span class="na">nombre</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">type</span><span class="p">:</span> <span class="nx">DataTypes</span><span class="p">.</span><span class="nx">INTEGER</span><span class="p">,</span>
    <span class="na">allowNull</span><span class="p">:</span> <span class="kc">false</span>
  <span class="p">},</span>
<span class="p">},</span> <span class="p">{</span>
  <span class="c1">// Other model options go here</span>
<span class="p">});</span>
</code></pre></div></div>

<p>Une fois le modèle donné, il faut <a href="https://sequelize.org/master/manual/model-basics.html#model-synchronization">synchroniser la base de donnée</a> avec celui-ci (si par exemple la base était créer avec un vieux modèle, il faut même changer la base pour qu’elle corresponde à notre nouveau modèle). Ceci se fait avec la fonction <strong>asynchrone</strong> <code class="language-plaintext highlighter-rouge">sync</code> :</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">sequelize</span><span class="p">.</span><span class="nx">sync</span><span class="p">()</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">synchronisation terminée.</span><span class="dl">"</span><span class="p">)</span>
    <span class="p">})</span>
</code></pre></div></div>

<blockquote class="attention">
  <p>Il est important d’attendre la fin de la synchronisation avant de lire ou sauver des données</p>
</blockquote>

<p>Normalement, la synchronisation des bases ne se fait pas en production. On a un script de création des modèles et de synchronisation que l’on exécute que lorsque le modèle change.</p>

<p>Comme ici on a une base de donnée en mémoire, elle est crée à chaque lancement du serveur, ce qui nous oblige à synchroniser à chaque démarrage (il faut ajouter les tables à la base fraichement créée).</p>

<h3 id="champs-spéciaux">champs spéciaux</h3>

<h4 id="clé-primaire">clé primaire</h4>

<p>Si l’on ne crée pas de clé primaire avec notre modèle, sequelize va créer un champ spécial nommé <code class="language-plaintext highlighter-rouge">id</code> qui s’incrémente tout seul et est la clé primaire de notre table.</p>

<p>Par défaut, utilisez toujours ce champ comme clé primaire.</p>

<h4 id="temps">temps</h4>

<p><a href="https://sequelize.org/master/manual/model-basics.html#timestamps">https://sequelize.org/master/manual/model-basics.html#timestamps</a></p>

<p>Par défaut, sequelize ajoute deux champs spéciaux <code class="language-plaintext highlighter-rouge">createdAt</code> and <code class="language-plaintext highlighter-rouge">updatedAt</code> pour connaitre la date de création et de la dernière mise à jour d’une donnée.</p>

<p>Le type de ces champ et <code class="language-plaintext highlighter-rouge">DataTypes.DATE</code>. A chaque fois que vous devez utiliser des dates ou des heures, il est <strong>indispensable</strong> d’utiliser des types dédiées. Il est criminel d’utiliser une chaine de caractère pour stocker des dates ou des heures : il y a trop de cas particuliers selon les pays et ou d’exception(année bissextile, etc).</p>

<h3 id="lire-et-sauver-des-données">lire et sauver des données</h3>

<p><a href="https://sequelize.org/master/manual/model-querying-basics.html">https://sequelize.org/master/manual/model-querying-basics.html</a></p>

<h3 id="exemple">exemple</h3>

<p>créer un fichier <em>“ma_db_test.js”</em> :</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="p">{</span> <span class="nx">Sequelize</span><span class="p">,</span> <span class="nx">DataTypes</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">sequelize</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">sequelize</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Sequelize</span><span class="p">(</span><span class="dl">'</span><span class="s1">sqlite::memory:</span><span class="dl">'</span><span class="p">);</span>

<span class="kd">const</span> <span class="nx">MonModele</span> <span class="o">=</span> <span class="nx">sequelize</span><span class="p">.</span><span class="nx">define</span><span class="p">(</span><span class="dl">'</span><span class="s1">MonModele</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
    <span class="na">message</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">type</span><span class="p">:</span> <span class="nx">DataTypes</span><span class="p">.</span><span class="nx">STRING</span><span class="p">,</span>
        <span class="na">allowNull</span><span class="p">:</span> <span class="kc">false</span>
    <span class="p">},</span>
    <span class="na">nombre</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">type</span><span class="p">:</span> <span class="nx">DataTypes</span><span class="p">.</span><span class="nx">INTEGER</span><span class="p">,</span>
        <span class="na">allowNull</span><span class="p">:</span> <span class="kc">false</span>
    <span class="p">},</span>
<span class="p">},</span> <span class="p">{</span>
    <span class="c1">// Other model options go here</span>
<span class="p">});</span>

<span class="k">async</span> <span class="kd">function</span> <span class="nx">initDB</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">await</span> <span class="nx">sequelize</span><span class="p">.</span><span class="nx">sync</span><span class="p">()</span>
    <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">MonModele</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
        <span class="na">message</span><span class="p">:</span> <span class="dl">"</span><span class="s2">mon premier message</span><span class="dl">"</span><span class="p">,</span>
        <span class="na">nombre</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span>
    <span class="p">})</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">message crée : </span><span class="dl">"</span><span class="p">)</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">())</span>

    <span class="nx">data</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">MonModele</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
        <span class="na">message</span><span class="p">:</span> <span class="dl">"</span><span class="s2">un autre massage</span><span class="dl">"</span><span class="p">,</span>
        <span class="na">nombre</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
    <span class="p">})</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">message crée : </span><span class="dl">"</span><span class="p">)</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">())</span>
    
<span class="p">}</span>

<span class="nx">initDB</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Lecture id = 1 :</span><span class="dl">"</span><span class="p">)</span>
    <span class="nx">data</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">MonModele</span><span class="p">.</span><span class="nx">findByPk</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> 
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">())</span>

    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">---------</span><span class="dl">"</span><span class="p">)</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">clé primaire : </span><span class="dl">"</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">message : </span><span class="dl">"</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">message</span><span class="p">)</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">nombre : </span><span class="dl">"</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">nombre</span><span class="p">)</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">date de création création : </span><span class="dl">"</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">createdAt</span><span class="p">)</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">dernière modification : </span><span class="dl">"</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">updatedAt</span><span class="p">)</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">---------</span><span class="dl">"</span><span class="p">)</span>

    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Lecture id qui n'existe pas :</span><span class="dl">"</span><span class="p">)</span>
    <span class="nx">data</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">MonModele</span><span class="p">.</span><span class="nx">findByPk</span><span class="p">(</span><span class="mi">42</span><span class="p">);</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="c1">// n'existe pas</span>

    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Lecture tous les éléments :</span><span class="dl">"</span><span class="p">)</span>
    <span class="nx">data</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">MonModele</span><span class="p">.</span><span class="nx">findAll</span><span class="p">();</span> 
    <span class="k">for</span> <span class="p">(</span><span class="nx">element</span> <span class="k">of</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">element</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">())</span>
    <span class="p">}</span>
    
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Lecture requête :</span><span class="dl">"</span><span class="p">)</span>
    <span class="nx">data</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">MonModele</span><span class="p">.</span><span class="nx">findAll</span><span class="p">({</span>
        <span class="na">where</span><span class="p">:</span> <span class="p">{</span>
            <span class="na">nombre</span><span class="p">:</span> <span class="mi">3</span>
        <span class="p">}</span>
    <span class="p">});</span> 
    <span class="k">for</span> <span class="p">(</span><span class="nx">element</span> <span class="k">of</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">element</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">())</span>
    <span class="p">}</span>
<span class="p">})</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">coucou</span><span class="dl">"</span><span class="p">)</span>
</code></pre></div></div>

<p>Exécutez le code avec la commande :</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>node ma_db_test.js
</code></pre></div></div>

<blockquote>
  <p>Le code vu dans la console qui ressemble à du SQL est bien du SQL. Ce sont les commandes faites par sequelize.</p>
</blockquote>

<p>On crée une fonction asynchrone <code class="language-plaintext highlighter-rouge">initDB</code> dont le but est de se synchroniser puis de créer des données dans la base. A l’intérieur d’une fonction asynchrone on exécute du code avec <code class="language-plaintext highlighter-rouge">await</code>, comme ça on est sur qu’on ne passera à la ligne suivant qu’une fois la ligne avec le <code class="language-plaintext highlighter-rouge">await</code> exécutée (on est sur que l’on crée des données une fois la base synchronisée)</p>

<p>On utilise ensuite cette fonction de façon asynchrone, avec un <code class="language-plaintext highlighter-rouge">then</code>. On voit que c’est exécuté de façon asynchrone puisque lorsque l’on exécute le code, la chaine <code class="language-plaintext highlighter-rouge">"coucou"</code> est écrite tout en haut de l’exécution, bien avant les requêtes en base de sequelize.</p>

<p>Les données sont affichées à l’écran sous la forme d’un json. Mais vous avez accès aux différents champs (entre les deux <code class="language-plaintext highlighter-rouge">console.log("---------")</code>) :</p>

<h2 id="crud">crud</h2>

<p>Pour l’accès à nos données, on utilise le formalisme <a href="https://fr.wikipedia.org/wiki/CRUD">CRUD</a>, c’est à dire que l’on veut avoir des url qui nous permettent de :</p>

<ul>
  <li>
<strong>C</strong>reate : créer un message</li>
  <li>
<strong>R</strong>ead : lire un message</li>
  <li>
<strong>U</strong>pdate : mettre à jour un message</li>
  <li>
<strong>D</strong>elete : supprimer un message</li>
</ul>

<p>Nous utiliserons l’id qui est ajouté par défaut à chaque message pour spécifier directement  un message.</p>

<p>On utilisera les version asynchrone (sans <code class="language-plaintext highlighter-rouge">await</code> des différentes méthodeq)</p>

<h3 id="create">create</h3>

<blockquote>
  <p><a href="https://sequelize.org/master/manual/model-instances.html#creating-an-instance">https://sequelize.org/master/manual/model-instances.html#creating-an-instance</a></p>
</blockquote>

<p>On veut créer une donnée avec sequelize en ayant le pseudo, le titre et le corps du message. On peut faire comme ça :</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">MonModele</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
        <span class="na">message</span><span class="p">:</span> <span class="dl">"</span><span class="s2">un autre massage</span><span class="dl">"</span><span class="p">,</span>
        <span class="na">nombre</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
    <span class="p">})</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">())</span>
    <span class="p">})</span>
</code></pre></div></div>

<p>Le message est poussé en base. La clé primaire est le champ <code class="language-plaintext highlighter-rouge">id</code>.  Si c’est le premier élément que vous créez, son <code class="language-plaintext highlighter-rouge">id</code> sera de 1, et si vous en créez d’autres, l’<code class="language-plaintext highlighter-rouge">id</code> va augmenter. C’est la clé primaire de notre modèle.</p>

<h3 id="read">read</h3>

<blockquote>
  <p><a href="https://sequelize.org/master/manual/model-querying-finders.html#-code-findbypk--code-">https://sequelize.org/master/manual/model-querying-finders.html#-code-findbypk--code-</a></p>
</blockquote>

<p>On va lire une instance en connaissant sa clé primaire.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">MonModele</span><span class="p">.</span><span class="nx">findByPk</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">())</span>
    <span class="p">})</span>
</code></pre></div></div>

<p>Si l’on donne une clé primaire inexistante, on récupère l’objet <code class="language-plaintext highlighter-rouge">null</code>.</p>

<h3 id="update">update</h3>

<blockquote>
  <p><a href="https://sequelize.org/master/manual/model-instances.html#updating-an-instance">https://sequelize.org/master/manual/model-instances.html#updating-an-instance</a></p>
</blockquote>

<p>On met à jour un objet en connaissant sa clé primaire et les attributs à changer.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">MonModele</span><span class="p">.</span><span class="nx">findByPk</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="k">async</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">data</span><span class="p">.</span><span class="nx">nombre</span> <span class="o">=</span> <span class="mi">9</span>
        <span class="k">await</span> <span class="nx">data</span><span class="p">.</span><span class="nx">save</span><span class="p">()</span>
    <span class="p">})</span>
</code></pre></div></div>

<p>Remarquez que l’on a créée une fonction de type <code class="language-plaintext highlighter-rouge">async</code> pour assurer que la donnée sera sauvée avant de terminer la fonction du <code class="language-plaintext highlighter-rouge">then</code>.</p>

<h3 id="delete">delete</h3>

<blockquote>
  <p><a href="https://sequelize.org/master/manual/model-instances.html#deleting-an-instance">https://sequelize.org/master/manual/model-instances.html#deleting-an-instance</a></p>
</blockquote>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">MonModele</span><span class="p">.</span><span class="nx">findByPk</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="k">async</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="k">await</span> <span class="nx">data</span><span class="p">.</span><span class="nx">destroy</span><span class="p">()</span>
    <span class="p">})</span>
</code></pre></div></div>

<p>Remarquez que l’on a créée une fonction de type <code class="language-plaintext highlighter-rouge">async</code> pour assurer que la donnée sera détruite avant de terminer la fonction du <code class="language-plaintext highlighter-rouge">then</code>.</p>

<h2 id="fichier-sqlite">fichier sqlite</h2>

<p>Nous avons pour l’instant juste utilisé une base de donnée en mémoire, qui sera réinitialisée à chaque fois. Lorsque l’on utilise une base de donnée en dur (fichier ou serveur), on dissocie l’initalisation de la base de son utilisation.</p>

<p>Si l’on reprend l’exemple précédent et que l’on utilise une base de donnée sqlite, on pourra connecter la base ainsi :</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">path</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">path</span><span class="dl">'</span><span class="p">)</span>

<span class="kd">const</span> <span class="nx">sequelize</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Sequelize</span><span class="p">({</span>
  <span class="na">dialect</span><span class="p">:</span> <span class="dl">'</span><span class="s1">sqlite</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">storage</span><span class="p">:</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="dl">'</span><span class="s1">db.sqlite</span><span class="dl">'</span><span class="p">)</span>
<span class="p">});</span>
</code></pre></div></div>

<p>Qui utilisera (ou la créera si elle n’existe pas) un fichier <em>“db.sqlite”</em> comme base de donnée.</p>

<p>Le fichier <em>“ma_db_test.js”</em> est ensuite découpé en 2 :</p>

<ul>
  <li>
<em>“ma_db_init.js”</em> qui créera la base et placera les première données</li>
  <li>
<em>“ma_db_utilisation.js”</em> qui utilisera la base initialisée.</li>
</ul>

<h3 id="ma_db_initjs">ma_db_init.js</h3>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="p">{</span> <span class="nx">Sequelize</span><span class="p">,</span> <span class="nx">DataTypes</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">sequelize</span><span class="dl">'</span><span class="p">);</span>
<span class="nx">path</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">path</span><span class="dl">'</span><span class="p">)</span>

<span class="kd">const</span> <span class="nx">sequelize</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Sequelize</span><span class="p">({</span>
  <span class="na">dialect</span><span class="p">:</span> <span class="dl">'</span><span class="s1">sqlite</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">storage</span><span class="p">:</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="dl">'</span><span class="s1">db.sqlite</span><span class="dl">'</span><span class="p">)</span>
<span class="p">});</span>

<span class="kd">const</span> <span class="nx">MonModele</span> <span class="o">=</span> <span class="nx">sequelize</span><span class="p">.</span><span class="nx">define</span><span class="p">(</span><span class="dl">'</span><span class="s1">MonModele</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
    <span class="na">message</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">type</span><span class="p">:</span> <span class="nx">DataTypes</span><span class="p">.</span><span class="nx">STRING</span><span class="p">,</span>
        <span class="na">allowNull</span><span class="p">:</span> <span class="kc">false</span>
    <span class="p">},</span>
    <span class="na">nombre</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">type</span><span class="p">:</span> <span class="nx">DataTypes</span><span class="p">.</span><span class="nx">INTEGER</span><span class="p">,</span>
        <span class="na">allowNull</span><span class="p">:</span> <span class="kc">false</span>
    <span class="p">},</span>
<span class="p">},</span> <span class="p">{</span>
    <span class="c1">// Other model options go here</span>
<span class="p">});</span>

<span class="k">async</span> <span class="kd">function</span> <span class="nx">initDB</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">await</span> <span class="nx">sequelize</span><span class="p">.</span><span class="nx">sync</span><span class="p">({</span><span class="na">force</span><span class="p">:</span> <span class="kc">true</span><span class="p">})</span>
    
    <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">MonModele</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
        <span class="na">message</span><span class="p">:</span> <span class="dl">"</span><span class="s2">mon premier message</span><span class="dl">"</span><span class="p">,</span>
        <span class="na">nombre</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span>
    <span class="p">})</span>

    <span class="nx">data</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">MonModele</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
        <span class="na">message</span><span class="p">:</span> <span class="dl">"</span><span class="s2">un autre massage</span><span class="dl">"</span><span class="p">,</span>
        <span class="na">nombre</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
    <span class="p">})</span>

<span class="p">}</span>

<span class="nx">initDB</span><span class="p">()</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">base initalisée</span><span class="dl">"</span><span class="p">)</span>
    <span class="p">})</span>

</code></pre></div></div>

<p>On utilise <code class="language-plaintext highlighter-rouge">await sequelize.sync({force: true})</code> comme synchronisation qui, au contrainre de <code class="language-plaintext highlighter-rouge">await sequelize.sync()</code>, commence par supprimer la base avant de la récréer.</p>

<p>Exécutez le code avec la commande :</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>node ma_db_init.js
</code></pre></div></div>

<p>Une fois le code exécuté, vous devriez voir un fichier nommé <em>“db.sqlite”</em> dans le dossier de votre projet. Il contient les 2 entrées créees.</p>

<h3 id="ma_db_utilisationjs">ma_db_utilisation.js</h3>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="p">{</span> <span class="nx">Sequelize</span><span class="p">,</span> <span class="nx">DataTypes</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">sequelize</span><span class="dl">'</span><span class="p">);</span>
<span class="nx">path</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">path</span><span class="dl">'</span><span class="p">)</span>

<span class="kd">const</span> <span class="nx">sequelize</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Sequelize</span><span class="p">({</span>
  <span class="na">dialect</span><span class="p">:</span> <span class="dl">'</span><span class="s1">sqlite</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">storage</span><span class="p">:</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="dl">'</span><span class="s1">db.sqlite</span><span class="dl">'</span><span class="p">)</span>
<span class="p">});</span>

<span class="kd">const</span> <span class="nx">MonModele</span> <span class="o">=</span> <span class="nx">sequelize</span><span class="p">.</span><span class="nx">define</span><span class="p">(</span><span class="dl">'</span><span class="s1">MonModele</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
    <span class="na">message</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">type</span><span class="p">:</span> <span class="nx">DataTypes</span><span class="p">.</span><span class="nx">STRING</span><span class="p">,</span>
        <span class="na">allowNull</span><span class="p">:</span> <span class="kc">false</span>
    <span class="p">},</span>
    <span class="na">nombre</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">type</span><span class="p">:</span> <span class="nx">DataTypes</span><span class="p">.</span><span class="nx">INTEGER</span><span class="p">,</span>
        <span class="na">allowNull</span><span class="p">:</span> <span class="kc">false</span>
    <span class="p">},</span>
<span class="p">},</span> <span class="p">{</span>
    <span class="c1">// Other model options go here</span>
<span class="p">});</span>

<span class="k">async</span> <span class="kd">function</span> <span class="nx">utilisation</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Lecture id = 1 :</span><span class="dl">"</span><span class="p">)</span>
    <span class="nx">data</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">MonModele</span><span class="p">.</span><span class="nx">findByPk</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">())</span>

    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">---------</span><span class="dl">"</span><span class="p">)</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">clé primaire : </span><span class="dl">"</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">message : </span><span class="dl">"</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">message</span><span class="p">)</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">nombre : </span><span class="dl">"</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">nombre</span><span class="p">)</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">date de création création : </span><span class="dl">"</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">createdAt</span><span class="p">)</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">dernière modification : </span><span class="dl">"</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">updatedAt</span><span class="p">)</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">---------</span><span class="dl">"</span><span class="p">)</span>

    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Lecture id qui n'existe pas :</span><span class="dl">"</span><span class="p">)</span>
    <span class="nx">data</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">MonModele</span><span class="p">.</span><span class="nx">findByPk</span><span class="p">(</span><span class="mi">42</span><span class="p">);</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="c1">// n'existe pas</span>

    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Lecture tous les éléments :</span><span class="dl">"</span><span class="p">)</span>
    <span class="nx">data</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">MonModele</span><span class="p">.</span><span class="nx">findAll</span><span class="p">();</span>
    <span class="k">for</span> <span class="p">(</span><span class="nx">element</span> <span class="k">of</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">element</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">())</span>
    <span class="p">}</span>

    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Lecture requête :</span><span class="dl">"</span><span class="p">)</span>
    <span class="nx">data</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">MonModele</span><span class="p">.</span><span class="nx">findAll</span><span class="p">({</span>
        <span class="na">where</span><span class="p">:</span> <span class="p">{</span>
            <span class="na">nombre</span><span class="p">:</span> <span class="mi">3</span>
        <span class="p">}</span>
    <span class="p">});</span>
    <span class="k">for</span> <span class="p">(</span><span class="nx">element</span> <span class="k">of</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">element</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">())</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nx">utilisation</span><span class="p">()</span>
</code></pre></div></div>

<p>On est obligé de charger le modèle, mais on est pas obligé de faire la synchronisation si on a au préalable.</p>

<p>On peut exécuter la modification et la visualisation du code avec :</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>node ma_db_utilisation.js
</code></pre></div></div>

<p>Notez qu’on a utilisé une fonction asynchrone car on veut pourvoir exécuter nos trois requêtes à la suite (d’où les `await).</p>

<h3 id="on-fignole">on fignole</h3>

<p>Les deux fichiers <em>“ma_db_init.js”</em> et <em>“ma_db_utilisation.js”</em> nécessitent le modèle. Comme la duplication de code est à proscrire, il faut déporter la définition du modèle dans un fichier à part, <em>“db.js”</em> :</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="p">{</span> <span class="nx">Sequelize</span><span class="p">,</span> <span class="nx">DataTypes</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">sequelize</span><span class="dl">'</span><span class="p">);</span>
<span class="nx">path</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">path</span><span class="dl">'</span><span class="p">)</span>

<span class="kd">const</span> <span class="nx">sequelize</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Sequelize</span><span class="p">({</span>
  <span class="na">dialect</span><span class="p">:</span> <span class="dl">'</span><span class="s1">sqlite</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">storage</span><span class="p">:</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="dl">'</span><span class="s1">db.sqlite</span><span class="dl">'</span><span class="p">)</span>
<span class="p">});</span>

<span class="kd">const</span> <span class="nx">MonModele</span> <span class="o">=</span> <span class="nx">sequelize</span><span class="p">.</span><span class="nx">define</span><span class="p">(</span><span class="dl">'</span><span class="s1">MonModele</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
    <span class="na">message</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">type</span><span class="p">:</span> <span class="nx">DataTypes</span><span class="p">.</span><span class="nx">STRING</span><span class="p">,</span>
        <span class="na">allowNull</span><span class="p">:</span> <span class="kc">false</span>
    <span class="p">},</span>
    <span class="na">nombre</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">type</span><span class="p">:</span> <span class="nx">DataTypes</span><span class="p">.</span><span class="nx">INTEGER</span><span class="p">,</span>
        <span class="na">allowNull</span><span class="p">:</span> <span class="kc">false</span>
    <span class="p">},</span>
<span class="p">},</span> <span class="p">{</span>
    <span class="c1">// Other model options go here</span>
<span class="p">});</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">sequelize</span><span class="p">:</span> <span class="nx">sequelize</span><span class="p">,</span>
    <span class="na">model</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">MonModele</span><span class="p">:</span> <span class="nx">MonModele</span><span class="p">,</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>On crée dans ce fichier tout ce qui est nécessaire à l’utilisation de la base de donnée.</p>

<p>Comme ce fichier ne sera lu et exécuté qu’au premier <code class="language-plaintext highlighter-rouge">require</code>, les autres fois on ne rendra que l’objet <code class="language-plaintext highlighter-rouge">module.exports</code>, on peut importer ce fichier à de multiple reprise et n’avoir au final qu’une seule base de donnée.</p>

<p>Ceci supprime la duplication des deux fichiers <em>“ma_db_init.js”</em> et <em>“ma_db_utilisation.js”</em></p>

<p><em>“ma_db_init.js”</em> :</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">db</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">./db</span><span class="dl">"</span><span class="p">)</span>

<span class="k">async</span> <span class="kd">function</span> <span class="nx">initDB</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">await</span> <span class="nx">db</span><span class="p">.</span><span class="nx">sequelize</span><span class="p">.</span><span class="nx">sync</span><span class="p">({</span><span class="na">force</span><span class="p">:</span> <span class="kc">true</span><span class="p">})</span>
    
    <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">db</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">MonModele</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
        <span class="na">message</span><span class="p">:</span> <span class="dl">"</span><span class="s2">mon premier message</span><span class="dl">"</span><span class="p">,</span>
        <span class="na">nombre</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span>
    <span class="p">})</span>

    <span class="nx">data</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">db</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">MonModele</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
        <span class="na">message</span><span class="p">:</span> <span class="dl">"</span><span class="s2">un autre massage</span><span class="dl">"</span><span class="p">,</span>
        <span class="na">nombre</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
    <span class="p">})</span>

<span class="p">}</span>

<span class="nx">initDB</span><span class="p">()</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">base initalisée</span><span class="dl">"</span><span class="p">)</span>
    <span class="p">})</span>
</code></pre></div></div>

<p><em>“ma_db_utilisation.js”</em> :</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">db</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">./db</span><span class="dl">"</span><span class="p">)</span>

<span class="k">async</span> <span class="kd">function</span> <span class="nx">utilisation</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Lecture id = 1 :</span><span class="dl">"</span><span class="p">)</span>
    <span class="nx">data</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">db</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">MonModele</span><span class="p">.</span><span class="nx">findByPk</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">())</span>

    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">---------</span><span class="dl">"</span><span class="p">)</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">clé primaire : </span><span class="dl">"</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">message : </span><span class="dl">"</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">message</span><span class="p">)</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">nombre : </span><span class="dl">"</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">nombre</span><span class="p">)</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">date de création création : </span><span class="dl">"</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">createdAt</span><span class="p">)</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">dernière modification : </span><span class="dl">"</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">updatedAt</span><span class="p">)</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">---------</span><span class="dl">"</span><span class="p">)</span>

    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Lecture id qui n'existe pas :</span><span class="dl">"</span><span class="p">)</span>
    <span class="nx">data</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">db</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">MonModele</span><span class="p">.</span><span class="nx">findByPk</span><span class="p">(</span><span class="mi">42</span><span class="p">);</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="c1">// n'existe pas</span>

    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Lecture tous les éléments :</span><span class="dl">"</span><span class="p">)</span>
    <span class="nx">data</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">db</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">MonModele</span><span class="p">.</span><span class="nx">findAll</span><span class="p">();</span>
    <span class="k">for</span> <span class="p">(</span><span class="nx">element</span> <span class="k">of</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">element</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">())</span>
    <span class="p">}</span>

    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Lecture requête :</span><span class="dl">"</span><span class="p">)</span>
    <span class="nx">data</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">db</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">MonModele</span><span class="p">.</span><span class="nx">findAll</span><span class="p">({</span>
        <span class="na">where</span><span class="p">:</span> <span class="p">{</span>
            <span class="na">nombre</span><span class="p">:</span> <span class="mi">3</span>
        <span class="p">}</span>
    <span class="p">});</span>
    <span class="k">for</span> <span class="p">(</span><span class="nx">element</span> <span class="k">of</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">element</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">())</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nx">utilisation</span><span class="p">()</span>
</code></pre></div></div>

  </div>

</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/cours_informatique/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">cours d'informatique</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">cours d'informatique</li>
</ul>
      </div>

      <div class="footer-col footer-col-2">
<ul class="social-media-list"><li><a href="https://github.com/FrancoisBrucker"><svg class="svg-icon"><use xlink:href="/cours_informatique/assets/minima-social-icons.svg#github"></use></svg> <span class="username">FrancoisBrucker</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>Support de cours/td d'informatique à l'école centrale marseille.</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>

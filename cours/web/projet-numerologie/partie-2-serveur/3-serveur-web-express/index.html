<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1"/>

    <title>Projet numérologie : partie 2 / web avec express</title>

    <link href=/cours_informatique/assets/node_modules/prismjs/themes/prism-solarizedlight.min.css rel="stylesheet">
    <link href=/cours_informatique/assets/node_modules/prismjs/plugins/line-numbers/prism-line-numbers.min.css rel="stylesheet">

    <link href=/cours_informatique/assets/stylesheets/main.css rel="stylesheet">

  </head>
  <body>
    <script>
      window.MathJax = {
        tex: {
          inlineMath: [
            [
              '$', '$'
            ],
            [
              '\\(', '\\)'
            ]
          ]
        },
        svg: {
          fontCache: 'global'
        }
      };
    </script>
    <script type="text/javascript" id="MathJax-script" async
  src=/cours_informatique/assets/node_modules/mathjax/es5/tex-svg-full.js></script>
  
    <header class="border-b-2 border-gray-200 mb-4">
      <div class="max-w-[1000px] mx-auto px-4">
        <div class="min-h-[50px] flex justify-between items-center">
          <a class="mx-2" href="/cours_informatique/">Home</a>
          <a class="mx-2" href="/cours_informatique/about">About</a>
        </div>
      </div>
    </header>

    <main class="max-w-[1000px] mx-auto px-4">
      
<article>

  <h1  class="mb-1">Projet numérologie : partie 2 / web avec express</h1>
  <div class="mb-4">
    

    
      <div class=" px-4 flex items-center">
        
          <div class="font-bold">Auteur : </div>
        
        <ul class="flex not-prose list-none my-0 last:after:content-['•'] last:after:px-1 mx-0 px-1">
          
            <li class="before:content-['•'] before:px-1">François Brucker</li>
          
        </ul>
      </div>
    
  </div>

  
    
<div class="quote relative  py-2 drop-shadow rounded rounded-tl-none rounded-bl-none border-solid border-l-8 border-purple-500 bg-purple-100">
<svg class="absolute w-7 h-7 pl-1 pt-0.5 pb-0.5 text-purple-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
  <path stroke-linecap="round" stroke-linejoin="round" d="M5 19a2 2 0 01-2-2V7a2 2 0 012-2h4l2 2h4a2 2 0 012 2v1M5 19h14a2 2 0 002-2v-5a2 2 0 00-2-2H9a2 2 0 00-2 2v5a2 2 0 01-2 2z" />
</svg>
<div class="pl-8 mr-8">

<a href="/cours_informatique/cours/">Cours</a><span class="px-1">/</span><a href="/cours_informatique/cours/web/">Web</a><span class="px-1">/</span><a href="/cours_informatique/cours/web/projet-numerologie/">Projet numérologie</a><span class="px-1">/</span><a href="/cours_informatique/cours/web/projet-numerologie/partie-2-serveur/">Projet numérologie / partie 2 serveur</a><span class="px-1">/</span><a href="/cours_informatique/cours/web/projet-numerologie/partie-2-serveur/3-serveur-web-express/">Projet numérologie : partie 2 / web avec express</a>

</div></div>

  

  <!-- début résumé -->
<p>On utilise le module express pour gérer plus élégamment notre site.</p>
<!-- fin résumé -->
<h2>gestionnaire de package</h2>
<p><a href="https://expressjs.com/">express</a> est un module pour node qui permet une gestion efficace et apaisée des site web.</p>
<p>Pour installer des packages node, on peut utiliser <a href="https://www.npmjs.com/">npm</a> (<strong>n</strong>ode <strong>p</strong>ackage <strong>m</strong>anager) qui est livré avec node.</p>
<blockquote>
<p>Un <a href="https://www.digitalocean.com/community/tutorials/how-to-use-node-js-modules-with-npm-and-package-json-fr">tutoriel pour utiliser npm</a></p>
</blockquote>
<h3>npm init</h3>
<p>Pour que <code>npm</code> puisse gérer nos module, il faut lui laisser créer un fichier de configuration nommé <em>&quot;package.json&quot;</em>. Pour cela, tapez dans un terminal placé à la racine de notre projet :</p>
<pre class="language-shell " style="counter-reset: linenumber 0"><code class="language-shell"><span class="token function">npm</span> init
</code></pre>
<p>Répondez aux questions (ou tapez sur entrée). Lorsque le programme est fini, vous trouverez un fichier <em>&quot;package.json&quot;</em> à la racine de votre projet.</p>
<p>Chez moi, il ressemble à ça :</p>
<pre class="language-json " style="counter-reset: linenumber 0"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"numerologie"</span><span class="token punctuation">,</span>
  <span class="token property">"version"</span><span class="token operator">:</span> <span class="token string">"1.0.0"</span><span class="token punctuation">,</span>
  <span class="token property">"description"</span><span class="token operator">:</span> <span class="token string">"de la numérologie"</span><span class="token punctuation">,</span>
  <span class="token property">"main"</span><span class="token operator">:</span> <span class="token string">"index.js"</span><span class="token punctuation">,</span>
  <span class="token property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"test"</span><span class="token operator">:</span> <span class="token string">"echo \"Error: no test specified\" &amp;&amp; exit 1"</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">"author"</span><span class="token operator">:</span> <span class="token string">"François Brucker"</span><span class="token punctuation">,</span>
  <span class="token property">"license"</span><span class="token operator">:</span> <span class="token string">"WTFPL"</span>
<span class="token punctuation">}</span>

</code></pre>
<p>Il ne contient pour l'instant que des informations générales quant au projet. Nous allons bientôt y ajouter des modules.</p>
<blockquote>
<p>Le <a href="https://fr.wikipedia.org/wiki/JavaScript_Object_Notation">json</a> est un format texte pour sauvegarder des données structurée. C'est un format génial qui sert tout autant pour les fichiers de configurations que le transfert de données par le web.</p>
</blockquote>
<h3>ajout d'un module</h3>
<p>Pour cela, tapez dans un terminal placé à la racine de notre projet :</p>
<pre class="language-shell " style="counter-reset: linenumber 0"><code class="language-shell"><span class="token function">npm</span> <span class="token function">add</span> <span class="token parameter variable">--save</span> express
</code></pre>
<blockquote class="attention">
<p>N'oubliez pas <code>--save</code>, sinon le module sera installé mais la dépendance ne sera pas ajoutée au fichier <em>&quot;package.json&quot;</em> ce qui est tarte.</p>
</blockquote>
<p>Cette commande a ajouté une dépendance à notre fichier <em>&quot;package.json&quot;</em> :</p>
<pre class="language-json " style="counter-reset: linenumber 0"><code class="language-json"><span class="token property">"dependencies"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"express"</span><span class="token operator">:</span> <span class="token string">"^4.17.1"</span>
  <span class="token punctuation">}</span>
</code></pre>
<p>A créer un fichier <em>&quot;package-lock.json&quot;</em> qui contient la liste de tous les modules installés et un (gros) dossier <em>&quot;node_modules&quot;</em> qui contient les modules installés.</p>
<blockquote>
<p>Il y a plus de 50 modules installés alors que l'on a demandé d'installer que le module <code>express</code>, car il a lui même des dépendances et ses dépendances d'autres dépendances, etc.</p>
</blockquote>
<p>La différence entre <em>&quot;package.json&quot;</em> et <em>&quot;package-lock.json&quot;</em> est que le premier décrit les versions possibles (nous, toutes les versions ultérieures à 4.17.1) alors que <em>&quot;package-lock.json&quot;</em> décrit la version effectivement installée (la 4.17.1). Cette méchanique permet de mettre à jour nos modules en supprimant le dossier <em>&quot;node_module&quot;</em> et le fichier <em>&quot;package-lock.json&quot;</em> et en tapant la commande <code>npm install</code>.</p>
<h3>sauvegarde et installation du projet</h3>
<p>Le dossier <em>&quot;node_module&quot;</em> n'est pas un module à sauver, on peut installer toutes les dépendances avec la commande <code>npm install</code> :</p>
<ul>
<li>grâce au fichier <em>&quot;package-lock.json&quot;</em> : la commande <code>npm --install</code> sait exactement quels modules installer</li>
<li>le fichier <em>&quot;package.json&quot;</em> donnant les dépendances générales de notre projet.</li>
</ul>
<h2>routes</h2>
<p>Le module <a href="https://expressjs.com/">express</a> va nous permettre de créer nos routes (les urls que le serveur connait) simplement.</p>
<p>Avant d'utiliser le module, penchons nous un peut sur que l'on veut :</p>
<ul>
<li>site statique : on demande à l'utilisateur de taper son prénom</li>
<li>une fois que l'on appuie sur le bouton, le prénom est envoyé au server qui retourne le chiffre associé.</li>
</ul>
<p>Pour l'instant nous n'avons qu'un site front. Donc commençons par organiser le tout.</p>
<h3>séparation front et back</h3>
<p>L'usage veut que le site front soit séparé des actions du serveur. Cela permet de ne pas se mélanger les fichiers.</p>
<ol>
<li>créez un dossier <em>&quot;numerologie/static&quot;</em> et déplacez les fichiers :
<ul>
<li><em>&quot;index.html&quot;</em></li>
<li><em>&quot;mains.css&quot;</em></li>
<li><em>&quot;numerologie.js&quot;</em></li>
</ul>
</li>
<li>supprimez le fichier <em>&quot;mes_test.js&quot;</em>, on ne s'en sert plus depis longtemps.</li>
</ol>
<p>Le projet ressemble maintenant à ça, en excluant le dossier <em>&quot;node_modules&quot;</em> :</p>
<pre class="language-text " style="counter-reset: linenumber 0"><code class="language-text">.
├── index.js
├── package-lock.json
├── package.json
└── static
    ├── index.html
    ├── main.css
    └── numerologie.js
</code></pre>
<blockquote>
<p>On a utilisé la commande unix <a href="https://linux.die.net/man/1/tree">tree</a> (<code>tree -I node_modules</code>) pour réaliser le dessin ci-dessus.</p>
</blockquote>
<h3>notre site en express</h3>
<p>Modifions le fichier <em>&quot;numerologie/index.js&quot;</em> pour que notre site fonctionne sous express :</p>
<pre class="language-javascript " style="counter-reset: linenumber 0"><code class="language-javascript"><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> hostname <span class="token operator">=</span> <span class="token string">'127.0.0.1'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> port <span class="token operator">=</span> <span class="token number">3000</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">"/static"</span><span class="token punctuation">,</span> express<span class="token punctuation">.</span><span class="token function">static</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'/static'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token number">301</span><span class="token punctuation">,</span> <span class="token string">'/static/index.html'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>


app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"et c'est le 404 : "</span> <span class="token operator">+</span> req<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>

    res<span class="token punctuation">.</span>statusCode <span class="token operator">=</span> <span class="token number">404</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Content-Type'</span><span class="token punctuation">,</span> <span class="token string">'text/html'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">"&lt;html>&lt;head>&lt;title>la quatre cent quatre&lt;/title>&lt;/head>&lt;body>&lt;h1>Et c'est la 404.&lt;/h1>&lt;img  src=\"https://www.leblogauto.com/wp-content/uploads/2020/04/Peugeot-404-1.jpg\" />&lt;/body>&lt;/html>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>port<span class="token punctuation">,</span> hostname<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Server running at http://</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>hostname<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>port<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>Tout se passe <em>via</em> l'objet <code>app</code>, qui est le résultat de l'import de express. Chaque requête au serveur passera d'un appel de <code>app</code> à l'autre (dans l'ordre du fichier).</p>
<blockquote>
<p>Express appelle ces bouts de codes qui interceptent une requête un <a href="https://expressjs.com/fr/guide/using-middleware.html">middleware</a></p>
</blockquote>
<p>Pour chaque appel de app (dans notre cas on en a 2 <code>app.use</code> et <code>app.get</code>) :</p>
<ol>
<li>on vérifie si la requête satisfait l'appel de <code>app</code> :
<ul>
<li><code>app.use()</code> : reçoit toutes les requêtes</li>
<li><code>app.get()</code> : ne reçoit que les requêtes de méthode <code>get</code></li>
<li><code>app.post()</code> : ne reçoit que les requêtes de méthode <code>post</code></li>
</ul>
</li>
<li>Si la requête satisfait l'appel de <code>app</code>, on vérifie si elle satisfait le 1er paramètre</li>
<li>Si la requête satisfait le 1er paramètre on exécute la méthode du second paramètre avec la requête en 1er paramètre.</li>
</ol>
<blockquote>
<p>Comme dit précédemment, la route <code>/static</code> ne doit être utilisée qu'en développement. En production, on doit avoir un serveur dédié aux fichiers statiques pour éviter tout problème de charge.</p>
</blockquote>
<p>Dans notre cas l'enchaînement de route est ainsi :</p>
<ol>
<li>1er <code>app.use</code> : si l'url de la requête commence par <code>/static</code> on envoie cette requête dans le gestionnaire de fichiers statiques de express.</li>
<li><code>app.get</code>  :  si l'url de la requête est <code>/</code> on redirige la requête vers <code>/static/index.html</code>. Cette requête redirigée sera alors consommée par le <code>app.use</code></li>
<li>2ème <code>app.use</code> : s on arrive là, c'est que toutes les routes précédentes ont échouées : on ne peut rien faire de la requêtes on indique au client que c'est un 404. On en a aussi profité pour rendre du contenu (toute une famille).</li>
</ol>
<blockquote>
<p>Le dernier appel de <code>app</code> doit être pour gérer les requêtes qui n'ont pas pu être consommées avant. C'est souvent que l'on ne sait pas quoi en faire donc on l'indique au client part un 404.</p>
</blockquote>
<p>Pour plus d'informations sur le routage express, n'hésitez pas à <a href="https://expressjs.com/fr/guide/routing.html">consulter la documentation</a></p>
<h3>fonction next()</h3>
<p>On peut remettre des requêtes utilisées en fonction avec la méthode <code>next()</code></p>
<p>Ajoutez par exemple ce code en début de fichier en faisant en sorte que ce soit le 1er appel à <code>app</code> :</p>
<pre class="language-javascript " style="counter-reset: linenumber 0"><code class="language-javascript"><span class="token comment">// ...</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    date <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Time:'</span><span class="token punctuation">,</span> date<span class="token punctuation">.</span><span class="token function">toLocaleDateString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> date<span class="token punctuation">.</span><span class="token function">toLocaleTimeString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"; url :"</span><span class="token punctuation">,</span> req<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// sans cette ligne on ne pourra pas poursuivre.</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// ...</span>
</code></pre>
<blockquote class="attention">
<p>Notez Le format de la fonction change, remarquez qu'il y a un troisième paramètre, <code>next</code>.<br>
Lorsque vous voulez utiliser <code>next</code> il faut que vous l'ajoutiez en paramètre de la fonction.</p>
</blockquote>
<p>Toutes les requêtes satisfont cet appel, c'est un loggeur rudimentaire.</p>
<p>Si vous supprimez la ligne avec <code>next()</code> plus rien ne fonctionne. Toutes les requêtes sont consommées.</p>


</article>
    </main>

    <footer class="min-h-[50px] border-t-2 border-gray-200 mt-4">
      <div class="max-w-[1000px] mx-auto px-4">
        <div class="min-h-[50px] flex justify-center items-center">
          <p>
            Cours d'informatique à l'école centrale Marseille
          </p>
        </div>
      </div>
    </footer>

  <script>
    MathJax.startup.document.getMathItemsWithin(document.body);
  </script>

  </body>
</html>
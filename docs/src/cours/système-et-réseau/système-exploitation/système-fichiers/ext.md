---
layout: layout/post.njk

title: Ext4

eleventyComputed:
  eleventyNavigation:
    key: "{{ page.url }}"
    title: "{{ title | safe }}"
    parent: "{{ '../' | siteUrl(page.url) }}"
---

> TBD : rendre joli. Faire des dessins d'inode.
> bien séparer ext2/3/4

[ext4](https://fr.wikipedia.org/wiki/Ext4) est le format standard du système de fichier Linux. Il est une évolution de l'ext3 (il augmente la taille maximale des fichiers et leurs gestion), lui même une évolution d'ext2 (ext3 est ext2 plus la journalisation).

{% info %}
<https://www.easeus.fr/partition-manager-tips/systeme-de-fichiers-ext2-ext3-ext4.html>
{% endinfo %}

## Principe

{% lien %}
<https://teaching.idallen.com/cst8207/13w/notes/450_file_system.html>
{% endlien %}

Plutôt que d'avoir une structure linéaire globale où sont stockés les structures de tous les fichiers (comme la FAT), ext utilise pour chaque fichier une structure arborée nommée [inode](https://fr.wikipedia.org/wiki/N%C5%93ud_d'index) qui contient à la fois les méta données et la structure de stockage.

## Format

{% lien %}
[Structure complète de ext4]((https://ext4.wiki.kernel.org/index.php/Ext4_Disk_Layout))
{% endlien %}

Le découpage de la structure est en 6 parties :

1. superblock (taille 1 bloc)
2. groupes (taille variable de plusieurs bloc)
3. bitmap des blocs (taille 1 bloc)
4. bitmap des inodes (taille 1 bloc)
5. liste des inodes (taille variable de plusieurs bloc)
6. blocs de données (taille variable de plusieurs bloc)

### superblock

La première partie de la structure, le superblock contient diverse informations sur le volume. En particulier :

- la taille d'un bloc, de 1KiB à 64KiB et habituellement 4KiB
- le nombres d'inodes du volume, au maximum $2^{32}$
- le nombre de blocs du volume, au maximum $2^{32}$

Le superblock est dupliqué, pour pouvoir le reconstitué en cas de corruption.

### Groupes

Les inodes et les blocs sont partitionnés en groupes. Chaque groupe forme un intervalle de blocs, ce qui permet, de limiter la [fragmentation](https://en.wikipedia.org/wiki/File_system_fragmentation) si on contraint les fichiers à être stockés avec des blocs du même groupe.

### bitmap des blocs et ds inodes

[bitmap](https://en.wikipedia.org/wiki/Bitmap) permettant de trouver un bloc ou un inode libre.

### Table des inodes

#### Table

un tableau d'inode.  Chaque inode fait une taille par défaut de 256B en ext4 (128B pour ext2 et ext3). Il est impensable d'avoir $2^{32}$, car la table seule ferait $2TiB$. L'usage veut que l'on ait 1/(16KiB) fois la taille du volume inode, ce qui fait $1.5\\%$ de la taille totale du disque.

La numérotation des inodes commence à 1, il n'existe pas d'iode 0.

#### Inode

{% lien %}
[inode](https://en.wikipedia.org/wiki/Ext2#Inodes)
{% endlien %}

Un inode est une structure permettant de stocker les méta-données et la structure d'un élément du système de fichiers : dossier ou fichier.

Cette structure est composée :

- méta-données de l'élément :
  - propriétaire
  - groupe
  - permissions
  - dates de création, dernière modification
- nombres de référence de cet inode
- type d'élément (dossier, fichier ou interface)
- blocs :
  - 12 adressages direct
  - 1 adressage indirect : un bloc de 128 adresses de blocs
  - 1 adressage doublement indirect : un bloc de 128 adresses indirects
  - 1 adressage triplement indirect : un bloc de 128 adresses doublement indirectes

Remarquez que le nom n'est pas présent dans un inode, au contraire du format FAT.

### blocs

#### élément

dossier : liste de noms plus inodes
permet des lien fort entre plusieurs fichiers qui se retrouvent identique. On incrémente le nombre de référence.

contient toujours . et ..

fichier : stockage

#### adressage

Cette adressage en arbre à deux grandes propriétés :

- il est compact et tient en cache
- on ne stocke que ce dont on a besoin (la FAT stock tout, même ce qui n'existe pas encore)
- l'indirection fait qu'on peut stocker beaucoup de chose (on ne fait que 3 étages pour limiter l'overhead)

$2^{32}$ blocs et taille de secteur de 512B. On peut stocker 128 adresses de blocs.

Nombre de blocs stockés :

- simple : $128 = 2^7$ blocs
- indirect : $128^2 = 2^{14} = 16 \text{KiB}$ blocs
- doublement indirect : $128^3 = 2 \text{MiB}$ blocs
- triplement indirect : $128^4 = 256 \text{MiB}$ blocs

Notez que l'on ne préremplit pas la structure, on alloue les blocs indirect que si le fichier est assez gros pour en avoir besoin. On ne gâche donc pas de place de stockage (ou si peu).

Avec une taille de bloc de 4KiB$, on arrive à des tailles respectables. De plus ext4 permet de stocker des intervalles contiguë de blocs plutôt qu'une unique  adresse, ce qui rend la taille d'un fichier virtuellement infinie.

{% note "élément de design" %}
inode :

- on ne stocke que ce qui est nécessaire
- stockage par niveau : l'arbre démultiplie les possibilités de stockage

{% endnote %}

## <span id="ext-opérations"></span>Opérations

la gestion des droit est au cœur du système.

Le cache fait que l'accès va aller vite, on a les tables directement en mémoire. La FAT en entier ne tient pas dedans.

### <span id="ext-opérations-ajout">Ajout

idem que pour la FAT

### <span id="ext-opérations-suppression">Suppression

On décrémente la référence. et si référence vaut 0, on supprime l'inode.
